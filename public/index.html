<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Pathway</title>
    
    <style>
        
        /* === å…¨å±€æ ·å¼ === */
        body {
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        /* ========================================= */
        /* 1. é¡¶éƒ¨å¯¼èˆªæ  (æºè‡ª File 2 æ”¹è‰¯ç‰ˆ)       */
        /* ========================================= */
        header.topbar {
            background-color: #fff;
            padding: 12px 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 14px;
            z-index: 100; /* ä¿è¯åœ¨ Regulation Bar ä¹‹ä¸Š */
            position: relative;
        }

        .brand {
            display: flex; align-items: center; gap: 10px; min-width: 0;
        }
        .brand-emoji { font-size: 20px; }
        .brand-title {
            font-size: 20px; font-weight: 700; color: #111827;
            letter-spacing: 0.2px; white-space: nowrap;
        }

        .topbar-center {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            justify-content: center; min-width: 0;
        }

        /* èƒ¶å›Šæ ·å¼ (Chips) */
        .chip {
            display: flex; align-items: center; gap: 8px; padding: 8px 10px;
            border: 1px solid #edf0f5; background: #f6f7fb; border-radius: 14px; min-width: 0;
            transition: all 0.2s;
        }
        .chip:focus-within {
            border-color: #2196F3;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        .chip-label { font-size: 12px; color: #4b5563; font-weight: 600; }
        .chip-arrow { color: #6b7280; user-select: none; }
        
        .chip input {
            border: none; background: transparent; outline: none;
            font-size: 13px; color: #111827; min-width: 0;
        }
        /* æœç´¢æ¡†å®½åº¦é€‚é… */
        .search-chip input { width: 180px; }
        .path-chip input { width: 100px; }

        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .topbar-actions {
            display: flex; align-items: center; gap: 8px; justify-content: flex-end;
        }
        .btn {
            cursor: pointer; padding: 8px 12px; border: 1px solid #e2e6ef;
            background: #fff; border-radius: 14px; font-size: 13px; color: #111827;
            display: flex; align-items: center; gap: 6px; white-space: nowrap;
            user-select: none; transition: all 0.2s;
        }
        .btn:hover { background: #f6f7fb; border-color: #d1d5db; }
        
        .btn-primary {
            background: #111827; color: #fff; border-color: #111827;
        }
        .btn-primary:hover { background: #0b1220; border-color: #000; }

        /* å†»ç»“æŒ‰é’®æ¿€æ´»æ€ */
        #freeze-toggle.is-on {
            border-color: #f59e0b; background: #fff7ed; color: #b45309;
        }

        /* ç®€å•çš„çŠ¶æ€æ–‡å­— */
        .status {
            font-size: 12px; color: #6b7280; margin-left: 5px;
            max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* é”™è¯¯æç¤º */
        #error-msg {
            display: none; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            color: #d32f2f; background: #ffebee;
            padding: 5px 15px; border-radius: 20px;
            font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 1100px) {
            header.topbar { grid-template-columns: 1fr; gap: 10px; }
            .topbar-center { justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; }
            .topbar-actions { justify-content: flex-start; }
        }

        /* ========================================= */
        /* æ–°ç‰ˆ Regulation é¢æ¿æ ·å¼                  */
        /* ========================================= */
        
        /* 1. é¢æ¿å®¹å™¨ï¼šä½äºHeaderä¸‹æ–¹ï¼Œç»å¯¹å®šä½æˆ–æµå¼å¸ƒå±€å‡å¯ */
        /* è¿™é‡Œä½¿ç”¨ç›¸å¯¹å®šä½æµå¼å¸ƒå±€ï¼Œæ¨æŒ¤ç”»å¸ƒï¼Œä¿è¯ä¸é®æŒ¡åŸæœ‰èŠ‚ç‚¹ */
        #regulation-panel {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            /* å…³é”®ï¼šå…è®¸ overflow visibleï¼Œè®©ä¸‹æ‹‰èœå•èƒ½æ˜¾ç¤ºå‡ºæ¥ */
            overflow: visible; 
            display: none; /* é»˜è®¤éšè— */
            z-index: 90;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            animation: slideDown 0.3s ease forwards;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 2. å†…éƒ¨åŒ…è£…å™¨ï¼šè´Ÿè´£å†…è¾¹è·å’Œå¸ƒå±€ */
                /* 2. å†…éƒ¨åŒ…è£…å™¨ï¼šè´Ÿè´£å†…è¾¹è·å’Œå¸ƒå±€ï¼ˆå•è¡Œæ»šåŠ¨ç‰ˆï¼‰ */
        #regulation-content-wrapper {
            padding: 12px 24px;
            display: flex;
            
            /* === æ”¹åŠ¨ 1: å¼ºåˆ¶ä¸æ¢è¡Œï¼Œä¸”å¼€å¯Xè½´æ»šåŠ¨ === */
            flex-wrap: nowrap; 
            overflow-x: auto; 
            
            gap: 12px;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œé˜²æ­¢æ’‘é«˜å¸¦æ¥çš„å‚ç›´å±…ä¸­é—®é¢˜ */
            
            /* === æ”¹åŠ¨ 2: å…³é”® Hack - é˜²æ­¢ä¸‹æ‹‰èœå•è¢« overflow è£å‰ª === */
            /* å‘ä¸‹æ’‘å¼€è¶³å¤Ÿç©ºé—´ç»™ dropdown æ˜¾ç¤º */
            padding-bottom: 340px; 
            /* ç”¨è´Ÿ margin æŠŠä¸‹æ–¹çš„å¸ƒå±€æ‹‰å›æ¥ï¼ŒæŠµæ¶ˆ padding çš„å ä½ */
            margin-bottom: -320px; 
            
            /* === æ”¹åŠ¨ 3: é¼ æ ‡äº‹ä»¶ç©¿é€ === */
            /* åªæœ‰å…·ä½“çš„ Chip æŒ‰é’®å“åº”é¼ æ ‡ï¼Œç©ºç™½é€æ˜åŒºåŸŸä¸é˜»æŒ¡ç‚¹å‡»ä¸‹æ–¹ç”»å¸ƒ */
            pointer-events: none;
            
            /* === æ”¹åŠ¨ 4: éšè—åŸç”Ÿçš„ä¸‘æ»šåŠ¨æ¡ (Chrome/Safari) === */
            scrollbar-width: none; /* Firefox */
        }
        
        /* éšè—æ»šåŠ¨æ¡ (Chrome/Safari) */
        #regulation-content-wrapper::-webkit-scrollbar {
            display: none; 
        }

        /* 3. åˆ†ç»„èƒ¶å›Šæ ·å¼ (Group Chip) */
        .reg-group {
            position: relative;
            display: inline-block;
            
            /* === æ”¹åŠ¨ 5: é˜²æ­¢è¢«æŒ¤æ‰ === */
            flex-shrink: 0; 
            
            /* === æ”¹åŠ¨ 6: æ¢å¤é¼ æ ‡äº‹ä»¶ (å› ä¸ºçˆ¶å®¹å™¨ç¦ç”¨äº†) === */
            pointer-events: auto; 
        }


        .reg-group-title {
            font-size: 12px; font-weight: 600; color: #374151;
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 20px; /* æ›´åœ†æ¶¦ */
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
            user-select: none;
        }
        
        .reg-group:hover .reg-group-title {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        .reg-group-count {
            background: #e5e7eb; color: #6b7280;
            font-size: 10px; padding: 1px 6px; border-radius: 10px;
        }
        .reg-group:hover .reg-group-count {
            background: #dbeafe; color: #1e40af;
        }

                /* 4. ä¸‹æ‹‰èœå• (Grid Layout) */
        .reg-dropdown {
            /* å¸ƒå±€å±æ€§ (display: grid å¿…é¡»å¸¸é©»ï¼Œä»¥ä¾¿è®¡ç®—å¸ƒå±€) */
            display: grid; 
            position: absolute;
            top: 110%; 
            left: 0;
            z-index: 1000;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 12px;
            min-width: 320px;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;

            /* === æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ visibility+opacity ä»£æ›¿ display:none === */
            visibility: hidden;   /* éšè—ï¼Œä¸æ¥æ”¶é¼ æ ‡äº‹ä»¶ */
            opacity: 0;           /* é€æ˜ */
            transform: translateY(-5px); /* ç¨å¾®å‘ä¸Šåç§»ï¼Œå¢å¼ºå‡ºç°åŠ¨ç”»æ„Ÿ */

            /* === å…³é”®é€»è¾‘ï¼šé¼ æ ‡ç§»å¼€æ—¶çš„è¿‡æ¸¡æ•ˆæœ === */
            /* å«ä¹‰ï¼šopacityåœ¨1ç§’å»¶è¿Ÿåå¼€å§‹å˜é€æ˜ï¼Œvisibilityåœ¨1ç§’å»¶è¿Ÿåå˜ä¸ºhidden */
            transition: 
                transform 0.2s ease 0.1s, 
                opacity 0.2s ease 0.1s, 
                visibility 0s linear 0.1s; 
        }


                /* åªæœ‰å½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */
        .reg-group:hover .reg-dropdown {
            /* === æ‚¬åœæ—¶ç«‹å³æ˜¾ç¤º === */
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
            
            /* è¦†ç›–ä¸Šé¢çš„ transitionï¼Œå°† delay è®¾ä¸º 0sï¼Œå®ç°â€œç§»å…¥ç«‹å³æ˜¾ç¤ºï¼Œç§»å‡ºå»¶è¿Ÿæ¶ˆå¤±â€ */
            transition-delay: 0s;
        }


        /* 5. ä¸‹æ‹‰èœå•å†…çš„æŒ‰é’®é¡¹ */
        .reg-item-btn {
            font-size: 12px; color: #4b5563;
            background: #fff;
            border: 1px solid #f3f4f6;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            text-align: left;
            display: flex; align-items: center;
            transition: all 0.1s;
        }
        .reg-item-btn:hover {
            background: #f0f9ff; color: #0284c7; border-color: #bae6fd;
        }
        .reg-item-btn.active {
            background: #0ea5e9; color: white; border-color: #0284c7;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
        }
        
        /* æ–‡æœ¬è¿‡é•¿çœç•¥ */
        .reg-item-btn span {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }



        /* ========================================= */
        /* 3. å¸ƒå±€ç»“æ„ (Container, Sidebar, Graph)  */
        /* ========================================= */
        #main-container {
            flex: 1; display: flex; overflow: hidden; position: relative;
        }

        /* å·¦ä¾§ç­›é€‰æ  */
        #sidebar {
            width: 260px; background: #fff; border-right: 1px solid #eee;
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-title {
            font-size: 14px; font-weight: bold; color: #555;
            margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;
        }

        .pathway-list { display: flex; flex-direction: column; gap: 8px; }
        
        .checkbox-item {
            display: flex; align-items: center; cursor: pointer;
            font-size: 13px; color: #444; padding: 5px;
            border-radius: 4px; transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f0f7ff; }
        .checkbox-item input { margin-right: 10px; accent-color: #2196F3; }

                /* Pathway åˆ†ç»„æŠ˜å  */
        .sheet-group { margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; }
        .sheet-header {
            display: flex; align-items: center; justify-content: space-between;
            gap: 10px; margin-bottom: 6px; cursor: pointer; user-select: none; padding: 4px 0;
        }
        .sheet-header:hover { background: #fafafa; }
        .sheet-name { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: bold; color: #333; }
        .sheet-swatch { width: 10px; height: 10px; border-radius: 3px; }
        
        /* 1. ç®­å¤´åŠ¨ç”»ä¼˜åŒ–ï¼šå¢åŠ ç¼“åŠ¨ */
        .sheet-arrow { 
            font-size: 10px; color: #999; margin-left: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        /* 2. å†…å®¹åŒºåŸŸåŠ¨ç”»ä¼˜åŒ–ï¼šä½¿ç”¨ max-height ä»£æ›¿ display */
        .sheet-body { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            margin-left: 10px; 
            
            /* å…³é”®åŠ¨ç”»å±æ€§ */
            overflow: hidden;       /* å¿…é¡»éšè—æº¢å‡ºå†…å®¹ */
            max-height: 1000px;     /* è®¾å®šä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ (å±•å¼€çŠ¶æ€) */
            opacity: 1;             /* å®Œå…¨ä¸é€æ˜ */
            transform: translateY(0);
            
            /* ç»„åˆè¿‡æ¸¡æ•ˆæœï¼šé«˜åº¦ã€é€æ˜åº¦ã€ä½ç§» */
            transition: 
                max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease,
                transform 0.3s ease,
                margin 0.3s ease;
        }

        /* 3. æ”¶èµ·çŠ¶æ€ï¼šé«˜åº¦å½’é›¶ï¼Œé€æ˜åº¦å½’é›¶ï¼Œç¦æ­¢ç‚¹å‡» */
        .sheet-group.collapsed .sheet-body { 
            /* display: none;  <-- åˆ æ‰è¿™è¡Œï¼Œå®ƒæ˜¯é€ æˆç”Ÿç¡¬çš„åŸå›  */
            max-height: 0; 
            opacity: 0;
            margin-top: 0;      /* æ¶ˆé™¤é—´è· */
            margin-bottom: 0;   
            transform: translateY(-10px); /* ç¨å¾®å‘ä¸Šä½ç§»ï¼Œäº§ç”Ÿæ”¶ç¼©æ„Ÿ */
            pointer-events: none; /* æ”¶èµ·åä¸å¯ç‚¹å‡» */
        }
        
        .sheet-group.collapsed .sheet-arrow { transform: rotate(-90deg); }


        .pw-text { flex: 1; margin-left: 6px; }
        
        /* Demonstrate currency / Pin æŒ‰é’® */
        .side-toggle-btn {
            margin-left: 8px; padding: 2px 8px; border: 1px solid #ddd;
            border-radius: 10px; background: #fff; cursor: pointer;
            font-size: 10px; color: #666; white-space: nowrap;
        }
        .side-toggle-btn:hover { background: #f6f6f6; }
        .side-toggle-btn.active { background: #e3f2fd; color: #1976D2; border-color: #90CAF9; }
        
        .side-action-btn {
            margin: 6px 0 10px 0; width: 100%; padding: 6px 8px;
            border: 1px solid #ddd; border-radius: 6px; background: #fff;
            cursor: pointer; font-size: 12px; color: #444;
        }
        .side-action-btn:hover { background: #f6f6f6; }

        /* ç»˜å›¾åŒºåŸŸ */
        #graph-area {
            flex: 1; position: relative; background: #f8f9fa; min-width: 0;
        }
        #cy { width: 100%; height: 100%; }

/* ========================================= */
/* ç»†èƒå™¨å›¾ç‰‡è¦†ç›–å±‚ (Organelle Overlay)       */
/* ========================================= */
#organelle-layer{
    position:absolute;
    inset:0;
    z-index: 60;               /* é«˜äº Cytoscape canvasï¼Œé¿å…è¢«èŠ‚ç‚¹é®ä½ */
    transform-origin: 0 0;
    pointer-events: none;      /* é»˜è®¤ä¸æŠ¢é¼ æ ‡ï¼Œé¿å…å½±å“å›¾äº¤äº’ */
}
#organelle-layer .organelle-item{
    position:absolute;
    box-sizing: border-box;
    transform-origin: center center;
    user-select: none;
    pointer-events: none;      /* é»˜è®¤ä¸å¯æ‹–ï¼Œéœ€å¼€å¯ç¼–è¾‘æ¨¡å¼æ‰å¯ç”¨ */
}
#organelle-layer .organelle-item img{
    width:100%;
    height:100%;
    display:block;
    opacity: var(--org-opacity, 0.27);
    filter: saturate(0.95) contrast(0.98);
}
/* ç¼–è¾‘æ¨¡å¼ä¸‹å¼€å¯äº¤äº’ */
body.organelle-edit-on #organelle-layer{ pointer-events: auto; }
body.organelle-edit-on #organelle-layer .organelle-item{ pointer-events: auto; cursor: grab; }
body.organelle-edit-on #organelle-layer .organelle-item:active{ cursor: grabbing; }

/* è½»é‡æ§åˆ¶ç‚¹ */
.org-handle{
    position:absolute;
    width:12px; height:12px;
    border-radius: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,0,0,0.35);
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    display:none;
}
body.organelle-edit-on .org-handle{ display:block; }
.org-handle.resize-se{ right:-6px; bottom:-6px; cursor: nwse-resize; }
.org-handle.rotate{
    left:50%; top:-18px;
    transform: translateX(-50%);
    width:16px; height:16px;
    border-radius: 20px;
    cursor: grab;
}
.org-rotate-line{
    position:absolute;
    left:50%; top:-10px;
    width:2px; height:12px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.35);
    display:none;
}
body.organelle-edit-on .org-rotate-line{ display:block; }

/* å°æç¤º */
#organelle-hint{
    position:absolute;
    left:14px; bottom:14px;
    z-index: 70;
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 12px;
    color:#2c3e50;
    background: rgba(255,255,255,0.88);
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    pointer-events:none;
}



        /* ========================================= */
        /* 4. å³ä¾§æœç´¢ç»“æœæ  (æºè‡ª File 2 æ ·å¼)     */
        /* ========================================= */
        #search-sidebar {
            width: 420px; max-width: 45vw; min-width: 300px;
            background: #fff; border-left: 1px solid #ddd;
            padding: 20px; overflow-y: auto;flex-shrink: 0;position: relative;
            flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.05);
            /* é»˜è®¤éšè—ç”±JSæ§åˆ¶ display */display: none;
        }

        .result-item {
            padding: 10px; margin-bottom: 8px; background: #fff;
            border: 1px solid #eee; border-radius: 6px; cursor: pointer;
            transition: all 0.2s;
        }
        .result-item:hover {
            background-color: #f0f7ff; border-color: #2196F3;
            transform: translateX(-3px); box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        }

        .result-name { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .result-pathway {
            font-size: 11px; color: #666; background: #f1f2f6;
            padding: 2px 6px; border-radius: 4px; display: inline-block;
        }
        .result-type-tag {
            font-size: 10px; padding: 2px 4px; border-radius: 3px;
            margin-left: 5px; color: #fff;
        }

        /* ========================================= */
        /* 5. ä¿¡æ¯é¢æ¿ä¸æ‚¬æµ®æ¡† (ä¿ç•™ File 1 ç‹¬æœ‰åŠŸèƒ½) */
        /* ========================================= */
        
        /* è¯¦ç»†ä¿¡æ¯é¢æ¿ (å³ä¸‹è§’) */
        #hover-info-panel {
            position: fixed; bottom: 20px; right: 20px;
            width: 320px; min-height: 100px; max-height: 50vh;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #ddd; border-left: 5px solid #2196F3;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 6px; padding: 15px; z-index: 1000;
            display: none; font-family: "Segoe UI", sans-serif;
            overflow-y: auto; pointer-events: auto;
        }
        .panel-close-btn {
            position: absolute; top: 5px; right: 8px;
            cursor: pointer; color: #999; font-size: 18px; font-weight: bold;
        }
        .panel-close-btn:hover { color: #333; }
        
        .info-section {
            margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px;
        }
        .info-section:last-child { border-bottom: none; }
        
        .info-title {
            font-size: 11px; color: #888; text-transform: uppercase;
            font-weight: bold; margin-bottom: 4px; letter-spacing: 0.5px;
        }
        .info-content {
            font-size: 13px; color: #333; line-height: 1.5; word-wrap: break-word;
        }
        .formula-text { color: #0984e3; font-weight: bold; font-family: Consolas, monospace; }

                /* Regulation æ‚¬æµ®å›¾ç‰‡/æ–‡å­—æ¡† - ä¿®æ”¹ä¸ºç”±ä¸‹è§’å›ºå®š */
        #regulation-overlay-label {
            position: fixed;            /* æ”¹ä¸º fixedï¼Œç›¸å¯¹äºå±å¹•å®šä½ */
            bottom: 20px;               /* è·ç¦»åº•éƒ¨ */
            right: 20px;                /* è·ç¦»å³ä¾§ */
            width: 300px;               /* å®½åº¦ä¸ info-panel ä¿æŒä¸€è‡´ */
            max-height: 600px;           /* æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢è¶…å‡ºå±å¹• */
            overflow-y: auto;           /* å†…å®¹è¿‡å¤šæ—¶å…è®¸æ»šåŠ¨ */
            
            background: rgba(30, 30, 30, 0.95); 
            color: #fff;
            padding: 15px;              /* å¢åŠ ä¸€ç‚¹å†…è¾¹è· */
            border-radius: 6px;
            font-size: 13px;
            
            pointer-events: auto;       /* å…è®¸é¼ æ ‡äº¤äº’ï¼ˆå¦‚æ»šåŠ¨ã€å¤åˆ¶æ–‡å­—ï¼‰ */
            z-index: 2000;
            display: none;
            text-align: left;           /* å·¦å¯¹é½æ›´é€‚åˆé˜…è¯»é•¿æ®µè½ */
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-left: 5px solid #f59e0b; /* åŠ ä¸ªå·¦è¾¹æ¡†åŒºåˆ†ï¼Œç±»ä¼¼ info-panel */
            
            /* ç§»é™¤ä¹‹å‰çš„ transitionï¼Œå› ä¸ºä¸å†è·Ÿéšç§»åŠ¨ */
            /* ç¾åŒ–æ»šåŠ¨æ¡ (Webkit) */
            scrollbar-width: thin;
            scrollbar-color: #666 #333;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ (Chrome/Safari) */
        #regulation-overlay-label::-webkit-scrollbar { width: 6px; }
        #regulation-overlay-label::-webkit-scrollbar-track { background: #333; }
        #regulation-overlay-label::-webkit-scrollbar-thumb { background: #666; border-radius: 3px; }
        /* è°ƒæ•´å†…éƒ¨å›¾ç‰‡æ ·å¼ */
        .reg-img-display {
            width: 100%; height: auto; max-height: 200px;
            object-fit: contain; border-radius: 4px; margin-bottom: 8px;
            display: block; background: #fff;
        }
        .reg-text-content { line-height: 1.5; color: #f1f2f6; }
        
        /* æ·»åŠ ä¸€ä¸ªç®€æ˜“çš„å…³é—­æŒ‰é’®æ ·å¼ */
        .reg-close-btn {
            position: absolute; top: 5px; right: 10px;
            cursor: pointer; color: #bbb; font-size: 18px; font-weight: bold;
        }
        .reg-close-btn:hover { color: #fff; }


        /* ========================================= */
        /* 6. å…¶ä»–è¾…åŠ©æ ·å¼                          */
        /* ========================================= */
        
        /* åŠ è½½é®ç½© */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; color: #666; z-index: 20;
        }
                /* ========================================= */
        /* 8. ä¾§è¾¹æ æŠ˜å æŒ‰é’®                         */
        /* ========================================= */
        
        /* æ”¶èµ·æŒ‰é’®ï¼ˆä½äº Sidebar æ ‡é¢˜æ å†…ï¼‰ */
        .sidebar-collapse-btn {
            float: right; 
            cursor: pointer; 
            color: #999; 
            font-size: 16px;
            transition: color 0.2s;
        }
        .sidebar-collapse-btn:hover { color: #333; }

        /* å±•å¼€æŒ‰é’®ï¼ˆæ‚¬æµ®åœ¨ç”»å¸ƒå·¦ä¸Šè§’ï¼Œåˆå§‹éšè—ï¼‰ */
        #sidebar-expand-btn {
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰ sidebar æ”¶èµ·æ—¶æ‰æ˜¾ç¤º */
            position: absolute; 
            left: 10px; top: 10px;
            z-index: 50; /* ä¿è¯åœ¨ç”»å¸ƒä¹‹ä¸Š */
            padding: 6px 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 12px;
            color: #555;
            align-items: center; gap: 4px;
        }
        #sidebar-expand-btn:hover {
            background: #f9f9f9; color: #2196F3;
        }

                /* ========================================= */
        /* 7. å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† (Lightbox)              */
        /* ========================================= */
        #img-modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; 
            z-index: 10000; /* æœ€é«˜å±‚çº§ */
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            cursor: zoom-out; /* ç‚¹å‡»ç¼©å° */
            justify-content: center; align-items: center;
            animation: fadeIn 0.2s;
        }
        
        #img-modal-content {
            display: block;
            max-width: 90%; 
            max-height: 90%;
            border: 2px solid #fff;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: zoomIn 0.2s;
            cursor: default;
        }

        /* ç¼©ç•¥å›¾æŒ‡é’ˆæ ·å¼ */
        .reg-img-display { cursor: zoom-in; transition: transform 0.1s; }
        .reg-img-display:hover { transform: scale(1.02); }

        /* å¼€å…³æ ·å¼ (Switch Toggle) */
        .switch {
            position: relative; display: inline-block; width: 34px; height: 18px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(16px); }


        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes zoomIn { from {transform: scale(0.8);} to {transform: scale(1);} }

    </style>
</head>
<body>
    <!-- 1. åŠ è½½é®ç½©å±‚ -->
    <div id="loading-mask" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h2 style="color: #333;">Loading...</h2>
        <div style="width: 300px; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 10px;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: #0984e3; transition: width 0.1s;"></div>
        </div>
        <p id="progress-text" style="margin-top: 10px; color: #666; font-size: 14px;">å‡†å¤‡æ•°æ®ä¸­...</p>
    </div>

    <!-- 2. é¡¶éƒ¨å¯¼èˆªæ  (èåˆç‰ˆ) -->
<header class="topbar">
    <div class="brand">
        <span class="brand-emoji">ğŸŒ±</span>
        <span class="brand-title">Metabolic Pathway</span>
    </div>

    <!-- ä¸­é—´ï¼šæœç´¢ä¸è·¯å¾„ -->
    <div class="topbar-center">
        <!-- æœç´¢æ¡† -->
        <div class="chip search-chip">
            <span>ğŸ”</span>
            <input type="text" id="search-input" placeholder="Enter Molecule (e.g. ATP)..." />
            <span id="search-status" style="font-size:11px; color:#888;"></span>
        </div>

        <!-- è·¯å¾„æŸ¥æ‰¾ -->
        <div class="chip path-chip">
            <span class="chip-label">Path:</span>
            <input type="text" id="path-start-input" placeholder="Begin" style="width:100px;">
            <span>â†’</span>
            <input type="text" id="path-end-input" placeholder="End" style="width:100px;">
            <button id="path-find-btn" type="button" class="btn" style="padding:4px 8px; height:auto;">ğŸ§¬ Search</button>
            <span id="path-status" style="font-size:11px; color:#555;"></span>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
    <div class="topbar-actions">
        <!-- === ä¿®æ”¹ï¼šRegulation å¼€å…³ä¸ä¸‹æ–¹æç¤ºæ–‡å­— === -->
        <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: center;">

            <!-- ä¸Šæ–¹ï¼šæ–‡å­— + å¼€å…³ (ä¿ç•™åŸæœ‰çš„æ¨ªå‘å¸ƒå±€) -->
            <div class="chip" style="background:transparent; border:none; padding:0; gap:8px; min-height: 20px;">
                <span class="chip-label" style="font-weight:bold; color:#555;">Regulation</span>
                <label class="switch">
                    <input type="checkbox" id="regulation-toggle" onchange="toggleRegulationAndRender()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- ä¸‹æ–¹ï¼šæç¤ºæ–‡å­— (é»˜è®¤éšè—ï¼Œå¼€å¯åæ˜¾ç¤º) -->
            <span id="scroll-hint-text" style="font-size: 10px; color: #999; margin-top: 2px; display: none; cursor: default;">
                Scroll to Move â‡„
            </span>

        </div>
                <div style="width:1px; height:20px; background:#e5e7eb; margin:0 5px;"></div> <!-- åˆ†éš”çº¿ -->
        <!-- File 1 åŸæœ‰çš„å›ä¸­æŒ‰é’® -->
        <button onclick="centerView()" class="btn" title="Don't get lost!">ğŸ  Back to Center</button>

        <!-- [æ–°å¢] ç¼–è¾‘æ¨¡å¼å¼€å…³ -->
        <div class="chip" style="background:transparent; border:none; padding:0; gap:8px;">
            <span class="chip-label" style="font-weight:bold; color:#d35400;">ğŸ–Šï¸ Edit Layout</span>
            <label class="switch">
                <input type="checkbox" id="edit-mode-toggle" onchange="toggleEditMode()">
                <span class="slider"></span>
            </label>
        </div>

        
        

<!-- [æ–°å¢] ç»†èƒå™¨å›¾ç‰‡ç¼–è¾‘å¼€å…³ -->
<div class="chip" style="background:transparent; border:none; padding:0; gap:8px;">
    <span class="chip-label" style="font-weight:bold; color:#2c3e50;">ğŸ§« Organelles</span>
    <label class="switch">
        <input type="checkbox" id="organelle-edit-toggle" onchange="toggleOrganelleEditMode()">
        <span class="slider"></span>
    </label>
</div>
<input id="organelle-opacity" type="range" min="0.05" max="0.75" step="0.01" value="0.27"
       title="Organelle opacity" style="width:110px; display:none;">
<button id="organelle-reset-btn" class="btn" style="display:none;" title="Reset organelles" onclick="resetOrganellesLayout()">â™»ï¸ Reset</button>

        <span id="status" class="status"></span>
    </div>
    <div id="error-msg"></div>
</header>
    <!-- === æ–°å¢ï¼šRegulation å±•å¼€é¢æ¿ (æ”¾åœ¨ Header ä¸‹æ–¹ï¼Œç‹¬ç«‹å®¹å™¨) === -->
<div id="regulation-panel">
    <div id="regulation-content-wrapper">
        <!-- å†…å®¹ç”± JS ç”Ÿæˆ -->
    </div>
</div>
    
    
    <!-- ç”¨äºæ˜¾ç¤ºèŠ‚ç‚¹ä¸‹æ–¹ Regulation æ–‡æœ¬çš„æµ®åŠ¨å±‚ -->
    <div id="regulation-overlay-label"></div>

    <!-- 3. ä¸»å†…å®¹åŒºåŸŸ (æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ª clean çš„ container) -->
    <div id="main-container">
        
        <!-- å·¦ä¾§ï¼šç­›é€‰æ§åˆ¶ -->
        <div id="sidebar">
            <div class="sidebar-title">
                Pathway Select
                <!-- [æ–°å¢] æ”¶èµ·æŒ‰é’® -->
                <span class="sidebar-collapse-btn" title="Collapse Sidebar" onclick="toggleSidebar()">&#9664;</span>
            </div>
            <div id="filter-container" class="pathway-list">
                <div style="color:#999; font-style:italic;">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šCytoscape ç”»å¸ƒ -->
        <div id="graph-area">
            <!-- [æ–°å¢] å±•å¼€æŒ‰é’® (æ‚¬æµ®) -->
            <button id="sidebar-expand-btn" onclick="toggleSidebar()">
                <span>&#9654;</span> Show Filter
            </button>

            <div id="loading" style="display:none;">å¤„ç†ä¸­...</div>
            <div id="cy"></div>
            <div id="organelle-layer" aria-label="organelle overlay"></div>
            <div id="organelle-hint" style="display:none;">Drag to move â€¢ Drag corner to resize â€¢ Drag ring to rotate â€¢ (Organelle mode ON)</div>
        </div>

        <!-- å³ä¾§ï¼šæœç´¢ç»“æœæ  (é»˜è®¤éšè—) -->
        <div id="search-sidebar" style="display: none;">
            <div class="sidebar-title" style="display:flex; justify-content:space-between; align-items:center;">
                <span>æœç´¢ç»“æœ (<span id="result-count">0</span>)</span>
                <!-- å…³é—­æŒ‰é’® -->
                <button onclick="closeSearchPanel()" style="border:none; background:none; cursor:pointer; font-size:18px; color:#999;">&times;</button>
            </div>
            <div id="search-results-list" class="pathway-list">
                <!-- JS ä¼šåœ¨è¿™é‡Œæ’å…¥ .result-item -->
            </div>
        </div>
    </div> <!-- å…³é—­ main-container -->

    <!-- 4. æ‚¬åœä¿¡æ¯å±•ç¤ºé¢æ¿ -->
    <div id="hover-info-panel">
        <!-- å†…å®¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        <div style="color:#ccc; text-align:center; margin-top:30px;">Waiting for connection...</div>
    </div>

    <!-- è„šæœ¬åº“ (Staticfile CDN) -->
    <script src="https://cdn.staticfile.org/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://cdn.staticfile.org/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <!-- === æ–°å¢ï¼šRDKit JS åº“ === -->
    <script src="https://unpkg.com/@rdkit/rdkit/Code/MinimalLib/dist/RDKit_minimal.js"></script>

<script>
        // === æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼çŠ¶æ€ ===
    // é»˜è®¤å…³é—­ï¼šä¸å¯æ‹–åŠ¨ï¼Œä¸å¯ä¿å­˜
    window.isEditMode = false;

    // ... (åœ¨ script æ ‡ç­¾é¡¶éƒ¨é™„è¿‘)

    // === æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼çŠ¶æ€ ===
    window.isEditMode = false;

    // === æ–°å¢ï¼šRDKit åˆå§‹åŒ–é€»è¾‘ ===
    window.rdkitModule = null; // å…¨å±€å˜é‡å­˜å‚¨ RDKit å®ä¾‹

    // åœ¨é¡µé¢åŠ è½½åˆæœŸå°è¯•åˆå§‹åŒ– RDKit
    // æ³¨æ„ï¼šinitRDKitModule æ˜¯å¼•å…¥ RDKit.js åè‡ªåŠ¨æä¾›çš„å…¨å±€å‡½æ•°
    if (window.initRDKitModule) {
        window.initRDKitModule()
            .then(function(instance) {
                window.rdkitModule = instance;
                console.log("RDKit JS åŠ è½½æˆåŠŸ!");
            })
            .catch(function(e) {
                console.error("RDKit åŠ è½½å¤±è´¥:", e);
            });
    }

// ... (åç»­ä»£ç )

    function toggleEditMode() {
        const checkbox = document.getElementById('edit-mode-toggle');
        window.isEditMode = checkbox.checked;
        
        const status = document.getElementById('status');
        
        if (window.cyGraph) {
            // cy.autoungrabify(true) è¡¨ç¤ºç¦æ­¢æŠ“å–(é”å®š)
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼(true)ï¼Œåˆ™ ungrabify åº”ä¸º false(å…è®¸æŠ“å–)
            window.cyGraph.autoungrabify(!window.isEditMode);
        }

        if (window.isEditMode) {
            if(status) {
                status.innerText = "âš ï¸ ç¼–è¾‘æ¨¡å¼ï¼šèŠ‚ç‚¹å¯ç§»åŠ¨ï¼Œæ›´æ”¹å°†è‡ªåŠ¨ä¿å­˜";
                status.style.color = "#d35400";
            }
        } else {
            if(status) {
                status.innerText = "ğŸ”’ é”å®šæ¨¡å¼ï¼šå¸ƒå±€å·²é”å®š";
                status.style.color = "#6b7280";
            }
        }
    }

    // ================= é…ç½®åŒºåŸŸ =================
    // åœ¨æ­¤å¤„è¾“å…¥ä½ æƒ³åˆå¹¶æ˜¾ç¤ºçš„ Sheet åç§°
    const TARGET_SHEETS = ["Carbonhydrates", "Lipids", "Proteins", "Nucleotides"];

    // ä¸»é¢˜è‰²ï¼šä¸åŒ sheet çš„ä¸»ååº”ç‰©/ä¸»äº§ç‰©
    const SHEET_COLORS = {
        Carbonhydrates: "#E699A7",
        Lipids: "#FEDD9E",
        Proteins: "#A6D9C0",
        Nucleotides: "#71A7D2"
    };
    // é¢œè‰²ä¼˜å…ˆçº§ï¼šè‹¥åŒä¸€åˆ†å­å‡ºç°åœ¨å¤šä¸ª sheetsï¼ŒæŒ‰æ­¤é¡ºåºå–è‰²
    const SHEET_PRIORITY = ["Carbonhydrates", "Lipids", "Proteins", "Nucleotides"];

     // === æ–°å¢ï¼šå‚è€ƒæ•°æ®å­˜å‚¨ ===
    window.refData = {
        molecules: new Map(), // Key: substance, Value: { smiles, link }
        enzymes: new Map()    // Key: name, Value: { ec, link }
    };

    // ====== Side-molecule visibility state ======
    // é€‰ä¸­çš„â€œé…¶/ååº”â€é›†åˆï¼šç‚¹é€‰å¤šä¸ªååº”æ—¶ï¼Œå°åˆ†å­ä¸ä¼šæ¶ˆå¤±
    window.selectedReactionIds = new Set();
    // è¢«â€œDemonstrate currencyâ€æŒ‰é’®å›ºå®šæ‰“å¼€çš„å°åˆ†å­ï¼šæŒ‰ pathway ç»´åº¦
    window.pinnedSidePathways = new Set();
    // å½“å‰ pathway å‹¾é€‰çŠ¶æ€ï¼ˆç”¨äº side-molecule çš„æ˜¾ç¤ºè£å‰ªï¼‰
    window.__selectedPathwaysSet = new Set();


    // ============================================================
    // [æ’å…¥] 1. å¤æ‚å›¾ç‰‡æ–‡ä»¶åæ¸…å•
    // æµè§ˆå™¨æ— æ³•è‡ªåŠ¨åˆ—å‡ºæ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ "A;B.png" è¿™ç§åå­—ï¼Œå¿…é¡»åœ¨æ­¤åˆ—å‡º
    // ============================================================
    const complexImageFiles = [
        // è¯·åœ¨æ­¤å¤„æ‰‹åŠ¨å¡«å…¥ images/ æ–‡ä»¶å¤¹ä¸‹é‚£äº›åŒ…å«åˆ†å·çš„æ–‡ä»¶å
        "G6PD;6PGD.png",
        "ExampleA;ExampleB.jpg", 
        // ...
    ];

    // [æ’å…¥] 2. æŸ¥æ‰¾åŒ¹é…æ–‡ä»¶åçš„è¾…åŠ©å‡½æ•°
    function findMatchingImageFile(targetName) {
        if (!targetName) return null;
        const cleanTarget = String(targetName).trim().toLowerCase();

        // éå†æ¸…å•
        for (let fileName of complexImageFiles) {
            // å»æ‰åç¼€
            const nameWithoutExt = fileName.replace(/\.[^/.]+$/, ""); 
            // åˆ†å‰²åå­—
            const parts = nameWithoutExt.split(';');
            // åªè¦æœ‰ä¸€ä¸ªéƒ¨åˆ†åŒ¹é…ï¼Œå°±è¿”å›è¿™ä¸ªæ–‡ä»¶å
            const isMatch = parts.some(part => part.trim().toLowerCase() === cleanTarget);
            if (isMatch) return fileName;
        }
        // æ²¡æ‰¾åˆ°åˆ™è¿”å›åŸå§‹åç§°ï¼ˆåç»­åœ¨imgæ ‡ç­¾é‡Œæ‹¼åç¼€ï¼‰
        return targetName;
    }

    // ... åŸæœ‰ä»£ç  ...


    function pickSheetColor(sheetSet) {
        if (!sheetSet) return "#95a5a6";
        for (const s of SHEET_PRIORITY) {
            if (sheetSet.has(s)) return SHEET_COLORS[s];
        }
        return "#95a5a6";
    }
    // === æ–°å¢ï¼šå¸ƒå±€å†»ç»“åŠŸèƒ½ ===
    window.__uiFrozen = (localStorage.getItem('metabolic_ui_frozen') === '1');

    function applyFrozenState() {
        const btn = document.getElementById('freeze-toggle');
        if (btn) {
            // æ›´æ–°æŒ‰é’®å¤–è§‚
            btn.textContent = window.__uiFrozen ? 'ğŸ”“ Unfreeze' : 'ğŸ”’ Freeze';
            btn.classList.toggle('is-on', window.__uiFrozen);
        }
        if (window.cyGraph) {
            // Cytoscape API: ç¦æ­¢/å…è®¸æŠ“å–èŠ‚ç‚¹
            window.cyGraph.autoungrabify(!!window.__uiFrozen);
        }
    }

    function toggleFrozen() {
        window.__uiFrozen = !window.__uiFrozen;
        localStorage.setItem('metabolic_ui_frozen', window.__uiFrozen ? '1' : '0');
        applyFrozenState();
    }

// ===========================================

    // å®šä¹‰ä¸€ä¸ª Keyï¼Œç”¨äºåœ¨æµè§ˆå™¨ç¼“å­˜ä¸­å­˜å‚¨æ•°æ®
    const STORAGE_KEY = 'metabolic_pathway_positions_v1';

    // ============================================================
    // Layout file persistence via backend (/api/layout)
    // - Save positions to layout_positions.json on the server
    // - Load them on startup and hydrate localStorage autosave cache
    // ============================================================
    async function saveLayoutToServer(positions) {
        try {
            await fetch('/api/layout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ positions })
            });
        } catch (e) {
            // ignore: keep UI responsive even if server write fails
            console.warn('[layout] save to server failed:', e.message || e);
        }
    }
        // ============================================
    // è§†å›¾å›ä¸­å‡½æ•°
    // ============================================
    function centerView() {
        const cy = window.cyGraph || window.cy;
        if (!cy) return;

        // ä½¿ç”¨åŠ¨ç”»å¹³æ»‘è¿‡æ¸¡åˆ°å…¨å±é€‚åº”çŠ¶æ€
        cy.animate({
            fit: {
                eles: cy.elements(), // åŒ…å«æ‰€æœ‰èŠ‚ç‚¹å’Œè¿çº¿
                padding: 50          // å››å‘¨ç•™ç™½ 50px
            },
            duration: 500,           // åŠ¨ç”»æ—¶é•¿ 500ms
            easing: 'ease-out-cubic' // ç¼“åŠ¨æ•ˆæœ
        });
    }

    async function preloadLayoutFromServer() {
        try {
            const res = await fetch('/api/layout', { method: 'GET' });
            if (!res.ok) return false;
            const positions = await res.json();
            if (!positions || typeof positions !== 'object') return false;

            // Put into autosave cache so existing restoreLayoutAuto() works unchanged
            const autoKey = STORAGE_KEY + '_autosave';
            localStorage.setItem(autoKey, JSON.stringify(positions));
            return true;
        } catch (e) {
            console.warn('[layout] preload from server failed:', e.message || e);
            return false;
        }
    }

    async function clearLayoutOnServer() {
        try {
            await fetch('/api/layout', { method: 'DELETE' });
        } catch (e) {
            console.warn('[layout] clear on server failed:', e.message || e);
        }
    }


    // ============================================
    // 1. ä¿å­˜å¸ƒå±€å‡½æ•°
    // ============================================
    function saveLayout() {
        if (!window.isEditMode) {
            alert("è¯·å…ˆå¼€å¯é¡¶éƒ¨å³ä¾§çš„ 'Edit Layout' å¼€å…³ï¼Œæ‰èƒ½ä¿å­˜å¸ƒå±€ä¿®æ”¹ã€‚");
            return;
        }
        if (!window.cyGraph) return;

        const positions = {};
        window.cyGraph.nodes().forEach(node => {
            // ç¡®ä¿ JSON æ–‡ä»¶é‡Œæ°¸è¿œåªæœ‰ä¸»å¹²èŠ‚ç‚¹å’Œååº”èŠ‚ç‚¹
            if (node.hasClass('side-molecule')) return;
            positions[node.id()] = node.position();
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(positions));
        saveLayoutToServer(positions);
        alert(`å·²ä¿å­˜ ${Object.keys(positions).length} ä¸ªä¸»èŠ‚ç‚¹çš„ä½ç½®ï¼\n(å‰¯èŠ‚ç‚¹ä½ç½®å°†åŠ¨æ€è®¡ç®—)`);
    }



    // ============================================
    // 2. æ¸…é™¤å¸ƒå±€(é‡ç½®)å‡½æ•°
    // ============================================
    function clearLayoutCache() {
        localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_KEY + '_autosave');
        clearLayoutOnServer();
alert('å·²æ¸…é™¤å¸ƒå±€ç¼“å­˜ã€‚åˆ·æ–°é¡µé¢å°†é‡æ–°è®¡ç®—é»˜è®¤å¸ƒå±€ã€‚');
        location.reload(); // è‡ªåŠ¨åˆ·æ–°é¡µé¢
    }




    let cy = null;

        // ============================================================
    // æœç´¢åŠŸèƒ½æ¨¡å—
    // ============================================================
    function initSearchListener() {
        const searchInput = document.getElementById('search-input');
        if(searchInput) {
            // ç›‘å¬è¾“å…¥äº‹ä»¶ (input ä»£è¡¨æ¯æ¬¡æ‰“å­—éƒ½è§¦å‘)
            searchInput.addEventListener('input', function(e) {
                const term = e.target.value.trim();
                performSearch(term);
            });
        }

        // è·¯å¾„æœç´¢ç›¸å…³
        const startInput = document.getElementById('path-start-input');
        const endInput = document.getElementById('path-end-input');
        const pathBtn = document.getElementById('path-find-btn');

        if (pathBtn && startInput && endInput) {
            const doPathSearch = () => {
                const startTerm = startInput.value.trim();
                const endTerm = endInput.value.trim();
                if (!startTerm || !endTerm) {
                    const ps = document.getElementById('path-status');
                    if (ps) ps.innerText = 'è¯·åŒæ—¶è¾“å…¥èµ·å§‹å’Œç»ˆæ­¢åˆ†å­';
                    return;
                }
                findPathBetweenMetabolites(startTerm, endTerm);
            };

            pathBtn.addEventListener('click', doPathSearch);
            endInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    doPathSearch();
                }
            });
        }
    }


        // ===================================
    // æœç´¢é€»è¾‘æ›´æ–° (æ”¯æŒå³ä¾§æ æ˜¾ç¤º + ç‚¹å‡»å®šä½)
    // ===================================
    function calcSimilarity(term, label) {
        if (!term || !label) return 0;
        const a = String(term).toLowerCase().trim();
        const b = String(label).toLowerCase().trim();
        if (!a || !b) return 0;
        if (a === b) return 1;

        // å­ä¸²åŠ åˆ†
        if (b.includes(a) || a.includes(b)) {
            // é•¿åº¦è¶Šæ¥è¿‘åˆ†æ•°è¶Šé«˜
            const lenDiff = Math.abs(a.length - b.length);
            const maxLen = Math.max(a.length, b.length) || 1;
            const closeness = 1 - lenDiff / maxLen;
            return 0.7 + 0.3 * closeness; // 0.7 ~ 1.0
        }

        // ç®€å•ç¼–è¾‘è·ç¦»ï¼Œç”¨äºæ¨¡ç³ŠåŒ¹é…
        const lenA = a.length;
        const lenB = b.length;
        const dp = Array(lenA + 1).fill(null).map(() => Array(lenB + 1).fill(0));
        for (let i = 0; i <= lenA; i++) dp[i][0] = i;
        for (let j = 0; j <= lenB; j++) dp[0][j] = j;
        for (let i = 1; i <= lenA; i++) {
            for (let j = 1; j <= lenB; j++) {
                const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                dp[i][j] = Math.min(
                    dp[i - 1][j] + 1,
                    dp[i][j - 1] + 1,
                    dp[i - 1][j - 1] + cost
                );
            }
        }
        const dist = dp[lenA][lenB];
        const maxLen = Math.max(lenA, lenB) || 1;
        const sim = 1 - dist / maxLen; // 0 ~ 1
        return sim * 0.6; // é™æƒä¸€ç‚¹ï¼Œé¿å…å‹è¿‡å­ä¸²åŒ¹é…
    }

    // === æ–°å¢ï¼šæœç´¢å¢å¼ºè¾…åŠ©å‡½æ•° ===
function getLinkedReactionsFromMolecule(node) {
    const cy = window.cyGraph;
    if (!cy || !node) return [];

    // 1) å¦‚æœæ˜¯å‰¯äº§ç‰©ï¼Œç›´æ¥æ‰¾ parentRxn
    if (node.hasClass && node.hasClass('side-molecule')) {
        const pr = node.data('parentRxn');
        if (pr) {
            const rxn = cy.$id(pr);
            if (rxn && rxn.length) return [rxn];
        }
    }

    // 2) å¦‚æœæ˜¯ä¸»å¹²åˆ†å­ï¼Œæ‰¾ç›¸è¿çš„ reaction èŠ‚ç‚¹
    const rxnSet = new Set();
    node.connectedEdges().forEach(e => {
        const s = e.source();
        const t = e.target();
        const other = (s.id() === node.id()) ? t : s;
        if (other && other.data && other.data('type') === 'reaction') {
            rxnSet.add(other);
        }
    });
    return Array.from(rxnSet);
}

function pickBestReactionForMolecule(node) {
    const cy = window.cyGraph;
    if (!cy) return null;
    const reactions = getLinkedReactionsFromMolecule(node);
    if (!reactions.length) return null;
    
    // ä¼˜å…ˆé€‰æ‹©é€šè¿‡ 'main' è¾¹è¿æ¥çš„ååº”
    const mainLinked = [];
    node.connectedEdges().forEach(e => {
        const other = (e.source().id() === node.id()) ? e.target() : e.source();
        if (other && other.data('type') === 'reaction' && e.data('edgeType') === 'main') {
            mainLinked.push(other);
        }
    });
    if (mainLinked.length) return mainLinked[0];
    return reactions[0]; 
}

    function focusOnReaction(rxnNode, opts = {}) {
        const cy = window.cyGraph;
        if (!cy || !rxnNode || !rxnNode.length) return;
        
        // 1) è§¦å‘å‰¯å°åˆ†å­å±•å¼€ logic (File 1 çš„ç°æœ‰é€»è¾‘)
        const rxnId = rxnNode.id();
        if (!window.selectedReactionIds) window.selectedReactionIds = new Set();
        window.selectedReactionIds.add(rxnId); // å¼ºåˆ¶é€‰ä¸­
        refreshSideVisibility(); // File 1 åŸæœ‰å‡½æ•°

        // 2) æ ·å¼å¤„ç†
        cy.nodes('[type="reaction"]').removeClass('search-focus-reaction');
        rxnNode.addClass('search-focus-reaction');

        // 3) èšç„¦åŠ¨ç”»ï¼šåŒ…å«ååº”èŠ‚ç‚¹åŠå…¶å‘¨å›´åˆ†å­
        const focusEles = rxnNode.closedNeighborhood();
        cy.elements().removeClass('highlighted').addClass('dimmed');
        focusEles.removeClass('dimmed').addClass('highlighted');
        
        // 4) è¡¥é«˜äº®å‘½ä¸­çš„åˆ†å­
        if (opts.alsoSelectNode && opts.alsoSelectNode.length) {
            opts.alsoSelectNode.removeClass('dimmed').addClass('highlighted');
        }

        // 5) ç§»åŠ¨è§†è§’
        cy.animate({
            fit: { eles: focusEles, padding: 180 },
            duration: 500,
            easing: 'ease-out-cubic'
        });
    }
    function computeNodesCentroid(nodes) {
const arr = nodes.toArray();
if (!arr.length) return null;
let sx = 0, sy = 0;
for (const n of arr) {
const p = n.position();
sx += p.x; sy += p.y;
}
return { x: sx / arr.length, y: sy / arr.length };
}

// å°†ååº”èŠ‚ç‚¹æ”¾åˆ°å…¶ä¸»ååº”ç‰©ä¸ä¸»äº§ç‰©ä¸­ç‚¹
function applyReactionMidpoints(cy) {
const reactions = cy.nodes('[type="reaction"]');
reactions.forEach(rxn => {
    const rxnId = rxn.id();// å¦‚æœè¯¥ååº”èŠ‚ç‚¹å·²ç»æœ‰ä¿å­˜çš„ä½ç½®ï¼Œåˆ™è·³è¿‡
if (savedPositions && savedPositions[rxnId]) return;
// åªçœ‹ main è¾¹
const srcs = rxn.incomers('edge[edgeType="main"]').sources();
const tgts = rxn.outgoers('edge[edgeType="main"]').targets();
if (!srcs.length || !tgts.length) return; // ä¸æ»¡è¶³â€œä¸€è¿›ä¸€å‡ºâ€çš„æ¡ä»¶åˆ™è·³è¿‡
const srcC = computeNodesCentroid(srcs);
const tgtC = computeNodesCentroid(tgts);
if (!srcC || !tgtC) return;

rxn.position({
  x: (srcC.x + tgtC.x) / 2,
  y: (srcC.y + tgtC.y) / 2
});
});
}



        // ===================================
    // æœç´¢é€»è¾‘æœ€ç»ˆä¿®å¤ç‰ˆï¼šå®Œå…¨åˆ†ç¦»è®¡ç®—ä¸æ¸²æŸ“
    // ===================================
    function performSearch(term) {
        const cy = window.cyGraph;
        if (!cy) return;

        const statusSpan = document.getElementById('search-status');
        const sidebar = document.getElementById('search-sidebar');

        // 1. è¾“å…¥ä¸ºç©ºæ—¶çš„å¤„ç†
        if (!term) {
            // æ¸…é™¤å›¾è¡¨æ ·å¼
            cy.batch(() => {
                cy.elements().removeClass('dimmed').removeClass('highlighted');
            });
            // æ¢å¤ç­›é€‰
            filterGraph();
            // é‡ç½® UI
            if (statusSpan) statusSpan.innerText = "";
            if (sidebar) {
                sidebar.style.display = 'none';
                cy.resize(); // å¿…é¡»é‡ç½®ç”»å¸ƒå¤§å°
            }
            return;
        }

        // 2. ç¬¬ä¸€é˜¶æ®µï¼šçº¯æ•°æ®è®¡ç®— (å®Œå…¨ç§»å‡º cy.batch)
        // è¿™æ ·å¯ä»¥ä¿è¯ orderedNodes å’Œ scores ä¸€å®šèƒ½è¢«æ­£ç¡®è®¡ç®—
        const matches = [];
        
        // éå†æ‰€æœ‰èŠ‚ç‚¹è®¡ç®—ç›¸ä¼¼åº¦
        cy.nodes().forEach(node => {
            const label = node.data('label');
            if (label) {
                const score = calcSimilarity(term, label);
                if (score > 0) {
                    matches.push({ node, score });
                }
            }
        });

        // 3. åˆ¤æ–­æ˜¯å¦æœ‰ç»“æœ
        if (matches.length === 0) {
            // æ²¡æœ‰ç»“æœï¼šæ˜¾ç¤ºæç¤ºå¹¶éšè—ä¾§è¾¹æ 
            if (statusSpan) statusSpan.innerText = "æœªæ‰¾åˆ°åŒ¹é…èŠ‚ç‚¹";
            if (sidebar) {
                sidebar.style.display = 'none';
                cy.resize();
            }
            // ç¡®ä¿å›¾è¡¨æ¢å¤æ­£å¸¸çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
            cy.batch(() => {
                 cy.elements().removeClass('dimmed').removeClass('highlighted');
            });
            return;
        }

        // 4. æœ‰ç»“æœï¼šè¿›è¡Œæ’åºå’Œæ•°æ®å‡†å¤‡
        matches.sort((a, b) => b.score - a.score);
        const orderedNodes = matches.map(m => m.node);
        const scores = matches.map(m => m.score);

        // 5. ç¬¬äºŒé˜¶æ®µï¼šæ›´æ–° Cytoscape æ ·å¼ (ä½¿ç”¨ batch ä¼˜åŒ–æ€§èƒ½)
        cy.batch(() => {
            // å…ˆè®©æ‰€æœ‰å…ƒç´ å˜æš—
            cy.elements().removeClass('highlighted').addClass('dimmed');

            // é«˜äº®åŒ¹é…çš„èŠ‚ç‚¹åŠå…¶é‚»å±…
            const matchCollection = cy.collection(orderedNodes);
            matchCollection.removeClass('dimmed').addClass('highlighted');
            matchCollection.neighborhood().removeClass('dimmed').addClass('highlighted');
        });

        // 6. ç¬¬ä¸‰é˜¶æ®µï¼šæ¸²æŸ“ UI (ç¡®ä¿ä¸€å®šä¼šæ‰§è¡Œ)
        if (statusSpan) statusSpan.innerText = `æ‰¾åˆ° ${orderedNodes.length} ä¸ªç»“æœ`;
        
        // å¼ºåˆ¶æ˜¾ç¤ºä¾§è¾¹æ å®¹å™¨
        if (sidebar) {
            sidebar.style.display = 'flex';
        }
        
        // è°ƒç”¨æ¸²æŸ“åˆ—è¡¨å‡½æ•°
        renderSearchResults(orderedNodes, scores);

        // è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼šä¾§è¾¹æ å‡ºç°åï¼Œç”»å¸ƒå®½åº¦å˜äº†ï¼Œå¿…é¡»é€šçŸ¥ cytoscape é‡æ–°é€‚åº”
        cy.resize();
    }


    // æ¸²æŸ“å³ä¾§åˆ—è¡¨çš„å‡½æ•°
    function renderSearchResults(nodes, scores) {
        const sidebar = document.getElementById('search-sidebar');
        const listContainer = document.getElementById('search-results-list');
        const countSpan = document.getElementById('result-count');

        // æ˜¾ç¤ºä¾§è¾¹æ 
        sidebar.style.display = 'flex';
        listContainer.innerHTML = ''; // æ¸…ç©ºæ—§ç»“æœ
        countSpan.innerText = nodes.length;

        nodes.forEach((node, idxScore) => {
            const data = node.data();
            const score = Array.isArray(scores) ? scores[idxScore] : undefined;

            // åˆ›å»ºå¡ç‰‡ DOM
            const item = document.createElement('div');
            item.className = 'result-item';

            // åˆ¤æ–­ç±»å‹æ ‡ç­¾é¢œè‰²
            let typeColor = '#95a5a6';
            let typeText = 'Unknown';
            if(node.hasClass('reaction')) { typeColor = '#55efc4'; typeText = 'é…¶/ååº”'; }
            else if(node.hasClass('main-molecule')) { typeColor = '#2ecc71'; typeText = 'Main Substrate'; }
            else { typeColor = '#74b9ff'; typeText = 'Other Substrate'; }

            const scoreHtml = (typeof score === 'number')
                ? `<div class="result-score" style="font-size:11px; color:#888;">ç›¸ä¼¼åº¦ ${(score*100).toFixed(0)}%</div>`
                : '';

            item.innerHTML = `
                <div class="result-name">
                    ${data.label || data.id}
                    <span class="result-type-tag" style="background:${typeColor}">${typeText}</span>
                </div>
                <div class="result-pathway">ğŸ“‚ ${data.pathway || 'Regulator'}</div>
                ${scoreHtml}
            `;

            // ç‚¹å‡»äº‹ä»¶ï¼šç§»åŠ¨è§†è§’
                        // ... (å‰é¢çš„ä»£ç ä¿æŒä¸å˜) ...

            // === ä¿®æ”¹å¼€å§‹ï¼šç‚¹å‡»äº‹ä»¶ä¼˜åŒ– ===
            item.addEventListener('click', () => {
                const cy = window.cyGraph;
                if (!cy) return;

                // é»˜è®¤ç›®æ ‡æ˜¯å½“å‰ç‚¹å‡»çš„èŠ‚ç‚¹
                let targetElement = node;
                let isSideMolecule = false;

                // 1. åˆ¤æ–­æ˜¯å¦ä¸ºå‰¯äº§ç‰© (æœ‰ parentRxn å±æ€§)
                if (data.parentRxn) {
                    const parentRxnNode = cy.getElementById(data.parentRxn);
                    // å¦‚æœèƒ½æ‰¾åˆ°å¯¹åº”çš„ååº”èŠ‚ç‚¹ï¼Œä¸”è¯¥ååº”èŠ‚ç‚¹å­˜åœ¨
                    if (parentRxnNode && parentRxnNode.length > 0) {
                        targetElement = parentRxnNode; // ã€å…³é”®ã€‘å°†é•œå¤´ç›®æ ‡æ”¹ä¸ºååº”èŠ‚ç‚¹
                        isSideMolecule = true;

                        // è§¦å‘å±•å¼€é€»è¾‘ï¼šå°†è¯¥ååº”åŠ å…¥â€œå·²é€‰é›†åˆâ€
                        if (!window.selectedReactionIds) window.selectedReactionIds = new Set();
                        window.selectedReactionIds.add(data.parentRxn);
                        
                        // åˆ·æ–°æ˜¾ç¤ºçŠ¶æ€ (è®©éšè—çš„å˜æ˜¾ç¤º)
                        if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
                        // é‡æ–°æ’åˆ—å‰¯åˆ†å­ä½ç½®
                        if (typeof alignSideNodes === 'function') setTimeout(alignSideNodes, 50);
                    }
                }

                // 2. è§†è§‰åé¦ˆï¼šåœ¨å›¾ä¸Šé«˜äº®ç›®æ ‡
                cy.batch(() => {
                    cy.elements().removeClass('highlighted').addClass('dimmed');
                    
                    // é«˜äº®ç›®æ ‡èŠ‚ç‚¹ (å¦‚æœæ˜¯å‰¯äº§ç‰©ï¼Œè¿™é‡Œé«˜äº®çš„æ˜¯ååº”èŠ‚ç‚¹)
                    targetElement.removeClass('dimmed').addClass('highlighted');
                    
                    // åŒæ—¶é«˜äº®å…¶ç›´æ¥é‚»å±… (è®©ç”¨æˆ·çœ‹æ¸…ä¸Šä¸‹æ–‡)
                    targetElement.neighborhood().removeClass('dimmed').addClass('highlighted');

                    // å¦‚æœåŸç‚¹å‡»çš„æ˜¯å‰¯äº§ç‰©ï¼Œä¹ŸæŠŠé‚£ä¸ªå‰¯äº§ç‰©ç‰¹æ„é«˜äº®ä¸€ä¸‹ï¼Œæ–¹ä¾¿ç”¨æˆ·çŸ¥é“è‡ªå·±ç‚¹äº†å•¥
                    if (isSideMolecule) {
                        node.removeClass('dimmed').addClass('highlighted');
                    }
                });

                // 3. åŠ¨ç”»ç§»åŠ¨é•œå¤´ (èšç„¦åˆ°ç›®æ ‡åŠå…¶é‚»å±…)
                cy.animate({
                    fit: {
                        eles: targetElement.closedNeighborhood(), // èšç„¦ååº”èŠ‚ç‚¹+å‘¨å›´ä¸€åœˆ
                        padding: 150 // ç•™ç™½å¤§ä¸€ç‚¹ï¼Œè§†é‡æ›´å¼€é˜”
                    },
                    duration: 500,
                    easing: 'ease-out-cubic'
                });

                // 4. UIåˆ—è¡¨åé¦ˆ
                document.querySelectorAll('.result-item').forEach(d => d.style.borderColor = '#eee');
                item.style.borderColor = '#2196F3';
            });
            // === ä¿®æ”¹ç»“æŸ ===

            listContainer.appendChild(item);
        });
    }


    // å…³é—­å³ä¾§æ 
    function closeSearchPanel() {
        const cy = window.cyGraph;
        const input = document.getElementById('search-input');
        const statusSpan = document.getElementById('search-status');
        const sidebar = document.getElementById('search-sidebar');

        // æ¸…ç©ºæœç´¢æ¡†ä¸çŠ¶æ€æ–‡å­—
        if (input) input.value = '';
        if (statusSpan) statusSpan.innerText = '';
        if (sidebar) sidebar.style.display = 'none';

        // æ¸…é™¤æœç´¢äº§ç”Ÿçš„é«˜äº® / å˜æš—
        if (cy) {
            cy.elements().removeClass('dimmed').removeClass('highlighted');
        }

        // æ¸…é™¤è·¯å¾„é«˜äº®
        if (typeof clearPathHighlight === 'function') {
            clearPathHighlight();
        }

        // æ¢å¤å½“å‰çš„ Pathway å¯è§æ€§ä¸å‰¯å°åˆ†å­/è·¨è†œæ˜¾éš
        filterGraph();
    }

    // æ¸…é™¤è·¯å¾„é«˜äº®
    function clearPathHighlight() {
        const cy = window.cyGraph;
        if (!cy) return;
        cy.elements('.path-node').removeClass('path-node');
        cy.elements('.path-edge').removeClass('path-edge');
        const ps = document.getElementById('path-status');
        if (ps) ps.innerText = '';
    }

    // æ ¹æ®åç§°æŒ‘é€‰â€œæœ€ç›¸ä¼¼â€çš„åˆ†å­èŠ‚ç‚¹
    function pickBestMoleculeNodeByName(term) {
        const cy = window.cyGraph;
        if (!cy) return null;
        const lower = String(term || '').toLowerCase().trim();
        if (!lower) return null;

        let bestNode = null;
        let bestScore = 0;

        cy.nodes('[type = "molecule"]').forEach(node => {
            const label = node.data('label');
            if (!label) return;
            const score = calcSimilarity(lower, label);
            if (score > bestScore) {
                bestScore = score;
                bestNode = node;
            }
        });

        return bestNode;
    }


    // ============================================
    // [ä¿®æ”¹] è·¯å¾„ç®—æ³•æ›¿æ¢ï¼šä½¿ç”¨ File 1 çš„ Dijkstra ç®—æ³•
    // ============================================
    function findPathBetweenMetabolites(startName, endName) {
        const cy = window.cyGraph;
        if (!cy) return;

        const status = document.getElementById('path-status');
        clearPathHighlight();

        // ---------------------------------------------------------
        // 1. å†…éƒ¨è¾…åŠ©ç±»ï¼šæœ€å°å † (MinHeap) ç”¨äº Dijkstra ä¼˜å…ˆçº§é˜Ÿåˆ—
        // ---------------------------------------------------------
        class MinHeap {
            constructor() { this.a = []; }
            push(x) { this.a.push(x); this._up(this.a.length - 1); }
            pop() {
                if (!this.a.length) return null;
                const top = this.a[0];
                const last = this.a.pop();
                if (this.a.length) { this.a[0] = last; this._down(0); }
                return top;
            }
            _up(i) {
                while (i > 0) {
                    const p = (i - 1) >> 1;
                    if (this.a[p].d <= this.a[i].d) break;
                    [this.a[p], this.a[i]] = [this.a[i], this.a[p]];
                    i = p;
                }
            }
            _down(i) {
                const n = this.a.length;
                while (true) {
                    let l = i * 2 + 1, r = l + 1, m = i;
                    if (l < n && this.a[l].d < this.a[m].d) m = l;
                    if (r < n && this.a[r].d < this.a[m].d) m = r;
                    if (m === i) break;
                    [this.a[m], this.a[i]] = [this.a[i], this.a[m]];
                    i = m;
                }
            }
            get size() { return this.a.length; }
        }

        // ---------------------------------------------------------
        // 2. å€™é€‰èŠ‚ç‚¹è·å– (æ¨¡ç³ŠåŒ¹é…)
        // ---------------------------------------------------------
        const getCandidates = (term, topN = 6, minScore = 0.62) => {
            const lower = String(term || '').toLowerCase().trim();
            if (!lower) return [];
            const scored = [];
            cy.nodes('[type="molecule"]').forEach(n => {
                const label = n.data('label');
                if (!label) return;
                const s = calcSimilarity(lower, label); // å¤ç”¨å…¨å±€çš„ calcSimilarity
                if (s > 0) scored.push({ n, s });
            });
            scored.sort((a, b) => b.s - a.s);
            const picked = scored.filter(x => x.s >= minScore).slice(0, topN).map(x => x.n);
            // è‡³å°‘è¿”å›ä¸€ä¸ªæœ€åŒ¹é…çš„ï¼Œå³æ—¶åˆ†æ•°å¾ˆä½
            if (picked.length === 0 && scored.length > 0) return [scored[0].n];
            return picked;
        };

        const startNodes = getCandidates(startName);
        const endNodes = getCandidates(endName);

        if (!startNodes.length || !endNodes.length) {
            if (status) status.innerText = 'æ‰¾ä¸åˆ°åŒ¹é…çš„èµ·å§‹æˆ–ç»ˆæ­¢åˆ†å­';
            renderPathResults([]);
            return;
        }

        // æ£€æŸ¥èµ·ç‚¹ç»ˆç‚¹æ˜¯å¦é‡åˆ
        const endSet = new Set(endNodes.map(n => n.id()));
        const anySame = startNodes.find(n => endSet.has(n.id()));
        if (anySame) {
            anySame.addClass('path-node');
            if (status) status.innerText = 'èµ·å§‹ä¸ç»ˆæ­¢ä¸ºåŒä¸€åˆ†å­';
            renderPathResults([]);
            return;
        }

        // ---------------------------------------------------------
        // 3. é‚»å±…æŸ¥æ‰¾é€»è¾‘ (æ ¸å¿ƒï¼šåŒºåˆ† è¿è¾“Cost=0 ä¸ ååº”Cost=1)
        // ---------------------------------------------------------
        
        // è¾…åŠ©ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§ (éšè—çš„ä¾§é“¾æˆ–è¢«è¿‡æ»¤çš„Pathwayä¸å‚ä¸å¯»è·¯)
        const isVisible = (ele) => {
            try { 
                // å¦‚æœæœ‰ç‰¹å®šçš„ class æ ‡è®°ä¸ºéšè—
                if(ele.hasClass('hidden-side') || ele.hasClass('hidden-transport') || ele.hasClass('dimmed')) {
                   // æ³¨æ„ï¼š'dimmed' é€šå¸¸åœ¨æœç´¢æ—¶å‡ºç°ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾ä»…ä¾æ® hidden class
                   // å¦‚æœéœ€è¦æ›´ä¸¥æ ¼ï¼Œå¯ä»¥æ£€æŸ¥ display styleã€‚
                   // ç®€å•èµ·è§ï¼Œè¿™é‡Œå‡è®¾ Cytoscape çš„ visible() api
                   return ele.visible(); 
                }
                return true;
            } catch (_) { return true; }
        };

        // è·¨è†œè¿è¾“/é€æ€§ï¼šåˆ†å­ <-> åˆ†å­ï¼ŒCost = 0
        const getTransportNeighbors = (molNode) => {
            const out = [];
            // edgeType="transport" (è™šçº¿)
            molNode.connectedEdges('edge[edgeType="transport"]').forEach(e => {
                if (!isVisible(e)) return;
                const other = (e.source().id() === molNode.id()) ? e.target() : e.source();
                if (other && other.data('type') === 'molecule' && isVisible(other)) {
                    out.push({ to: other, cost: 0, rxn: null });
                }
            });
            return out;
        };

        // åŒ–å­¦ååº”ï¼šåˆ†å­ --(in)--> ååº” --(out)--> åˆ†å­ï¼ŒCost = 1
        const getReactionNeighbors = (molNode, includeSide) => {
            const out = [];
            // åŒºåˆ†æ˜¯å¦åŒ…å«å‰¯ååº”è¾¹
            const inSel = includeSide ? 'edge[type="in"]' : 'edge[type="in"][edgeType="main"]';
            const outSel = includeSide ? 'edge[type="out"]' : 'edge[type="out"][edgeType="main"]';

            // 1. åˆ†å­ -> ååº” (æ¶ˆè€—)
            const rxnEdges = molNode.outgoers(inSel).filter(e => isVisible(e));
            rxnEdges.forEach(e => {
                const rxn = e.target();
                if (!rxn || rxn.data('type') !== 'reaction' || !isVisible(rxn)) return;

                // 2. ååº” -> äº§ç‰© (ç”Ÿæˆ)
                const prodEdges = rxn.outgoers(outSel).filter(ee => isVisible(ee));
                prodEdges.forEach(ee => {
                    const prod = ee.target();
                    if (!prod || prod.data('type') !== 'molecule') return;
                    if (!isVisible(prod)) return;
                    
                    // æ‰¾åˆ°äº†ä¸€ä¸ªä¸‹æ¸¸åˆ†å­ï¼Œä»£ä»·ä¸º 1ï¼ˆä»£è¡¨ç»è¿‡äº†1æ­¥ååº”ï¼‰
                    out.push({ to: prod, cost: 1, rxn: rxn });
                });
            });

            return out;
        };

        // ---------------------------------------------------------
        // 4. æ‰§è¡Œæœç´¢ (Dijkstra)
        // ---------------------------------------------------------
        const runSearch = (includeSide) => {
            const dist = new Map();
            const prev = new Map(); // Map<molId, { prevMolId, via: 'rxn'|'transport', rxnId? }>
            const heap = new MinHeap();

            // åˆå§‹åŒ–èµ·ç‚¹ (å¯èƒ½æœ‰å¤šä¸ªå€™é€‰èµ·ç‚¹ï¼Œéƒ½è®¾ä¸ºè·ç¦» 0)
            startNodes.forEach(s => {
                if (!isVisible(s)) return;
                dist.set(s.id(), 0);
                heap.push({ id: s.id(), d: 0 });
            });

            let bestEnd = null;
            let bestDist = Infinity;

            while (heap.size) {
                const cur = heap.pop();
                if (!cur) break;
                const curId = cur.id;
                const curD = cur.d;

                // æ‡’æƒ°åˆ é™¤ï¼šå¦‚æœå †é‡Œçš„è·ç¦»æ¯”å·²çŸ¥æœ€çŸ­è·ç¦»å¤§ï¼Œè·³è¿‡
                if (curD > (dist.get(curId) ?? Infinity)) continue;
                
                // å‰ªæï¼šå¦‚æœå·²ç»æ‰¾åˆ°ç»ˆç‚¹ï¼Œä¸”å½“å‰è·¯å¾„æ¯”å·²çŸ¥ç»ˆç‚¹è·¯å¾„è¿˜é•¿ï¼Œè·³è¿‡
                if (curD > bestDist) break;

                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹é›†åˆ
                if (endSet.has(curId)) {
                    // æ‰¾åˆ°ä¸€ä¸ªç»ˆç‚¹
                    if (curD < bestDist) {
                        bestEnd = curId;
                        bestDist = curD;
                    }
                    // Dijkstra ä¿è¯ç¬¬ä¸€æ¬¡é‡åˆ°ç»ˆç‚¹å³ä¸ºæœ€çŸ­ï¼Œä½†åœ¨å¤šèµ·ç‚¹å¤šç»ˆç‚¹ä¸‹ç¨å¾®ä¿ç•™ç»§ç»­æŸ¥çœ‹åŒè·ç¦»çš„å¯èƒ½æ€§
                    // è¿™é‡Œå¯ä»¥ç›´æ¥ breakï¼Œå› ä¸ºå®ƒæ˜¯ Priority Queue
                    break;
                }

                const curNode = cy.$id(curId);
                if (!curNode || !curNode.length) continue;

                // è·å–é‚»å±…
                const neigh = []
                    .concat(getTransportNeighbors(curNode))
                    .concat(getReactionNeighbors(curNode, includeSide));

                for (const nb of neigh) {
                    const nbId = nb.to.id();
                    const nd = curD + nb.cost;
                    const old = dist.get(nbId);

                    if (old === undefined || nd < old) {
                        dist.set(nbId, nd);
                        prev.set(nbId, {
                            prevMolId: curId,
                            via: nb.cost === 0 ? 'transport' : 'rxn',
                            rxnId: nb.rxn ? nb.rxn.id() : null
                        });
                        heap.push({ id: nbId, d: nd });
                    }
                }
            }

            if (!bestEnd || bestDist === Infinity) return null;

            // --- è·¯å¾„é‡å»º ---
            const nodes = [];     // å­˜å‚¨è·¯å¾„ä¸Šçš„ Cytoscape èŠ‚ç‚¹å¯¹è±¡
            let curId = bestEnd;
            nodes.push(cy.$id(curId));

            const involvedRxnIds = new Set(); // è®°å½•è·¯å¾„ç»è¿‡çš„ååº” ID

            // å›æº¯ç›´åˆ°æ‰¾åˆ°æŸä¸ªèµ·ç‚¹
            while (!startNodes.some(s => s.id() === curId)) {
                const p = prev.get(curId);
                if (!p) break; // å¼‚å¸¸æ–­è£‚

                // å¦‚æœæ˜¯ååº”æ­¥éª¤ï¼ŒæŠŠååº”èŠ‚ç‚¹ä¹ŸåŠ è¿›å»
                if (p.via === 'rxn' && p.rxnId) {
                    involvedRxnIds.add(p.rxnId);
                    nodes.push(cy.$id(p.rxnId));
                }
                // åŠ å…¥ä¸Šæ¸¸åˆ†å­
                nodes.push(cy.$id(p.prevMolId));
                curId = p.prevMolId;
            }

            nodes.reverse(); // ç¿»è½¬ä¸º æ­£åº

            // è¿™é‡Œå°†æ²¿é€”çš„ååº”è®¾ä¸ºé€‰ä¸­çŠ¶æ€ï¼Œä»¥ä¾¿æ˜¾ç¤ºå‰¯äº§ç‰©ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (involvedRxnIds.size && window.selectedReactionIds) {
                involvedRxnIds.forEach(id => window.selectedReactionIds.add(id));
                // åˆ·æ–°æ˜¾ç¤ºç¡®ä¿å‰¯äº§ç‰©ï¼ˆå¦‚æœæœ‰ï¼‰èƒ½è¢«çœ‹åˆ°ï¼Œä¸è¿‡è·¯å¾„é€šå¸¸åªåŒ…å«ä¸»å¹²
                if(typeof refreshSideVisibility === 'function') refreshSideVisibility();
            }

            return [{ nodes, reactionSteps: bestDist, totalNodes: nodes.length }];
        };

        // ç­–ç•¥ï¼šä¼˜å…ˆåªèµ°ä¸»ååº” (Main edges)ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå†æ”¾å®½å‡å¯èµ° (Side edges)
        let pathsInfo = runSearch(false);
        if (!pathsInfo) pathsInfo = runSearch(true);

        if (!pathsInfo || !pathsInfo.length) {
            if (status) status.innerText = 'åœ¨å½“å‰ç½‘ç»œä¸­æœªæ‰¾åˆ°é€šè·¯ (å¯èƒ½è¢«ç­›é€‰å™¨è¿‡æ»¤)';
            renderPathResults([]);
            return;
        }

        // æ¸²æŸ“ç»“æœ
        applyPathHighlight(pathsInfo[0].nodes);
        renderPathResults(pathsInfo);

        if (status) {
            status.innerText = `æ‰¾åˆ°æœ€ä½³è·¯å¾„ï¼šåŒ…å« ${pathsInfo[0].reactionSteps} ä¸ªååº”æ­¥éª¤`;
        }
        
        // èšç„¦è¾“å…¥æ¡†
        const endInput = document.getElementById('path-end-input');
        if(endInput) endInput.focus();
    }

    // ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ ...


    // é«˜äº®å¹¶èšç„¦ä¸€æ¡ç»™å®šè·¯å¾„
    function applyPathHighlight(pathNodes) {
        const cy = window.cyGraph;
        if (!cy || !pathNodes || !pathNodes.length) return;

        clearPathHighlight();

        const pathNodesCol = cy.collection(pathNodes);
        pathNodesCol.addClass('path-node');

        const pathEdges = [];
        for (let i = 0; i < pathNodes.length - 1; i++) {
            const a = pathNodes[i];
            const b = pathNodes[i + 1];
            const edgesAB = a.edgesTo(b);
            edgesAB.forEach(e => pathEdges.push(e));
        }
        const pathEdgesCol = cy.collection(pathEdges);
        pathEdgesCol.addClass('path-edge');

        cy.animate({
            fit: {
                eles: pathNodesCol.union(pathEdgesCol),
                padding: 80
            },
            duration: 500,
            easing: 'ease-out-cubic'
        });
    }

    // åœ¨å³ä¾§åˆ—è¡¨ä¸­å±•ç¤ºå¤šæ¡è·¯å¾„ï¼ˆä»çŸ­åˆ°é•¿ï¼‰
    function renderPathResults(pathsInfo) {
        const sidebar = document.getElementById('search-sidebar');
        const listContainer = document.getElementById('search-results-list');
        const countSpan = document.getElementById('result-count');

        if (!sidebar || !listContainer || !countSpan) return;

        // å¦‚æœæ²¡æœ‰è·¯å¾„ï¼Œä¸”å½“å‰ä¹Ÿä¸æ˜¯æœç´¢æ¨¡å¼ï¼Œå°±ç®€å•æ¸…ç©º
        if (!pathsInfo || pathsInfo.length === 0) {
            listContainer.innerHTML = '';
            countSpan.innerText = 0;
            // ä¸å¼ºåˆ¶éšè—ä¾§è¾¹æ ï¼Œäº¤ç»™ closeSearchPanel æˆ–æœç´¢é€»è¾‘æ§åˆ¶
            return;
        }

        sidebar.style.display = 'flex';
        listContainer.innerHTML = '';

        countSpan.innerText = pathsInfo.length;

        pathsInfo.forEach((info, idx) => {
            const item = document.createElement('div');
            item.className = 'result-item';

            const stepText = `${info.reactionSteps} ä¸ªååº”æ­¥éª¤`;
            const nodeLabels = info.nodes
                .map(n => n.data && (n.data('label') || n.id()))
                .filter(Boolean);

            // åªå±•ç¤ºå‰è‹¥å¹²ä¸ªèŠ‚ç‚¹ï¼Œé¿å…å¤ªé•¿
            const preview = nodeLabels.slice(0, 6).join(' â†’ ') +
                (nodeLabels.length > 6 ? ' â†’ ...' : '');

            item.innerHTML = `
                <div class="result-name">
                    è·¯å¾„ ${idx + 1}
                    <span class="result-type-tag" style="background:#e67e22;">${stepText}</span>
                </div>
                <div class="result-pathway" style="font-size:11px; color:#555; margin-top:2px;">
                    ${preview}
                </div>
            `;

            item.addEventListener('click', () => {
                applyPathHighlight(info.nodes);
                const ps = document.getElementById('path-status');
                if (ps) {
                    ps.innerText = `å½“å‰ä¸ºè·¯å¾„ ${idx + 1}ï¼ŒåŒ…å« ${info.reactionSteps} ä¸ªååº”æ­¥éª¤`;
                }
                document.querySelectorAll('.result-item').forEach(d => d.style.borderColor = '#eee');
                item.style.borderColor = '#e67e22';
            });

            listContainer.appendChild(item);
        });
    }


    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.onload = async function() {
        try {
            if (typeof cytoscapeDagre !== 'undefined') {
                cytoscape.use(cytoscapeDagre);
            }
        } catch (e) { console.warn("Layout plugin already registered"); }

        // å¹¶è¡ŒåŠ è½½å›¾è¡¨æ•°æ®å’Œå‚è€ƒæ•°æ®
        await Promise.all([
            loadAndMergeSheets(),
            loadReferenceData()
        ]);
    };

    // === æ–°å¢ï¼šåŠ è½½å‚è€ƒæ•°æ®å‡½æ•° ===
    async function loadReferenceData() {
        try {
            // 1. åŠ è½½ molecule SMILES Sheet
            const molRes = await fetch(`/api/data/${encodeURIComponent('molecule SMILES')}`);
            if (molRes.ok) {
                const molData = await molRes.json();
                molData.forEach(row => {
                    // ç¡®ä¿åŒ¹é…æ—¶ä¸åŒºåˆ†é¦–å°¾ç©ºæ ¼
                    const name = String(row['Substance'] || '').trim();
                    if (name) {
                        window.refData.molecules.set(name, {
                            smiles: row['SMILES'],
                            link: row['Link']
                        });
                    }
                });
            }

            // 2. åŠ è½½ enzyme EC Sheet
            const enzRes = await fetch(`/api/data/${encodeURIComponent('enzyme EC')}`);
            if (enzRes.ok) {
                const enzData = await enzRes.json();
                enzData.forEach(row => {
                    const name = String(row['name'] || '').trim();
                    if (name) {
                        window.refData.enzymes.set(name, {
                            ec: row['identifier'], // å¯¹åº” identifier æ 
                            link: row['link']      // å¯¹åº” link æ 
                        });
                    }
                });
            }
            console.log("å‚è€ƒæ•°æ®åŠ è½½å®Œæ¯•");
        } catch (e) {
            console.warn("å‚è€ƒæ•°æ®åŠ è½½å¤±è´¥ï¼ˆéé˜»æ–­æ€§ï¼‰:", e);
        }
    }


        async function loadAndMergeSheets() {
        // æ˜¾ç¤ºå° Loading æç¤ºï¼Œé‡ç½®çŠ¶æ€
        document.getElementById('loading').style.display = 'flex';
        updateStatus('');
    
        try {
            let combinedData = [];
            
            // å¹¶è¡ŒåŠ è½½ Excel æ•°æ®
            const requests = TARGET_SHEETS.map(name =>
                fetch(`/api/data/${encodeURIComponent(name)}`)
                    .then(res => {
                        if(!res.ok) throw new Error(`Sheet [${name}] è¯»å–å¤±è´¥ (Status: ${res.status})`);
                        return res.json();
                    })
                    .then(sheetData => {
                        if (!Array.isArray(sheetData)) throw new Error(`Sheet [${name}] æ•°æ®æ ¼å¼é”™è¯¯`);
                        sheetData.forEach(row => row.__sheet = name);
                        return sheetData;
                    })
            );

            const results = await Promise.all(requests);
            results.forEach(sheetData => {
                combinedData = combinedData.concat(sheetData);
            });

            console.log(`åˆå¹¶å®Œæˆï¼Œå…± ${combinedData.length} è¡Œæ•°æ®`);
            
            // é¢„åŠ è½½å¸ƒå±€
            await preloadLayoutFromServer();

            // å¼€å§‹ç»˜å›¾
            processDataAndDraw(combinedData);

        } catch (err) {
            console.error('Data Load Error:', err);
            
            // ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æœå‡ºé”™ï¼Œå¿…é¡»æ‰‹åŠ¨éšè—å…¨å±ç™½è‰²é®ç½©ï¼Œå¦åˆ™ç”¨æˆ·åªèƒ½çœ‹åˆ°ç™½å±
            const mask = document.getElementById('loading-mask');
            if (mask) mask.style.display = 'none';

            // æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º
            showError(`æ•°æ®åŠ è½½å¤±è´¥: ${err.message}`);
        } finally {
            // éšè—ä¸­é—´çš„å° loading æ–‡å­—
            const smallLoading = document.getElementById('loading');
            if (smallLoading) smallLoading.style.display = 'none';
        }
    }


        // ============================================
    // æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†æ•°æ®å¹¶ç»˜å›¾
    // ============================================
    function processDataAndDraw(data) {
        // ã€ä¿®å¤ 1ã€‘ç§»é™¤äº† if (!window.cyGraph) return; 
        // å› ä¸ºé¦–æ¬¡åŠ è½½æ—¶ graph å°šæœªåˆ›å»ºï¼Œä¸èƒ½ç›´æ¥è¿”å›ã€‚

        const elements = [];
        const pathwaysBySheet = new Map();
        
        // ç”¨äºååº”å»é‡çš„æ³¨å†Œè¡¨ï¼škey=signature, value=rxnId
        const rxnRegistry = new Map(); 
        const createdRxnIds = new Set();
        
        // å…¨å±€å˜é‡ï¼šå­˜å‚¨ç‰©è´¨çš„æºæ•°æ®ï¼ˆç”¨äºæœç´¢å’Œæ˜¾ç¤ºæ‰€å±Pathwayï¼‰
        window.mainMoleculeMeta = new Map();

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 1ï¼šæ–‡æœ¬æ ¼å¼åŒ– (å¤„ç†ä¸Šä¸‹æ ‡ã€å¸Œè…Šå­—æ¯)
        // -------------------------------------------------------------
        function formatText(str) {
            if (!str || typeof str !== 'string') return str;
            let s = str;

            // 1. å¸Œè…Šå­—æ¯æ›¿æ¢ (ä¸åŒºåˆ†å¤§å°å†™)
            s = s.replace(/alpha/gi, 'Î±');
            s = s.replace(/beta/gi, 'Î²');
            s = s.replace(/gamma/gi, 'Î³');
            s = s.replace(/delta/gi, 'Î”');

            // 2. åŒ–å­¦å¼/ç‰¹æ®Šå­—ç¬¦æ›¿æ¢è§„åˆ™
            const replacements = [
                { k: 'NH4+',  v: 'NHâ‚„âº' },
                { k: 'HCO3-', v: 'HCOâ‚ƒâ»' },
                { k: 'NADP+', v: 'NADPâº' },
                { k: 'NAD+',  v: 'NADâº' },
                { k: 'FADH2', v: 'FADHâ‚‚' },
                { k: 'H2O',   v: 'Hâ‚‚O' },
                { k: 'NH3',   v: 'NHâ‚ƒ' },
                { k: 'O2',    v: 'Oâ‚‚' },
                { k: 'N5',    v: 'Nâ‚…' },
                { k: 'N10',   v: 'Nâ‚â‚€' },
                { k: 'CO2',   v: 'COâ‚‚' },
                { k: 'H+',    v: 'Hâº' },
                { k: 'e-',    v: 'eâ»' },
                { k: '2e-',   v: '2eâ»' },
                { k: '3e-',   v: '3eâ»' },
                { k: '4e-',   v: '4eâ»' }
            ];

            replacements.forEach(item => {
                const reqStr = item.k.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
                const re = new RegExp(reqStr, 'g');
                s = s.replace(re, item.v);
            });

            return s;
        }

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 2ï¼šè§£æåˆ†å­å­—ç¬¦ä¸² (åˆ†å·æˆ–å†’å·åˆ†éš”)
        // -------------------------------------------------------------
        const parseMolecules = (str) => {
            if (!str) return [];
            // æ”¯æŒ "A; B" æˆ– "A: id" æ ¼å¼ï¼Œå–åˆ†å·åˆ†éš”åçš„ç¬¬ä¸€éƒ¨åˆ†
            return String(str).split(';').map(s => s.split(':')[0].trim()).filter(s => s);
        };

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 3ï¼šè§„èŒƒåŒ–ç»†èƒå™¨åç§°
        // -------------------------------------------------------------
        const normalizeCompartment = (place) => {
            if (!place) return '';
            const raw = String(place).trim();
            if (!raw || raw === '0') return '';
            const first = raw.split(/[;,]/)[0].trim();
            return first.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_\u4e00-\u9fa5]/g, '_');
        };

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 4ï¼šç”Ÿæˆååº”å”¯ä¸€ç­¾å (ç”¨äºåˆå¹¶åŒç±»ååº”)
        // -------------------------------------------------------------
                // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 4ï¼šç”Ÿæˆååº”å”¯ä¸€ç­¾å (ç”¨äºåˆå¹¶åŒç±»ååº”)
        // -------------------------------------------------------------
        const getRxnSignature = (enzyme, sources, targets, place) => {
            const e = (enzyme || '').trim().toLowerCase();
            const s = sources.slice().sort().join('|').toLowerCase();
            const t = targets.slice().sort().join('|').toLowerCase();
            
            // å®‰å…¨å¤„ç†åœºæ‰€å­—ç¬¦ä¸²
            let p = 'unknown';
            if (place && String(place).trim() !== '0' && String(place).trim() !== '') {
                p = String(place).trim().toLowerCase();
            }

            return {
                // å°†åœºæ‰€ p æ‹¼æ¥åˆ°ç­¾åä¸­ï¼ŒåŒºåˆ†ä¸åŒåœºæ‰€çš„åŒåååº”
                forward: `${e}__${s}__>>__${t}__@${p}`,
                reverse: `${e}__${t}__>>__${s}__@${p}` 
            };
        };


        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 5ï¼šèŠ‚ç‚¹æ·»åŠ é€»è¾‘
        // -------------------------------------------------------------
        const addedNodes = new Set();

        // æ·»åŠ ä¸»èŠ‚ç‚¹ (å‚ä¸å¸ƒå±€)
        const addMainNode = (name, compartment, sheetName, pathway) => {
            const id = compartment ? `${name}@@${compartment}` : name;
            
            if (!addedNodes.has(id)) {
                const displayLabel = formatText(name); // Label æ ¼å¼åŒ–
                elements.push({ 
                    data: { 
                        id: id, 
                        label: displayLabel, 
                        baseName: name, 
                        type: 'molecule', 
                        isSide: false,
                        pathway: pathway 
                    },
                    classes: 'molecule main-molecule'
                });
                addedNodes.add(id);
            }

            // æ›´æ–°å…ƒæ•°æ®
            if (!window.mainMoleculeMeta.has(name)) {
                window.mainMoleculeMeta.set(name, { pathwaySheets: new Map(), sheets: new Set() });
            }
            const meta = window.mainMoleculeMeta.get(name);
            if (sheetName) meta.sheets.add(sheetName); // è®°å½• sheet ç”¨äºé…è‰²
            if (pathway) {
                if (!meta.pathwaySheets.has(pathway)) meta.pathwaySheets.set(pathway, new Set());
                if (sheetName) meta.pathwaySheets.get(pathway).add(sheetName);
            }
        };

        // æ·»åŠ å‰¯èŠ‚ç‚¹ (åˆå§‹éšè—)
            // åŸæ¥çš„ï¼šclasses: 'molecule side-molecule'
    // ä¿®æ”¹ä¸ºï¼š
    const addSideNode = (id, name, role, parentRxnId, direction, pathway) => {
        if (!addedNodes.has(id)) {
            const displayLabel = formatText(name);
            elements.push({ 
                data: { 
                    id: id, 
                    label: displayLabel,
                    baseName: name, 
                    type: 'molecule', 
                    isSide: true, 
                    role: role, 
                    parentRxn: parentRxnId, 
                    direction: direction,
                    pathway: pathway 
                }, 
                // === æŠŠ role åŠ è¿›å»ï¼Œè¿™æ · CSS .sub-reactant æ‰èƒ½ç”Ÿæ•ˆ ===
                classes: `molecule side-molecule ${role}` 
            });
            addedNodes.add(id);
        }
    };


        // -------------------------------------------------------------
        // ä¸»å¾ªç¯ï¼šè§£æ Excel æ•°æ®è¡Œ
        // -------------------------------------------------------------
        data.forEach((row, index) => {
            const mainSources = parseMolecules(row['Main Reactant']);
            const sideSources = parseMolecules(row['Other Reactant']); 
            const mainTargets = parseMolecules(row['Main Product']);
            const sideTargets = parseMolecules(row['Other Product']); 

            if ((mainSources.length + sideSources.length > 0) && (mainTargets.length + sideTargets.length > 0)) {
                const pathway = row['Pathway'];
                const enzyme = row['Enzyme'];
                const sheetName = row.__sheet || 'Unknown';
                const originalPlace = row['Place in Cell'] || 'Unknown';
                const compKey = normalizeCompartment(originalPlace);

                // --- 1. è·å–å¹¶æ ¼å¼åŒ–æ–‡æœ¬ä¿¡æ¯ ---
                const rawDesc = (row['Description'] && String(row['Description']).trim() !== '0') ? String(row['Description']).trim() : '';
                const formatDesc = formatText(rawDesc);

                const rawCoenzyme = (row['Coenzyme'] && String(row['Coenzyme']).trim() !== '0') ? String(row['Coenzyme']).trim() : '';
                const formatCoenzyme = formatText(rawCoenzyme);
                // [æ–°å¢] 1. è¯»å–æ¿€æ´»å‰‚å’ŒæŠ‘åˆ¶å‰‚
                const rawActivator = row['Activator'] || row['activator'];
                const rawInhibitor = row['Inhibitor'] || row['inhibitor'];
                // è¾…åŠ©æ¸…æ´—å‡½æ•°ï¼šå»å†’å·å’Œæ•°å­— "ATP:1" -> "ATP"
                const cleanRegName = (str) => {
                    if (!str) return '';
                    return String(str).split(':')[0].trim();
                };

                // [ä¿®æ”¹] 2. Regulation åˆ¤æ–­é€»è¾‘
                // åªè¦æœ‰ Special regulation æ–‡å­—ï¼Œæˆ–è€…æœ‰ Activatorï¼Œæˆ–è€…æœ‰ Inhibitorï¼Œéƒ½ç®—æœ‰ Regulation
                const specialReg = row['Special regulation'];
                let regText = null;
                let hasRegulation = false;

                // æ£€æŸ¥æ–‡æœ¬æè¿°
                if (specialReg && String(specialReg).trim().toLowerCase() !== 'un') {
                    regText = formatText(String(specialReg).trim());
                    hasRegulation = true;
                }
                // æ£€æŸ¥æ˜¯å¦æœ‰æ¿€æ´»å‰‚/æŠ‘åˆ¶å‰‚ (ä¿®æ­£äº†ä½ çš„éœ€æ±‚ï¼šè¿™ä¸¤æ ä¸ä¸º0ä¹Ÿè¦åŠ å…¥Regulation Modeåˆ—è¡¨)
                const hasAct = (rawActivator && rawActivator !== 0 && String(rawActivator) !== '0');
                const hasInh = (rawInhibitor && rawInhibitor !== 0 && String(rawInhibitor) !== '0');
                
                if (hasAct || hasInh) {
                    hasRegulation = true;
                }

                // Pathway List
                if (pathway) {
                    if (!pathwaysBySheet.has(sheetName)) pathwaysBySheet.set(sheetName, []);
                    const list = pathwaysBySheet.get(sheetName);
                    if (!list.includes(pathway)) list.push(pathway);
                }

                // --- 2. ç”Ÿæˆååº”æ–¹ç¨‹å¼ ---
                const reactantsStr = [...mainSources, ...sideSources].join(' + ');
                const productsStr = [...mainTargets, ...sideTargets].join(' + ');
                const rawFormula = `${reactantsStr} â€”â€”â†’ ${productsStr}`;
                const formatFormula = formatText(rawFormula);

                // --- 3. ç”Ÿæˆæˆ–è·å–ååº”èŠ‚ç‚¹ ---
                 const sig = getRxnSignature(enzyme, mainSources, mainTargets, originalPlace);
                let rxnId;
                
                if (rxnRegistry.has(sig.forward)) {
                    rxnId = rxnRegistry.get(sig.forward);
                } else if (rxnRegistry.has(sig.reverse)) {
                    rxnId = rxnRegistry.get(sig.reverse);
                } else {
                    const safeEnzyme = (enzyme || 'rxn').replace(/[^a-zA-Z0-9]/g, '_');
                    rxnId = `rxn_${safeEnzyme}_${index}`;
                    rxnRegistry.set(sig.forward, rxnId);
                }

                const isZeroEnzyme = !enzyme || String(enzyme).trim() === '0' || String(enzyme).trim() === '';
                const labelText = isZeroEnzyme ? '' : formatText(enzyme);
                // === æ–°å¢ï¼šè·å–åŸå§‹é…¶åç§°ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼å³å¯ï¼‰ï¼Œç”¨äºåŒ¹é… ===
                const rawEnzymeName = (enzyme && String(enzyme).trim() !== '0') ? String(enzyme).trim() : '';

                // --- 4. æ·»åŠ ä¸åˆå¹¶ååº”èŠ‚ç‚¹ ---
                if (!createdRxnIds.has(rxnId)) {
                    // === æ–°å»ºèŠ‚ç‚¹ ===
                    elements.push({
                        data: { 
                            id: rxnId, 
                            label: labelText, 
                            type: 'reaction', 
                            pathway: pathway || 'Uncategorized',
                            infoEnzyme: labelText,
                            infoFormula: formatFormula,
                            infoDesc: formatDesc,
                            infoCoenzyme: formatCoenzyme,
                            infoPlace: (originalPlace === '0') ? null : originalPlace,
                            hasRegulation: hasRegulation,
                            rawEnzyme: rawEnzymeName,
                            regulationText: regText
                        },
                        classes: 'reaction'
                    });
                    createdRxnIds.add(rxnId);
                   
                } else {
                    // === åˆå¹¶å·²æœ‰èŠ‚ç‚¹ä¿¡æ¯ ===
                    const existingNodeWrapper = elements.find(e => e.data.id === rxnId);
                    if (existingNodeWrapper) {
                        if (hasRegulation) existingNodeWrapper.data.hasRegulation = true;
                        const d = existingNodeWrapper.data;
                        if (!d.infoFormula.includes(formatFormula)) d.infoFormula += `\n${formatFormula}`;
                        
                        if (formatDesc) {
                            if (d.infoDesc) d.infoDesc += `\n${formatDesc}`;
                            else d.infoDesc = formatDesc;
                        }
                        
                        if (formatCoenzyme) {
                            if (d.infoCoenzyme) {
                                if(!d.infoCoenzyme.includes(formatCoenzyme)) d.infoCoenzyme += `\n${formatCoenzyme}`;
                            } else {
                                d.infoCoenzyme = formatCoenzyme;
                            }
                        }

                        if (hasRegulation) {
                            d.hasRegulation = true;
                            if (d.regulationText && regText && !d.regulationText.includes(regText)) {
                                d.regulationText += `\n${regText}`;
                            } else if (!d.regulationText) {
                                d.regulationText = regText;
                            }
                        }

                        if (pathway && d.pathway !== pathway && !d.pathway.includes(pathway)) {
                            d.pathway += `, ${pathway}`;
                        }
                    }
                }
                 // [æ–°å¢] 3. åˆ›å»º Activator èŠ‚ç‚¹å’Œè¾¹ (ä»…åœ¨æ–°åˆ›å»ºååº”æ—¶å¤„ç†ï¼Œé¿å…é‡å¤)
                    if (hasAct) {
                        const acts = String(rawActivator).split(';');
                        acts.forEach(actName => {
                            const name = cleanRegName(actName);
                            if (!name) return;
                            // å”¯ä¸€IDï¼šact_ååº”ID_åå­—
                            const actNodeId = `act_${rxnId}_${name}`; 
                            elements.push({
                                data: { id: actNodeId, label: name, nodeType: 'activator', parentEnzyme: rxnId },
                                position: { x: 0, y: 0 }, // åˆå§‹ä½ç½®ï¼Œç‚¹å‡»åä¼šè‡ªåŠ¨æ’ç‰ˆ
                                classes: 'reg-node hidden-reg' // é»˜è®¤éšè—
                            });
                            elements.push({
                                data: { source: actNodeId, target: rxnId, interaction: 'activate' },
                                classes: 'reg-edge hidden-reg' // é»˜è®¤éšè—
                            });
                        });
                    }

                    // [æ–°å¢] 4. åˆ›å»º Inhibitor èŠ‚ç‚¹å’Œè¾¹
                    if (hasInh) {
                        const inhs = String(rawInhibitor).split(';');
                        inhs.forEach(inhName => {
                            const name = cleanRegName(inhName);
                            if (!name) return;
                            const inhNodeId = `inh_${rxnId}_${name}`;
                            elements.push({
                                data: { id: inhNodeId, label: name, nodeType: 'inhibitor', parentEnzyme: rxnId },
                                position: { x: 0, y: 0 },
                                classes: 'reg-node hidden-reg'
                            });
                            elements.push({
                                data: { source: inhNodeId, target: rxnId, interaction: 'inhibit' },
                                classes: 'reg-edge hidden-reg'
                            });
                        });
                    }
                // --- 5. åˆ›å»ºè¿çº¿å’Œç‰©è´¨èŠ‚ç‚¹ ---
                
                mainSources.forEach(s => {
                    const srcId = compKey ? `${s}@@${compKey}` : s;
                    addMainNode(s, compKey, sheetName, pathway);
                    elements.push({ 
                        data: { source: srcId, target: rxnId, pathway: pathway, type: 'in', edgeType: 'main' }, 
                        classes: 'edge-main' 
                    });
                });

                sideSources.forEach((s, i) => {
                    const sid = `${rxnId}_side_in_${s}_${index}_${i}`; 
                    addSideNode(sid, s, 'sub-reactant', rxnId, 'in', pathway);
                    elements.push({ 
                        data: { source: sid, target: rxnId, pathway: pathway, type: 'in', edgeType: 'side' }, 
                        classes: 'edge-side hidden-side' 
                    });
                });

                mainTargets.forEach(t => {
                    const tgtId = compKey ? `${t}@@${compKey}` : t;
                    addMainNode(t, compKey, sheetName, pathway);
                    elements.push({ 
                        data: { source: rxnId, target: tgtId, pathway: pathway, type: 'out', edgeType: 'main' }, 
                        classes: 'edge-main' 
                    });
                });

                sideTargets.forEach((t, i) => {
                    const sid = `${rxnId}_side_out_${t}_${index}_${i}`;
                    addSideNode(sid, t, 'sub-product', rxnId, 'out', pathway);
                    elements.push({ 
                        data: { source: rxnId, target: sid, pathway: pathway, type: 'out', edgeType: 'side' }, 
                        classes: 'edge-side hidden-side' 
                    });
                });
            }
        });

        // 6. ç”Ÿæˆå·¦ä¾§ç­›é€‰å™¨ checkboxes
        generateCheckboxes(pathwaysBySheet);

        // 7. å›å¡«ä¸»å¹²åˆ†å­çš„é»˜è®¤é¢œè‰²
        // ä¸Šé¢ä»£ç æ„å»º elements æ—¶æ²¡æœ‰å¡« colorï¼Œè¿™é‡Œè¡¥ä¸Š
        elements.forEach(el => {
            if (el && el.classes && String(el.classes).includes('main-molecule')) {
                const meta = window.mainMoleculeMeta.get(el.data.baseName);
                if (meta && meta.sheets) {
                    el.data.color = pickSheetColor(meta.sheets);
                } else {
                    el.data.color = '#95a5a6';
                }
            }
        });

        // ã€ä¿®å¤ 2ã€‘ è°ƒç”¨æ‚¨åŸæœ¬å·²æœ‰çš„ drawCytoscape å‡½æ•°
        // å®ƒè´Ÿè´£åˆå§‹åŒ– window.cyGraphï¼Œè´Ÿè´£æ¸²æŸ“ï¼Œå¹¶è´Ÿè´£å…³é—­ Loading é®ç½©
        
// ============================================================
// 5. è·¨è†œè¿è¾“è¾¹ (Transport edges): åŒååˆ†å­åœ¨ä¸åŒç»†èƒå™¨/åŒºå®¤ä¹‹é—´å»ºç«‹è”ç³»
//    - edgeType: "transport" (ç”¨äºå¯»è·¯ cost=0)
//    - classes: "edge-transport hidden-transport" (ç”± refreshTransportVisibility æ§åˆ¶æ˜¾éš)
// ============================================================
(function buildTransportEdges(){
    const baseToNodeIds = new Map(); // baseName -> Set(nodeId)
    elements.forEach(el => {
        if (!el || !el.data) return;
        if (el.data.type !== 'molecule') return;
        if (el.data.isSide) return;
        const id = String(el.data.id || '');
        const base = String(el.data.baseName || el.data.label || '').trim();
        if (!base) return;
        // åªä¸ºå¸¦åŒºå®¤æ ‡ç­¾çš„ä¸»åˆ†å­åˆ›å»ºè¿è¾“è¿çº¿ï¼šname@@compartment
        if (!id.includes('@@')) return;
        if (!baseToNodeIds.has(base)) baseToNodeIds.set(base, new Set());
        baseToNodeIds.get(base).add(id);
    });

    const addedEdgeIds = new Set();
    baseToNodeIds.forEach((idSet, baseName) => {
        const ids = Array.from(idSet);
        if (ids.length < 2) return;

        // è¿æ¥æ‰€æœ‰åŒºå®¤ç»„åˆï¼ˆæ— æ–¹å‘ï¼‰ï¼Œç”¨æµ…ç°è™šçº¿è¡¨ç¤ºâ€œè·¨è†œ/è½¬è¿å…³è”â€
        for (let i = 0; i < ids.length; i++) {
            for (let j = i + 1; j < ids.length; j++) {
                const a = ids[i], b = ids[j];
                if (a === b) continue;
                const s = a < b ? a : b;
                const t = a < b ? b : a;
                const eid = `trans__${s}__${t}`;
                if (addedEdgeIds.has(eid)) continue;
                addedEdgeIds.add(eid);

                elements.push({
                    data: {
                        id: eid,
                        source: s,
                        target: t,
                        edgeType: 'transport',
                        baseName: baseName
                    },
                    classes: 'edge-transport hidden-transport'
                });
            }
        }
    });
})();

        console.log(`å¤„ç†å®Œæˆï¼Œç”Ÿæˆçš„å…ƒç´ æ•°é‡: ${elements.length}`);
        drawCytoscape(elements);
}


    // ============================================================
    // 2. Cytoscape ç»˜å›¾ä¸å¸ƒå±€ (Draw & Layout)
    // ============================================================
    function drawCytoscape(allElements) {
        const container = document.getElementById('cy');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingMask = document.getElementById('loading-mask');

        // 1. åˆå§‹åŒ–ç©ºå›¾è¡¨
        window.cyGraph = cytoscape({
            container: container,
            // é™åˆ¶æ»šè½®ç¼©æ”¾é€Ÿåº¦ï¼Œé˜²æ­¢ä¸€æ»šè½®å›¾ä¹Ÿæ²¡äº†
            wheelSensitivity: 0.2, 
                    style: [
            // -----------------------------------------------------
            // 1. åŸºç¡€é»˜è®¤å€¼
            // -----------------------------------------------------
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'text-valign': 'center', 'text-halign': 'center',
                    'font-size': '12px', 'color': '#fff',
                    'text-wrap': 'wrap',
                    'border-width': 0, // é»˜è®¤æ— è¾¹æ¡†
                    'shape': 'round-rectangle',
                    'width': 'label', 'height': 'label', 'padding': '8px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'curve-style': 'straight',
                }
            },

            // -----------------------------------------------------
            // 2. èŠ‚ç‚¹é…è‰² (æ ¹æ®æ‚¨è¦æ±‚çš„é¢œè‰²)
            // -----------------------------------------------------
            
            // ã€ä¸»è¦ååº”ç‰©/äº§ç‰©ã€‘ï¼šç»¿è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.main-molecule',
                style: {
                    'background-color': 'data(color)', // ç”± sheet å†³å®š
                    'font-weight': 'bold',
                    'color': '#fff'
                }
            },

            // ã€å‰¯ååº”ç‰©ã€‘ï¼šæµ…è“è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.sub-reactant',
                style: {
                    'background-color': '#74b9ff', // æµ…è“
                    'font-size': '10px',
                    'padding': '5px'
                }
            },

            // ã€å‰¯ç”Ÿæˆç‰©ã€‘ï¼šæµ…ç´«è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.sub-product',
                style: {
                    'background-color': '#a29bfe', // æµ…ç´«
                    'font-size': '10px',
                    'padding': '5px'
                }
            },
            // ã€éšè—çš„å‰¯å°åˆ†å­/å‰¯è¿çº¿ã€‘ï¼šé»˜è®¤ä¸æ˜¾ç¤º
            {
                selector: '.hidden-side',
                style: {
                    'display': 'none'
                }
            },


            // ã€éšè—çš„è·¨è†œè¿è¾“è¾¹ã€‘ï¼šé»˜è®¤ä¸æ˜¾ç¤ºï¼Œç”±é€»è¾‘æ§åˆ¶æ˜¾ç¤º
            {
                selector: '.hidden-transport',
                style: {
                    'display': 'none'
                }
            },


            // ã€é…¶/ååº”èŠ‚ç‚¹ã€‘ï¼šæ— èƒŒæ™¯ï¼Œæµ…ç»¿è‰²è¾¹æ¡†
            {
                // ä½¿ç”¨ type é€‰æ‹©å™¨æˆ–è€… class é€‰æ‹©å™¨
                selector: 'node[type="reaction"]',
                style: {
                    'background-color': '#e5e5e5', // æµ…ç°è‰²èƒŒæ™¯
                    'background-opacity': 1,
                    'border-width': 0,
                    'color': '#000',               // é»‘è‰²å­—ä½“
                    'font-weight': 'normal',         // åŠ ç²—
                    'shape': 'ellipse',
                    'font-size': '11px',
                    'width': 'label', 'height': 'label', 'padding': '6px'
                }
            },

            // -----------------------------------------------------
            // 3. è¿çº¿é…è‰²ä¸ç®­å¤´ (é€»è¾‘æ ¸å¿ƒ)
            // -----------------------------------------------------

            // ã€æŒ‡å‘ååº”èŠ‚ç‚¹çš„è¾¹ (In)ã€‘ï¼šæµ…ç»¿è‰²ï¼Œæ— ç®­å¤´
            // åŒ¹é… data.type === 'in'
            {
                selector: 'edge[type="in"]',
                style: {
                    'line-color': '#C0C0C0',       // æµ…ç»¿è‰²
                    'target-arrow-shape': 'none',  // æ— ç®­å¤´
                    'width': 4           // çº¿æ›´ç²—ï¼Œç®­å¤´ä¹Ÿä¼šæ›´â€œæœ‰å­˜åœ¨æ„Ÿâ€
                }
            },

            // ã€ç¦»å¼€ååº”èŠ‚ç‚¹çš„è¾¹ (Out)ã€‘ï¼šç»¿è‰²ï¼Œæœ‰ç®­å¤´
            // åŒ¹é… data.type === 'out'
            {
                selector: 'edge[type="out"]',
                style: {
                    'line-color': '#CDCDCD',       // ç»¿è‰²
                    'target-arrow-shape': 'triangle', // ä¸‰è§’å½¢ç®­å¤´
                    'target-arrow-color': '#CDCDCD',
                    'arrow-scale': 1.6,   // è°ƒå¤§ç®­å¤´ï¼ˆé»˜è®¤å¤§æ¦‚æ˜¯ 1ï¼‰
                    'width': 4            // çº¿æ›´ç²—ï¼Œç®­å¤´ä¹Ÿä¼šæ›´â€œæœ‰å­˜åœ¨æ„Ÿâ€
                }
            },

            

            // ã€ç»†èƒå™¨è½¬è¿è¾¹ (Transport)ã€‘ï¼šç°è‰²è™šçº¿ï¼Œæ— ç®­å¤´ï¼ˆåŒååˆ†å­ä¸åŒç»†èƒå™¨ä¹‹é—´ï¼‰
            {
                selector: '.edge-transport',
                style: {
                    'line-color': '#CDCDCD',
                    'line-style': 'dashed',
                    'width': 2.0,
                    'target-arrow-shape': 'none',
                    'opacity': 1.0
                }
            },
// -----------------------------------------------------
            // 4. äº¤äº’é«˜äº®æ ·å¼ (ä¿æŒåŸæœ‰çš„åŠŸèƒ½)
            // -----------------------------------------------------
            {
                selector: ':selected',
                style: {
                    'background-color': '#e17055',
                    'line-color': '#e17055',
                    'target-arrow-color': '#e17055'
                }
            },
            {
                selector: '.dimmed',
                style: { 'opacity': 0.1, 'z-index': 0 }
            },
            {
                selector: '.highlighted',
                style: {
                    'opacity': 1,
                    // 'border-width': 3,
                    // 'border-color': '#d63031', // æœç´¢é«˜äº®çº¢æ¡†
                    'z-index': 999
                }
            },
            {
                selector: '.path-node',
                style: {
                    'border-width': 3,
                    'border-color': '#e67e22',
                    'z-index': 1000
                }
            },
            {
                selector: '.path-edge',
                style: {
                    'line-color': '#e67e22',
                    'width': 4,
                    'opacity': 0.9,
                    'z-index': 1000
                }
            },
            // ===========================================
            // [æ–°å¢] è°ƒæ§å› å­é€šè¿‡ classæ§åˆ¶æ˜¾ç¤ºéšè—
            // ===========================================
            {
                selector: '.hidden-reg',
                style: { 'display': 'none' }
            },

            {
                selector: 'node[nodeType="activator"]',
                style: {
                    'background-color': '#2e7d32',  /* æ›´æ·±çš„ç»¿è‰² */
                    'border-color': '#1b5e20',
                    'border-width': 2,
                    'color': '#ffffff',             /* ç™½è‰²æ–‡å­— */
                    'text-outline-color': '#2e7d32', /* æ–‡å­—æè¾¹å¢å¼ºå¯è¯»æ€§ */
                    'text-outline-width': 1,
                    'shape': 'round-rectangle',
                    'font-size': 12,                /* å­—ä½“ç¨å¤§ */
                    'font-weight': 'bold',
                    'width': 'label', 'height': 'label', 'padding': '8px',
                    'opacity': 1,                   /* å¼ºåˆ¶ä¸é€æ˜ */
                    'z-index': 1002                 /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
                }
            },
            // Inhibitor (æŠ‘åˆ¶å‰‚): æ·±çº¢è‰²èƒŒæ™¯ + ç™½è‰²æ–‡å­— + å¼ºä¸é€æ˜åº¦
            {
                selector: 'node[nodeType="inhibitor"]',
                style: {
                    'background-color': '#c62828',  /* æ›´æ·±çš„çº¢è‰² */
                    'border-color': '#b71c1c',
                    'border-width': 2,
                    'color': '#ffffff',             /* ç™½è‰²æ–‡å­— */
                    'text-outline-color': '#c62828',
                    'text-outline-width': 1,
                    'shape': 'round-rectangle',
                    'font-size': 12,
                    'font-weight': 'bold',
                    'width': 'label', 'height': 'label', 'padding': '8px',
                    'opacity': 1,
                    'z-index': 1002
                }
            },
            
            // æ¿€æ´»è¿çº¿: ç»¿è‰²å®çº¿ + ç²—ç»†è°ƒæ•´
            {
                selector: 'edge[interaction="activate"]',
                style: {
                    'line-color': '#4CAF50',
                    'target-arrow-color': '#4CAF50',
                    'target-arrow-shape': 'triangle',
                    'width': 3,
                    'opacity': 0.9,
                    'curve-style': 'bezier'
                }
            },
            // æŠ‘åˆ¶è¿çº¿: çº¢è‰²å®çº¿ + ç²—ç»†è°ƒæ•´
            {
                selector: 'edge[interaction="inhibit"]',
                style: {
                    'line-color': '#EF5350',
                    'target-arrow-color': '#EF5350',
                    'target-arrow-shape': 'tee',
                    'width': 3,
                    'opacity': 0.9,
                    'curve-style': 'bezier'
                }
            }
        ],

            // åˆå§‹æ”¾å®½é™åˆ¶ï¼Œé˜²æ­¢å¸ƒå±€è®¡ç®—æ—¶è¢«å¡ä½
            minZoom: 1e-50,
            maxZoom: 1e50,
            zoomingEnabled: true,
            panningEnabled: true,
            layout: { name: 'preset' }, // åˆå§‹ä¸è®¡ç®—å¸ƒå±€
            elements: [] 
        });

        // ==========================================
        // å…³é”®ä¿®å¤ï¼šåˆ†ç¦» èŠ‚ç‚¹(Node) å’Œ è¿çº¿(Edge)
        // ==========================================
        const allNodes = [];
        const edgesByPathway = {};
        const pathwayNames = [];

        allElements.forEach(ele => {
            // åˆ¤æ–­æ˜¯å¦ä¸ºèŠ‚ç‚¹ï¼ˆgroupä¸å†™é»˜è®¤æ˜¯nodesï¼Œæˆ–è€…åˆ¤æ–­ data.source æ˜¯å¦å­˜åœ¨ï¼‰
            // Cytoscape JSON ä¸­ï¼Œè¿çº¿é€šå¸¸æœ‰ data.source å’Œ data.target
            if (ele.group === 'nodes' || (!ele.data.source && !ele.data.target)) {
                allNodes.push(ele);
            } else {
                // è¿™æ˜¯ä¸€ä¸ªè¿çº¿ (Edge)
                const p = ele.data.pathway || 'Other';
                if (!edgesByPathway[p]) {
                    edgesByPathway[p] = [];
                    pathwayNames.push(p); // è®°å½•é€šè·¯å
                }
                edgesByPathway[p].push(ele);
            }
        });

        // 2. ç¬¬ä¸€æ­¥ï¼šå®‰å…¨æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹ (ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºèŠ‚ç‚¹ä¸ä¾èµ–åˆ«äºº)
        // ä¸ºäº†é˜²æ­¢ä¸€å¼€å§‹ä¹Ÿæ˜¯ä¹±çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåŠ è¿›å»ä½†ä¸é‡ç»˜ï¼Œæˆ–è€…é»˜é»˜åŠ è¿›å»
        window.cyGraph.add(allNodes);
        console.log(`å·²é¢„åŠ è½½ ${allNodes.length} ä¸ªèŠ‚ç‚¹ï¼Œé˜²æ­¢ä¾èµ–æŠ¥é”™ã€‚`);

        // 3. ç¬¬äºŒæ­¥ï¼šé€æ­¥åŠ è½½è¿çº¿ (åŠ¨ç”»è¿‡ç¨‹)
        let currentIndex = 0;

        function renderNextBatch() {
            try {
                // ç»“æŸæ¡ä»¶
                if (currentIndex >= pathwayNames.length) {
                    finishLoading();
                    return;
                }

                const pName = pathwayNames[currentIndex];
                const edgesBatch = edgesByPathway[pName];

                // æ›´æ–° UI
                const percent = Math.round(((currentIndex + 1) / pathwayNames.length) * 100);
                if(progressBar) progressBar.style.width = `${percent}%`;
                if(progressText) progressText.innerText = `æ­£åœ¨è¿æ¥: ${pName} (${currentIndex + 1}/${pathwayNames.length})`;

                // æ·»åŠ è¿™æ‰¹è¿çº¿
                if (edgesBatch && edgesBatch.length > 0) {
                    window.cyGraph.batch(() => {
                        window.cyGraph.add(edgesBatch);
                    });
                }

                currentIndex++;
                // ç»§ç»­ä¸‹ä¸€å¸§
                requestAnimationFrame(renderNextBatch);

            } catch (err) {
                console.error("åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè·³è¿‡è¯¥æ‰¹æ¬¡ç»§ç»­:", err);
                // å¦‚æœå‡ºé”™ï¼Œå¼ºåˆ¶ç»§ç»­ä¸‹ä¸€é¡¹ï¼Œé˜²æ­¢å¡æ­»
                currentIndex++;
                requestAnimationFrame(renderNextBatch);
            }
        }

    // 4. æ”¶å°¾å·¥ä½œ
function finishLoading() {
    const progressText = document.getElementById('progress-text');
    const loadingMask = document.getElementById('loading-mask');

    if(progressText) progressText.innerText = "Finalizing Layout...";
    
    // === å®‰å…¨ç½‘ 1ï¼šå¼ºåˆ¶å…œåº•è®¡æ—¶å™¨ ===
    // å¦‚æœ 8 ç§’åå¸ƒå±€è¿˜æ²¡æå®šï¼ˆæˆ–å¡æ­»äº†ï¼‰ï¼Œå¼ºåˆ¶ç§»é™¤é®ç½©ï¼Œé˜²æ­¢ç”¨æˆ·ä¸€ç›´çœ‹ç™½å±
    const safetyTimer = setTimeout(() => {
        if (loadingMask && loadingMask.style.display !== 'none') {
            console.warn("Layout took too long or failed silently. Forcing mask removal.");
            loadingMask.style.display = 'none';
        }
    }, 8000);

    setTimeout(() => {
        const cy = window.cyGraph;

        // å°è¯•è‡ªåŠ¨æ¢å¤ä¸Šä¸€æ¬¡å¸ƒå±€
        let restored = false;
        let savedPositions = null;

try {
  // å…ˆä»æœ¬åœ°ç¼“å­˜æ¢å¤
  const raw = localStorage.getItem(STORAGE_KEY_AUTO);
  if (raw) {
    savedPositions = JSON.parse(raw);
  }
  if (savedPositions) {
    restored = restoreLayoutAuto(); // è¿™ä¸ªå‡½æ•°ä¼šæŠŠä½ç½®åº”ç”¨åˆ°å›¾ä¸Š
  }
} catch (e) {
  console.warn("Auto-restore layout failed:", e);
}

        // å®šä¹‰å¸ƒå±€å‚æ•°
        const layoutConfig = {
            name: restored ? 'preset' : 'dagre',
            rankDir: 'TB',
            padding: 50,
            fit: true,
            animate: false
        };

        // æ’é™¤å‰¯åˆ†å­ï¼Œåªå¯¹éª¨å¹²è¿›è¡Œå¸ƒå±€
        // æ³¨æ„ï¼šå¦‚æœä¸å°å¿ƒæ²¡é€‰åˆ°ä»»ä½•å…ƒç´ ï¼ˆæ¯”å¦‚ç©ºå›¾ï¼‰ï¼Œlayoutstop å¯èƒ½ä¸ä¼šè§¦å‘
        // æ‰€ä»¥æˆ‘ä»¬è¦åšä¸ªåˆ¤æ–­
        const backboneEles = cy.elements().not('.side-molecule, .edge-side, .hidden-reg');
        
        // å¦‚æœå›¾æ˜¯ç©ºçš„ï¼Œç›´æ¥æ‰‹åŠ¨ç§»é™¤é®ç½©
        if (backboneEles.length === 0 && cy.elements().length === 0) {
            loadingMask.style.display = 'none';
            clearTimeout(safetyTimer);
            return;
        }
        // === æ–°å¢ï¼šæŠŠâ€œå•è¿›å•å‡ºâ€çš„ååº”èŠ‚ç‚¹æ”¾åˆ°ä¸­ç‚¹ ===
// === æ–°å¢ï¼šä»…åœ¨ã€Œæœªä¿å­˜è¿‡ä½ç½®ã€æ—¶ï¼Œä¸ºååº”èŠ‚ç‚¹åº”ç”¨ä¸­ç‚¹ ===
// å¦‚æœæ²¡æœ‰ savedPositionsï¼Œåˆ™å¯¹æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ååº”èŠ‚ç‚¹åº”ç”¨ä¸­ç‚¹
try {
  if (!savedPositions || Object.keys(savedPositions).length === 0) {
    applyReactionMidpoints(cy, null);
  } else {
    // å³ä½¿æœ‰ä¿å­˜ä½ç½®ï¼Œä¹Ÿå¯ä»¥ç»™ã€Œæœªä¿å­˜è¿‡çš„ååº”èŠ‚ç‚¹ã€åº”ç”¨ä¸­ç‚¹
    // ï¼ˆä¾‹å¦‚æ–°åŠ å…¥çš„æ•°æ®æ²¡æœ‰å†å²ä½ç½®ï¼‰
    applyReactionMidpoints(cy, savedPositions);
  }
} catch (e) {
  console.warn("applyReactionMidpoints failed:", e);
}

        const layout = backboneEles.length > 0 ? backboneEles.layout(layoutConfig) : cy.layout({ name: 'grid' });

        layout.on('layoutstop', () => {
            // æ¸…é™¤å¼ºåˆ¶å…œåº•è®¡æ—¶å™¨ï¼ˆå› ä¸ºæˆ‘ä»¬ç°åœ¨æ­£å¸¸ç»“æŸäº†ï¼‰
            clearTimeout(safetyTimer);

            // === å®‰å…¨ç½‘ 2ï¼šå°†é€»è¾‘åŒ…è£¹åœ¨ try-catch ä¸­ ===
            try {
                // 1. ç»‘å®šäº¤äº’
                if (typeof bindSideInteractionsOnce === 'function') bindSideInteractionsOnce();
                
                // 3. å¼ºåˆ¶æ’åˆ—å‰¯åˆ†å­
                if (typeof alignSideNodes === 'function') {
                    alignSideNodes(); 
                }
                // 2. åˆ·æ–°å¯è§æ€§
                if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
                if (typeof refreshTransportVisibility === 'function') refreshTransportVisibility();


                // 4. ç­›é€‰å™¨é€»è¾‘
                if (typeof filterGraph === 'function') filterGraph();
                
                // 5. é”å®šä¸é€‚é…
                cy.autoungrabify(true);
                const editToggle = document.getElementById('edit-mode-toggle');
                if(editToggle) editToggle.checked = false;
                
                cy.fit(cy.elements(), 50);

                // [æ–°å¢] åˆå§‹åŒ–ç»†èƒå™¨å›¾ç‰‡è¦†ç›–å±‚ï¼ˆåªåšä¸€æ¬¡ï¼‰
                try { initOrganelleOverlayOnce(cy); } catch(e){ console.warn('init organelles failed', e); }


                // 6. è‡ªåŠ¨ä¿å­˜
                if (typeof autoSaveLayoutDebounced === 'function') autoSaveLayoutDebounced();

                // 7. è®¾ç½®ç¼©æ”¾é™åˆ¶
                try {
                    const fitZoom = cy.zoom();
                    cy.minZoom(fitZoom * 0.5);
                    cy.maxZoom(fitZoom * 500);
                } catch(zErr) { console.warn("Zoom setup error", zErr); }

            } catch (err) {
                // å¦‚æœä¸Šé¢ä»»ä½•ä¸€æ­¥æŠ¥é”™ï¼Œè¿™é‡Œä¼šæ•è·ï¼Œå¹¶æ‰“å°çº¢è‰²é”™è¯¯ï¼Œä½†ä¸ä¼šé˜»æ­¢é®ç½©æ¶ˆé™¤
                console.error("Critical error during layout post-processing:", err);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾å¼æç¤ºç”¨æˆ·
                // alert("å¸ƒå±€å¤„ç†å‡ºç°é”™è¯¯ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ï¼Œè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                // === æ— è®ºæˆåŠŸè¿˜æ˜¯æŠ¥é”™ï¼Œè¿™é‡Œéƒ½ä¼šæ‰§è¡Œ ===
                if(loadingMask) {
                    loadingMask.style.opacity = '0';
                    setTimeout(() => {
                        loadingMask.style.display = 'none';
                    }, 500);
                }
            }
        });

        // å¼€å§‹è¿è¡Œå¸ƒå±€
        try {
            layout.run();
        } catch (runErr) {
            console.error("Layout run failed:", runErr);
            // å¦‚æœè¿ layout.run éƒ½å´©äº†ï¼Œæ‰‹åŠ¨éšè—é€»è¾‘
            loadingMask.style.display = 'none';
        }
        
        if(typeof initSearchListener === 'function') initSearchListener();

    }, 100);
}



        // å¯åŠ¨å¾ªç¯
        renderNextBatch();
    }




    // ============================================================
    // 3. æ ¸å¿ƒç®—æ³•ï¼šç²¾ç¡®å‡ ä½•å®šä½ + æ··åˆçº¿å‹ (recalculateCurves)
    // ============================================================
    const recalculateCurves = () => {
    };

    // ============================================================
    // 4. å³ä¾§ç­›é€‰é€»è¾‘ (Filter)
    // ============================================================
    function generateCheckboxes(pathwaysBySheet) {
        const container = document.getElementById('filter-container');
        container.innerHTML = '';

        // Global Select All
        const globalDiv = document.createElement('label');
        globalDiv.className = 'checkbox-item';
        globalDiv.innerHTML = `<input type="checkbox" id="check-all-global" checked> <b>(Select All)</b>`;
        container.appendChild(globalDiv);

        // Clear selected side-molecules (only from reaction selection)
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clear-selected-side';
        clearBtn.className = 'side-action-btn';
        clearBtn.textContent = 'Clear selected molecules';
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.selectedReactionIds) window.selectedReactionIds.clear();
            refreshSideVisibility();
        });
        container.appendChild(clearBtn);


        const buildSheetGroup = (sheetName) => {
            const group = document.createElement('div');
            group.className = 'sheet-group collapsed';// é»˜è®¤æŠ˜å 

            const header = document.createElement('div');
            header.className = 'sheet-header';
            // === ä¿®æ”¹ï¼šHeaderå†…éƒ¨ç»“æ„ ===
            // å·¦ä¾§ï¼šè‰²å— + åå­—
            const leftHtml = `
                <div class="sheet-name">
                    <span class="sheet-swatch" style="background:${SHEET_COLORS[sheetName] || '#95a5a6'}"></span>
                    <span>${sheetName}</span>
                </div>`;
            
            // å³ä¾§ï¼šå…¨é€‰æ¡† + ç®­å¤´
            const rightPart = document.createElement('div');
            rightPart.style.display = 'flex'; 
            rightPart.style.alignItems = 'center';

            const selectAll = document.createElement('label');
            selectAll.className = 'checkbox-item sheet-selectall';
            selectAll.innerHTML = `<input type="checkbox" class="check-all-sheet" data-sheet="${sheetName}" checked> <b>(Select All)</b>`;
            selectAll.onclick = (e) => e.stopPropagation(); // å…³é”®ï¼šé˜²æ­¢ç‚¹å‡»å¤é€‰æ¡†æ—¶è§¦å‘æŠ˜å 

            // ç®­å¤´å›¾æ ‡
            const arrow = document.createElement('span');
            arrow.className = 'sheet-arrow';
            arrow.innerText = 'â–¼'; // æˆ–ç”¨ SVG

            rightPart.appendChild(selectAll);
            rightPart.appendChild(arrow);
            
            header.innerHTML = leftHtml;
            header.appendChild(rightPart);

            // === ä¿®æ”¹ï¼šæ·»åŠ æŠ˜å ç‚¹å‡»äº‹ä»¶ ===
            header.onclick = () => {
                group.classList.toggle('collapsed');
            };

            const body = document.createElement('div');
            body.className = 'sheet-body';

            group.appendChild(header);
            group.appendChild(body);

            return { group, body, selectAllInput: selectAll.querySelector('input') };
        };

        // Render groups in TARGET_SHEETS order
        const sheetGroups = new Map();
        TARGET_SHEETS.forEach(sheet => {
            const { group, body, selectAllInput } = buildSheetGroup(sheet);
            sheetGroups.set(sheet, { body, selectAllInput });
            container.appendChild(group);
        });

        // Fill pathways (keep sheet order as collected)
        TARGET_SHEETS.forEach(sheet => {
            const list = (pathwaysBySheet && pathwaysBySheet.get) ? (pathwaysBySheet.get(sheet) || []) : [];
            const { body } = sheetGroups.get(sheet) || {};
            if (!body) return;

            if (!list || list.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#999;font-size:12px;padding:4px 6px;font-style:italic;';
                empty.textContent = 'ï¼ˆæ—  Pathwayï¼‰';
                body.appendChild(empty);
                return;
            }

            list.forEach(pw => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = '';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'pw-check';
                cb.value = pw;
                cb.dataset.sheet = sheet;
                cb.checked = true;

                const text = document.createElement('span');
                text.className = 'pw-text';
                text.textContent = pw;

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'side-toggle-btn';
                btn.dataset.pathway = pw;
                btn.textContent = 'Demonstrate currency';
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const p = btn.dataset.pathway;
                    if (!window.pinnedSidePathways) window.pinnedSidePathways = new Set();
                    if (window.pinnedSidePathways.has(p)) {
                        window.pinnedSidePathways.delete(p);
                        btn.classList.remove('active');
                    } else {
                        window.pinnedSidePathways.add(p);
                        btn.classList.add('active');
                    }
                    refreshSideVisibility();
                });

                label.appendChild(cb);
                label.appendChild(text);
                label.appendChild(btn);
                body.appendChild(label);
            });
        });

        const allPwChecks = () => Array.from(container.querySelectorAll('.pw-check'));
        const updateGlobalState = () => {
            const boxes = allPwChecks();
            const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
            document.getElementById('check-all-global').checked = allChecked;
        };
        const updateSheetState = (sheet) => {
            const boxes = allPwChecks().filter(cb => cb.dataset.sheet === sheet);
            const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
            const g = sheetGroups.get(sheet);
            if (g && g.selectAllInput) g.selectAllInput.checked = allChecked;
        };

        // Bind global select all
        globalDiv.querySelector('input').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            allPwChecks().forEach(cb => cb.checked = isChecked);
            TARGET_SHEETS.forEach(updateSheetState);
            filterGraph();
        });

        // Bind per-sheet select all
        TARGET_SHEETS.forEach(sheet => {
            const g = sheetGroups.get(sheet);
            if (!g) return;
            g.selectAllInput.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                allPwChecks()
                    .filter(cb => cb.dataset.sheet === sheet)
                    .forEach(cb => cb.checked = isChecked);
                updateGlobalState();
                filterGraph();
            });
        });

        // Bind per-pathway
        allPwChecks().forEach(cb => {
            cb.addEventListener('change', () => {
                updateSheetState(cb.dataset.sheet);
                updateGlobalState();
                filterGraph();
            });
        });

        // Initial state
        TARGET_SHEETS.forEach(updateSheetState);
        updateGlobalState();
        setTimeout(filterGraph, 100);
    }


    
    // æ ¹æ®å½“å‰é€‰ä¸­çš„ Pathwayï¼ŒåŠ¨æ€åˆ·æ–°ä¸»å¹²åˆ†å­ï¼ˆMain Reactant / Main Productï¼‰çš„é¢œè‰²
    function updateMainMoleculeColors(selectedPathways) {
        const cy = window.cyGraph || window.cy;
        const metaMap = window.mainMoleculeMeta;
        if (!cy || !metaMap) return;

        cy.nodes('.main-molecule').forEach(n => {
            const meta = metaMap.get(n.data('baseName') || n.id());
            if (!meta) return;

            // è‹¥é€‰ä¸­äº† Pathwayï¼šä¼˜å…ˆç”¨è¯¥åˆ†å­åœ¨â€œè¢«é€‰ä¸­ Pathwayâ€å¯¹åº”çš„ sheet é¢œè‰²
            if (selectedPathways && selectedPathways.length > 0) {
                const candidate = new Set();
                selectedPathways.forEach(pw => {
                    const sset = meta.pathwaySheets.get(pw);
                    if (sset) sset.forEach(s => candidate.add(s));
                });
                if (candidate.size > 0) {
                    n.data('color', pickSheetColor(candidate));
                    return;
                }
            }

            // å¦åˆ™ï¼šæŒ‰åˆ†å­å…¨å±€å‡ºç°çš„ sheets å–é»˜è®¤é¢œè‰²ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
            n.data('color', pickSheetColor(meta.sheets));
        });
    }

    function filterGraph() {
        const currentCy = window.cyGraph || window.cy;
        if (!currentCy) return;

        const checkboxes = document.querySelectorAll('.pw-check');
        // è·å–å…¨å±€å…¨é€‰æŒ‰é’®çš„çŠ¶æ€
        const globalCheckbox = document.getElementById('check-all-global');
        const isGlobalChecked = globalCheckbox && globalCheckbox.checked;

        const selectedPathways = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // è®°å½•å½“å‰å‹¾é€‰çš„ pathway
        window.__selectedPathwaysSet = new Set(selectedPathways);

        currentCy.batch(() => {
            const allElements = currentCy.elements();
            
            // === ä¿®æ”¹æ ¸å¿ƒå¼€å§‹ï¼šå¦‚æœæ˜¯å…¨é€‰çŠ¶æ€ï¼Œæˆ–è€…å…¨éƒ¨éƒ½å‹¾é€‰äº† ===
            if (isGlobalChecked || selectedPathways.length === checkboxes.length) {
                // ç›´æ¥ç§»é™¤æ‰€æœ‰ç‰¹æ®Šæ ·å¼ç±»ï¼Œæ¢å¤å›¾è¡¨é»˜è®¤çš„æ¸…æ™°çŠ¶æ€
                allElements.removeClass('dimmed highlighted');
                // æ¢å¤é»˜è®¤é¢œè‰²
                updateMainMoleculeColors(selectedPathways);
            } 
            else if (selectedPathways.length === 0) {
                // å¦‚æœä»€ä¹ˆéƒ½æ²¡é€‰ï¼šå…¨éƒ¨å˜æš—
                allElements.removeClass('highlighted').addClass('dimmed');
                updateMainMoleculeColors([]);
            } 
            else {
                // æ™®é€šç­›é€‰çŠ¶æ€ï¼šå…ˆå…¨éƒ¨å˜æš—
                allElements.removeClass('highlighted').addClass('dimmed');

                // æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¾¹
                const activeEdges = currentCy.edges().filter(edge => {
                    const pData = edge.data('pathway');
                    if (!pData) return false;
                    return selectedPathways.includes(pData);
                });

                // é«˜äº®ç¬¦åˆæ¡ä»¶çš„è¾¹åŠå…¶è¿æ¥çš„èŠ‚ç‚¹
                activeEdges.removeClass('dimmed').addClass('highlighted');
                activeEdges.connectedNodes().removeClass('dimmed').addClass('highlighted');
                
                // æ›´æ–°é¢œè‰²
                updateMainMoleculeColors(selectedPathways);
            }
            // === ä¿®æ”¹æ ¸å¿ƒç»“æŸ ===
        });

        // åˆ·æ–°å…³è”çš„å‰¯å°åˆ†å­å’Œè·¨è†œè¿è¾“è¾¹
        refreshSideVisibility();
        refreshTransportVisibility();
    }


    // è¾…åŠ©å·¥å…·
    function showStatus(msg) { document.getElementById('status').innerText = msg; }
    function updateStatus(text) { document.getElementById('status').innerText = text; }

    // ============================================================
    // 4b. å‰¯å°åˆ†å­æ˜¾ç¤ºé€»è¾‘ï¼šé»˜è®¤éšè—ï¼ŒæŒ‰éœ€å›´ç»•é…¶èŠ‚ç‚¹å±•å¼€
    // ============================================================
    function refreshSideVisibility() {
        const cy = window.cyGraph;
        if (!cy) return;

        const selectedPathways = window.__selectedPathwaysSet || new Set();
        const pinned = window.pinnedSidePathways || new Set();
        const selectedRxns = window.selectedReactionIds || new Set();

        cy.batch(() => {
            // å…ˆå…¨éƒ¨éšè—
            cy.nodes('.side-molecule').addClass('hidden-side');
            cy.edges('.edge-side').addClass('hidden-side');

            // å†æŒ‰â€œå›ºå®šæ‰“å¼€çš„ pathwayâ€æ˜¾ç¤º
            cy.nodes('[type="reaction"]').forEach(rxn => {
                const pw = rxn.data('pathway');
                if (!pw) return;
                // åªåœ¨è¯¥ pathway ä»ç„¶è¢«å‹¾é€‰æ—¶å±•å¼€ï¼ˆé¿å…ä¸è¿‡æ»¤å†²çªï¼‰
                if (pinned.has(pw) && (selectedPathways.size === 0 || selectedPathways.has(pw))) {
                    showSideForReaction(rxn.id());
                }
            });

            // å†æŒ‰â€œç‚¹é€‰çš„ååº”â€æ˜¾ç¤ºï¼ˆå…è®¸å¤šä¸ªå…±å­˜ï¼‰
            selectedRxns.forEach(rxnId => {
                showSideForReaction(rxnId);
            });
        });

        // æ˜¾ç¤ºåå†ç»Ÿä¸€å¯¹é½ï¼Œé¿å…æ•£è½/é‡å 
        alignSideNodes();
    }

function refreshTransportVisibility() {
    const cy = window.cyGraph;
    if (!cy) return;

    const selectedPathways = window.__selectedPathwaysSet || new Set();
    const globalCheckbox = document.getElementById('check-all-global');
    const isGlobalAllChecked = !!(globalCheckbox && globalCheckbox.checked);

    cy.batch(() => {
        const allTransEdges = cy.edges('.edge-transport');

        // å…ˆå…¨éƒ¨æ˜¾ç¤ºï¼Œå†æŒ‰è§„åˆ™å»â€œæ‰“éšè—æ ‡è®°â€
        allTransEdges.removeClass('hidden-transport');

        // æƒ…å†µ 1ï¼šå…¨é€‰çŠ¶æ€ - æ‰€æœ‰è·¨è†œè¾¹éƒ½æ˜¾ç¤ºä¸ºæµ…ç°è™šçº¿
        if (isGlobalAllChecked) {
            // å…¨é€‰æ—¶ filterGraph å·²ç»æ¸…é™¤äº† dimmedï¼Œè¿™é‡Œåªéœ€ç¡®ä¿ display æ­£å¸¸
            return;
        }

        // æƒ…å†µ 2ï¼šæ²¡æœ‰ä»»ä½• Pathway è¢«é€‰ä¸­ - å…¨éƒ¨éšè—
        if (!selectedPathways || selectedPathways.size === 0) {
            allTransEdges.addClass('hidden-transport');
            return;
        }

        // å°å·¥å…·ï¼šåˆ¤æ–­ä¸€ä¸ªåˆ†å­èŠ‚ç‚¹æ˜¯å¦â€œå‚ä¸äº†é€‰ä¸­ Pathwayâ€
        const inSelectedPathway = (node) => {
            let flag = false;
            node.neighborhood('node[type="reaction"]').forEach(rxn => {
                if (flag) return;
                const pw = rxn.data('pathway');
                if (pw && selectedPathways.has(pw)) {
                    flag = true;
                }
            });
            return flag;
        };

        // æƒ…å†µ 3ï¼šéƒ¨åˆ† Pathway è¢«é€‰ä¸­ - åªæœ‰ä¸¤ç«¯éƒ½â€œå±äºé€‰ä¸­ Pathwayâ€çš„æ‰æ˜¾ç¤º
        allTransEdges.forEach(edge => {
            const src = edge.source();
            const tgt = edge.target();

            const srcOk = inSelectedPathway(src);
            const tgtOk = inSelectedPathway(tgt);

            if (!(srcOk && tgtOk)) {
                edge.addClass('hidden-transport');
            }
        });

        // è®©å¯è§çš„è·¨è†œè¿è¾“è¾¹ä¸å— filterGraph çš„ dimmed å½±å“ï¼ˆå¦åˆ™çœ‹èµ·æ¥åƒæ²¡ç”»å‡ºæ¥ï¼‰
        allTransEdges.filter(':visible').removeClass('dimmed');
    });
}


function showSideForReaction(rxnId) {
        const cy = window.cyGraph;
        if (!cy) return;

        // side nodes çš„ id éƒ½ä»¥ `${rxnId}_side_` å¼€å¤´
        cy.nodes('.side-molecule').forEach(n => {
            if (n.id().startsWith(`${rxnId}_side_`)) {
                n.removeClass('hidden-side');
            }
        });

        // side edgesï¼šè¿æ¥ååº”èŠ‚ç‚¹ä¸ side node
        cy.edges('.edge-side').forEach(e => {
            const s = e.data('source');
            const t = e.data('target');
            if ((typeof s === 'string' && s.startsWith(`${rxnId}_side_`)) ||
                (typeof t === 'string' && t.startsWith(`${rxnId}_side_`))) {
                e.removeClass('hidden-side');
            }
        });
    }

        // ============================================================
    // ç‚¹å‡»äº¤äº’ä¸ä¿¡æ¯é¢æ¿æ¸²æŸ“
    // ============================================================
    function bindSideInteractionsOnce() {
        const cy = window.cyGraph;
        if (!cy) return;
        if (cy.__sideBound) return;
        cy.__sideBound = true;

        const panel = document.getElementById('hover-info-panel');

        // è¾…åŠ©å‡½æ•°ï¼šå°†æ¢è¡Œç¬¦è½¬ä¸ºHTMLæ¢è¡Œï¼Œç©ºå€¼å¤„ç†
        const formatMultiLine = (text) => {
            if (!text) return 'None';
            // å°† \n æ›¿æ¢ä¸º <br/>ï¼Œå¹¶ä¸ºäº†ç¾è§‚ï¼Œå¯ä»¥åœ¨å¤šè¡Œä¹‹é—´åŠ ä¸ªåˆ†éš”çº¿
            return String(text).replace(/\n/g, '<br/><span style="display:block;height:4px;border-bottom:1px dashed #eee;margin:4px 0;"></span>');
        };

        cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            const data = node.data();

            // [æ–°å¢] è°ƒæ§å› å­äº¤äº’é€»è¾‘
            // 1. å¦‚æœç‚¹å‡»çš„æ˜¯è°ƒæ§å› å­æœ¬èº«ï¼Œä¸åšä»»ä½•å¤„ç† (é˜²æ­¢æŠ¥é”™)
            if (data.nodeType === 'activator' || data.nodeType === 'inhibitor') return;

            // ã€äº’æ–¥é€»è¾‘ 2ã€‘ï¼šä¸€æ—¦ç‚¹å‡»ç”»å¸ƒèŠ‚ç‚¹æ‰“å¼€æ™®é€š Info Panelï¼Œç«‹å³å…³é—­ Regulation Overlay
            closeRegulationOverlay(); 
            // 2. åªæœ‰å¼€å¯äº† Regulation Mode æ—¶æ‰å¤„ç†
            const isRegMode = document.getElementById('regulation-toggle') && document.getElementById('regulation-toggle').checked;
            
            // å…ˆéšè—æ‰€æœ‰æ­¤æ—¶å±•ç¤ºçš„è°ƒæ§å› å­ (ä¿æŒç”»é¢å¹²å‡€ï¼Œåªæ˜¾ç¤ºå½“å‰)
            cy.elements('.reg-node').addClass('hidden-reg'); // å‡è®¾ä¹‹å‰åŠ äº† helper class
            cy.elements('.reg-edge').addClass('hidden-reg'); 
            // ä¹Ÿå¯ä»¥ç”¨ selector: cy.nodes('[nodeType="activator"], [nodeType="inhibitor"]').style('display', 'none');

            if (isRegMode && data.type === 'reaction') {
                // æŸ¥æ‰¾å±äºå½“å‰ååº”çš„è°ƒæ§å› å­
                // é€»è¾‘ï¼šæ‰¾åˆ° target æ˜¯å½“å‰ååº”ï¼Œä¸” interaction æ˜¯ activate æˆ– inhibit çš„è¾¹ -> è·å–æºèŠ‚ç‚¹
                const connectedEdges = node.incomers('edge[interaction="activate"], edge[interaction="inhibit"]');
                const connectedNodes = connectedEdges.sources();

                if (connectedNodes.length > 0) {
                    // æ˜¾ç¤º
                    connectedNodes.removeClass('hidden-reg').style('display', 'element');
                    connectedEdges.removeClass('hidden-reg').style('display', 'element');

                    // ç®€å•å¸ƒå±€ï¼šå›´ç»•åœ†å½¢æ’åˆ—
                    const center = node.position();
                    const r = 60; 
                    connectedNodes.forEach((child, i) => {
                        const angle = i * (2 * Math.PI / connectedNodes.length) - Math.PI / 2;
                        child.position({
                            x: center.x + r * Math.cos(angle),
                            y: center.y + r * Math.sin(angle)
                        });
                    });
                    showAndLayoutRegulators(node);
                }
            }
            

            let html = '';

             // ç”¨äºåç»­å¼‚æ­¥ç»˜åˆ¶ SMILES çš„å›è°ƒ
            let drawSmilesCallback = null;

            // å…³é—­æŒ‰é’®
            html += `<div class="panel-close-btn" onclick="document.getElementById('hover-info-panel').style.display='none'">&times;</div>`;

            if (data.type === 'reaction') {
                // 1. Reaction Formula (æ”¯æŒæ¢è¡Œ)
                if(data.infoFormula) {
                    html += `
                    <div class="info-section">
                        <div class="info-title">Reaction Equation</div>
                        <div class="info-content formula-text">${formatMultiLine(data.infoFormula)}</div>
                    </div>`;
                }
                
                // 2. Enzyme Name
                if(data.infoEnzyme) {
                    html += `<div class="info-section"><div class="info-title">Enzyme</div><div class="info-content">${data.infoEnzyme}</div></div>`;
                }
                // === æ–°å¢ï¼šåŒ¹é… Enzyme EC ä¿¡æ¯ ===
                // ä½¿ç”¨ rawEnzyme è¿›è¡ŒåŒ¹é…
                if (data.rawEnzyme && window.refData.enzymes.has(data.rawEnzyme)) {
                    const info = window.refData.enzymes.get(data.rawEnzyme);
                    const ecCode = info.ec || 'N/A';
                    const linkUrl = info.link;
                    
                    let extraHtml = `<div class="info-section"><div class="info-title">EC Code</div><div class="info-content" style="font-family:monospace; font-weight:bold;">${ecCode}</div>`;
                    
                    if (linkUrl && linkUrl !== '0') {
                        extraHtml += `<div style="margin-top:4px;"><a href="${linkUrl}" target="_blank" style="color:#2196F3;text-decoration:none;font-size:12px;">ğŸ”— View Database &rarr;</a></div>`;
                    }
                    extraHtml += `</div>`;
                    html += extraHtml;
                }
                // 3. Description (æ”¯æŒæ¢è¡Œ)
                const desc = (data.infoDesc && data.infoDesc !== '0') ? formatMultiLine(data.infoDesc) : null;
                if (desc) {
                    html += `<div class="info-section"><div class="info-title">Description</div><div class="info-content">${desc}</div></div>`;
                }

                // 4. Coenzyme (æ–°å¢ï¼Œæ”¯æŒæ¢è¡Œ)
                const coe = (data.infoCoenzyme && data.infoCoenzyme !== '0') ? formatMultiLine(data.infoCoenzyme) : null;
                if (coe) {
                    html += `<div class="info-section"><div class="info-title">Coenzyme</div><div class="info-content" style="color:#d63031;">${coe}</div></div>`;
                }
                
                // 5. Pathway
                html += `<div class="info-section"><div class="info-title">Pathway</div><div class="info-content" style="color:#0984e3;">${data.pathway}</div></div>`;

                // äº¤äº’ï¼šä¿æŒç‚¹å‡»ååº”å±•å¼€å‰¯äº§ç‰©çš„é€»è¾‘
                const id = node.id();
                if (!window.selectedReactionIds) window.selectedReactionIds = new Set();
                if (window.selectedReactionIds.has(id)) window.selectedReactionIds.delete(id);
                else window.selectedReactionIds.add(id);
                refreshSideVisibility();
                setTimeout(alignSideNodes, 50);

            } else if (data.type === 'molecule') {
                // ç‰©è´¨èŠ‚ç‚¹ä¿¡æ¯
                html += `<div class="info-section"><div class="info-title">Molecule</div><div class="info-content"><b>${data.label}</b></div></div>`;
                
                // === æ–°å¢ï¼šæŸ¥æ‰¾å¹¶æ˜¾ç¤ºç‰©è´¨æ‰€å±çš„ Pathway ===
                // ä»å…¨å±€å…ƒæ•°æ®ä¸­è·å–è¯¥ç‰©è´¨åå¯¹åº”çš„ Pathway é›†åˆ
                const meta = window.mainMoleculeMeta ? window.mainMoleculeMeta.get(data.baseName || data.label) : null;
                let pathwayStr = 'Unknown';
                
                if (meta && meta.pathwaySheets) {
                    // meta.pathwaySheets æ˜¯ä¸€ä¸ª Map<PathwayName, Set<SheetName>>
                    const pathways = Array.from(meta.pathwaySheets.keys());
                    if (pathways.length > 0) {
                        // ç”¨æ ‡ç­¾æ ·å¼æ˜¾ç¤ºå¤šä¸ª Pathway
                        pathwayStr = pathways.map(p => 
                            `<span style="display:inline-block;background:#e1f5fe;color:#0277bd;padding:2px 6px;border-radius:4px;margin:2px;font-size:11px;">${p}</span>`
                        ).join('');
                    }
                } else if (data.pathway) {
                    // Fallback: å¦‚æœæ˜¯å‰¯äº§ç‰©èŠ‚ç‚¹ï¼Œå¯èƒ½ç›´æ¥å°±æœ‰ pathway å±æ€§
                    pathwayStr = `<span style="background:#e1f5fe;color:#0277bd;padding:2px 6px;border-radius:4px;">${data.pathway}</span>`;
                }

                html += `<div class="info-section"><div class="info-title">Belongs to Pathway</div><div class="info-content">${pathwayStr}</div></div>`;
            }

            // === æ–°å¢ï¼šåŒ¹é… Molecule SMILES ä¿¡æ¯ ===
                // ä½¿ç”¨ baseName (å³åŸå§‹ Substance åç§°) è¿›è¡ŒåŒ¹é…
                const rawName = data.baseName ? data.baseName.trim() : '';
                if (window.refData.molecules.has(rawName)) {
                    const info = window.refData.molecules.get(rawName);
                    
                    // 1. ç»“æ„å¼ (Canvas)
                    if (info.smiles && info.smiles !== '0') {
                        html += `
                        <div class="info-section">
                            <div class="info-title">Structure</div>
                            <div style="background:#fff; border:1px solid #eee; border-radius:4px; padding:5px; text-align:center;">
                                <canvas id="smiles-canvas" width="280" height="150"></canvas>
                            </div>
                        `;
                        // è®¾ç½®å›è°ƒï¼Œå¿…é¡»ç­‰ innerHTML è®¾ç½®å®Œåæ‰èƒ½è·å– canvas ä¸Šä¸‹æ–‡
                    drawSmilesCallback = () => {
                        const canvas = document.getElementById('smiles-canvas');
                        // æ£€æŸ¥ RDKit æ˜¯å¦åŠ è½½å®Œæˆ
                        if (canvas && window.rdkitModule) {
                            try {
                                // 1. åˆ›å»ºåˆ†å­å¯¹è±¡
                                const mol = window.rdkitModule.get_mol(info.smiles);
                                
                                if (mol) {
                                    // 2. ç»˜åˆ¶åˆ° Canvas
                                    // draw_to_canvas(canvas_dom, width, height)
                                    // ä¼  -1 è¡¨ç¤ºä½¿ç”¨ canvas è‡ªèº«çš„å®½é«˜
                                    mol.draw_to_canvas(canvas, -1, -1);
                                    
                                    // 3. ã€é‡è¦ã€‘é‡Šæ”¾ WASM å†…å­˜
                                    mol.delete();
                                } else {
                                    // åˆ†å­è§£æå¤±è´¥å¤„ç†
                                    const ctx = canvas.getContext('2d');
                                    ctx.font = "12px Arial";
                                    ctx.fillStyle = "red";
                                    ctx.fillText("Invalid Structure", 10, 50);
                                }
                            } catch(err) {
                                console.warn('RDKit draw error:', err);
                            }
                        } else if (canvas && !window.rdkitModule) {
                            // RDKit è¿˜æ²¡åŠ è½½å®Œçš„æƒ…å†µ
                            const ctx = canvas.getContext('2d');
                            ctx.fillText("Loading Lib...", 10, 50);
                        }
                    };
                    }
                    
                    // 2. å¤–éƒ¨é“¾æ¥
                    if (info.link && info.link !== '0') {
                         html += `<div style="margin-top:6px;"><a href="${info.link}" target="_blank" style="color:#2196F3;text-decoration:none;font-weight:bold;font-size:12px;">ğŸ”— View Substance Info &rarr;</a></div>`;
                    }
                    
                    if (info.smiles) html += `</div>`; // Close info-section
                }

            panel.innerHTML = html;
            panel.style.display = 'block';

            // å¦‚æœéœ€è¦ç»˜åˆ¶ç»“æ„å¼ï¼Œåœ¨ DOM æ¸²æŸ“åæ‰§è¡Œ
            if (drawSmilesCallback) {
                // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²æ›´æ–°
                setTimeout(drawSmilesCallback, 0);
                }

        });

                // ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢æ¿ (æ–°ä»£ç ï¼šåŒæ—¶å¤„ç† InfoPanel å’Œ RegulationOverlay)
                // çº¦ 3247 è¡Œé™„è¿‘
        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢æ¿ (æ–°ä»£ç ï¼šåŒæ—¶å¤„ç† InfoPanel, RegulationOverlay å’Œ SideMolecules)
        cy.on('tap', (evt) => {
            // evt.target === cy è¡¨ç¤ºç‚¹å‡»çš„æ˜¯èƒŒæ™¯ç”»å¸ƒï¼Œè€Œä¸æ˜¯èŠ‚ç‚¹æˆ–è¿çº¿
            if (evt.target === cy) {
                
                // 1. å…³é—­æ™®é€šä¿¡æ¯é¢æ¿
                panel.style.display = 'none';
                
                // 2. å…³é—­ Regulation é»‘æ¡† (å¦‚æœæœ‰çš„è¯)
                if (typeof closeRegulationOverlay === 'function') {
                    closeRegulationOverlay();
                }

                // 3. éšè—æ‰€æœ‰ Activator/Inhibitor (è°ƒæ§å› å­)
                cy.elements('[nodeType="activator"], [nodeType="inhibitor"]')
                  .addClass('hidden-reg').style('display', 'none');
                cy.elements('edge[interaction="activate"], edge[interaction="inhibit"]')
                  .addClass('hidden-reg').style('display', 'none');

                // === ã€æ–°å¢ã€‘ 4. æ¸…é™¤å‰¯äº§ç‰©é€‰æ‹©çŠ¶æ€ ===
                if (window.selectedReactionIds) {
                    window.selectedReactionIds.clear(); // æ¸…ç©ºå·²é€‰çš„ååº”é›†åˆ
                }
                
                // === ã€æ–°å¢ã€‘ 5. åˆ·æ–°è§†å›¾ ===
                // è¿™ä¼šè®©é‚£äº›å› ä¸ºâ€œè¢«é€‰ä¸­â€è€Œæ˜¾ç¤ºçš„å‰¯äº§ç‰©é‡æ–°éšè—
                // (æ³¨æ„ï¼šé€šè¿‡å·¦ä¾§ Toggle æŒ‰é’®å¼ºåˆ¶æ˜¾ç¤ºçš„å‰¯äº§ç‰©ä¸ä¼šè¢«éšè—ï¼Œè¿™æ˜¯é¢„æœŸè¡Œä¸º)
                if (typeof refreshSideVisibility === 'function') {
                    refreshSideVisibility();
                }
            }
        });



        // æ‹–åŠ¨ååº”èŠ‚ç‚¹æ—¶ï¼Œå‰¯å°åˆ†å­è·Ÿéšæ’å¸ƒ
        let _raf = null;
        cy.on('drag', 'node[type="reaction"]', (evt) => {
            // åªæœ‰åœ¨æœªå†»ç»“æ—¶ï¼Œæ‰å…è®¸é‡æ–°è®¡ç®—å‰¯åˆ†å­ä½ç½®
            if (!window.__uiFrozen) {
                if (_raf) cancelAnimationFrame(_raf);
                
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è·å–å½“å‰æ­£åœ¨æ‹–åŠ¨çš„èŠ‚ç‚¹IDï¼Œå¹¶åªæ›´æ–°è¿™ä¸€ä¸ªèŠ‚ç‚¹
                const draggedNodeId = evt.target.id();
                
                _raf = requestAnimationFrame(() => alignSideNodes(draggedNodeId));
            }
        });

        // ä»¥åŠ dragfree
        cy.on('dragfree', 'node', () => {
            if (!window.__uiFrozen) alignSideNodes();
            autoSaveLayoutDebounced();
        });

    }


    // ============================================================
    // 4c. è‡ªåŠ¨ä¿å­˜/æ¢å¤å¸ƒå±€ï¼ˆé¿å…æ¯æ¬¡éƒ½é‡è°ƒä½ç½®ï¼‰
    // ============================================================
    const STORAGE_KEY_AUTO = STORAGE_KEY + '_autosave';

    function saveLayoutAuto() {
        if (!window.isEditMode) return; 
        if (!window.cyGraph) return;

        const positions = {};
        window.cyGraph.nodes().forEach(node => {
            // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘ ===
            // åŒæ ·ï¼Œè‡ªåŠ¨ä¿å­˜ä¹Ÿä¸åŒ…å«å‰¯èŠ‚ç‚¹
            if (node.hasClass('side-molecule')) return;

            positions[node.id()] = node.position();
        });
        
        localStorage.setItem(STORAGE_KEY + '_autosave', JSON.stringify(positions));
        saveLayoutToServer(positions);
    }



        function restoreLayoutAuto() {
        // å°è¯•ä» localStorage è·å–
        const raw = localStorage.getItem(STORAGE_KEY_AUTO);
        // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•ç”¨é¢„åŠ è½½çš„æœåŠ¡å™¨æ•°æ® (window.__preloadLayout)
        // æˆ–è€…æ˜¯ä¹‹å‰ saveLayoutToServer ä¿å­˜çš„å†…å­˜å˜é‡
        // è¿™é‡Œæ²¿ç”¨ä½ åŸæœ¬çš„é€»è¾‘ï¼Œä¸»è¦ä¿®æ”¹å¾ªç¯å†…éƒ¨
        
        if (!raw || !window.cyGraph) return false;

        let positions = null;
        try {
            positions = JSON.parse(raw);
        } catch {
            return false;
        }
        if (!positions || typeof positions !== 'object') return false;

        const cy = window.cyGraph;
        const restoredIds = new Set();
        let restoreCount = 0;

        cy.batch(() => {
            // éå† JSON ä¸­çš„æ‰€æœ‰ ID
            for (const [id, pos] of Object.entries(positions)) {
                const node = cy.getElementById(id);
                // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘ ===
                // è¿™æ ·å‰¯èŠ‚ç‚¹å°±ä¸ä¼šè¢« JSON é‡Œçš„ (0,0) æˆ–æ—§åæ ‡å½±å“
                if (node.length === 0) continue;
                if (node.hasClass('side-molecule')) continue; 

                if (typeof pos.x === 'number' && typeof pos.y === 'number') {
                    node.position({ x: pos.x, y: pos.y });
                    restoredIds.add(id);
                    restoreCount++;
                }
            }
        });

        // å¯¹â€œæ–°å‡ºç°çš„ä¸»å¹²èŠ‚ç‚¹â€ï¼Œç®€å•å®‰ç½®åœ¨é‚»å±…æ—è¾¹ (åŸæœ¬çš„é€»è¾‘)
        cy.nodes().forEach(node => {
            if (restoredIds.has(node.id())) return; 
            if (node.data('isSide') === true || node.hasClass('side-molecule')) return; // å‰¯èŠ‚ç‚¹ä¸ç®¡

            let sumX = 0, sumY = 0, cnt = 0;
            node.neighborhood('node').forEach(nb => {
                if (!restoredIds.has(nb.id())) return;
                const bp = nb.position();
                sumX += bp.x; sumY += bp.y; cnt++;
            });
            if (cnt > 0) {
                node.position({ x: sumX / cnt + 40, y: sumY / cnt });
            }
        });

        console.log(`å·²æ¢å¤ ${restoreCount} ä¸ªä¸»èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¿½ç•¥äº†å‰¯èŠ‚ç‚¹ã€‚`);
        return restoreCount > 0;
    }


    let _saveTimer = null;
    function autoSaveLayoutDebounced() {
        if (_saveTimer) clearTimeout(_saveTimer);
        _saveTimer = setTimeout(() => {
            try { saveLayoutAuto(); } catch(e) {}
        }, 250);
    }

    window.addEventListener('beforeunload', () => {
        try { saveLayoutAuto(); } catch(e) {}
    });

    // ============================================================
    // 5. ã€ä¿®æ­£ç‰ˆã€‘å‰¯èŠ‚ç‚¹å¼ºåˆ¶å¯¹é½ç®—æ³•
    // ============================================================
    function alignSideNodes(specificRxnId = null) {
        const cy = window.cyGraph;
        if (!cy) return;

        cy.batch(() => {
            // === å‚æ•°é…ç½® ===
            const OFFSET_X = 135;    // æ°´å¹³è·ç¦»ï¼šç¦»ååº”èŠ‚ç‚¹å¤šè¿œ
            const STEP_Y  = 26;      // å‚ç›´é—´è·ï¼šå‰¯äº§ç‰©ä¹‹é—´çš„è·ç¦»
            const MAX_PER_COL = 8;   // æ¯åˆ—æœ€å¤šæ”¾å‡ ä¸ª
            const COL_GAP = 65;      // å¤šåˆ—æ—¶çš„åˆ—é—´è·

            let targets;
            if (specificRxnId) {
                targets = cy.getElementById(specificRxnId);
            } else {
                targets = cy.nodes('[type="reaction"]');
            }

            targets.forEach(rxnNode => {
                const center = rxnNode.position();
                const rxnId = rxnNode.id();

                const inNodes = [];
                const outNodes = [];

                // æŸ¥æ‰¾å±äºè¯¥ååº”çš„æ‰€æœ‰å‰¯åˆ†å­
                cy.nodes('.side-molecule').forEach(n => {
                    if (n.data('parentRxn') !== rxnId) return; 
                    
                    // === ã€BUG ä¿®å¤å…³é”®ç‚¹ã€‘ ===
                    // ä½¿ç”¨ direction å­—æ®µæ¥åˆ¤æ–­æ˜¯ååº”ç‰©(in)è¿˜æ˜¯äº§ç‰©(out)
                    // åŸæ¥çš„ä»£ç ä½¿ç”¨çš„æ˜¯ roleï¼Œä½† role å­˜çš„æ˜¯ 'sub-reactant'
                    const dir = n.data('direction');

                    if (dir === 'in') inNodes.push(n);
                    else if (dir === 'out') outNodes.push(n);
                });

                // æ’ç‰ˆé€»è¾‘ï¼ˆæ …æ ¼åŒ–/åˆ—è¡¨åŒ–ï¼‰
                const placeGrid = (nodes, side) => {
                    const total = nodes.length;
                    if (total === 0) return;

                    const cols = Math.ceil(total / MAX_PER_COL);
                    for (let c = 0; c < cols; c++) {
                        const start = c * MAX_PER_COL;
                        const chunk = nodes.slice(start, start + MAX_PER_COL);
                        
                        // å‚ç›´å±…ä¸­è®¡ç®—
                        const rows = chunk.length;
                        const yStart = center.y - ((rows - 1) * STEP_Y) / 2;

                        // å·¦ä¾§å‘å·¦å»¶ä¼¸ï¼Œå³ä¾§å‘å³å»¶ä¼¸
                        const x = (side === 'left')
                            ? (center.x - OFFSET_X - c * COL_GAP)
                            : (center.x + OFFSET_X + c * COL_GAP);

                        chunk.forEach((node, r) => {
                            // å¼ºåˆ¶æ›´æ–°ä½ç½®
                            node.position({
                                x: x,
                                y: yStart + r * STEP_Y
                            });
                        });
                    }
                };

                // å·¦è¾¹æ”¾ååº”ç‰© (in)ï¼Œå³è¾¹æ”¾äº§ç‰© (out)
                placeGrid(inNodes, 'left');
                placeGrid(outNodes, 'right');
            });
        });
    }



    // ============================================================
    // Regulation æ£€ç´¢åŠŸèƒ½æ¨¡å—
    // ============================================================

    let currentRegNodeId = null; // å½“å‰é€‰ä¸­çš„æœ‰ Regulation çš„èŠ‚ç‚¹ID

        // åˆ‡æ¢å¼€å…³é€»è¾‘
    function toggleRegulationAndRender() {
        const isChecked = document.getElementById('regulation-toggle').checked;
        const panel = document.getElementById('regulation-panel');
        const cy = window.cyGraph; // è·å– cytoscape å®ä¾‹ä»¥ä¾¿é‡ç½®å¤§å°
        const hint = document.getElementById('scroll-hint-text');
        if (hint) hint.style.display = isChecked ? 'block' : 'none';
        
        if (isChecked) {
            panel.style.display = 'block';
            renderRegulationList();
            // å› ä¸ºé¢æ¿å‡ºç°å ç”¨äº†é«˜åº¦ï¼Œé€šçŸ¥ canvas é‡æ–°è®¡ç®—å¤§å°
            if (cy) cy.resize(); 
        } else {
            panel.style.display = 'none';
            closeRegulationOverlay(); // å…³é—­æ‚¬æµ®çª—
            if (cy) cy.resize();
        }
    }



       // ============================================================
    // æ¸²æŸ“ Regulation é¢æ¿ (æ”¯æŒä¸€ä¸ªèŠ‚ç‚¹å±äºå¤šä¸ª Pathway)
    // ============================================================
    function renderRegulationList() {
        if (!window.cyGraph) return;
        const container = document.getElementById('regulation-content-wrapper');
        if (!container) return;
        
        container.innerHTML = '';

        // 1. ç­›é€‰æ‰€æœ‰æœ‰ Regulation çš„èŠ‚ç‚¹
        const regNodes = window.cyGraph.nodes().filter(n => n.data('hasRegulation') === true);

        if (regNodes.length === 0) {
            container.innerHTML = '<span style="color:#9ca3af;font-size:12px;">å½“å‰è§†å›¾æ— ç‰¹æ®Šè°ƒæ§ååº”ã€‚</span>';
            return;
        }

        // 2. æŒ‰ Pathway è¿›è¡Œåˆ†ç»„ (æ ¸å¿ƒä¿®æ”¹ä¸é‡æ„)
        const groupByPathway = {};

        regNodes.forEach(node => {
            // è·å–åŸå§‹ pathway å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "glycolysis, gluconeogenesis"
            const rawPathway = node.data('pathway');
            
            let pathways = [];
            
            // å¦‚æœä¸ºç©ºæˆ– '0'ï¼Œå½’ä¸º 'Other'
            if (!rawPathway || rawPathway === '0') {
                pathways = ['Other'];
            } else {
                // === å…³é”®é€»è¾‘ä¿®æ”¹ ===
                // 1.å¦‚æœä¸åŒ…å«é€—å·ï¼Œå°±æ˜¯å•ä¸ªï¼›
                // 2.å¦‚æœåŒ…å«é€—å·ï¼Œä½¿ç”¨ split(',') æ‹†åˆ†ï¼›
                // 3.ä½¿ç”¨ map(trim) å»é™¤å‰åç©ºæ ¼
                pathways = rawPathway.split(',').map(s => s.trim());
            }

            // éå†è¯¥èŠ‚ç‚¹æ‰€å±çš„æ¯ä¸€ä¸ª Pathwayï¼Œå°†å…¶æ”¾å…¥å¯¹åº”çš„æ•°ç»„ä¸­
            pathways.forEach(pwName => {
                // é˜²æ­¢ç©ºå­—ç¬¦ä¸²
                if(!pwName) return; 
                
                if (!groupByPathway[pwName]) {
                    groupByPathway[pwName] = [];
                }
                groupByPathway[pwName].push(node);
            });
        });

        // 3. æ’åº Pathway åç§° (é¿å… 'gluconeogenesis' å’Œ 'glycolysis' ä¹±åº)
        const sortedPathways = Object.keys(groupByPathway).sort();

        // 4. ç”Ÿæˆ DOM
        sortedPathways.forEach(pwName => {
            const nodeList = groupByPathway[pwName];
            
            // å¤–å±‚ï¼šç»„ (Chip)
            const groupDiv = document.createElement('div');
            groupDiv.className = 'reg-group';

            // æ ‡é¢˜éƒ¨åˆ†
            const titleDiv = document.createElement('div');
            titleDiv.className = 'reg-group-title';
            titleDiv.innerHTML = `
                <span>${pwName}</span>
                <span class="reg-group-count">${nodeList.length}</span>
            `;

            // ä¸‹æ‹‰èœå• (Dropdown)
            const dropdownDiv = document.createElement('div');
            dropdownDiv.className = 'reg-dropdown';

            nodeList.forEach(node => {
                const data = node.data();
                // ä¼˜å…ˆæ˜¾ç¤º Labelï¼Œå…¶æ¬¡ infoEnzymeï¼Œæœ€å ID
                let label = data.label || data.infoEnzyme || data.id;
                if(!label || label === '0') label = "Unnamed";

                const btn = document.createElement('div');
                btn.className = 'reg-item-btn';
                // ä½¿ç”¨ span åŒ…è£¹æ–‡å­—ï¼Œæ–¹ä¾¿ CSS æ§åˆ¶çœç•¥å·
                btn.innerHTML = `<span>${label}</span>`;
                btn.title = label; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå…¨ç§°

                // é«˜äº®é€»è¾‘ (å¦‚æœå½“å‰é€‰ä¸­äº†è¯¥èŠ‚ç‚¹ï¼Œä¸ç®¡å®ƒå‡ºç°åœ¨å“ªä¸ªç»„é‡Œï¼Œéƒ½é«˜äº®)
                if (currentRegNodeId === node.id()) {
                    btn.classList.add('active');
                }

                btn.onclick = (e) => {
                    e.stopPropagation();
                    console.log("Clicked:", label, "in group:", pwName); // è°ƒè¯•
                    handleRegulationClick(node, btn);
                };

                dropdownDiv.appendChild(btn);
            });

            groupDiv.appendChild(titleDiv);
            groupDiv.appendChild(dropdownDiv);
            container.appendChild(groupDiv);
        });
    }




    // ============================================================
    // 3. ç‚¹å‡»åˆ—è¡¨é¡¹äº¤äº’ (é€‚é…æ–°æ ·å¼)
    // ============================================================
    function handleRegulationClick(node, btnElement) {
        // æ¸…é™¤åˆ—è¡¨é«˜äº®
        document.querySelectorAll('.reg-item-btn').forEach(b => b.classList.remove('active'));
        
        const overlay = document.getElementById('regulation-overlay-label');
        const infoPanel = document.getElementById('hover-info-panel');

        // ã€äº’æ–¥é€»è¾‘ 1ã€‘: å¦‚æœæ‰“å¼€ Regulation å¼¹çª—ï¼Œå¼ºåˆ¶å…³é—­æ™®é€š Info Panel
        if(infoPanel) infoPanel.style.display = 'none';

        // å¦‚æœé‡å¤ç‚¹å‡»å½“å‰é€‰ä¸­çš„ -> å–æ¶ˆ
        if (currentRegNodeId === node.id()) {
            closeRegulationOverlay();
            return;
        }

        // é€‰ä¸­çŠ¶æ€æ›´æ–°
        currentRegNodeId = node.id();
        if(btnElement) btnElement.classList.add('active');

        // ã€æ ¸å¿ƒæ–°å¢ã€‘ï¼šä¸»åŠ¨è°ƒç”¨æ˜¾ç¤ºä¸æ’ç‰ˆå‡½æ•°
        showAndLayoutRegulators(node);

        // é•œå¤´åŠ¨ç”»
        const cy = window.cyGraph;
        if(!cy) return;
        const targetZoom = 1.2;
        const w = cy.width();
        const h = cy.height();
        const finalPan = {
            x: (w / 2) - (node.position('x') * targetZoom),
            y: (h / 2) - (node.position('y') * targetZoom) 
        };

        cy.animate({
            zoom: targetZoom,
            pan: finalPan,
            duration: 500,
            easing: 'ease-out-cubic',
            complete: () => {
                updateOverlayPosition(); 
            }
        });
    }




        // ============================================================
    // 4. æ›´æ–°æ‚¬æµ®æ¡†å†…å®¹ (æœ€ç»ˆç‰ˆï¼šå«æ–‡ä»¶åæ¨¡ç³ŠåŒ¹é… + JPG/PNGè‡ªåŠ¨å›é€€)
    // ============================================================
    function updateOverlayPosition() {
        if (!currentRegNodeId) return;
        const cy = window.cyGraph;
        const node = cy.getElementById(currentRegNodeId);
        if (!node || node.empty()) return;

        const overlay = document.getElementById('regulation-overlay-label');
        
        // 1. è·å–æ–‡æœ¬å†…å®¹
        const regText = node.data('regulationText') || 'No details available.';
        let displayName = node.data('label') || node.id();

        // 2. è·å–ç”¨äºæœç´¢å›¾ç‰‡çš„åå­— (ä¼˜å…ˆä½¿ç”¨ rawEnzymeï¼Œå…¶æ¬¡ baseName)
        let searchName = node.data('rawEnzyme') || node.data('baseName') || displayName;
        searchName = String(searchName).trim();

        // 3. [å…³é”®æ­¥éª¤] è°ƒç”¨è¾…åŠ©å‡½æ•°æŸ¥æ‰¾çœŸå®æ–‡ä»¶å
        // (æ¯”å¦‚ searchName="A", æ¸…å•é‡Œæ˜¯ "A;B.png", è¿™é‡Œä¼šè¿”å› "A;B.png")
        // æ³¨æ„ï¼šfindMatchingImageFile å‡½æ•°å¿…é¡»åœ¨å‰é¢å®šä¹‰å¥½
        let realFileName = findMatchingImageFile(searchName);
        
        // 4. å‡†å¤‡è·¯å¾„ (å‰¥ç¦»åç¼€ï¼Œæ–¹ä¾¿åš PNG/JPG åˆ‡æ¢)
        // æ— è®º realFileName æ˜¯ "ATP.png" è¿˜æ˜¯ "ATP"ï¼Œè¿™é‡Œéƒ½æŠŠåç¼€å»æ‰
        let baseFileName = realFileName.replace(/\.(png|jpg|jpeg)$/i, "");
        
        const pngPath = `images/${baseFileName}.png`;
        const jpgPath = `images/${baseFileName}.jpg`;

        // 5. ç”Ÿæˆ HTML
        overlay.innerHTML = `
            <div class="reg-close-btn" onclick="closeRegulationOverlay()">Ã—</div>
            <strong style="display:block; margin-bottom:8px; font-size:14px; color:#ffd700;">
                ${displayName} Regulation
            </strong>
            
            <!-- å›¾ç‰‡åŠ è½½é€»è¾‘ï¼šé»˜è®¤PNG -> å¤±è´¥å°è¯•JPG -> å†å¤±è´¥éšè— -->
            <!-- data-tried-jpg æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ï¼Œç”¨äºæ ‡è®°æ˜¯å¦å·²ç»è¯•è¿‡JPGäº† -->
            <img src="${pngPath}" 
                 class="reg-img-display" 
                 title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹ (Click to enlarge): ${realFileName}"
                 onclick="openImageModal(this.src)"
                 onerror="
                    if (!this.getAttribute('data-tried-jpg')) {
                        // ç¬¬ä¸€æ¬¡æŠ¥é”™ï¼šæ ‡è®°å¹¶å°è¯•åˆ‡åˆ° JPG
                        this.setAttribute('data-tried-jpg', 'true');
                        console.log('PNG failed, trying JPG for:', '${baseFileName}');
                        this.src = '${jpgPath}';
                    } else {
                        // ç¬¬äºŒæ¬¡æŠ¥é”™(JPGä¹ŸæŒ‚äº†)ï¼šéšè—å›¾ç‰‡
                        this.style.display = 'none';
                    }
                 " />
                 
            <div class="reg-text-content">${regText}</div>
        `;

        // 6. æ ·å¼é‡ç½® (å› ä¸ºæ˜¯ fixed å®šä½ï¼Œä¸éœ€è¦è®¡ç®— left/top)
        overlay.style.top = '';
        overlay.style.left= '';
overlay.style.transform = '';
overlay.style.display = 'block';
}





    
    // æ–°å¢ï¼šå…³é—­æµ®çª—çš„è¾…åŠ©å‡½æ•°
    function closeRegulationOverlay() {
        const overlay = document.getElementById('regulation-overlay-label');
        if(overlay) overlay.style.display = 'none';
        
        // åŒæ—¶å–æ¶ˆé€‰ä¸­çŠ¶æ€
        currentRegNodeId = null;
        document.querySelectorAll('.reg-item-btn').forEach(b => b.classList.remove('active'));
    }

        // ============================================================
    // å›¾ç‰‡æ”¾å¤§åŠŸèƒ½å‡½æ•°
    // ============================================================
    function openImageModal(src) {
        // 1. æ£€æŸ¥é¡µé¢ä¸Šæ˜¯å¦å·²æœ‰æ¨¡æ€æ¡† DOMï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        let modal = document.getElementById('img-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'img-modal';
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = function() { modal.style.display = 'none'; };
            
            // å†…éƒ¨å›¾ç‰‡å®¹å™¨
            const img = document.createElement('img');
            img.id = 'img-modal-content';
            // é˜»æ­¢ç‚¹å‡»å›¾ç‰‡æœ¬èº«è§¦å‘å…³é—­ï¼ˆå¯é€‰ï¼Œçœ‹ä½“éªŒåå¥½ï¼Œè¿™é‡Œä¿æŒé»˜è®¤ç‚¹å‡»ä»»æ„å¤„å…³é—­æ›´æ–¹ä¾¿ï¼‰
            // img.onclick = function(e) { e.stopPropagation(); }; 
            
            modal.appendChild(img);
            document.body.appendChild(modal);
        }

        // 2. è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤º
        const imgEl = document.getElementById('img-modal-content');
        imgEl.src = src;
        modal.style.display = 'flex'; // ä½¿ç”¨ flex å±…ä¸­
    }

        // ============================================
    // ä¾§è¾¹æ æŠ˜å /å±•å¼€é€»è¾‘
    // ============================================
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const expandBtn = document.getElementById('sidebar-expand-btn');
        const cy = window.cyGraph;

        if (sidebar.style.display === 'none') {
            // å±•å¼€
            sidebar.style.display = 'flex';
            expandBtn.style.display = 'none';
        } else {
            // æ”¶èµ·
            sidebar.style.display = 'none';
            expandBtn.style.display = 'flex';
        }

        // [å…³é”®] ä¾§è¾¹æ å®½åº¦å˜åŒ–åï¼Œå¿…é¡»é€šçŸ¥ Cytoscape é‡æ–°è®¡ç®—ç”»å¸ƒå¤§å°
        if (cy) {
            //è¿™é‡ŒåŠ ä¸€ä¸ªçŸ­æš‚å»¶æ—¶ç¡®ä¿DOMæ¸²æŸ“å®Œæ¯•
            setTimeout(() => {
                cy.resize();
            }, 50);
        }
    }


    // ============================================================
    // 5. ç»‘å®šäº‹ä»¶ (æ–°ç‰ˆï¼šç§»é™¤ Pan/Zoom ç›‘å¬ï¼Œä¿ç•™ç‚¹å‡»ç©ºç™½å…³é—­)
    // ============================================================
    function bindRegulationOverlayEvents() {
        const cy = window.cyGraph;
        if (!cy) return;
        
        // ç§»é™¤åŸæœ¬çš„ cy.on('pan zoom position'...) ç›‘å¬ï¼Œå› ä¸ºç°åœ¨æ˜¯å›ºå®šå®šä½
        
        // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰ä¸­å¹¶å…³é—­
        cy.on('tap', (e) => {
             // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯ï¼Œä¸”å¤„äº Regulation æ¨¡å¼
             if (e.target === cy && document.getElementById('regulation-toggle').checked) {
                 closeRegulationOverlay();
             }
        });
    }
    // === æ–°å¢è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå¹¶å›´ç»•ä¸­å¿ƒæ’åˆ—è°ƒèŠ‚å› å­ ===
    function showAndLayoutRegulators(centerNode) {
        const cy = window.cyGraph;
        if (!cy || !centerNode) return;

        // 1. å…ˆéšè—å›¾ä¸Šå…¶ä»–æ‰€æœ‰çš„è°ƒæ§å› å­ï¼Œä¿æŒè§†é‡å¹²å‡€
        cy.elements('.reg-node').addClass('hidden-reg').style('display', 'none');
        cy.elements('.reg-edge').addClass('hidden-reg').style('display', 'none');

        // 2. æ‰¾åˆ°æŒ‡å‘è¯¥èŠ‚ç‚¹çš„è°ƒèŠ‚è¾¹å’ŒæºèŠ‚ç‚¹
        const connectedEdges = centerNode.incomers('edge[interaction="activate"], edge[interaction="inhibit"]');
        const connectedNodes = connectedEdges.sources();

        if (connectedNodes.length > 0) {
            // 3. ç§»é™¤éšè—ç±»ï¼Œæ˜¾ç¤ºå‡ºæ¥
            connectedNodes.removeClass('hidden-reg').style('display', 'element');
            connectedEdges.removeClass('hidden-reg').style('display', 'element');

            // 4. æ•°å­¦è®¡ç®—ï¼šå›´ç»• reaction èŠ‚ç‚¹å‘ˆåœ†å½¢æ’åˆ—
            const center = centerNode.position();
            const r = 80; // åŠå¾„
            
            // ä¸ºäº†ä¸å’Œä¸»å¹²è¿çº¿ï¼ˆé€šå¸¸åœ¨å·¦å³ï¼‰å’Œå‰¯ååº”ï¼ˆé€šå¸¸åœ¨ä¸Šä¸‹ï¼‰é‡å ï¼Œ
            // æˆ‘ä»¬å¯ä»¥å°è¯•æŠŠå®ƒä»¬æ”¾åœ¨ 45åº¦è§’çš„ä½ç½®ï¼Œæˆ–è€…å¹³å‡åˆ†å¸ƒ
            connectedNodes.forEach((child, i) => {
                // (-Math.PI / 2) æ˜¯ä»æ­£ä¸Šæ–¹å¼€å§‹æ’
                const angle = i * (2 * Math.PI / connectedNodes.length) - Math.PI / 2 + 0.5; // +0.5 ç¨å¾®åä¸€ç‚¹é”™å¼€å‚ç›´æ–¹å‘
                
                // ä»…è®¾ç½®ä½ç½®ï¼Œä¸ä¿å­˜åˆ°å¸ƒå±€æ–‡ä»¶
                child.position({
                    x: center.x + r * Math.cos(angle),
                    y: center.y + r * Math.sin(angle)
                });
            });
        }
    }
    // ============================================
    // [æ–°å¢] ä½¿å¾— Regulation Bar æ”¯æŒé¼ æ ‡æ»šè½®å·¦å³æ»‘åŠ¨
    // ============================================
    const regWrapper = document.getElementById('regulation-content-wrapper');
    if (regWrapper) {
        regWrapper.addEventListener('wheel', (evt) => {
            // å¦‚æœå­˜åœ¨å‚ç›´æ»šåŠ¨å¢é‡ (deltaY)
            if (evt.deltaY !== 0) {
                // é˜»æ­¢é»˜è®¤çš„ç½‘é¡µå‚ç›´æ»šåŠ¨
                evt.preventDefault();
                // å°†å‚ç›´æ»šåŠ¨çš„è·ç¦»è½¬æ¢ä¸ºæ°´å¹³æ»šåŠ¨
                regWrapper.scrollLeft += evt.deltaY;
            }
        }, { passive: false }); //passive: false å…è®¸ preventDefault
}


// ============================================================
//  [æ–°å¢] ç»†èƒå™¨å›¾ç‰‡è¦†ç›–å±‚ï¼šå¯æ‹–æ‹½ / ç¼©æ”¾ / æ—‹è½¬ï¼Œå¹¶éšå›¾å¹³ç§»ç¼©æ”¾
// ============================================================
window.isOrganelleEditMode = false;
window.organelleOverlayInited = false;

const ORGANELLE_ASSETS = {
    chloroplast: { src: 'orgenells/chloroplast.jpg', title: 'Chloroplast' },
    er_smooth:   { src: 'orgenells/ER%20smooth.jpg', title: 'ER smooth' },
    glyoxysome:  { src: 'orgenells/glyoxysome.jpg', title: 'Glyoxysome' },
    mitochondria:{ src: 'orgenells/mitochondria.jpg', title: 'Mitochondria' }
};

const ORGANELLE_STORAGE_KEY = 'metabolic_organelles_layout_v1';

function _getGraphAreaRect(){
    const ga = document.getElementById('graph-area');
    return ga ? ga.getBoundingClientRect() : null;
}

function _getCy(){
    return window.cyGraph || window.cy || null;
}

function _ensureOrganelleLayer(){
    const layer = document.getElementById('organelle-layer');
    if (!layer) return null;
    if (!layer.style.getPropertyValue('--org-opacity')) {
        layer.style.setProperty('--org-opacity', '0.27');
    }
    return layer;
}

function _defaultOrganelleLayout(){
    return {
        version: 4,
        coordMode: 'world',
        opacity: 0.27,
        organelles: {
            chloroplast: { x: 260, y: 80,  w: 220, h: 120, rot: 0 },
            er_smooth:   { x: 60,  y: 60,  w: 220, h: 140, rot: 0 },
            glyoxysome:  { x: 420, y: 360, w: 160, h: 160, rot: 0 },
            mitochondria:{ x: 260, y: 200, w: 340, h: 240, rot: 0 }
        }
    };
}

function _normalizeOrganellePayload(payload){
    const base = _defaultOrganelleLayout();
    const p = (payload && typeof payload === 'object') ? payload : {};
    const out = {
        version: Number(p.version || base.version),
        coordMode: (p.coordMode || 'world'),
        opacity: (typeof p.opacity === 'number' ? p.opacity : base.opacity),
        organelles: {}
    };
    const org = (p.organelles && typeof p.organelles === 'object') ? p.organelles : {};
    for (const key of Object.keys(ORGANELLE_ASSETS)){
        const d = base.organelles[key];
        const v = org[key] || {};
        out.organelles[key] = {
            x: (typeof v.x === 'number' ? v.x : d.x),
            y: (typeof v.y === 'number' ? v.y : d.y),
            w: (typeof v.w === 'number' ? v.w : d.w),
            h: (typeof v.h === 'number' ? v.h : d.h),
            rot: (typeof v.rot === 'number' ? v.rot : 0)
        };
    }
    return out;
}

async function loadOrganellesLayout(){
    try{
        const resp = await fetch('/api/organelles', { cache: 'no-store' });
        if (resp.ok){
            const payload = await resp.json();
            const normalized = _normalizeOrganellePayload(payload);
            localStorage.setItem(ORGANELLE_STORAGE_KEY, JSON.stringify(normalized));
            return normalized;
        }
    }catch(e){
        console.warn('Fetch organelles layout failed, fallback to local:', e);
    }
    try{
        const raw = localStorage.getItem(ORGANELLE_STORAGE_KEY);
        if (raw) return _normalizeOrganellePayload(JSON.parse(raw));
    }catch(e){}
    return _defaultOrganelleLayout();
}

let _organelleSaveTimer = null;
function saveOrganellesLayoutDebounced(layout){
    try{ localStorage.setItem(ORGANELLE_STORAGE_KEY, JSON.stringify(layout)); }catch(e){}
    if (_organelleSaveTimer) clearTimeout(_organelleSaveTimer);
    _organelleSaveTimer = setTimeout(async () => {
        try{
            await fetch('/api/organelles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(layout)
            });
        }catch(e){
            console.warn('Save organelles layout failed:', e);
        }
    }, 450);
}

function _applyOrganelleOpacity(opacity){
    const layer = _ensureOrganelleLayer();
    if (!layer) return;
    const v = Math.max(0.05, Math.min(0.85, opacity));
    layer.style.setProperty('--org-opacity', String(v));
}

function _updateOrganelleLayerTransform(){
    const cy = _getCy();
    const layer = _ensureOrganelleLayer();
    if (!cy || !layer) return;
    const pan = cy.pan();
    const zoom = cy.zoom();
    layer.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
}

function _renderOneOrganelle(el, st){
    el.style.left = st.x + 'px';
    el.style.top  = st.y + 'px';
    el.style.width  = st.w + 'px';
    el.style.height = st.h + 'px';
    el.style.transform = `rotate(${st.rot || 0}deg)`;
}

function _buildOrganelleDOM(layer, key){
    const wrapper = document.createElement('div');
    wrapper.className = 'organelle-item';
    wrapper.dataset.key = key;
    wrapper.title = ORGANELLE_ASSETS[key].title || key;

    const img = document.createElement('img');
    img.src = ORGANELLE_ASSETS[key].src;
    img.alt = key;
    img.draggable = false;

    const rotateLine = document.createElement('div');
    rotateLine.className = 'org-rotate-line';

    const rotateHandle = document.createElement('div');
    rotateHandle.className = 'org-handle rotate';
    rotateHandle.title = 'Rotate';

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'org-handle resize-se';
    resizeHandle.title = 'Resize';

    wrapper.appendChild(img);
    wrapper.appendChild(rotateLine);
    wrapper.appendChild(rotateHandle);
    wrapper.appendChild(resizeHandle);

    layer.appendChild(wrapper);
    return { wrapper, rotateHandle, resizeHandle };
}

function initOrganelleOverlayOnce(cy){
    if (window.organelleOverlayInited) return;
    const layer = _ensureOrganelleLayer();
    if (!layer) return;
    window.organelleOverlayInited = true;

    cy.on('pan zoom', _updateOrganelleLayerTransform);
    window.addEventListener('resize', _updateOrganelleLayerTransform);

    loadOrganellesLayout().then(layout => {
        window._organelleLayout = layout;
        _applyOrganelleOpacity(layout.opacity || 0.27);

        const slider = document.getElementById('organelle-opacity');
        if (slider) slider.value = String(layout.opacity || 0.27);

        layer.innerHTML = '';
        const domMap = {};
        for (const key of Object.keys(ORGANELLE_ASSETS)){
            const dom = _buildOrganelleDOM(layer, key);
            domMap[key] = dom;
            _renderOneOrganelle(dom.wrapper, layout.organelles[key]);
        }
        window._organelleDomMap = domMap;

        _updateOrganelleLayerTransform();
        _bindOrganelleInteractions(domMap);
    });
}

function toggleOrganelleEditMode(){
    const checkbox = document.getElementById('organelle-edit-toggle');
    window.isOrganelleEditMode = !!(checkbox && checkbox.checked);

    const slider = document.getElementById('organelle-opacity');
    const resetBtn = document.getElementById('organelle-reset-btn');
    const hint = document.getElementById('organelle-hint');
    if (slider) slider.style.display = window.isOrganelleEditMode ? 'inline-block' : 'none';
    if (resetBtn) resetBtn.style.display = window.isOrganelleEditMode ? 'inline-flex' : 'none';
    if (hint) hint.style.display = window.isOrganelleEditMode ? 'block' : 'none';

    document.body.classList.toggle('organelle-edit-on', window.isOrganelleEditMode);

    const cy = _getCy();
    if (cy){
        try{
            cy.userPanningEnabled(!window.isOrganelleEditMode);
            cy.boxSelectionEnabled(!window.isOrganelleEditMode);
        }catch(e){}
    }
}

async function resetOrganellesLayout(){
    try{ await fetch('/api/organelles', { method: 'DELETE' }); }catch(e){}
    window._organelleLayout = _defaultOrganelleLayout();
    saveOrganellesLayoutDebounced(window._organelleLayout);
    const domMap = window._organelleDomMap || {};
    for (const key of Object.keys(ORGANELLE_ASSETS)){
        const st = window._organelleLayout.organelles[key];
        if (domMap[key]) _renderOneOrganelle(domMap[key].wrapper, st);
    }
    _applyOrganelleOpacity(window._organelleLayout.opacity || 0.27);
    const slider = document.getElementById('organelle-opacity');
    if (slider) slider.value = String(window._organelleLayout.opacity || 0.27);
}

function _bindOrganelleInteractions(domMap){
    const cy = _getCy();
    const layer = _ensureOrganelleLayer();
    if (!cy || !layer) return;

    const state = { mode: null, key: null, start: null };

    const getLocal = (evt) => {
        const rect = _getGraphAreaRect();
        if (!rect) return { x: 0, y: 0 };
        return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    };

    const stopAll = () => {
        state.mode = null; state.key = null; state.start = null;
        window.removeEventListener('pointermove', onMove, true);
        window.removeEventListener('pointerup', onUp, true);
    };

    const onUp = () => { stopAll(); };

    const onMove = (evt) => {
        if (!window.isOrganelleEditMode) return;
        if (!state.mode || !state.key) return;
        const layout = window._organelleLayout;
        if (!layout) return;

        const zoom = cy.zoom();
        const pan = cy.pan();
        const cur = getLocal(evt);
        const dxModel = (cur.x - state.start.px) / zoom;
        const dyModel = (cur.y - state.start.py) / zoom;

        const st = layout.organelles[state.key];

        if (state.mode === 'drag'){
            st.x = state.start.x + dxModel;
            st.y = state.start.y + dyModel;
        } else if (state.mode === 'resize'){
            st.w = Math.max(20, state.start.w + dxModel);
            st.h = Math.max(20, state.start.h + dyModel);
        } else if (state.mode === 'rotate'){
            const cxModel = st.x + st.w / 2;
            const cyModel = st.y + st.h / 2;
            const cx = cxModel * zoom + pan.x;
            const cyy = cyModel * zoom + pan.y;
            const ang = Math.atan2(cur.y - cyy, cur.x - cx) * 180 / Math.PI;
            st.rot = state.start.rot + (ang - state.start.ang0);
        }

        _renderOneOrganelle(domMap[state.key].wrapper, st);
        layout.opacity = Number(layout.opacity || 0.27);
        saveOrganellesLayoutDebounced(layout);
    };

    for (const key of Object.keys(domMap)){
        const { wrapper, rotateHandle, resizeHandle } = domMap[key];

        wrapper.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            if (evt.target === rotateHandle || evt.target === resizeHandle) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;
            const p = getLocal(evt);
            state.mode = 'drag';
            state.key = key;
            state.start = { px: p.x, py: p.y, x: layout.organelles[key].x, y: layout.organelles[key].y };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });

        resizeHandle.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;
            const p = getLocal(evt);
            state.mode = 'resize';
            state.key = key;
            state.start = { px: p.x, py: p.y, w: layout.organelles[key].w, h: layout.organelles[key].h };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });

        rotateHandle.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;

            const p = getLocal(evt);
            const st = layout.organelles[key];
            const zoom = cy.zoom();
            const pan = cy.pan();
            const cxModel = st.x + st.w / 2;
            const cyModel = st.y + st.h / 2;
            const cx = cxModel * zoom + pan.x;
            const cyy = cyModel * zoom + pan.y;
            const ang0 = Math.atan2(p.y - cyy, p.x - cx) * 180 / Math.PI;

            state.mode = 'rotate';
            state.key = key;
            state.start = { px: p.x, py: p.y, rot: st.rot || 0, ang0 };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });
    }

    const slider = document.getElementById('organelle-opacity');
    if (slider){
        slider.addEventListener('input', (evt) => {
            const v = Number(evt.target.value);
            const layout = window._organelleLayout || _defaultOrganelleLayout();
            layout.opacity = v;
            window._organelleLayout = layout;
            _applyOrganelleOpacity(v);
            saveOrganellesLayoutDebounced(layout);
        });
    }
}


// åœ¨è„šæœ¬æœ€åå¯åŠ¨ç›‘å¬
initSearchListener();

</script> </body> </html>