<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Pathway</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20 65 L40 50 L60 50 L80 35 M60 50 L75 70' fill='none' stroke='%232ecc71' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'/><circle cx='40' cy='50' r='6' fill='%232c3e50'/></svg>">
    
    <style>
        
        /* === å…¨å±€æ ·å¼ === */
        body {
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        /* ========================================= */
        /* 1. é¡¶éƒ¨å¯¼èˆªæ  (æºè‡ª File 2 æ”¹è‰¯ç‰ˆ)       */
        /* ========================================= */
        header.topbar {
    /* ä½¿ç”¨æ·±è‰²è°ƒä½†å¸¦é€æ˜åº¦ï¼Œèƒ½ä¸ç»¿è‰²/å½©è‰²çš„ä»£è°¢èŠ‚ç‚¹å½¢æˆå¼ºå¯¹æ¯” */
    background: rgba(17, 24, 39, 0.85); 
    backdrop-filter: blur(12px); /* æ¯›ç»ç’ƒæ¨¡ç³Šæ„Ÿ */
    -webkit-backdrop-filter: blur(12px);
    
    padding: 10px 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* ç»†å¾®çš„é¡¶éƒ¨äº®è¾¹ */
    
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 20px;
    z-index: 1000;
    position: relative;
    transition: all 0.3s ease;
}

        /* === ç°ä»£åŒ–å“ç‰Œæ ‡é¢˜æ ·å¼ === */
/* === ç°ä»£åŒ–å“ç‰Œæ ‡é¢˜æ ·å¼ + GitHub è·³è½¬äº¤äº’ === */
.brand {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 4px 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: default;
    user-select: none;
    color: cornsilk;
}

/* GitHub è·³è½¬çš„å›¾æ ‡å®¹å™¨ï¼ˆæ•´åˆåŸæœ‰å‘¼å¸ç¯æ•ˆæœï¼‰ */
a.brand-emoji {
    text-decoration: none;
    position: relative; /* ä¸ºæç¤ºæ¡†æä¾›å®šä½åŸºå‡† */
    font-size: 24px;
    background: #f0fdf4; /* ææ·¡çš„ç»¿è‰²èƒŒæ™¯ */
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.1);
    transition: transform 0.3s ease;
    cursor: pointer; /* é¼ æ ‡æŒ‡é’ˆå˜ä¸ºæ‰‹å‹ */
}

/* é¼ æ ‡æ‚¬æµ®æ—¶å›¾æ ‡æ—‹è½¬ç¼©æ”¾æ•ˆæœï¼ˆä¿ç•™åŸæœ‰äº¤äº’ï¼‰ */
.brand:hover a.brand-emoji {
    transform: rotate(15deg) scale(1.1);
    background: #dcfce7;
}

/* æç¤ºæ¡† (Tooltip) æ ·å¼ - é»˜è®¤éšè— */
a.brand-emoji::after {
    content: "See Source Code"; /* æç¤ºæ–‡å­— */
    /* æç¤ºæ¡†åŸºç¡€æ ·å¼ */
    position: absolute;
    left: 100%; /* æç¤ºæ¡†åœ¨å›¾æ ‡å³ä¾§æ˜¾ç¤º */
    top: 50%;
    transform: translateY(-50%);
    margin-left: 12px; /* ä¸å›¾æ ‡ä¿æŒé—´è· */
    padding: 6px 12px;
    font-size: 14px; /* è°ƒæ•´ä¸ºåˆé€‚çš„å­—ä½“å¤§å° */
    white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
    background: rgba(255, 255, 255, 0.95); /* ç™½è‰²åŠé€æ˜èƒŒæ™¯ */
    color: #22c55e; /* ç»¿è‰²æ–‡å­— */
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    /* é»˜è®¤éšè— */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999; /* ç¡®ä¿æç¤ºæ¡†åœ¨æœ€ä¸Šå±‚ */
    width: auto; /* è‡ªåŠ¨é€‚åº”æ–‡å­—å®½åº¦ */
    height: auto; /* è‡ªåŠ¨é€‚åº”æ–‡å­—é«˜åº¦ */
}

/* é¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºæç¤ºæ¡† */
a.brand-emoji:hover::after {
    opacity: 1;
    visibility: visible;
}

.brand-title {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
}

/* 1. ä¸»æ ‡é¢˜ï¼ˆMetabolismï¼‰ä¼˜åŒ–ï¼šæå‡äº®åº¦å’Œå­—ä½“ç²—ç»† */
.brand-title-main {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šåŒæ—¶å®šä¹‰æ ‡å‡†å±æ€§å’Œç§æœ‰å‰ç¼€å±æ€§ */
    background: linear-gradient(135deg, #ffffff 0%, #cbd5e1 100%) !important;
    background-clip: text !important;         /* æ ‡å‡†å±æ€§ */
    -webkit-background-clip: text !important; /* ç§æœ‰å‰ç¼€å±æ€§ï¼ˆç”¨äº Chrome/Safariï¼‰ */
    -webkit-text-fill-color: transparent !important; /* å¿…é¡»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™æ–‡å­—ä¼šè¦†ç›–èƒŒæ™¯ */
    
    font-size: 24px !important;
    font-weight: 800 !important;
    letter-spacing: -0.5px !important;
}
/* å‰¯æ ‡é¢˜ï¼šå¢åŠ ç‰ˆæœ¬æˆ–ä¸“ä¸šæ„Ÿæ ‡æ³¨ */
.brand-title-sub {
    font-size: 10px;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-top: 2px;
}
/* --- æ–°å¢ï¼šè¯´æ˜ä¹¦è·³è½¬å›¾æ ‡æ ·å¼ --- */
.manual-link {
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.45); /* åˆå§‹ä¸ºæ·¡ç°è‰²ï¼Œä¸å¹²æ‰°ä¸»æ ‡é¢˜ */
    text-decoration: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    margin-left: 8px;
    padding: 4px;
    border-radius: 6px;
}

.manual-link:hover {
    color: #60a5fa; /* æ‚¬åœæ—¶å˜ä¸ºäº®è“è‰²ï¼Œä¸æ•´ä½“UIå‘¼åº” */
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
}

/* æç¤ºå›¾æ ‡å¾®è°ƒ */
.manual-link svg {
    display: block;
}
/* 1. ä¿®æ­£ä¸­é—´åŒºåŸŸçš„æ•´ä½“å¸ƒå±€ï¼Œç¡®ä¿å®¹å™¨ä¸è¢«æŒ¤å‹ */
.topbar-center {
    display: flex; 
    align-items: center; 
    gap: 12px; 
    flex-wrap: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œï¼Œé˜²æ­¢é”™ä½ */
    justify-content: center; 
    min-width: 0;
}

/* 2. æ ¸å¿ƒä¿®æ­£ï¼šChip èƒ¶å›Šå®¹å™¨ */
.chip {
    display: flex !important;
    align-items: center !important; /* å¼ºåˆ¶å‚ç›´å±…ä¸­ï¼Œè§£å†³å›¾æ ‡é”™ä½ */
    gap: 8px; 
    background: rgba(255, 255, 255, 0.12) !important; 
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 20px !important; /* æ¢å¤åœ†è§’å½¢çŠ¶ */
    padding: 0 14px !important; /* å»æ‰ä¸Šä¸‹ paddingï¼Œç”±é«˜åº¦æ§åˆ¶ */
    height: 38px !important; /* ç»Ÿä¸€å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢å¡Œé™· */
    box-sizing: border-box !important;
    transition: all 0.1s ease;
}
        .chip:focus-within {
            border-color: #2196F3;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        /* 3. Regulation å¼€å…³æ–‡å­—ä¼˜åŒ–ï¼šå¤§å¹…æå‡å¯¹æ¯”åº¦ */
/* ä¿®æ­£ï¼šæ–‡å­—é¢œè‰²æ”¹ä¸ºæŸ”å’Œç™½ï¼Œå¹¶å¢åŠ å›¾æ ‡å¯¹é½ */
.chip-label {
    color: rgba(255, 255, 255, 0.85) !important; /* æŸ”å’Œç™½ */
    font-weight: 700 !important;
    font-size: 13px !important;
    display: flex;
    align-items: center;
    gap: 6px;
    text-shadow: none !important;
}
        .chip-arrow { color:rgba(255, 255, 255, 0.45); user-select: none; }
        
/* 3. ä¿®æ­£å†…éƒ¨å›¾æ ‡å’Œæ–‡å­—çš„å‚ç›´æ’åˆ— */
.chip span, 
.chip .chip-label {
    display: flex;
    align-items: center;
    height: 100%;
    line-height: 1;
    white-space: nowrap;
}

/* 4. ä¿®æ­£è¾“å…¥æ¡†æ ·å¼ */
.chip input {
    background: transparent !important;
    border: none !important;
    outline: none !important;
    color: #ffffff !important;
    font-size: 13px !important;
    height: 100% !important; /* å……æ»¡å®¹å™¨é«˜åº¦ */
    margin: 0 !important;
    padding: 0 !important;
}

/* æå‡æç¤ºè¯ï¼ˆPlaceholderï¼‰çš„æ¸…æ™°åº¦ */
.chip input::placeholder {
    color: rgba(255, 255, 255, 0.45) !important;
}
        /* 5. ä¸“é—¨å¤„ç†é‚£ä¸ª DNA å›¾æ ‡æº¢å‡ºçš„ Search æŒ‰é’® */
#path-find-btn {
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #ffffff !important;
    border-radius: 12px !important;
    padding: 4px 10px !important;
    height: 28px !important; /* æ¯”å¤–æ¡†ç¨çŸ® */
    font-size: 12px !important;
    font-weight: bold !important;
    margin-left: 4px !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 6. ä¿®æ­£æœç´¢æ¡†çš„å…·ä½“å®½åº¦ */
.search-chip input { width: 180px !important; }
.path-chip input { width: 90px !important; }
/* å½“é¼ æ ‡èšç„¦æ—¶å¢å¼ºäº®åº¦ */
.chip:focus-within {
    background: rgba(255, 255, 255, 0.2) !important;
    border-color: #60a5fa !important;
    box-shadow: 0 0 8px rgba(96, 165, 250, 0.3) !important;
}
/* ç»Ÿä¸€å›¾æ ‡å®¹å™¨çš„é¢œè‰²å’Œå¯¹é½ */
.chip-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½ï¼Œç¬¦åˆå¹³é¢å‰ªå½±æ„Ÿ */
    margin-right: 4px;
}

/* æœç´¢æ¡†èšç„¦æ—¶å›¾æ ‡å˜äº® */
.search-chip:focus-within .chip-icon {
    color: #ffffff;
}

/* è°ƒæ•´ Home é”®å†…éƒ¨å›¾æ ‡å¤§å° */
button[onclick="centerView()"] svg {
    transition: transform 0.1s ease;
}

button[onclick="centerView()"]:hover svg {
    transform: scale(1.1);
    color: #60a5fa; /* æ‚¬åœæ—¶å˜ä¸ºäº®è“è‰² */
}
        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .topbar-actions {
            display: flex; align-items: center; gap: 8px; justify-content: flex-end;
        }
        .btn {
            cursor: pointer;
             padding: 8px 12px; border: 1px solid #e2e6ef;
            background: #fff; border-radius: 14px; font-size: 13px; color: #ffffff;
            display: flex; align-items: center; gap: 6px; white-space: nowrap;
            user-select: none; transition: transform 0.1s;;
        }
        .btn:hover { background: #f6f7fb; border-color: #d1d5db; }
        
        .btn-primary {
            background: #111827; color: #fff; border-color: #111827;
        }
        .btn-primary:hover { background: #0b1220; border-color: #000; }

        /* å†»ç»“æŒ‰é’®æ¿€æ´»æ€ */
        #freeze-toggle.is-on {
            border-color: #f59e0b; background: #fff7ed; color: #b45309;
        }

        /* ç®€å•çš„çŠ¶æ€æ–‡å­— */
        .status {
            font-size: 12px; color: #6b7280; margin-left: 5px;
            max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* é”™è¯¯æç¤º */
        #error-msg {
    display: none; 
    position: fixed; /* æ”¹ä¸ºå›ºå®šå®šä½ */
    top: 80px;      /* ä½äºé¡¶éƒ¨å¯¼èˆªæ ä¸‹æ–¹ */
    left: 50%;
    transform: translateX(-50%);
    background: #fff5f5; /* æµ…çº¢èƒŒæ™¯ */
    color: #e53e3e;      /* è­¦å‘Šçº¢æ–‡å­— */
    border: 1px solid #feb2b2;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    z-index: 10001;      /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    animation: fadeInScale 0.3s ease-out;
}

@keyframes fadeInScale {
    from { opacity: 0; transform: translate(-50%, -10px) scale(0.95); }
    to { opacity: 1; transform: translate(-50%, 0) scale(1); }
}

        /* å“åº”å¼é€‚é… */
        @media (max-width: 1100px) {
            header.topbar { grid-template-columns: 1fr; gap: 10px; }
            .topbar-center { justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; }
            .topbar-actions { justify-content: flex-start; }
        }
/* 1. è°ƒæ•´ Path: å­—ç¬¦ä¸²æ ·å¼ */
.chip-label-prefix {
    font-size: 13px !important;
    font-weight: 600 !important; /* ç¨å¾®å‡ç»†ï¼Œé¿å…è¿‡ç²— */
    color: rgba(255, 255, 255, 0.7) !important; /* ä½¿ç”¨åŠé€æ˜ç™½ï¼Œä¸æœç´¢æ¡†å ä½ç¬¦åè°ƒ */
    margin-right: 4px;
    text-shadow: none !important; /* å»é™¤å¯èƒ½çš„é˜´å½± */
}

/* 2. è°ƒæ•´ä¸­é—´ç®­å¤´çš„æ ·å¼ */
.chip-separator {
    display: flex;
    align-items: center;
    color: rgba(255, 255, 255, 0.4); /* ç®­å¤´ä½œä¸ºåˆ†éš”ç¬¦ï¼Œé¢œè‰²åº”æ›´æ·¡ä¸€äº› */
    margin: 0 8px;
}

/* 3. ç»Ÿä¸€è¾“å…¥æ¡†å†…çš„æ–‡å­—å¯¹é½å’Œé¢œè‰² */
.path-chip input {
    color: #ffffff !important;
    font-size: 13px !important;
}

.path-chip input::placeholder {
    color: rgba(255, 255, 255, 0.3) !important; /* ç»Ÿä¸€å ä½ç¬¦é€æ˜åº¦ */
}

/* 4. è°ƒæ•´ Search æŒ‰é’®å†…çš„ DNA å›¾æ ‡ */
#path-find-btn {
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    background: rgba(255, 255, 255, 0.1) !important;
    transition: all 0.1s ease;
    color: #ffffff !important;
}

#path-find-btn:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    border-color: #60a5fa !important;
}
        /* ========================================= */
        /* æ–°ç‰ˆ Regulation é¢æ¿æ ·å¼                  */
        /* ========================================= */
        
        /* 1. é¢æ¿å®¹å™¨ï¼šä½äºHeaderä¸‹æ–¹ï¼Œç»å¯¹å®šä½æˆ–æµå¼å¸ƒå±€å‡å¯ */
        /* è¿™é‡Œä½¿ç”¨ç›¸å¯¹å®šä½æµå¼å¸ƒå±€ï¼Œæ¨æŒ¤ç”»å¸ƒï¼Œä¿è¯ä¸é®æŒ¡åŸæœ‰èŠ‚ç‚¹ */
       /* ========================================= */
/* æ–°ç‰ˆ Regulation é¢æ¿æ ·å¼ (å«åŠ¨ç”»ç‰ˆ)        */
/* ========================================= */
/* ç¡®ä¿åŒ…è£…å™¨æ’‘æ»¡é«˜åº¦ï¼Œè¿™æ ·åœ¨é¢æ¿ä»»ä½•åœ°æ–¹æ»šåŠ¨éƒ½èƒ½è§¦å‘ */
#regulation-content-wrapper {
    padding: 12px 24px;
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 12px;
    align-items: flex-start;
    
    /* === å½»åº•åˆ æ‰åŸæ¥çš„ padding-bottom å’Œ margin-bottom === */
    padding-bottom: 12px;  /* æ¢å¤æ­£å¸¸çš„å†…è¾¹è· */
    margin-bottom: 0; 
    
    pointer-events: auto;  /* å…è®¸æ¥æ”¶æ»šè½®äº‹ä»¶ */
    scrollbar-width: none;
}
#regulation-panel {
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    z-index: 90;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    
    /* === åŠ¨ç”»åˆå§‹çŠ¶æ€ (æ”¶èµ·) === */
    max-height: 0;          /* é«˜åº¦ä¸º0 */
    opacity: 0;             /* é€æ˜ */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transform: translateY(-10px);   /* ç¨å¾®å‘ä¸Šåç§» */
    
    /* å…³é”®ï¼šåŠ¨ç”»æœŸé—´å¿…é¡» hiddenï¼Œå¦åˆ™æ— æ³•å®ç°é«˜åº¦åŠ¨ç”» */
    overflow: hidden;       
    
    /* è¿‡æ¸¡æ•ˆæœ */
    transition: 
        max-height 0.1s cubic-bezier(0.25, 0.8, 0.25, 1),
        opacity 0.1s ease,
        transform 0.1s ease,
        border-width 0.1s ease;
}

/* === å±•å¼€çŠ¶æ€ (ç”±JSæ·»åŠ  .is-open) === */
#regulation-panel.is-open {
    max-height: 400px;      /* ç»™ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦é™åˆ¶ */
    opacity: 1;
    transform: translateY(0);
    border-bottom-width: 1px;
}

/* === è¾…åŠ©ç±»ï¼šå…è®¸æº¢å‡º (ç”±JSå»¶æ—¶æ·»åŠ ) === */
#regulation-panel.allow-overflow {
    overflow: visible !important; /* åŠ¨ç”»ç»“æŸåï¼Œå…è®¸å†…å®¹æº¢å‡ºé¢æ¿è¾¹ç•Œ */
}
/* ä¿®æ”¹â€œScroll to Moveâ€æç¤ºè¯é¢œè‰² */
#scroll-hint-text {
    color: #94a3b8 !important; /* æ”¹ä¸ºæµ…ç°è‰²ï¼Œæå‡å¯è§åº¦ */
    font-size: 11px !important;
}

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 2. å†…éƒ¨åŒ…è£…å™¨ï¼šè´Ÿè´£å†…è¾¹è·å’Œå¸ƒå±€ */
                /* 2. å†…éƒ¨åŒ…è£…å™¨ï¼šè´Ÿè´£å†…è¾¹è·å’Œå¸ƒå±€ï¼ˆå•è¡Œæ»šåŠ¨ç‰ˆï¼‰ */
        #regulation-content-wrapper {
            padding: 12px 24px;
            display: flex;
            
            /* === æ”¹åŠ¨ 1: å¼ºåˆ¶ä¸æ¢è¡Œï¼Œä¸”å¼€å¯Xè½´æ»šåŠ¨ === */
            flex-wrap: nowrap; 
            overflow-x: auto; 
            
            gap: 12px;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œé˜²æ­¢æ’‘é«˜å¸¦æ¥çš„å‚ç›´å±…ä¸­é—®é¢˜ */
            
            /* === æ”¹åŠ¨ 2: å…³é”® Hack - é˜²æ­¢ä¸‹æ‹‰èœå•è¢« overflow è£å‰ª === */
            /* å‘ä¸‹æ’‘å¼€è¶³å¤Ÿç©ºé—´ç»™ dropdown æ˜¾ç¤º */
            padding-bottom: 340px; 
            /* ç”¨è´Ÿ margin æŠŠä¸‹æ–¹çš„å¸ƒå±€æ‹‰å›æ¥ï¼ŒæŠµæ¶ˆ padding çš„å ä½ */
            margin-bottom: -320px; 
            
            /* === æ”¹åŠ¨ 3: é¼ æ ‡äº‹ä»¶ç©¿é€ === */
            /* åªæœ‰å…·ä½“çš„ Chip æŒ‰é’®å“åº”é¼ æ ‡ï¼Œç©ºç™½é€æ˜åŒºåŸŸä¸é˜»æŒ¡ç‚¹å‡»ä¸‹æ–¹ç”»å¸ƒ */
            pointer-events: none;
            
            /* === æ”¹åŠ¨ 4: éšè—åŸç”Ÿçš„ä¸‘æ»šåŠ¨æ¡ (Chrome/Safari) === */
            scrollbar-width: none; /* Firefox */
        }
        
        /* éšè—æ»šåŠ¨æ¡ (Chrome/Safari) */
        #regulation-content-wrapper::-webkit-scrollbar {
            display: none; 
        }

        /* 3. åˆ†ç»„èƒ¶å›Šæ ·å¼ (Group Chip) */
        .reg-group {
            position: relative;
            display: inline-block;
            
            /* === æ”¹åŠ¨ 5: é˜²æ­¢è¢«æŒ¤æ‰ === */
            flex-shrink: 0; 
            
            /* === æ”¹åŠ¨ 6: æ¢å¤é¼ æ ‡äº‹ä»¶ (å› ä¸ºçˆ¶å®¹å™¨ç¦ç”¨äº†) === */
            pointer-events: auto; 
        }


        .reg-group-title {
            font-size: 12px; font-weight: 600; 
            background: rgba(255, 255, 255, 0.05) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding: 6px 12px;
            border-radius: 20px; /* æ›´åœ†æ¶¦ */
            cursor: pointer;
            transition: all 0.1s;
            display: flex; align-items: center; gap: 6px;
            user-select: none;
        }
        
        .reg-group:hover .reg-group-title {
            background: #2563eb !important; /* æ‚¬åœæ—¶ä½¿ç”¨æ›´äº®çš„è“è‰²æ¿€å‘å¯¹æ¯” */
    color: #fff !important;
            border-color: #bfdbfe;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        .reg-group-count {
            background: #e5e7eb; color: #6b7280;
            font-size: 10px; padding: 1px 6px; border-radius: 10px;
        }
        .reg-group:hover .reg-group-count {
            background: #dbeafe; color: #1e40af;
        }

                /* 4. ä¸‹æ‹‰èœå• (Grid Layout) */
        .reg-dropdown {
            /* å¸ƒå±€å±æ€§ (display: grid å¿…é¡»å¸¸é©»ï¼Œä»¥ä¾¿è®¡ç®—å¸ƒå±€) */
            display: grid; 
            position: absolute;
            top: 110%; 
            left: 0;
            z-index: 1000;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 12px;
            min-width: 320px;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;

            /* === æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ visibility+opacity ä»£æ›¿ display:none === */
            visibility: hidden;   /* éšè—ï¼Œä¸æ¥æ”¶é¼ æ ‡äº‹ä»¶ */
            opacity: 0;           /* é€æ˜ */
            transform: translateY(-5px); /* ç¨å¾®å‘ä¸Šåç§»ï¼Œå¢å¼ºå‡ºç°åŠ¨ç”»æ„Ÿ */

            /* === å…³é”®é€»è¾‘ï¼šé¼ æ ‡ç§»å¼€æ—¶çš„è¿‡æ¸¡æ•ˆæœ === */
            /* å«ä¹‰ï¼šopacityåœ¨1ç§’å»¶è¿Ÿåå¼€å§‹å˜é€æ˜ï¼Œvisibilityåœ¨1ç§’å»¶è¿Ÿåå˜ä¸ºhidden */
            transition: 
                transform 0.2s ease 0.1s, 
                opacity 0.2s ease 0.1s, 
                visibility 0s linear 0.1s; 
        }


                /* åªæœ‰å½“é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */
        .reg-group:hover .reg-dropdown {
            /* === æ‚¬åœæ—¶ç«‹å³æ˜¾ç¤º === */
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
            
            /* è¦†ç›–ä¸Šé¢çš„ transitionï¼Œå°† delay è®¾ä¸º 0sï¼Œå®ç°â€œç§»å…¥ç«‹å³æ˜¾ç¤ºï¼Œç§»å‡ºå»¶è¿Ÿæ¶ˆå¤±â€ */
            transition-delay: 0s;
        }


        /* 5. ä¸‹æ‹‰èœå•å†…çš„æŒ‰é’®é¡¹ */
        .reg-item-btn {
            font-size: 12px; color: #4b5563;
            background: #fff;
            border: 1px solid #f3f4f6;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            text-align: left;
            display: flex; align-items: center;
            transition: all 0.1s;
        }
        .reg-item-btn:hover {
            background: #f0f9ff; color: #0284c7; border-color: #bae6fd;
        }
        .reg-item-btn.active {
            background: #0ea5e9; color: white; border-color: #0284c7;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
        }
        
        /* æ–‡æœ¬è¿‡é•¿çœç•¥ */
        .reg-item-btn span {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }



        /* ========================================= */
        /* 3. å¸ƒå±€ç»“æ„ (Container, Sidebar, Graph)  */
        /* ========================================= */
        #main-container {
            flex: 1; display: flex; overflow: hidden; position: relative;
        }

/* ========================================= */
/* 3. ç°ä»£åŒ–å·¦ä¾§è¾¹æ  - æ»šåŠ¨ä¼˜åŒ–ä¿®å¤ç‰ˆ         */
/* ========================================= */
#sidebar {
    width: 320px; 
    background: #ffffff; 
    border-right: 1px solid #eee;
    
    /* æ ¸å¿ƒä¿®å¤ 1ï¼šä¸¥æ ¼é”å®šé«˜åº¦ï¼Œå¿…é¡»å‡å»é¡¶éƒ¨é«˜åº¦å¹¶è®¾å®š box-sizing */
    height: calc(100vh - 65px) !important; 
    box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šå¢åŠ æ€»é«˜åº¦ */
    padding: 20px 20px 0 20px; 
    
    display: flex; 
    flex-direction: column;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
    overflow: hidden; 
    min-width: 0 !important;
    transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1), 
                padding 0.2s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.15s ease;
}
/* åœ¨ HTML ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ‰€æœ‰å†…å®¹åŒ…åœ¨ä¸€ä¸ª div.sidebar-inner é‡Œ */
/* --- æ ¸å¿ƒä¿®å¤ï¼šå†…éƒ¨å›ºå®šå®½åº¦å®¹å™¨ --- */
.sidebar-inner {
    width: 280px; /* å›ºå®šå®½åº¦ï¼Œç­‰äº (sidebarå®½åº¦ - padding) */
    display: flex;
    flex-direction: column;
    height: 100%;
    flex-shrink: 0;
    /* å¼ºåˆ¶å†…éƒ¨æ–‡æœ¬ä¸æ¢è¡Œï¼Œé˜²æ­¢ç¼©è¿›æ—¶æ–‡å­—æŒ¤å‹ä¹±è·³ */
    white-space: nowrap; 
}
#sidebar.collapsed {
    width: 0 !important;
    min-width: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    opacity: 0;
    border-right: none;
    visibility: hidden; /* å½»åº•æ”¶èµ·æ—¶éšè—å†…éƒ¨å­å…ƒç´ ï¼Œé˜²æ­¢æº¢å‡ºæ˜¾ç¤º */
    pointer-events: none;
}
/* æ ‡é¢˜å›ºå®š */
.sidebar-title {
    flex-shrink: 0;
    font-size: 14px; 
    font-weight: bold; 
    color: #555;
    margin-bottom: 15px; 
    text-transform: uppercase; 
    letter-spacing: 1px;
}
/* å¤–éƒ¨é“¾æ¥æŒ‰é’® */
/* --- ä¼˜åŒ–ï¼šå¤–éƒ¨é“¾æ¥å’Œå›¾ä¾‹å›ºå®šåœ¨åº•éƒ¨ --- */
#sidebar-external-links {
    flex-shrink: 0;    /* ç¦æ­¢å‹ç¼© */
    padding: 12px 0;
    border-top: 1px solid #f1f5f9;
    background: #fff;
    /* ç¡®ä¿å®½åº¦å›ºå®šï¼Œä¸è¢«çˆ¶çº§ç¼©è¿›æŒ¤å‹ */
    width: 100%;
    margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
}
#sidebar-external-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: #f1f5f9;
    color: #475569 !important;
    padding: 12px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.1s;
    border: none !important;
}

#sidebar-external-links a:hover {
    background: #e2e8f0;
    color: #1e293b !important;
}

        .pathway-list { display: flex; flex-direction: column; gap: 8px; }
        
/* è°ƒæ•´ checkbox-item çš„å¸ƒå±€ï¼Œç¡®ä¿å‚ç›´å±…ä¸­ */
/* æ¢å¤ Pathway å¤é€‰æ¡†çš„ç®€æ´æ ·å¼ï¼ˆç§»é™¤ä¹‹å‰çš„ color-dotï¼‰ */
.checkbox-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 8px;
    cursor: pointer;
    font-size: 13px;
    color: #444;
}

.checkbox-item:hover {
    background: #f1f5f9;
}
.checkbox-item input { margin-right: 10px; accent-color: #2196F3; }

.checkbox-item input:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.checkbox-item input:checked::after {
    content: 'âœ“';
    position: absolute;
    color: white;
    font-size: 11px;
    left: 2px;
    top: -1px;
}
                /* Pathway åˆ†ç»„æŠ˜å  */
        /* åˆ†ç»„æ ‡é¢˜ï¼šå›å½’æœ€åˆçš„ä¸‹åˆ’çº¿åˆ†å‰²çº¿æ ·å¼ */
.sheet-group { 
    margin-top: 12px; 
    padding-top: 8px; 
    border-top: 1px solid #eee; 
    background: none !important; /* å»é™¤å¡ç‰‡èƒŒæ™¯ */
    border-radius: 0;
}
/* åˆ†ç»„å¤´éƒ¨æ ·å¼ */
.sheet-header {
    display: flex;
    align-items: center;
    padding: 10px 0;
    font-weight: bold;
    color: #333;
    border-bottom: 1px solid #f1f5f9;
    margin-bottom: 8px;
}

.sheet-swatch {
    width: 12px;
    height: 12px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* å¤§åˆ†ç±»æ ‡é¢˜ï¼ˆå¦‚ Carbohydratesï¼‰å·¦ä¾§çš„é¢œè‰²æ–¹å— */
.sheet-swatch-modern {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    display: inline-block;
    margin-right: 10px;
    flex-shrink: 0;
}
        /* 1. ç®­å¤´åŠ¨ç”»ä¼˜åŒ–ï¼šå¢åŠ ç¼“åŠ¨ */
        .sheet-arrow { 
            font-size: 10px; color: #999; margin-left: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        /* 2. å†…å®¹åŒºåŸŸåŠ¨ç”»ä¼˜åŒ–ï¼šä½¿ç”¨ max-height ä»£æ›¿ display */
        .sheet-body { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            margin-left: 10px; 
            
            /* å…³é”®åŠ¨ç”»å±æ€§ */
            overflow: hidden;       /* å¿…é¡»éšè—æº¢å‡ºå†…å®¹ */
            max-height: 1000px;     /* è®¾å®šä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ (å±•å¼€çŠ¶æ€) */
            opacity: 1;             /* å®Œå…¨ä¸é€æ˜ */
            transform: translateY(0);
            
            /* ç»„åˆè¿‡æ¸¡æ•ˆæœï¼šé«˜åº¦ã€é€æ˜åº¦ã€ä½ç§» */
            transition: 
                max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease,
                transform 0.3s ease,
                margin 0.3s ease;
        }

        /* 3. æ”¶èµ·çŠ¶æ€ï¼šé«˜åº¦å½’é›¶ï¼Œé€æ˜åº¦å½’é›¶ï¼Œç¦æ­¢ç‚¹å‡» */
        .sheet-group.collapsed .sheet-body { 
            /* display: none;  <-- åˆ æ‰è¿™è¡Œï¼Œå®ƒæ˜¯é€ æˆç”Ÿç¡¬çš„åŸå›  */
            max-height: 0; 
            opacity: 0;
            margin-top: 0;      /* æ¶ˆé™¤é—´è· */
            margin-bottom: 0;   
            transform: translateY(-10px); /* ç¨å¾®å‘ä¸Šä½ç§»ï¼Œäº§ç”Ÿæ”¶ç¼©æ„Ÿ */
            pointer-events: none; /* æ”¶èµ·åä¸å¯ç‚¹å‡» */
        }
        
        .sheet-group.collapsed .sheet-arrow { transform: rotate(-90deg); }


        /* Pathway æ–‡å­—å®¹å™¨ï¼Œå æ®ä¸­é—´å‰©ä½™ç©ºé—´ */
.pw-text {
    flex: 1; 
    margin-left: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* æ–‡å­—è¿‡é•¿æ˜¾ç¤ºçœç•¥å· */
}
        
/* ç°ä»£åŒ–å°åˆ†å­åˆ‡æ¢æŒ‰é’®æ ·å¼ */
.side-toggle-btn {
    opacity: 0.6; /* é»˜è®¤åŠé€æ˜ï¼Œä¸æŠ¢çœ¼ */
    padding: 3px 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #f9fafb;
    font-size: 10px;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0; /* ç¦æ­¢æŒ‰é’®è¢«å‹ç¼© */
}

.side-toggle-btn:hover {
    opacity: 1;
    background: #ffffff;
    border-color: #3b82f6;
    color: #3b82f6;
}

.side-toggle-btn.active {
    opacity: 1;
    background: #eff6ff;
    border-color: #3b82f6;
    color: #3b82f6;
    font-weight: bold;
    box-shadow: inset 0 1px 2px rgba(59, 130, 246, 0.1);
}
        /* ç»˜å›¾åŒºåŸŸ */
        #graph-area {
            flex: 1; position: relative; background: #f8f9fa; min-width: 0;
        }
        #cy { width: 100%; height: 100%;
            position: relative;  /* å…³é”®ï¼šè®¾ç½®å®šä½ä¸Šä¸‹æ–‡ */
    z-index: 10;         /* å…³é”®ï¼šè®¾ç½®æ¯”èƒŒæ™¯å›¾é«˜çš„å±‚çº§ */
}
/* --- ä¿®æ”¹ï¼šPathway åˆ—è¡¨æ»šåŠ¨å®¹å™¨ --- */
/* æ ¸å¿ƒä¿®å¤ 2ï¼šPathway æ»šåŠ¨å®¹å™¨ */
/* --- æ ¸å¿ƒï¼šæ»šåŠ¨æ¡åŒºåŸŸ --- */
#filter-container {
    flex: 1;           /* å æ®ä¸­é—´å‰©ä½™æ‰€æœ‰ç©ºé—´ */
    overflow-y: auto !important;  /* å¼ºåˆ¶å¼€å¯æ»šåŠ¨ */
    overflow-x: hidden;
    min-height: 0;     /* æå…¶é‡è¦ï¼šFlexå¸ƒå±€ä¸‹å¿…é¡»åŠ è¿™è¡Œï¼Œæ»šåŠ¨æ¡æ‰ä¼šå‡ºç° */
    margin-right: -8px; 
    padding-right: 8px;
}
/* ç¾åŒ–æ»šåŠ¨æ¡ */
#filter-container::-webkit-scrollbar { width: 5px; }
#filter-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
/* é’ˆå¯¹æ»‘å—ï¼ˆRangeï¼‰çš„ç®€å•å½¢çŠ¶ä¿®æ­£ */
#organelle-opacity {
    accent-color: #ffffff !important; /* å°†æ»‘å—åœ†ç‚¹å’Œè¿›åº¦æ¡æ”¹ä¸ºç™½è‰² */
    background: rgba(255, 255, 255, 0.2) !important; /* æœªé€‰ä¸­éƒ¨åˆ†çš„è½¨é“èƒŒæ™¯ */
    height: 4px !important;
}
#organelle-layer{
    position:absolute;
    inset:0;
    z-index: 0;               /* é«˜äº Cytoscape canvasï¼Œé¿å…è¢«èŠ‚ç‚¹é®ä½ */
    transform-origin: 0 0;
    pointer-events: none;      /* é»˜è®¤ä¸æŠ¢é¼ æ ‡ï¼Œé¿å…å½±å“å›¾äº¤äº’ */
}
#organelle-layer .organelle-item{
    position:absolute;
    box-sizing: border-box;
    transform-origin: center center;
    user-select: none;
    pointer-events: none;      /* é»˜è®¤ä¸å¯æ‹–ï¼Œéœ€å¼€å¯ç¼–è¾‘æ¨¡å¼æ‰å¯ç”¨ */
}
#organelle-layer .organelle-item img{
    width:100%;
    height:100%;
    display:block;
    opacity: var(--org-opacity, 0.27);
    filter: saturate(0.95) contrast(0.98);
}
/* ç¼–è¾‘æ¨¡å¼ä¸‹å¼€å¯äº¤äº’ */
body.organelle-edit-on #organelle-layer{ pointer-events: auto; }
body.organelle-edit-on #organelle-layer .organelle-item{ pointer-events: auto; cursor: grab; }
body.organelle-edit-on #organelle-layer .organelle-item:active{ cursor: grabbing; }

/* è½»é‡æ§åˆ¶ç‚¹ */
.org-handle{
    position:absolute;
    width:12px; height:12px;
    border-radius: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,0,0,0.35);
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    display:none;
}
body.organelle-edit-on .org-handle{ display:block; }
.org-handle.resize-se{ right:-6px; bottom:-6px; cursor: nwse-resize; }
.org-handle.rotate{
    left:50%; top:-18px;
    transform: translateX(-50%);
    width:16px; height:16px;
    border-radius: 20px;
    cursor: grab;
}
.org-rotate-line{
    position:absolute;
    left:50%; top:-10px;
    width:2px; height:12px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.35);
    display:none;
}
body.organelle-edit-on .org-rotate-line{ display:block; }

/* å°æç¤º */
#organelle-hint{
    position:absolute;
    left:14px; bottom:14px;
    z-index: 70;
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 12px;
    color:#2c3e50;
    background: rgba(255,255,255,0.88);
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    pointer-events:none;
}



        /* ========================================= */
        /* [ä¿®æ­£ç‰ˆ] 4. ç»Ÿä¸€å³ä¾§è¾¹æ  (Right Sidebar)   */
        /* ========================================= */
        #right-sidebar {
            /* æ ¸å¿ƒï¼šé»˜è®¤çŠ¶æ€å®Œå…¨æ”¶èµ· */
            width: 0; 
            background: #fff; 
            
            /* æ”¶èµ·æ—¶å»æ‰è¾¹æ¡†ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸€æ¡ç»†çº¿ */
            border-left: none; 
            box-shadow: none;

            /* å¸ƒå±€åŸºç¡€ */
            display: flex; 
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            z-index: 20;

            /* åŠ¨ç”»æ•ˆæœ */
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden; /* å¿…é¡»éšè—æº¢å‡ºå†…å®¹ */
        }

        /* --- å±•å¼€çŠ¶æ€ (ç”± JS æ·»åŠ æ­¤ Class) --- */
        #right-sidebar.expanded {
            width: 400px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.05);
            border-left: 1px solid #eee;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }

        /* ä¾§è¾¹æ å†…éƒ¨å®¹å™¨ */
        .right-sidebar-content {
            width: 400px; /* å›ºå®šå®½åº¦ï¼Œé˜²æ­¢åŠ¨ç”»æ—¶å†…å®¹æŒ¤å‹ */
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .right-sidebar-content::-webkit-scrollbar { width: 4px; }
        .right-sidebar-content::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        /* ä¸Šæ–¹æ”¶èµ·æŒ‰é’®æ¡ */
        .sidebar-collapse-bar {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: flex-start;
            background: #fafafa;
        }
        .right-collapse-icon {
            cursor: pointer; color: #666; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            transition: color 0.1s;
        }
        .right-collapse-icon:hover { color: #2196F3; }

        /* å„ä¸ªåˆ†åŒºæ ·å¼ */
        .sidebar-section {
            border-bottom: 8px solid #f4f6f9; /* åŒºå—åˆ†å‰²çº¿ */
            padding: 0; /* å†…éƒ¨ Padding äº¤ç»™ header å’Œ content */
            animation: fadeIn 0.3s ease;
            display: none; /* é»˜è®¤ä¸æ˜¾ç¤ºï¼Œæœ‰æ•°æ®æ—¶ flex/block */
            flex-direction: column;
        }
        
        .section-header {
            padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .section-title {
            font-size: 13px; font-weight: 800; color: #444; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .section-close-btn {
            cursor: pointer; color: #bbb; font-size: 18px; line-height: 1;
        }
        .section-close-btn:hover { color: #ff4757; }

                /* ========================================= */
        /* [è¿˜åŸ] æœç´¢ç»“æœåˆ—è¡¨æ ·å¼ (Classic Style)   */
        /* ========================================= */
        .result-list { 
            display: flex; flex-direction: column; gap: 8px; 
            padding: 10px;
            overflow-y: auto;
            max-height: 400px;
        }

        .result-item {
            padding: 12px 14px; 
            background: #fff;
            border: 1px solid #edf2f7; /* æµ…ç°è¾¹æ¡† */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s ease;
            margin-bottom: 8px;
        }

        .result-item:hover {
            background: #f0f9ff;
            border-color: #2196F3;
            transform: translateX(2px); /* å¾®å¾®å³ç§» */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-name {
            font-size: 18px; 
            font-weight: 800; 
            color: #1a1a1a;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 4px;
            list-style: 1.4;
        }

        /* ç±»å‹æ ‡ç­¾ (å¦‚ Enzyme, Main Substrate) */
        .result-type-tag {
            font-size: 10px; 
            font-weight: 600;
            padding: 2px 8px; 
            border-radius: 10px; 
            color: #fff; 
            white-space: nowrap;
            margin-left: 8px;
        }

        /* è·¯å¾„è¡Œ (å¸¦æ–‡ä»¶å¤¹å›¾æ ‡) */
        .result-pathway {
            font-size: 12px; 
            color: #666; 
            margin-top: 5px;
            display: flex; 
            align-items: center; 
            gap: 4px;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }

        .result-score {
            font-size: 10px; 
            color: #9ca3af; 
            text-align: right; 
            margin-top: 2px;
        }

        /* èŠ‚ç‚¹è¯¦æƒ…å®¹å™¨ */
        #node-detail-content { padding: 15px; }
        
        /* è¯¦æƒ…æ’ç‰ˆ - å­—æ®µ */
        .detail-group { margin-bottom: 12px; }
        .detail-label { 
            font-size: 10px; font-weight: 700; color: #9ca3af; 
            text-transform: uppercase; margin-bottom: 4px;
        }
        .detail-value { 
            font-size: 13px; color: #1f2937; line-height: 1.5; 
            word-wrap: break-word; 
        }
         /* åŒ–å­¦å¼ä¸“ç”¨ */
        .formula-box {
            background: #f8fafc; padding: 8px; border-radius: 4px;
            border-left: 3px solid #3b82f6; font-family: monospace; font-size: 12px;
        }
        /* é“¾æ¥ */
        .detail-link { 
            color: #2563eb; text-decoration: none; font-size: 12px; 
            display: inline-flex; align-items: center; gap: 4px; 
        }
        .detail-header-title {
            font-size: 22px;
            font-weight: 900;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        /* æ‰©å±•æŒ‰é’® */
        #right-sidebar-expand-btn {
            display: none; /* é»˜è®¤éšè— */
            position: absolute; right: 0; top: 80px; z-index: 50;
            padding: 8px 12px 8px 10px;
            background: #fff; border: 1px solid #e5e7eb; border-right: none;
            border-radius: 6px 0 0 6px; box-shadow: -2px 2px 8px rgba(0,0,0,0.05);
            cursor: pointer; color: #4b5563; align-items: center; gap: 4px; font-size: 12px;
        }

        /* éšè—æ—§çš„æ‚¬æµ®çª— */
        #hover-info-panel { display: none !important; }

        /* 2. ç¡®ä¿ä¾§è¾¹æ å†…çš„å›¾ç‰‡å®¹å™¨ç¾è§‚ */
        .reg-detail-img-container {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        .reg-detail-img-container img {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            cursor: zoom-in;
        }

        /* 3. è°ƒèŠ‚å› å­è¯¦æƒ…çš„æ–‡æœ¬æ ·å¼ */
        .reg-detail-text {
            line-height: 1.6;
            color: #334155;
            font-size: 14px;
            padding: 10px;
            background: #fffbeb; /* æ·¡æ·¡çš„ç¥ç€è‰²èƒŒæ™¯ï¼Œæš—ç¤ºè°ƒèŠ‚ä¿¡æ¯ */
            border-left: 4px solid #f59e0b;
            border-radius: 4px;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ (Chrome/Safari) */
        #regulation-overlay-label::-webkit-scrollbar { width: 6px; }
        #regulation-overlay-label::-webkit-scrollbar-track { background: #333; }
        #regulation-overlay-label::-webkit-scrollbar-thumb { background: #666; border-radius: 3px; }
        /* è°ƒæ•´å†…éƒ¨å›¾ç‰‡æ ·å¼ */
        .reg-img-display {
            width: 100%; height: auto; max-height: 200px;
            object-fit: contain; border-radius: 4px; margin-bottom: 8px;
            display: block; background: #fff;
        }
        .reg-text-content { line-height: 1.5; color: #f1f2f6; }
        
        /* æ·»åŠ ä¸€ä¸ªç®€æ˜“çš„å…³é—­æŒ‰é’®æ ·å¼ */
        .reg-close-btn {
            position: absolute; top: 5px; right: 10px;
            cursor: pointer; color: #bbb; font-size: 18px; font-weight: bold;
        }
        .reg-close-btn:hover { color: #fff; }
/* 4. Homeé”®ä¼˜åŒ–ï¼šä½¿å…¶ä¸çªå…€ï¼Œèå…¥æ•´ä½“ Glassmorphism é£æ ¼ */
button[onclick="centerView()"] {
    /* ä¿®æ”¹é¢œè‰²ä¸å½¢çŠ¶ï¼šå»é™¤çº¯ç™½èƒŒæ™¯ï¼Œæ”¹ä¸ºåŠé€æ˜æ·±è‰²èƒŒæ™¯ */
    background: rgba(255, 255, 255, 0.1) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    /* ä¿®æ”¹å¤§å°ï¼šè°ƒæ•´ä¸ºåœ†å½¢æˆ–åœ†è§’çŸ©å½¢ï¼Œå‡å°ä½“ç§¯ */
    border-radius: 50% !important;
    width: 38px !important;
    height: 38px !important;
    font-size: 18px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

button[onclick="centerView()"]:hover {
    /* é¼ æ ‡æ‚¬åœè‰² */
    background: rgba(255, 255, 255, 0.25) !important;
    border-color: #60a5fa !important;
}

        /* ========================================= */
        /* 6. å…¶ä»–è¾…åŠ©æ ·å¼                          */
        /* ========================================= */
        
        /* åŠ è½½é®ç½© */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; color: #666; z-index: 20;
        }
                /* ========================================= */
        /* 8. ä¾§è¾¹æ æŠ˜å æŒ‰é’®                         */
        /* ========================================= */
        
        /* æ”¶èµ·æŒ‰é’®ï¼ˆä½äº Sidebar æ ‡é¢˜æ å†…ï¼‰ */
        .sidebar-collapse-btn {
            float: right; 
            cursor: pointer; 
            color: #999; 
            font-size: 16px;
            transition: color 0.1s;
        }
        .sidebar-collapse-btn:hover { color: #333; }
        .pathway-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px; /* ç¨å¾®å¸¦ä¸€ç‚¹åœ†è§’ï¼Œæ›´ç²¾è‡´ */
    margin-right: 8px;
    flex-shrink: 0;    /* é˜²æ­¢è¢«æŒ¤å‹å˜å½¢ */
    display: inline-block;
}
        /* å±•å¼€æŒ‰é’®ï¼ˆæ‚¬æµ®åœ¨ç”»å¸ƒå·¦ä¸Šè§’ï¼Œåˆå§‹éšè—ï¼‰ */
        #sidebar-expand-btn {
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰ sidebar æ”¶èµ·æ—¶æ‰æ˜¾ç¤º */
            position: absolute; 
            left: 10px; top: 10px;
            z-index: 50; /* ä¿è¯åœ¨ç”»å¸ƒä¹‹ä¸Š */
            padding: 6px 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 12px;
            color: #555;
            align-items: center; gap: 4px;
        }
        #sidebar-expand-btn:hover {
            background: #f9f9f9; color: #2196F3;
        }
        /* Pathway ä¸“å±æ ‡ç­¾æ ·å¼ */
        .pathway-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .pathway-pill {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.1s;
        }

        .pathway-pill:hover {
            background: #e0f2fe;
            color: #0369a1;
            border-color: #bae6fd;
        }

        .pathway-pill::before {
            content: 'ğŸ“‚';
            font-size: 10px;
        }
                /* ========================================= */
        /* 7. å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† (Lightbox)              */
        /* ========================================= */
        #img-modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; 
            z-index: 10000; /* æœ€é«˜å±‚çº§ */
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            cursor: zoom-out; /* ç‚¹å‡»ç¼©å° */
            justify-content: center; align-items: center;
            animation: fadeIn 0.2s;
        }
        
        #img-modal-content {
            display: block;
            max-width: 90%; 
            max-height: 90%;
            border: 2px solid #fff;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: zoomIn 0.2s;
            cursor: default;
        }

        /* ç¼©ç•¥å›¾æŒ‡é’ˆæ ·å¼ */
        .reg-img-display { cursor: zoom-in; transition: transform 0.1s; }
        .reg-img-display:hover { transform: scale(1.02); }

        /* ä¿®æ­£ï¼šå¼€å…³(Switch)æ ·å¼ä¸æ»‘åŠ¨æ–¹å‘ */
.switch {
    position: relative; 
    display: inline-block; 
    width: 38px; 
    height: 20px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(255, 255, 255, 0.2); 
    transition: .3s; 
    border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
    background-color: white; 
    transition: .3s; 
    border-radius: 50%;
}
/* å…³é”®ä¿®æ­£ï¼šchecked çŠ¶æ€ä¸‹åœ†ç‚¹å‘å³ç§»åŠ¨ 18px */
input:checked + .slider { 
    background-color: #ffffff !important; 
}
input:checked + .slider:before { 
    transform: translateX(18px); 
    background-color: #111827; /* å¼€å¯ååœ†ç‚¹å˜ä¸ºæ·±è‰² */
}
/* === ç°ä»£åŒ–æ“ä½œæŒ‰é’®æ ·å¼ === */
.side-action-btn {
    width: 100%;
    margin: 10px 0 20px 0;
    padding: 10px 16px;
    background: rgba(241, 245, 249, 0.8); /* ææµ…çš„è“ç°è‰² */
    color: #64748b; /* ç°ä»£é’¢ç°è‰² */
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.side-action-btn:hover {
    background: #fff;
    color: #ef4444; /* æ‚¬åœæ—¶å˜ä¸ºçº¢è‰²ï¼Œæš—ç¤ºâ€œæ¸…é™¤/åˆ é™¤â€æ“ä½œ */
    border-color: #fecaca;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
    transform: translateY(-1px);
}

.side-action-btn:active {
    transform: translateY(0px);
    background: #fef2f2;
}

/* æŒ‰é’®å†…çš„å›¾æ ‡æ ·å¼ */
.side-action-btn svg {
    transition: transform 0.2s ease;
}

.side-action-btn:hover svg {
    transform: rotate(90deg);
}
        /* å›¾ä¾‹å®¹å™¨ï¼šå›ºå®šåœ¨ Sidebar åº•éƒ¨ */
/* --- å›¾ä¾‹åŒºåŸŸï¼šå½»åº•ä¿®å¤æ˜¾ç¤ºä¸å…¨ --- */
/* æ ¸å¿ƒä¿®å¤ 3ï¼šå›¾ä¾‹åŒºåŸŸå¼ºåˆ¶å¯è§ */
/* 3. æ ¸å¿ƒä¿®æ”¹ï¼šå›¾ä¾‹åŒºåŸŸå¼ºåˆ¶é”å®š */
#sidebar-legend {
    flex: 0 0 auto;      /* ç»å¯¹ç¦æ­¢å¢é•¿å’Œç¼©å° */
    padding: 15px;
    background: #f8fafc;
    border-top: 2px solid #edf2f7;
    width: 100%;
    box-sizing: border-box;
    display: block !important;
    position: relative;
    z-index: 101;
}
.legend-title {
    font-size: 10px;
    font-weight: 800;
    color: #262627;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 16px;
}

/* å¼ºåˆ¶ Legend å†…éƒ¨ç¾¤ç»„ä¸è¢«æˆªæ–­ */
.legend-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #475569;
    height: 18px; /* å›ºå®šæ¯ä¸€è¡Œçš„é«˜åº¦ï¼Œé˜²æ­¢å¡Œé™· */
}

.l-swatch {
    width: 20px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
}

        .l-node-rxn { background: #e5e5e5; border: 1px solid #ccc; border-radius: 2px; }
        .l-node-sub-in { background: #74b9ff; }
        .l-node-sub-out { background: #a29bfe; }
        .l-node-act { background: #2e7d32; border-radius: 2px; }
        .l-node-inh { background: #c62828; border-radius: 2px; }

        /* è¿çº¿æ¨¡æ‹Ÿ */
        .l-line {
            width: 24px;
            height: 0;
            border-top-width: 2px;
            border-top-style: solid;
            position: relative;
        }
        .l-line-main { border-top-color: #C0C0C0; }
        .l-line-main::after {
            content: '';
            position: absolute;
            right: -2px; top: -4px;
            border-left: 5px solid #C0C0C0;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
        }
        /* ä¿®æ­£è™šçº¿æ ·å¼ */
.l-line-reg { border-top: 2px dashed #4CAF50; width: 24px; }
.l-line-trans { border-top: 2px dashed #CDCDCD; width: 24px; }
/* ç¡®ä¿ç”»å¸ƒå®¹å™¨åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æœ€å°å°ºå¯¸ï¼Œé˜²æ­¢ resize ç¬é—´å¡Œé™· */
#graph-area {
    min-width: 300px; /* æˆ–è€…ä½ è®¤ä¸ºåˆé€‚çš„æœ€å°å®½åº¦ */
    overflow: hidden;
}

#cy {
    /* å¼ºåˆ¶ GPU åŠ é€Ÿï¼Œå‡å°‘é‡ç»˜æ—¶çš„é—ªçƒ */
    backface-visibility: hidden;
    transform: translateZ(0);
}
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes zoomIn { from {transform: scale(0.8);} to {transform: scale(1);} }

    </style>
</head>
<body>
    <div id="loading-mask">
    <div class="loader-content">
        <div class="loader-logo">
            <div class="ring"></div>
            <div class="leaf">ğŸŒ±</div>
        </div>
        <h2 class="loader-title">Metabolism</h2>
        <p class="loader-subtitle">Processing biological network...</p>
        
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        <p id="progress-text">Initializing...</p>
    </div>
</div>

<style>
/* === ç°ä»£åŒ–é®ç½©å±‚æ ·å¼ === */
#loading-mask {
    position: fixed;
    inset: 0;
    background: #ffffff;
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.6s;
}

.loader-content {
    text-align: center;
    animation: fadeInScale 0.8s ease-out;
}

/* åŠ¨æ€ Logo åŠ¨ç”» */
.loader-logo {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loader-logo .ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 3px solid #f0fdf4;
    border-top: 3px solid #22c55e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loader-logo .leaf {
    font-size: 32px;
    animation: breathe 2s ease-in-out infinite;
}

/* å­—ä½“æ ·å¼ */
.loader-title {
    font-family: "Inter", "Segoe UI", sans-serif;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    color: #111827;
    margin: 0;
}

.loader-subtitle {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* è¿›åº¦æ¡æ ·å¼ */
.progress-container {
    width: 200px;
    height: 4px;
    background: #f3f4f6;
    border-radius: 10px;
    margin: 30px auto 10px;
    overflow: hidden;
    position: relative;
}

#progress-bar {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #22c55e, #10b981);
    border-radius: 10px;
    transition: width 0.3s ease-out;
}

#progress-text {
    font-size: 11px;
    color: #9ca3af;
    font-family: monospace;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes breathe {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.15); opacity: 1; }
}

@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
</style>
    <!-- 2. é¡¶éƒ¨å¯¼èˆªæ  (èåˆç‰ˆ) -->
<header class="topbar">
<div class="brand">
        <a href="https://github.com/codestoler/BioChemPathways" target="_blank" class="brand-emoji source-code-link">ğŸŒ±</a>
        <div class="brand-title">
            <span class="brand-title-main">Metabolism</span>
            <span class="brand-title-sub">Pathway Explorer</span>
        </div>
    
    <a href="manual.html" target="_blank" class="manual-link" title="Open User Manual">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    </a>
</div>

    <!-- ä¸­é—´ï¼šæœç´¢ä¸è·¯å¾„ -->
    <div class="topbar-center">
        <!-- æœç´¢æ¡† -->
        <div class="chip search-chip">
    <span class="chip-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </span>
    <input type="text" id="search-input" placeholder="Enter Molecule (e.g. ATP)..." />
</div>

        <!-- è·¯å¾„æŸ¥æ‰¾ -->
        <div class="chip path-chip">
            <span class="chip-label-prefix">Path:</span>
            <input type="text" id="path-start-input" placeholder="Start Molecule">
            
            <span class="chip-separator">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
            </span>
            
            <input type="text" id="path-end-input" placeholder="End Molecule">
            <button id="path-find-btn" type="button" class="btn">
                Search
            </button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
    <div class="topbar-actions">
        <!-- === ä¿®æ”¹ï¼šRegulation å¼€å…³ä¸ä¸‹æ–¹æç¤ºæ–‡å­— === -->
        <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: center;">

            <!-- ä¸Šæ–¹ï¼šæ–‡å­— + å¼€å…³ (ä¿ç•™åŸæœ‰çš„æ¨ªå‘å¸ƒå±€) -->
            <div class="chip" style="background:transparent; border:none; padding:0; gap:8px; min-height: 20px;">
                <span class="chip-label" style="font-weight:bold; color:#555;">Regulation</span>
                <label class="switch">
                    <input type="checkbox" id="regulation-toggle" onchange="toggleRegulationAndRender()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- ä¸‹æ–¹ï¼šæç¤ºæ–‡å­— (é»˜è®¤éšè—ï¼Œå¼€å¯åæ˜¾ç¤º) -->
            <span id="scroll-hint-text" style="font-size: 10px; color: #999; margin-top: 2px; display: none; cursor: default;">
                Scroll to Move â‡„
            </span>

        </div>
                <div style="width:1px; height:20px; background:#e5e7eb; margin:0 5px;"></div> <!-- åˆ†éš”çº¿ -->
        <!-- File 1 åŸæœ‰çš„å›ä¸­æŒ‰é’® -->
        <button onclick="centerView()" class="btn" title="Back to Center">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
</button>
        <!-- [ä¿®æ”¹] ç»†èƒå™¨æ§åˆ¶ï¼šåªä¿ç•™æ»‘å— -->
        <div class="chip" style="background:transparent; border:none; padding:0; gap:8px;">
            <span class="chip-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <circle cx="8" cy="8" r="1.5" fill="currentColor"></circle>
                    <circle cx="15" cy="11" r="1" fill="currentColor"></circle>
                    <circle cx="11" cy="16" r="2" fill="currentColor"></circle>
                </svg>
                Organelles
            </span>
            <input id="organelle-opacity" type="range" min="0.05" max="0.75" step="0.01" value="0.27">
        </div>

        <span id="status" class="status"></span>
    </div>
    <div id="error-msg"></div>
</header>
    <!-- === æ–°å¢ï¼šRegulation å±•å¼€é¢æ¿ (æ”¾åœ¨ Header ä¸‹æ–¹ï¼Œç‹¬ç«‹å®¹å™¨) === -->
<div id="regulation-panel">
    <div id="regulation-content-wrapper">
        <!-- å†…å®¹ç”± JS ç”Ÿæˆ -->
    </div>
</div>
    
    
    <!-- ç”¨äºæ˜¾ç¤ºèŠ‚ç‚¹ä¸‹æ–¹ Regulation æ–‡æœ¬çš„æµ®åŠ¨å±‚ -->
    <div id="regulation-overlay-label"></div>

    <!-- 3. ä¸»å†…å®¹åŒºåŸŸ (æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ª clean çš„ container) -->
    <div id="main-container">
        
        <!-- å·¦ä¾§ï¼šç­›é€‰æ§åˆ¶ -->
        <div id="sidebar">
            <div class="sidebar-inner">
            <div class="sidebar-title">
                Pathway Select
                <!-- [æ–°å¢] æ”¶èµ·æŒ‰é’® -->
                <span class="sidebar-collapse-btn" title="Collapse Sidebar" onclick="toggleSidebar()">&#9664;</span>
            </div>
            <div id="filter-container" class="pathway-list">
                <div style="color:#999; font-style:italic;">No data found</div>
            </div>
            <div id="sidebar-external-links" style="padding: 0 15px 10px 15px;">
            <a href="amino acid.html" target="_blank" style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                background: #f0f7ff;
                color: #2196F3;
                text-decoration: none;
                padding: 10px;
                border: 1px solid #d0e7ff;
                border-radius: 8px;
                font-size: 13px;
                font-weight: bold;
                transition: all 0.1s;
            " onmouseover="this.style.background='#e3f2fd';this.style.borderColor='#2196F3';" 
            onmouseout="this.style.background='#f0f7ff';this.style.borderColor='#d0e7ff';">
                More Amino Acid Details â†—
            </a>
        </div>
        
            <div id="sidebar-legend">
            <div class="legend-title">Map Legend</div>
            <div class="legend-group">
                <div class="legend-item">
                    <div class="l-swatch l-node-rxn"></div>
                    <span>Enzyme / Reaction</span>
                </div>
                <div class="legend-item">
                    <div class="l-swatch l-node-sub-in"></div>
                    <span>Sub-Reactant</span>
                </div>
                <div class="legend-item">
                    <div class="l-swatch l-node-sub-out"></div>
                    <span>Sub-Product</span>
                </div>
                
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:4px 0;">

                <div class="legend-item">
                    <div class="l-swatch l-node-act"></div>
                    <span>Activator</span>
                </div>
                <div class="legend-item">
                    <div class="l-swatch l-node-inh"></div>
                    <span>Inhibitor</span>
                </div>

                <hr style="border:0; border-top:1px solid #e2e8f0; margin:4px 0;">

                <div class="legend-item">
                    <div class="l-line l-line-main"></div>
                    <span>Main Metabolic Path</span>
                </div>

                <div class="legend-item">
                    <div class="l-line l-line-reg"></div>
                    <span>Regulatory Control</span>
                </div>

                <div class="legend-item">
                    <div class="l-line l-line-trans"></div>
                    <span>Transport / Transmembrane</span>
                </div>
            </div>
            </div>
        </div>
        </div>

        <!-- ä¸­é—´ï¼šCytoscape ç”»å¸ƒ -->
        <div id="graph-area">
            <!-- [æ–°å¢] å±•å¼€æŒ‰é’® (æ‚¬æµ®) -->
            <button id="sidebar-expand-btn" onclick="toggleSidebar()">
                <span>&#9654;</span> Pathway Filter
            </button>
            <!-- [æ–°å¢] å³ä¾§å±•å¼€æŒ‰é’® -->
            <button id="right-sidebar-expand-btn" onclick="toggleRightSidebar()">
                &#9664; Results
            </button>
            <div id="loading" style="display:none;">å¤„ç†ä¸­...</div>
            <div id="cy"></div>
            <div id="organelle-layer" aria-label="organelle overlay"></div>
            <div id="organelle-hint" style="display:none;">Drag to move â€¢ Drag corner to resize â€¢ Drag ring to rotate â€¢ (Organelle mode ON)</div>
        </div>

                <!-- [ä¿®æ”¹] å³ä¾§è¾¹æ ï¼šç»Ÿä¸€å±•ç¤ºæœç´¢ã€è·¯å¾„ã€è¯¦æƒ… -->
        <!-- åˆå§‹çŠ¶æ€ï¼šå»æ‰ expanded ç±»ï¼Œå»æ‰è¡Œå†…æ ·å¼ï¼Œä¾é  CSS é»˜è®¤ width:0 éšè— -->
        <div id="right-sidebar">
            <div class="right-sidebar-content">
                
                <!-- é¡¶éƒ¨æ”¶èµ·æŒ‰é’® -->
                <div class="sidebar-collapse-bar">
                    <span class="right-collapse-icon" onclick="toggleRightSidebar()" title="Collapse Panel">
                        &#9654; Collapse
                    </span>
                </div>

                <!-- 1. åŒºåŸŸï¼šæœç´¢ç»“æœ (åˆå§‹ hidden) -->
                <div id="section-search-results" class="sidebar-section" style="display:none;">
                    <div class="section-header">
                        <span class="section-title">ğŸ” Substrate (<span id="result-count">0</span>)</span>
                        <span class="section-close-btn" onclick="clearSpecificState('search')" title="Clear Search">&times;</span>
                    </div>
                    <div id="list-search-results" class="result-list"></div>
                </div>

                <!-- 2. åŒºåŸŸï¼šè·¯å¾„ç»“æœ (åˆå§‹ hidden) -->
                <div id="section-path-results" class="sidebar-section" style="display:none;">
                    <div class="section-header">
                        <span class="section-title">ğŸ§¬ Path Analysis</span>
                        <span class="section-close-btn" onclick="clearSpecificState('path')" title="Clear Path">&times;</span>
                    </div>
                    <div id="list-path-results" class="result-list"></div>
                </div>

                <!-- 3. åŒºåŸŸï¼šç‚¹å‡»èŠ‚ç‚¹è¯¦æƒ… (åˆå§‹ hidden) -->
                <div id="section-node-details" class="sidebar-section" style="display:none;">
                    <div class="section-header">
                        <span class="section-title">ğŸŒ± Details</span>
                        <span class="section-close-btn" onclick="clearSpecificState('node')" title="Close Detail">&times;</span>
                    </div>
                    <!-- è¯¦æƒ…å†…å®¹å®¹å™¨ -->
                    <div id="node-detail-content"></div>
                </div>

            </div>
        </div>

    </div> <!-- å…³é—­ main-container -->

    <!-- 4. æ‚¬åœä¿¡æ¯å±•ç¤ºé¢æ¿ -->
    <div id="hover-info-panel">
        <!-- å†…å®¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        <div style="color:#ccc; text-align:center; margin-top:30px;">Waiting for connection...</div>
    </div>

    <!-- è„šæœ¬åº“ (Staticfile CDN) -->
    <script src="https://cdn.staticfile.org/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://cdn.staticfile.org/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <!-- === æ–°å¢ï¼šRDKit JS åº“ === -->
    <script src="https://unpkg.com/@rdkit/rdkit/Code/MinimalLib/dist/RDKit_minimal.js"></script>

<script>
    window.currentRegNodeId = null;
        // === æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼çŠ¶æ€ ===
    // é»˜è®¤å…³é—­ï¼šä¸å¯æ‹–åŠ¨ï¼Œä¸å¯ä¿å­˜
    window.isEditMode = false;

    // ... (åœ¨ script æ ‡ç­¾é¡¶éƒ¨é™„è¿‘)

    // === æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼çŠ¶æ€ ===
    window.isEditMode = false;

    // === æ–°å¢ï¼šRDKit åˆå§‹åŒ–é€»è¾‘ ===
    window.rdkitModule = null; // å…¨å±€å˜é‡å­˜å‚¨ RDKit å®ä¾‹

    // åœ¨é¡µé¢åŠ è½½åˆæœŸå°è¯•åˆå§‹åŒ– RDKit
    // æ³¨æ„ï¼šinitRDKitModule æ˜¯å¼•å…¥ RDKit.js åè‡ªåŠ¨æä¾›çš„å…¨å±€å‡½æ•°
    if (window.initRDKitModule) {
        window.initRDKitModule()
            .then(function(instance) {
                window.rdkitModule = instance;
                console.log("RDKit JS åŠ è½½æˆåŠŸ!");
            })
            .catch(function(e) {
                console.error("RDKit åŠ è½½å¤±è´¥:", e);
            });
    }

// ... (åç»­ä»£ç )

    function toggleEditMode() {
        const checkbox = document.getElementById('edit-mode-toggle');
        window.isEditMode = checkbox.checked;
        
        const status = document.getElementById('status');
        
        if (window.cyGraph) {
            // cy.autoungrabify(true) è¡¨ç¤ºç¦æ­¢æŠ“å–(é”å®š)
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼(true)ï¼Œåˆ™ ungrabify åº”ä¸º false(å…è®¸æŠ“å–)
            window.cyGraph.autoungrabify(!window.isEditMode);
        }

        if (window.isEditMode) {
            if(status) {
                status.innerText = "âš ï¸ ç¼–è¾‘æ¨¡å¼ï¼šèŠ‚ç‚¹å¯ç§»åŠ¨ï¼Œæ›´æ”¹å°†è‡ªåŠ¨ä¿å­˜";
                status.style.color = "#d35400";
            }
        } else {
            if(status) {
                status.innerText = "ğŸ”’ é”å®šæ¨¡å¼ï¼šå¸ƒå±€å·²é”å®š";
                status.style.color = "#6b7280";
            }
        }
    }

    // ================= é…ç½®åŒºåŸŸ =================
    // åœ¨æ­¤å¤„è¾“å…¥ä½ æƒ³åˆå¹¶æ˜¾ç¤ºçš„ Sheet åç§°
    const TARGET_SHEETS = ["Carbonhydrates", "Lipids", "Amino acids", "Nucleotides"];

    // ä¸»é¢˜è‰²ï¼šä¸åŒ sheet çš„ä¸»ååº”ç‰©/ä¸»äº§ç‰©
    const SHEET_COLORS = {
        "Carbonhydrates": "#E699A7",
        "Lipids": "#FEDD9E",
        "Amino acids": "#A6D9C0",
        "Nucleotides": "#71A7D2"
    };
    // é¢œè‰²ä¼˜å…ˆçº§ï¼šè‹¥åŒä¸€åˆ†å­å‡ºç°åœ¨å¤šä¸ª sheetsï¼ŒæŒ‰æ­¤é¡ºåºå–è‰²
    const SHEET_PRIORITY = ["Carbonhydrates", "Lipids", "Amino acids", "Nucleotides"];

     // === æ–°å¢ï¼šå‚è€ƒæ•°æ®å­˜å‚¨ ===
    window.refData = {
        molecules: new Map(), // Key: substance, Value: { smiles, link }
        enzymes: new Map()    // Key: name, Value: { ec, link }
    };

    // ====== Side-molecule visibility state ======
    // é€‰ä¸­çš„â€œé…¶/ååº”â€é›†åˆï¼šç‚¹é€‰å¤šä¸ªååº”æ—¶ï¼Œå°åˆ†å­ä¸ä¼šæ¶ˆå¤±
    window.selectedReactionIds = new Set();
    // è¢«â€œDemonstrate currencyâ€æŒ‰é’®å›ºå®šæ‰“å¼€çš„å°åˆ†å­ï¼šæŒ‰ pathway ç»´åº¦
    window.pinnedSidePathways = new Set();
    // å½“å‰ pathway å‹¾é€‰çŠ¶æ€ï¼ˆç”¨äº side-molecule çš„æ˜¾ç¤ºè£å‰ªï¼‰
    window.__selectedPathwaysSet = new Set();


    // ============================================================
    // [æ’å…¥] 1. å¤æ‚å›¾ç‰‡æ–‡ä»¶åæ¸…å•
    // æµè§ˆå™¨æ— æ³•è‡ªåŠ¨åˆ—å‡ºæ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ "A;B.png" è¿™ç§åå­—ï¼Œå¿…é¡»åœ¨æ­¤åˆ—å‡º
    // ============================================================
    const complexImageFiles = [
        // è¯·åœ¨æ­¤å¤„æ‰‹åŠ¨å¡«å…¥ images/ æ–‡ä»¶å¤¹ä¸‹é‚£äº›åŒ…å«åˆ†å·çš„æ–‡ä»¶å
        "G6PD;6PGD.png",
        "ExampleA;ExampleB.jpg", 
        // ...
    ];

    // [æ’å…¥] 2. æŸ¥æ‰¾åŒ¹é…æ–‡ä»¶åçš„è¾…åŠ©å‡½æ•°
function findMatchingImageFile(targetName) {
    if (!targetName) return null;
    const cleanTarget = String(targetName).trim().toLowerCase();

    // 1. ä¼˜å…ˆä»â€œå¤æ‚æ–‡ä»¶åæ¸…å•â€ä¸­æŸ¥æ‰¾ï¼ˆå¤„ç†å¸¦åˆ†å·çš„æƒ…å†µï¼‰
    for (let fileName of (complexImageFiles || [])) {
        const nameWithoutExt = fileName.replace(/\.[^/.]+$/, ""); 
        const parts = nameWithoutExt.split(';');
        if (parts.some(part => part.trim().toLowerCase() === cleanTarget)) return fileName;
    }
    
    // 2. å¦‚æœæ¸…å•é‡Œæ²¡æ‰¾åˆ°ï¼Œä¸è¦è¿”å› nullï¼Œè€Œæ˜¯è¿”å›åŸå§‹åç§°
    // è®© img æ ‡ç­¾çš„ onerror æœºåˆ¶å»å¤„ç†è¿™ç§â€œä¸ç¡®å®šæ˜¯å¦å­˜åœ¨â€çš„æ™®é€šå›¾ç‰‡
    return targetName; 
}

    function pickSheetColor(sheetSet) {
        if (!sheetSet) return "#95a5a6";
        for (const s of SHEET_PRIORITY) {
            if (sheetSet.has(s)) return SHEET_COLORS[s];
        }
        return "#95a5a6";
    }
    // === æ–°å¢ï¼šå¸ƒå±€å†»ç»“åŠŸèƒ½ ===
    window.__uiFrozen = (localStorage.getItem('metabolic_ui_frozen') === '1');

    function applyFrozenState() {
        const btn = document.getElementById('freeze-toggle');
        if (btn) {
            // æ›´æ–°æŒ‰é’®å¤–è§‚
            btn.textContent = window.__uiFrozen ? 'ğŸ”“ Unfreeze' : 'ğŸ”’ Freeze';
            btn.classList.toggle('is-on', window.__uiFrozen);
        }
        if (window.cyGraph) {
            // Cytoscape API: ç¦æ­¢/å…è®¸æŠ“å–èŠ‚ç‚¹
            window.cyGraph.autoungrabify(!!window.__uiFrozen);
        }
    }

    function toggleFrozen() {
        window.__uiFrozen = !window.__uiFrozen;
        localStorage.setItem('metabolic_ui_frozen', window.__uiFrozen ? '1' : '0');
        applyFrozenState();
    }

// ===========================================

    // å®šä¹‰ä¸€ä¸ª Keyï¼Œç”¨äºåœ¨æµè§ˆå™¨ç¼“å­˜ä¸­å­˜å‚¨æ•°æ®
    const STORAGE_KEY = 'metabolic_pathway_positions_v1';

    // ä¿®æ”¹å‰ï¼šä¼šå‘é€ POST è¯·æ±‚åˆ°æœåŠ¡å™¨
    // ä¿®æ”¹åï¼šä»…åœ¨æ§åˆ¶å°è®°å½•ï¼Œä¸å‘é€è¯·æ±‚
    async function saveLayoutToServer(positions) {
        console.log('[Local Only] Layout saved to browser storage.');
        return; // é˜»æ–­è¯·æ±‚
    }
            // ============================================
    // è§†å›¾å›ä¸­å‡½æ•°
    // ============================================
    function centerView() {
        const cy = window.cyGraph || window.cy;
        if (!cy) return;

        // ä½¿ç”¨åŠ¨ç”»å¹³æ»‘è¿‡æ¸¡åˆ°å…¨å±é€‚åº”çŠ¶æ€
        cy.animate({
            fit: {
                eles: cy.elements(), // åŒ…å«æ‰€æœ‰èŠ‚ç‚¹å’Œè¿çº¿
                padding: 50          // å››å‘¨ç•™ç™½ 50px
            },
            duration: 500,           // åŠ¨ç”»æ—¶é•¿ 500ms
            easing: 'ease-out-cubic' // ç¼“åŠ¨æ•ˆæœ
        });
    }

    async function preloadLayoutFromServer() {
        try {
            const res = await fetch('layout_positions.json');
            if (!res.ok) return false;
            const positions = await res.json();
            if (!positions || typeof positions !== 'object') return false;

            // Put into autosave cache so existing restoreLayoutAuto() works unchanged
            const autoKey = STORAGE_KEY + '_autosave';
            localStorage.setItem(autoKey, JSON.stringify(positions));
            return true;
        } catch (e) {
            console.warn('[layout] preload from server failed:', e.message || e);
            return false;
        }
    }

    async function clearLayoutOnServer() {
        // åˆ æ‰ fetch è¯·æ±‚
        console.log('[Local Only] Server layout remains untouched.');
    }

    // ============================================
    // 1. ä¿å­˜å¸ƒå±€å‡½æ•°
    // ============================================
    function saveLayout() {
        if (!window.isEditMode) {
            alert("è¯·å…ˆå¼€å¯é¡¶éƒ¨å³ä¾§çš„ 'Edit Layout' å¼€å…³ï¼Œæ‰èƒ½ä¿å­˜å¸ƒå±€ä¿®æ”¹ã€‚");
            return;
        }
        if (!window.cyGraph) return;

        const positions = {};
        window.cyGraph.nodes().forEach(node => {
            // ç¡®ä¿ JSON æ–‡ä»¶é‡Œæ°¸è¿œåªæœ‰ä¸»å¹²èŠ‚ç‚¹å’Œååº”èŠ‚ç‚¹
            if (node.hasClass('side-molecule')) return;
            positions[node.id()] = node.position();
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(positions));
        saveLayoutToServer(positions);
        alert(`å·²ä¿å­˜ ${Object.keys(positions).length} ä¸ªä¸»èŠ‚ç‚¹çš„ä½ç½®ï¼\n(å‰¯èŠ‚ç‚¹ä½ç½®å°†åŠ¨æ€è®¡ç®—)`);
    }



    // ============================================
    // 2. æ¸…é™¤å¸ƒå±€(é‡ç½®)å‡½æ•°
    // ============================================
    function clearLayoutCache() {
        localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_KEY + '_autosave');
        clearLayoutOnServer();
alert('å·²æ¸…é™¤å¸ƒå±€ç¼“å­˜ã€‚åˆ·æ–°é¡µé¢å°†é‡æ–°è®¡ç®—é»˜è®¤å¸ƒå±€ã€‚');
        location.reload(); // è‡ªåŠ¨åˆ·æ–°é¡µé¢
    }




    let cy = null;
    // ============================================================
    // [ä¿®å¤ç‰ˆ] å³ä¾§è¾¹æ å…¨å±€çŠ¶æ€ç®¡ç†
    // ============================================================
    window.rightSidebarState = {
        searchData: null, // æœç´¢ç»“æœæ•°ç»„
        pathData: null,   // è·¯å¾„ç»“æœæ•°ç»„
        nodeHtml: null,   // èŠ‚ç‚¹è¯¦æƒ… HTML
        isExpanded: false // ç”¨äºè®°å½•ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ”¶èµ·ï¼Œæˆ–è€…ç”±ç¨‹åºè‡ªåŠ¨å±•å¼€
    };

    // æ ¸å¿ƒå‡½æ•°ï¼šæ ¹æ®æ•°æ®çŠ¶æ€å†³å®šæ˜¾ç¤ºå“ªäº›åŒºå—ï¼Œä»¥åŠä¾§è¾¹æ æ˜¯å¦å±•å¼€
    function updateRightSidebar() {
        const state = window.rightSidebarState;
        const sidebar = document.getElementById('right-sidebar');
        const expandBtn = document.getElementById('right-sidebar-expand-btn');

        // è·å–å„åŒºå— DOM
        const secSearch = document.getElementById('section-search-results');
        const secPath = document.getElementById('section-path-results');
        const secNode = document.getElementById('section-node-details');
        const divNode = document.getElementById('node-detail-content');

        let hasAnyContent = false;

        // 1. å¤„ç†æœç´¢ç»“æœæ¨¡å—
        if (state.searchData && state.searchData.length > 0) {
            secSearch.style.display = 'flex'; // æ˜¾ç¤º
            hasAnyContent = true;
        } else {
            secSearch.style.display = 'none'; // éšè—
        }

        // 2. å¤„ç†è·¯å¾„ç»“æœæ¨¡å—
        if (state.pathData && state.pathData.length > 0) {
            secPath.style.display = 'flex'; // æ˜¾ç¤º
            hasAnyContent = true;
        } else {
            secPath.style.display = 'none'; // éšè—
        }

        // 3. å¤„ç†èŠ‚ç‚¹è¯¦æƒ…æ¨¡å—
        if (state.nodeHtml) {
            secNode.style.display = 'flex'; // æ˜¾ç¤º
            divNode.innerHTML = state.nodeHtml;
            
            // å¦‚æœæœ‰ SMILES canvas éœ€è¦ç»˜åˆ¶ï¼Œæ‰§è¡Œå›è°ƒ
            if (window._pendingSmilesCallback) {
                setTimeout(window._pendingSmilesCallback, 0);
                window._pendingSmilesCallback = null;
            }
            hasAnyContent = true;
        } else {
            secNode.style.display = 'none'; // éšè—
        }

        // 4. æœ€ç»ˆå†³å®šä¾§è¾¹æ æ•´ä½“æ˜¯å¦å±•å¼€
        if (!hasAnyContent) {
            // æ²¡æœ‰ä»»ä½•æ•°æ® -> å¼ºåˆ¶æ”¶èµ·
            sidebar.classList.remove('expanded');
            state.isExpanded = false;
            // æ²¡æ•°æ®ä¹Ÿä¸éœ€è¦æ˜¾ç¤ºå±•å¼€æŒ‰é’®
            if (expandBtn) expandBtn.style.display = 'none';
        } else {
            // æœ‰æ•°æ®
            if (state.isExpanded) {
                // çŠ¶æ€ä¸ºå±•å¼€ -> æ·»åŠ  expanded ç±» (å®½åº¦å˜å¤§)
                sidebar.classList.add('expanded');
                if (expandBtn) expandBtn.style.display = 'none';
            } else {
                // çŠ¶æ€ä¸ºæ”¶èµ· -> ç§»é™¤ expanded ç±» (å®½åº¦å˜ 0)
                sidebar.classList.remove('expanded');
                // æ˜¾ç¤ºå°æ‚¬æµ®æŒ‰é’®ï¼Œè®©ç”¨æˆ·èƒ½å†æ¬¡æ‰“å¼€
                if (expandBtn) expandBtn.style.display = 'flex';
            }
        }

        // é€šçŸ¥ Cytoscape é€‚é…ç”»å¸ƒå¤§å°
        const cy = window.cyGraph;
        if (cy) setTimeout(() => cy.resize(), 300);
    }
    // ç»Ÿä¸€çš„è§†è§’ä¸­å¿ƒå¯¹é½å‡½æ•°
window.focusNodeCenter = function(node) {
    const cy = window.cyGraph || window.cy;
    if (!cy || !node || node.length === 0) return;

    // 1. å¼ºè¡Œåœæ­¢ä¹‹å‰çš„æ‰€æœ‰åŠ¨ç”»
    cy.stop();

    // 2. å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å³ä¾§è¾¹æ å±•å¼€åçš„å®¹å™¨å®½åº¦å·²ç»ç¨³å®š
    // å»¶è¿Ÿ 350ms å¯¹åº” CSS transition çš„ 0.3s
    setTimeout(() => {
        const targetPos = node.position();
        const level = 2.0; // ç»Ÿä¸€è®¾ç½®æ”¾å¤§å€ç‡ä¸º 2.0ï¼Œä½ å¯ä»¥æŒ‰éœ€ç»Ÿä¸€ä¿®æ”¹æ­¤å¤„

        // é‡æ–°è·å–å½“å‰ç”»å¸ƒçš„å®é™…å®½é«˜ï¼ˆæ­¤æ—¶è¾¹æ å·²å±•å¼€ï¼‰
        const panX = cy.width() / 2 - targetPos.x * level;
        const panY = cy.height() / 2 - targetPos.y * level;

        cy.animate({
            pan: { x: panX, y: panY },
            zoom: level,
            duration: 500,
            easing: 'ease-out-cubic'
        });
    }, 350); 
};
    // åˆ‡æ¢æŠ˜å /å±•å¼€
    function toggleRightSidebar() {
        const s = window.rightSidebarState;
        
        // åˆ‡æ¢çŠ¶æ€
        s.isExpanded = !s.isExpanded;
        
        // åº”ç”¨çŠ¶æ€
        updateRightSidebar();
    }

    // æ¸…é™¤ç‰¹å®šæ¨¡å—çš„æ•°æ®
    // è¯·æ›¿æ¢åŸæœ‰çš„ clearSpecificState å‡½æ•°
function clearSpecificState(type) {
    const cy = window.cyGraph || window.cy;
    
    if (type === 'search') {
        window.rightSidebarState.searchData = null;
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        // æ¸…é™¤æœç´¢äº§ç”Ÿçš„é«˜äº®
        if (cy) cy.elements().removeClass('dimmed highlighted');
        if (typeof filterGraph === 'function') filterGraph(); // æ¢å¤å½“å‰é€šè·¯çš„æ­£å¸¸æ˜¾ç¤º
        
    } else if (type === 'path') {
        window.rightSidebarState.pathData = null;
        if (typeof clearPathHighlight === 'function') clearPathHighlight();
        
    } else if (type === 'node') {
        window.rightSidebarState.nodeHtml = null;
        // å¦‚æœæ˜¯è¯¦æƒ…é¡µï¼Œå¯èƒ½éœ€è¦æ¸…é™¤é€‰ä¸­çŠ¶æ€
        if (window.selectedReactionIds) window.selectedReactionIds.clear();
        if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
    }

    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¿…é¡»è°ƒç”¨æ­¤å‡½æ•°ï¼Œå³ä¾§è¾¹æ æ‰ä¼šé‡æ–°è®¡ç®—å“ªäº›åŒºå—è¯¥éšè—
    updateRightSidebar();
}


    // ============================================================
    // [ä¿®æ”¹] â€œå…³é—­æœç´¢é¢æ¿â€ é€»è¾‘
    // ============================================================
    function closeSearchPanel() {
        // å…¼å®¹æ—§ä»£ç è°ƒç”¨
        clearSpecificState('search');
        // åŒæ—¶æ¸…é™¤è·¯å¾„ï¼Ÿè§†éœ€æ±‚è€Œå®šï¼ŒåŸä»£ç å¥½åƒæ˜¯åˆ†å¼€çš„ï¼Œè¿™é‡Œä¿æŒåˆ†å¼€
    }

        // ============================================================
    // æœç´¢åŠŸèƒ½æ¨¡å—
    // ============================================================
    function initSearchListener() {
        const searchInput = document.getElementById('search-input');
        if(searchInput) {
            // ç›‘å¬è¾“å…¥äº‹ä»¶ (input ä»£è¡¨æ¯æ¬¡æ‰“å­—éƒ½è§¦å‘)
            searchInput.addEventListener('input', function(e) {
                const term = e.target.value.trim();
                performSearch(term);
            });
        }

        // è·¯å¾„æœç´¢ç›¸å…³
        const startInput = document.getElementById('path-start-input');
        const endInput = document.getElementById('path-end-input');
        const pathBtn = document.getElementById('path-find-btn');

        if (pathBtn && startInput && endInput) {
            const doPathSearch = () => {
                const startTerm = startInput.value.trim();
                const endTerm = endInput.value.trim();
                if (!startTerm || !endTerm) {
                    const ps = document.getElementById('path-status');
                    if (ps) ps.innerText = 'Please enter both start and end molecules.';
                    return;
                }
                findPathBetweenMetabolites(startTerm, endTerm);
            };

            pathBtn.addEventListener('click', doPathSearch);
            endInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    doPathSearch();
                }
            });
        }
    }


        // ===================================
    // æœç´¢é€»è¾‘æ›´æ–° (æ”¯æŒå³ä¾§æ æ˜¾ç¤º + ç‚¹å‡»å®šä½)
    // ===================================
    function calcSimilarity(term, label) {
        if (!term || !label) return 0;
        const a = String(term).toLowerCase().trim();
        const b = String(label).toLowerCase().trim();
        if (!a || !b) return 0;
        if (a === b) return 1;

        // å­ä¸²åŠ åˆ†
        if (b.includes(a) || a.includes(b)) {
            // é•¿åº¦è¶Šæ¥è¿‘åˆ†æ•°è¶Šé«˜
            const lenDiff = Math.abs(a.length - b.length);
            const maxLen = Math.max(a.length, b.length) || 1;
            const closeness = 1 - lenDiff / maxLen;
            return 0.7 + 0.3 * closeness; // 0.7 ~ 1.0
        }

        // ç®€å•ç¼–è¾‘è·ç¦»ï¼Œç”¨äºæ¨¡ç³ŠåŒ¹é…
        const lenA = a.length;
        const lenB = b.length;
        const dp = Array(lenA + 1).fill(null).map(() => Array(lenB + 1).fill(0));
        for (let i = 0; i <= lenA; i++) dp[i][0] = i;
        for (let j = 0; j <= lenB; j++) dp[0][j] = j;
        for (let i = 1; i <= lenA; i++) {
            for (let j = 1; j <= lenB; j++) {
                const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                dp[i][j] = Math.min(
                    dp[i - 1][j] + 1,
                    dp[i][j - 1] + 1,
                    dp[i - 1][j - 1] + cost
                );
            }
        }
        const dist = dp[lenA][lenB];
        const maxLen = Math.max(lenA, lenB) || 1;
        const sim = 1 - dist / maxLen; // 0 ~ 1
        return sim * 0.6; // é™æƒä¸€ç‚¹ï¼Œé¿å…å‹è¿‡å­ä¸²åŒ¹é…
    }

    // === æ–°å¢ï¼šæœç´¢å¢å¼ºè¾…åŠ©å‡½æ•° ===
function getLinkedReactionsFromMolecule(node) {
    const cy = window.cyGraph;
    if (!cy || !node) return [];

    // 1) å¦‚æœæ˜¯å‰¯äº§ç‰©ï¼Œç›´æ¥æ‰¾ parentRxn
    if (node.hasClass && node.hasClass('side-molecule')) {
        const pr = node.data('parentRxn');
        if (pr) {
            const rxn = cy.$id(pr);
            if (rxn && rxn.length) return [rxn];
        }
    }

    // 2) å¦‚æœæ˜¯ä¸»å¹²åˆ†å­ï¼Œæ‰¾ç›¸è¿çš„ reaction èŠ‚ç‚¹
    const rxnSet = new Set();
    node.connectedEdges().forEach(e => {
        const s = e.source();
        const t = e.target();
        const other = (s.id() === node.id()) ? t : s;
        if (other && other.data && other.data('type') === 'reaction') {
            rxnSet.add(other);
        }
    });
    return Array.from(rxnSet);
}

function pickBestReactionForMolecule(node) {
    const cy = window.cyGraph;
    if (!cy) return null;
    const reactions = getLinkedReactionsFromMolecule(node);
    if (!reactions.length) return null;
    
    // ä¼˜å…ˆé€‰æ‹©é€šè¿‡ 'main' è¾¹è¿æ¥çš„ååº”
    const mainLinked = [];
    node.connectedEdges().forEach(e => {
        const other = (e.source().id() === node.id()) ? e.target() : e.source();
        if (other && other.data('type') === 'reaction' && e.data('edgeType') === 'main') {
            mainLinked.push(other);
        }
    });
    if (mainLinked.length) return mainLinked[0];
    return reactions[0]; 
}

    function focusOnReaction(rxnNode, opts = {}) {
        const cy = window.cyGraph;
        if (!cy || !rxnNode || !rxnNode.length) return;
        
        // 1) è§¦å‘å‰¯å°åˆ†å­å±•å¼€ logic (File 1 çš„ç°æœ‰é€»è¾‘)
        const rxnId = rxnNode.id();
        if (!window.selectedReactionIds) window.selectedReactionIds = new Set();
        window.selectedReactionIds.add(rxnId); // å¼ºåˆ¶é€‰ä¸­
        refreshSideVisibility(); // File 1 åŸæœ‰å‡½æ•°

        // 2) æ ·å¼å¤„ç†
        cy.nodes('[type="reaction"]').removeClass('search-focus-reaction');
        rxnNode.addClass('search-focus-reaction');

        // 3) èšç„¦åŠ¨ç”»ï¼šåŒ…å«ååº”èŠ‚ç‚¹åŠå…¶å‘¨å›´åˆ†å­
        const focusEles = rxnNode.closedNeighborhood();
        cy.elements().removeClass('highlighted').addClass('dimmed');
        focusEles.removeClass('dimmed').addClass('highlighted');
        
        // 4) è¡¥é«˜äº®å‘½ä¸­çš„åˆ†å­
        if (opts.alsoSelectNode && opts.alsoSelectNode.length) {
            opts.alsoSelectNode.removeClass('dimmed').addClass('highlighted');
        }

        // 5) ç§»åŠ¨è§†è§’
        cy.animate({
            fit: { eles: focusEles, padding: 180 },
            duration: 500,
            easing: 'ease-out-cubic'
        });
    }
    function computeNodesCentroid(nodes) {
const arr = nodes.toArray();
if (!arr.length) return null;
let sx = 0, sy = 0;
for (const n of arr) {
const p = n.position();
sx += p.x; sy += p.y;
}
return { x: sx / arr.length, y: sy / arr.length };
}

// å°†ååº”èŠ‚ç‚¹æ”¾åˆ°å…¶ä¸»ååº”ç‰©ä¸ä¸»äº§ç‰©ä¸­ç‚¹
function applyReactionMidpoints(cy) {
const reactions = cy.nodes('[type="reaction"]');
reactions.forEach(rxn => {
    const rxnId = rxn.id();// å¦‚æœè¯¥ååº”èŠ‚ç‚¹å·²ç»æœ‰ä¿å­˜çš„ä½ç½®ï¼Œåˆ™è·³è¿‡
if (savedPositions && savedPositions[rxnId]) return;
// åªçœ‹ main è¾¹
const srcs = rxn.incomers('edge[edgeType="main"]').sources();
const tgts = rxn.outgoers('edge[edgeType="main"]').targets();
if (!srcs.length || !tgts.length) return; // ä¸æ»¡è¶³â€œä¸€è¿›ä¸€å‡ºâ€çš„æ¡ä»¶åˆ™è·³è¿‡
const srcC = computeNodesCentroid(srcs);
const tgtC = computeNodesCentroid(tgts);
if (!srcC || !tgtC) return;

rxn.position({
  x: (srcC.x + tgtC.x) / 2,
  y: (srcC.y + tgtC.y) / 2
});
});
}


    // å…³é—­å³ä¾§æ 
    function closeSearchPanel() {
        const cy = window.cyGraph;
        const input = document.getElementById('search-input');
        const statusSpan = document.getElementById('search-status');
        const sidebar = document.getElementById('search-sidebar');

        // æ¸…ç©ºæœç´¢æ¡†ä¸çŠ¶æ€æ–‡å­—
        if (input) input.value = '';
        if (statusSpan) statusSpan.innerText = '';
        if (sidebar) sidebar.style.display = 'none';

        // æ¸…é™¤æœç´¢äº§ç”Ÿçš„é«˜äº® / å˜æš—
        if (cy) {
            cy.elements().removeClass('dimmed').removeClass('highlighted');
        }

        // æ¸…é™¤è·¯å¾„é«˜äº®
        if (typeof clearPathHighlight === 'function') {
            clearPathHighlight();
        }

        // æ¢å¤å½“å‰çš„ Pathway å¯è§æ€§ä¸å‰¯å°åˆ†å­/è·¨è†œæ˜¾éš
        filterGraph();
    }

    // æ¸…é™¤è·¯å¾„é«˜äº®
    function clearPathHighlight() {
        const cy = window.cyGraph;
        if (!cy) return;
        
        stopPathFlowAnimation(); // åœæ­¢åŠ¨ç”»
        
        cy.elements('.path-node').removeClass('path-node');
        cy.elements('.path-edge').removeClass('path-edge').style('line-dash-offset', 0); // é‡ç½®åç§»
        
        const ps = document.getElementById('path-status');
        if (ps) ps.innerText = '';
    }
    // æ ¹æ®åç§°æŒ‘é€‰â€œæœ€ç›¸ä¼¼â€çš„åˆ†å­èŠ‚ç‚¹
    function pickBestMoleculeNodeByName(term) {
        const cy = window.cyGraph;
        if (!cy) return null;
        const lower = String(term || '').toLowerCase().trim();
        if (!lower) return null;

        let bestNode = null;
        let bestScore = 0;

        cy.nodes('[type = "molecule"]').forEach(node => {
            const label = node.data('label');
            if (!label) return;
            const score = calcSimilarity(lower, label);
            if (score > bestScore) {
                bestScore = score;
                bestNode = node;
            }
        });

        return bestNode;
    }






    function applyPathHighlight(pathNodes) {
    const cy = window.cyGraph;
    if (!cy || !pathNodes || !pathNodes.length) return;

    // 1. æ¸…é™¤æ—§çŠ¶æ€
    clearPathHighlight();
    stopPathFlowAnimation(); // å…ˆåœæ­¢ä¹‹å‰çš„æµåŠ¨

    const pathNodesCol = cy.collection(pathNodes);
    pathNodesCol.addClass('path-node');

    const pathEdges = [];
    for (let i = 0; i < pathNodes.length - 1; i++) {
        const a = pathNodes[i];
        const b = pathNodes[i + 1];
        // å…³é”®ï¼šåªè·å–ä» a åˆ° b çš„æœ‰å‘è¾¹ï¼Œç¡®ä¿åŠ¨ç”»æ–¹å‘æ­£ç¡®
        const edgesAB = a.edgesTo(b); 
        edgesAB.forEach(e => pathEdges.push(e));
    }
    const pathEdgesCol = cy.collection(pathEdges);
    pathEdgesCol.addClass('path-edge');

    // 2. é•œå¤´å¹³æ»‘ç§»åŠ¨
    cy.animate({
        fit: {
            eles: pathNodesCol.union(pathEdgesCol),
            padding: 80
        },
        duration: 500,
        easing: 'ease-out-cubic',
        complete: () => {
            // 3. é•œå¤´ç§»åŠ¨å®Œæˆåï¼Œå¯åŠ¨æµåŠ¨åŠ¨ç”»
            startPathFlowAnimation();
        }
    });
}
// -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 1ï¼šæ–‡æœ¬æ ¼å¼åŒ– (å¤„ç†ä¸Šä¸‹æ ‡ã€å¸Œè…Šå­—æ¯)
        // -------------------------------------------------------------
        function formatText(str) {
            if (!str || typeof str !== 'string') return str;
            let s = str;

            // 1. å¸Œè…Šå­—æ¯æ›¿æ¢ (ä¸åŒºåˆ†å¤§å°å†™)
            s = s.replace(/alpha/gi, 'Î±');
            s = s.replace(/beta/gi, 'Î²');
            s = s.replace(/gamma/gi, 'Î³');
            s = s.replace(/delta/gi, 'Î”');

            // 2. åŒ–å­¦å¼/ç‰¹æ®Šå­—ç¬¦æ›¿æ¢è§„åˆ™
            const replacements = [
                { k: 'NH4+',  v: 'NHâ‚„âº' },
                { k: 'Ca2+',  v: 'CaÂ²âº' },
                { k: 'Mg2+',  v: 'MgÂ²âº' },
                { k: 'PO4-',  v: 'POâ‚„â»' },
                { k: 'HCO3-', v: 'HCOâ‚ƒâ»' },
                { k: 'NADP+', v: 'NADPâº' },
                { k: 'NAD+',  v: 'NADâº' },
                { k: 'FADH2', v: 'FADHâ‚‚' },
                { k: 'H2O',   v: 'Hâ‚‚O' },
                { k: 'NH3',   v: 'NHâ‚ƒ' },
                { k: 'O2',    v: 'Oâ‚‚' },
                { k: 'N5',    v: 'Nâµ' },
                { k: 'N10',   v: 'NÂ¹â°' },
                { k: 'CO2',   v: 'COâ‚‚' },
                { k: 'H+',    v: 'Hâº' }
            ];

            replacements.forEach(item => {
                const reqStr = item.k.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
                const re = new RegExp(reqStr, 'g');
                s = s.replace(re, item.v);
            });
            // ä½¿ç”¨ (?<![a-zA-Z]) ç¡®ä¿ e çš„å‰é¢æ²¡æœ‰è‹±æ–‡å­—æ¯ï¼ˆé˜²æ­¢åŒ¹é… ase-ï¼‰
            // ä½¿ç”¨ (?![a-zA-Z]) ç¡®ä¿ - çš„åé¢æ²¡æœ‰è‹±æ–‡å­—æ¯
            // -------------------------------------------------------------
            s = s.replace(/(?<![a-zA-Z])e-(?![a-zA-Z])/g, 'eâ»');
                    return s;
        }
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.onload = async function() {
        try {
            if (typeof cytoscapeDagre !== 'undefined') {
                cytoscape.use(cytoscapeDagre);
            }
        } catch (e) { console.warn("Layout plugin already registered"); }

        // å¹¶è¡ŒåŠ è½½å›¾è¡¨æ•°æ®å’Œå‚è€ƒæ•°æ®
        await Promise.all([
            loadAndMergeSheets(),
            loadReferenceData()
        ]);
    };

    // === æ–°å¢ï¼šåŠ è½½å‚è€ƒæ•°æ®å‡½æ•° ===
    async function loadReferenceData() {
        try {
            // 1. åŠ è½½ molecule SMILES Sheet
            const molRes = await fetch(`data/molecule_SMILES.json`);

            if (molRes.ok) {
                const molData = await molRes.json();
                molData.forEach(row => {
                    // ç¡®ä¿åŒ¹é…æ—¶ä¸åŒºåˆ†é¦–å°¾ç©ºæ ¼
                    const name = String(row['Substance'] || '').trim();
                    if (name) {
                        window.refData.molecules.set(name, {
                            smiles: row['SMILES'],
                            link: row['Link']
                        });
                    }
                });
            }

            // 2. åŠ è½½ enzyme EC Sheet
            // ...
            const enzRes = await fetch(`data/enzyme_EC.json`);
            if (enzRes.ok) {
                const enzData = await enzRes.json();
                enzData.forEach(row => {
                    const name = String(row['name'] || '').trim();
                    if (name) {
                        window.refData.enzymes.set(name, {
                            ec: row['identifier'], // å¯¹åº” identifier æ 
                            link: row['link']      // å¯¹åº” link æ 
                        });
                    }
                });
            }
            console.log("å‚è€ƒæ•°æ®åŠ è½½å®Œæ¯•");
        } catch (e) {
            console.warn("å‚è€ƒæ•°æ®åŠ è½½å¤±è´¥ï¼ˆéé˜»æ–­æ€§ï¼‰:", e);
        }
    }


        async function loadAndMergeSheets() {
        // æ˜¾ç¤ºå° Loading æç¤ºï¼Œé‡ç½®çŠ¶æ€
        document.getElementById('loading').style.display = 'flex';
        updateStatus('');
    
        try {
            let combinedData = [];
            
            // å¹¶è¡ŒåŠ è½½ Excel æ•°æ®
            const requests = TARGET_SHEETS.map(name =>
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æŠŠæ–‡ä»¶åé‡Œçš„ç©ºæ ¼æ¢æˆäº†ä¸‹åˆ’çº¿ï¼Œå¯¹åº”åˆšæ‰ç”Ÿæˆçš„ JSON æ–‡ä»¶å
                    fetch(`data/${name.replace(/\s+/g, '_')}.json`)
                    .then(res => {
                        if(!res.ok) throw new Error(`Sheet [${name}] è¯»å–å¤±è´¥ (Status: ${res.status})`);
                        return res.json();
                    })
                    .then(sheetData => {
                        if (!Array.isArray(sheetData)) throw new Error(`Sheet [${name}] æ•°æ®æ ¼å¼é”™è¯¯`);
                        sheetData.forEach(row => row.__sheet = name);
                        return sheetData;
                    })
            );

            const results = await Promise.all(requests);
            results.forEach(sheetData => {
                combinedData = combinedData.concat(sheetData);
            });

            console.log(`åˆå¹¶å®Œæˆï¼Œå…± ${combinedData.length} è¡Œæ•°æ®`);
            
            // é¢„åŠ è½½å¸ƒå±€
            await preloadLayoutFromServer();

            // å¼€å§‹ç»˜å›¾
            processDataAndDraw(combinedData);

        } catch (err) {
            console.error('Data Load Error:', err);
            
            // ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æœå‡ºé”™ï¼Œå¿…é¡»æ‰‹åŠ¨éšè—å…¨å±ç™½è‰²é®ç½©ï¼Œå¦åˆ™ç”¨æˆ·åªèƒ½çœ‹åˆ°ç™½å±
            const mask = document.getElementById('loading-mask');
            if (mask) mask.style.display = 'none';

            // æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º
            showError(`æ•°æ®åŠ è½½å¤±è´¥: ${err.message}`);
        } finally {
            // éšè—ä¸­é—´çš„å° loading æ–‡å­—
            const smallLoading = document.getElementById('loading');
            if (smallLoading) smallLoading.style.display = 'none';
        }
    }


        // ============================================
    // æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†æ•°æ®å¹¶ç»˜å›¾
    // ============================================
    function processDataAndDraw(data) {
        // ã€ä¿®å¤ 1ã€‘ç§»é™¤äº† if (!window.cyGraph) return; 
        // å› ä¸ºé¦–æ¬¡åŠ è½½æ—¶ graph å°šæœªåˆ›å»ºï¼Œä¸èƒ½ç›´æ¥è¿”å›ã€‚

        const elements = [];
        const pathwaysBySheet = new Map();
        
        // ç”¨äºååº”å»é‡çš„æ³¨å†Œè¡¨ï¼škey=signature, value=rxnId
        const rxnRegistry = new Map(); 
        const createdRxnIds = new Set();
        
        // å…¨å±€å˜é‡ï¼šå­˜å‚¨ç‰©è´¨çš„æºæ•°æ®ï¼ˆç”¨äºæœç´¢å’Œæ˜¾ç¤ºæ‰€å±Pathwayï¼‰
        window.mainMoleculeMeta = new Map();

        

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 2ï¼šè§£æåˆ†å­å­—ç¬¦ä¸² (åˆ†å·æˆ–å†’å·åˆ†éš”)
        // -------------------------------------------------------------
        const parseMolecules = (str) => {
            if (!str) return [];
            // æ”¯æŒ "A; B" æˆ– "A: id" æ ¼å¼ï¼Œå–åˆ†å·åˆ†éš”åçš„ç¬¬ä¸€éƒ¨åˆ†
            return String(str).split(';').map(s => s.split(':')[0].trim()).filter(s => s);
        };

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 3ï¼šè§„èŒƒåŒ–ç»†èƒå™¨åç§°
        // -------------------------------------------------------------
        const normalizeCompartment = (place) => {
            if (!place) return '';
            const raw = String(place).trim();
            if (!raw || raw === '0') return '';
            const first = raw.split(/[;,]/)[0].trim();
            return first.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_\u4e00-\u9fa5]/g, '_');
        };

        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 4ï¼šç”Ÿæˆååº”å”¯ä¸€ç­¾å (ç”¨äºåˆå¹¶åŒç±»ååº”)
        // -------------------------------------------------------------
                // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 4ï¼šç”Ÿæˆååº”å”¯ä¸€ç­¾å (ç”¨äºåˆå¹¶åŒç±»ååº”)
        // -------------------------------------------------------------
        const getRxnSignature = (enzyme, sources, targets, place) => {
            const e = (enzyme || '').trim().toLowerCase();
            const s = sources.slice().sort().join('|').toLowerCase();
            const t = targets.slice().sort().join('|').toLowerCase();
            
            // å®‰å…¨å¤„ç†åœºæ‰€å­—ç¬¦ä¸²
            let p = 'unknown';
            if (place && String(place).trim() !== '0' && String(place).trim() !== '') {
                p = String(place).trim().toLowerCase();
            }

            return {
                // å°†åœºæ‰€ p æ‹¼æ¥åˆ°ç­¾åä¸­ï¼ŒåŒºåˆ†ä¸åŒåœºæ‰€çš„åŒåååº”
                forward: `${e}__${s}__>>__${t}__@${p}`,
                reverse: `${e}__${t}__>>__${s}__@${p}` 
            };
        };


        // -------------------------------------------------------------
        // å†…éƒ¨è¾…åŠ©å‡½æ•° 5ï¼šèŠ‚ç‚¹æ·»åŠ é€»è¾‘
        // -------------------------------------------------------------
        const addedNodes = new Set();

        // æ·»åŠ ä¸»èŠ‚ç‚¹ (å‚ä¸å¸ƒå±€)
        const addMainNode = (name, compartment, sheetName, pathway) => {
            const id = compartment ? `${name}@@${compartment}` : name;
            
            if (!addedNodes.has(id)) {
                const displayLabel = formatText(name); // Label æ ¼å¼åŒ–
                elements.push({ 
                    data: { 
                        id: id, 
                        label: displayLabel, 
                        baseName: name, 
                        type: 'molecule', 
                        isSide: false,
                        pathway: pathway 
                    },
                    classes: 'molecule main-molecule'
                });
                addedNodes.add(id);
            }

            // æ›´æ–°å…ƒæ•°æ®
            if (!window.mainMoleculeMeta.has(name)) {
                window.mainMoleculeMeta.set(name, { pathwaySheets: new Map(), sheets: new Set() });
            }
            const meta = window.mainMoleculeMeta.get(name);
            if (sheetName) meta.sheets.add(sheetName); // è®°å½• sheet ç”¨äºé…è‰²
            if (pathway) {
                if (!meta.pathwaySheets.has(pathway)) meta.pathwaySheets.set(pathway, new Set());
                if (sheetName) meta.pathwaySheets.get(pathway).add(sheetName);
            }
        };

        // æ·»åŠ å‰¯èŠ‚ç‚¹ (åˆå§‹éšè—)
            // åŸæ¥çš„ï¼šclasses: 'molecule side-molecule'
    // ä¿®æ”¹ä¸ºï¼š
    const addSideNode = (id, name, role, parentRxnId, direction, pathway) => {
        if (!addedNodes.has(id)) {
            const displayLabel = formatText(name);
            elements.push({ 
                data: { 
                    id: id, 
                    label: displayLabel,
                    baseName: name, 
                    type: 'molecule', 
                    isSide: true, 
                    role: role, 
                    parentRxn: parentRxnId, 
                    direction: direction,
                    pathway: pathway 
                }, 
                // === æŠŠ role åŠ è¿›å»ï¼Œè¿™æ · CSS .sub-reactant æ‰èƒ½ç”Ÿæ•ˆ ===
                classes: `molecule side-molecule ${role}` 
            });
            addedNodes.add(id);
        }
    };


        // -------------------------------------------------------------
        // ä¸»å¾ªç¯ï¼šè§£æ Excel æ•°æ®è¡Œ
        // -------------------------------------------------------------
        data.forEach((row, index) => {
            // --- æ–°å¢ï¼šç²¾å‡†æ›¿æ¢ "un" ä¸º "0" ---
            for (let key in row) {
                if (typeof row[key] === 'string' && row[key].trim().toLowerCase() === 'un') {
                    row[key] = '0';
                }
            }
            // --- æ›¿æ¢ç»“æŸ ---
            const mainSources = parseMolecules(row['Main Reactant']);
            const sideSources = parseMolecules(row['Other Reactant']); 
            const mainTargets = parseMolecules(row['Main Product']);
            const sideTargets = parseMolecules(row['Other Product']); 

            if ((mainSources.length + sideSources.length > 0) && (mainTargets.length + sideTargets.length > 0)) {
                const pathway = row['Pathway'];
                const enzyme = row['Enzyme'];
                const sheetName = row.__sheet || 'Unknown';
                const originalPlace = row['Place in Cell'] || 'Unknown';
                const compKey = normalizeCompartment(originalPlace);

                // --- 1. è·å–å¹¶æ ¼å¼åŒ–æ–‡æœ¬ä¿¡æ¯ ---
                const rawDesc = (row['Description'] && String(row['Description']).trim() !== '0') ? String(row['Description']).trim() : '';
                const formatDesc = formatText(rawDesc);

                const rawCoenzyme = (row['Coenzyme'] && String(row['Coenzyme']).trim() !== '0') ? String(row['Coenzyme']).trim() : '';
                const formatCoenzyme = formatText(rawCoenzyme);
                // [æ–°å¢] 1. è¯»å–æ¿€æ´»å‰‚å’ŒæŠ‘åˆ¶å‰‚
                const rawActivator = row['Activator'] || row['activator'];
                const rawInhibitor = row['Inhibitor'] || row['inhibitor'];
                // è¾…åŠ©æ¸…æ´—å‡½æ•°ï¼šå»å†’å·å’Œæ•°å­— "ATP:1" -> "ATP"
                const cleanRegName = (str) => {
                    if (!str) return '';
                    return String(str).split(':')[0].trim();
                };

                // [ä¿®æ”¹] 2. Regulation åˆ¤æ–­é€»è¾‘
                // åªè¦æœ‰ Special regulation æ–‡å­—ï¼Œæˆ–è€…æœ‰ Activatorï¼Œæˆ–è€…æœ‰ Inhibitorï¼Œéƒ½ç®—æœ‰ Regulation
                const specialReg = row['Special regulation'];
                let regText = null;
                let hasRegulation = false;

                // æ£€æŸ¥æ–‡æœ¬æè¿°
                if (specialReg && String(specialReg).trim().toLowerCase() !== 'un') {
                    regText = formatText(String(specialReg).trim());
                    hasRegulation = true;
                }
                // æ£€æŸ¥æ˜¯å¦æœ‰æ¿€æ´»å‰‚/æŠ‘åˆ¶å‰‚ (ä¿®æ­£äº†ä½ çš„éœ€æ±‚ï¼šè¿™ä¸¤æ ä¸ä¸º0ä¹Ÿè¦åŠ å…¥Regulation Modeåˆ—è¡¨)
                const hasAct = (rawActivator && rawActivator !== 0 && String(rawActivator) !== '0');
                const hasInh = (rawInhibitor && rawInhibitor !== 0 && String(rawInhibitor) !== '0');
                
                if (hasAct || hasInh) {
                    hasRegulation = true;
                }

                // Pathway List
                if (pathway) {
                    if (!pathwaysBySheet.has(sheetName)) pathwaysBySheet.set(sheetName, []);
                    const list = pathwaysBySheet.get(sheetName);
                    if (!list.includes(pathway)) list.push(pathway);
                }

                // --- 2. ç”Ÿæˆååº”æ–¹ç¨‹å¼ ---
                const reactantsStr = [...mainSources, ...sideSources].join(' + ');
                const productsStr = [...mainTargets, ...sideTargets].join(' + ');
                const rawFormula = `${reactantsStr} â€”â€”â†’ ${productsStr}`;
                const formatFormula = formatText(rawFormula);

                // --- 3. ç”Ÿæˆæˆ–è·å–ååº”èŠ‚ç‚¹ ---
                 const sig = getRxnSignature(enzyme, mainSources, mainTargets, originalPlace);
                let rxnId;
                
                if (rxnRegistry.has(sig.forward)) {
                    rxnId = rxnRegistry.get(sig.forward);
                } else if (rxnRegistry.has(sig.reverse)) {
                    rxnId = rxnRegistry.get(sig.reverse);
                } else {
                    const safeEnzyme = (enzyme || 'rxn').replace(/[^a-zA-Z0-9]/g, '_');
                    rxnId = `rxn_${safeEnzyme}_${index}`;
                    rxnRegistry.set(sig.forward, rxnId);
                }

                const isZeroEnzyme = !enzyme || String(enzyme).trim() === '0' || String(enzyme).trim() === '';
                const labelText = isZeroEnzyme ? '' : formatText(enzyme);
                // === æ–°å¢ï¼šè·å–åŸå§‹é…¶åç§°ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼å³å¯ï¼‰ï¼Œç”¨äºåŒ¹é… ===
                const rawEnzymeName = (enzyme && String(enzyme).trim() !== '0') ? String(enzyme).trim() : '';

                // --- 4. æ·»åŠ ä¸åˆå¹¶ååº”èŠ‚ç‚¹ ---
                if (!createdRxnIds.has(rxnId)) {
                    // === æ–°å»ºèŠ‚ç‚¹ ===
                    elements.push({
                        data: { 
                            id: rxnId, 
                            label: labelText, 
                            type: 'reaction', 
                            pathway: pathway || 'Uncategorized',
                            infoEnzyme: labelText,
                            infoFormula: formatFormula,
                            infoDesc: formatDesc,
                            infoCoenzyme: formatCoenzyme,
                            infoPlace: (originalPlace === '0') ? null : originalPlace,
                            hasRegulation: hasRegulation,
                            rawEnzyme: rawEnzymeName,
                            regulationText: regText
                        },
                        classes: 'reaction'
                    });
                    createdRxnIds.add(rxnId);
                   
                } else {
                    // === åˆå¹¶å·²æœ‰èŠ‚ç‚¹ä¿¡æ¯ ===
                    const existingNodeWrapper = elements.find(e => e.data.id === rxnId);
                    if (existingNodeWrapper) {
                        if (hasRegulation) existingNodeWrapper.data.hasRegulation = true;
                        const d = existingNodeWrapper.data;
                        if (!d.infoFormula.includes(formatFormula)) d.infoFormula += `\n${formatFormula}`;
                        
                        if (formatDesc) {
                            if (d.infoDesc) d.infoDesc += `\n${formatDesc}`;
                            else d.infoDesc = formatDesc;
                        }
                        
                        if (formatCoenzyme) {
                            if (d.infoCoenzyme) {
                                if(!d.infoCoenzyme.includes(formatCoenzyme)) d.infoCoenzyme += `\n${formatCoenzyme}`;
                            } else {
                                d.infoCoenzyme = formatCoenzyme;
                            }
                        }

                        if (hasRegulation) {
                            d.hasRegulation = true;
                            if (d.regulationText && regText && !d.regulationText.includes(regText)) {
                                d.regulationText += `\n${regText}`;
                            } else if (!d.regulationText) {
                                d.regulationText = regText;
                            }
                        }

                        if (pathway && d.pathway !== pathway && !d.pathway.includes(pathway)) {
                            d.pathway += `, ${pathway}`;
                        }
                    }
                }
                 // [æ–°å¢] 3. åˆ›å»º Activator èŠ‚ç‚¹å’Œè¾¹ (ä»…åœ¨æ–°åˆ›å»ºååº”æ—¶å¤„ç†ï¼Œé¿å…é‡å¤)
                    if (hasAct) {
                        const acts = String(rawActivator).split(';');
                        acts.forEach(actName => {
                            const name = cleanRegName(actName);
                            if (!name) return;
                            // å”¯ä¸€IDï¼šact_ååº”ID_åå­—
                            const actNodeId = `act_${rxnId}_${name}`; 
                            elements.push({
                                data: { id: actNodeId, label: name, nodeType: 'activator', parentEnzyme: rxnId },
                                position: { x: 0, y: 0 }, // åˆå§‹ä½ç½®ï¼Œç‚¹å‡»åä¼šè‡ªåŠ¨æ’ç‰ˆ
                                classes: 'reg-node hidden-reg' // é»˜è®¤éšè—
                            });
                            elements.push({
                                data: { source: actNodeId, target: rxnId, interaction: 'activate' },
                                classes: 'reg-edge hidden-reg' // é»˜è®¤éšè—
                            });
                        });
                    }

                    // [æ–°å¢] 4. åˆ›å»º Inhibitor èŠ‚ç‚¹å’Œè¾¹
                    if (hasInh) {
                        const inhs = String(rawInhibitor).split(';');
                        inhs.forEach(inhName => {
                            const name = cleanRegName(inhName);
                            if (!name) return;
                            const inhNodeId = `inh_${rxnId}_${name}`;
                            elements.push({
                                data: { id: inhNodeId, label: name, nodeType: 'inhibitor', parentEnzyme: rxnId },
                                position: { x: 0, y: 0 },
                                classes: 'reg-node hidden-reg'
                            });
                            elements.push({
                                data: { source: inhNodeId, target: rxnId, interaction: 'inhibit' },
                                classes: 'reg-edge hidden-reg'
                            });
                        });
                    }
                // --- 5. åˆ›å»ºè¿çº¿å’Œç‰©è´¨èŠ‚ç‚¹ ---
                
                mainSources.forEach(s => {
                    const srcId = compKey ? `${s}@@${compKey}` : s;
                    addMainNode(s, compKey, sheetName, pathway);
                    elements.push({ 
                        data: { source: srcId, target: rxnId, pathway: pathway, type: 'in', edgeType: 'main' }, 
                        classes: 'edge-main' 
                    });
                });

                sideSources.forEach((s, i) => {
                    const sid = `${rxnId}_side_in_${s}_${index}_${i}`; 
                    addSideNode(sid, s, 'sub-reactant', rxnId, 'in', pathway);
                    elements.push({ 
                        data: { source: sid, target: rxnId, pathway: pathway, type: 'in', edgeType: 'side' }, 
                        classes: 'edge-side hidden-side' 
                    });
                });

                mainTargets.forEach(t => {
                    const tgtId = compKey ? `${t}@@${compKey}` : t;
                    addMainNode(t, compKey, sheetName, pathway);
                    elements.push({ 
                        data: { source: rxnId, target: tgtId, pathway: pathway, type: 'out', edgeType: 'main' }, 
                        classes: 'edge-main' 
                    });
                });

                sideTargets.forEach((t, i) => {
                    const sid = `${rxnId}_side_out_${t}_${index}_${i}`;
                    addSideNode(sid, t, 'sub-product', rxnId, 'out', pathway);
                    elements.push({ 
                        data: { source: rxnId, target: sid, pathway: pathway, type: 'out', edgeType: 'side' }, 
                        classes: 'edge-side hidden-side' 
                    });
                });
            }
        });

        // 6. ç”Ÿæˆå·¦ä¾§ç­›é€‰å™¨ checkboxes
        generateCheckboxes(pathwaysBySheet);

        // 7. å›å¡«ä¸»å¹²åˆ†å­çš„é»˜è®¤é¢œè‰²
        // ä¸Šé¢ä»£ç æ„å»º elements æ—¶æ²¡æœ‰å¡« colorï¼Œè¿™é‡Œè¡¥ä¸Š
        elements.forEach(el => {
            if (el && el.classes && String(el.classes).includes('main-molecule')) {
                const meta = window.mainMoleculeMeta.get(el.data.baseName);
                if (meta && meta.sheets) {
                    el.data.color = pickSheetColor(meta.sheets);
                } else {
                    el.data.color = '#95a5a6';
                }
            }
        });

        // ã€ä¿®å¤ 2ã€‘ è°ƒç”¨æ‚¨åŸæœ¬å·²æœ‰çš„ drawCytoscape å‡½æ•°
        // å®ƒè´Ÿè´£åˆå§‹åŒ– window.cyGraphï¼Œè´Ÿè´£æ¸²æŸ“ï¼Œå¹¶è´Ÿè´£å…³é—­ Loading é®ç½©
        
// ============================================================
// 5. è·¨è†œè¿è¾“è¾¹ (Transport edges): åŒååˆ†å­åœ¨ä¸åŒç»†èƒå™¨/åŒºå®¤ä¹‹é—´å»ºç«‹è”ç³»
//    - edgeType: "transport" (ç”¨äºå¯»è·¯ cost=0)
//    - classes: "edge-transport hidden-transport" (ç”± refreshTransportVisibility æ§åˆ¶æ˜¾éš)
// ============================================================
(function buildTransportEdges(){
    const baseToNodeIds = new Map(); // baseName -> Set(nodeId)
    elements.forEach(el => {
        if (!el || !el.data) return;
        if (el.data.type !== 'molecule') return;
        if (el.data.isSide) return;
        const id = String(el.data.id || '');
        const base = String(el.data.baseName || el.data.label || '').trim();
        if (!base) return;
        // åªä¸ºå¸¦åŒºå®¤æ ‡ç­¾çš„ä¸»åˆ†å­åˆ›å»ºè¿è¾“è¿çº¿ï¼šname@@compartment
        if (!id.includes('@@')) return;
        if (!baseToNodeIds.has(base)) baseToNodeIds.set(base, new Set());
        baseToNodeIds.get(base).add(id);
    });

    const addedEdgeIds = new Set();
    baseToNodeIds.forEach((idSet, baseName) => {
        const ids = Array.from(idSet);
        if (ids.length < 2) return;

        // è¿æ¥æ‰€æœ‰åŒºå®¤ç»„åˆï¼ˆæ— æ–¹å‘ï¼‰ï¼Œç”¨æµ…ç°è™šçº¿è¡¨ç¤ºâ€œè·¨è†œ/è½¬è¿å…³è”â€
        for (let i = 0; i < ids.length; i++) {
            for (let j = i + 1; j < ids.length; j++) {
                const a = ids[i], b = ids[j];
                if (a === b) continue;
                const s = a < b ? a : b;
                const t = a < b ? b : a;
                const eid = `trans__${s}__${t}`;
                if (addedEdgeIds.has(eid)) continue;
                addedEdgeIds.add(eid);

                elements.push({
                    data: {
                        id: eid,
                        source: s,
                        target: t,
                        edgeType: 'transport',
                        baseName: baseName
                    },
                    classes: 'edge-transport hidden-transport'
                });
            }
        }
    });
})();

        console.log(`å¤„ç†å®Œæˆï¼Œç”Ÿæˆçš„å…ƒç´ æ•°é‡: ${elements.length}`);
        drawCytoscape(elements);
}


    // ============================================================
    // 2. Cytoscape ç»˜å›¾ä¸å¸ƒå±€ (Draw & Layout)
    // ============================================================
    function drawCytoscape(allElements) {
        const container = document.getElementById('cy');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingMask = document.getElementById('loading-mask');

        // 1. åˆå§‹åŒ–ç©ºå›¾è¡¨
        window.cyGraph = cytoscape({
            container: container,
            // é™åˆ¶æ»šè½®ç¼©æ”¾é€Ÿåº¦ï¼Œé˜²æ­¢ä¸€æ»šè½®å›¾ä¹Ÿæ²¡äº†
            wheelSensitivity: 0.2, 
                    style: [
            // -----------------------------------------------------
            // 1. åŸºç¡€é»˜è®¤å€¼
            // -----------------------------------------------------
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'text-valign': 'center', 'text-halign': 'center',
                    'font-size': '15px', 'color': '#fff',
                    'text-wrap': 'wrap',
                    'border-width': 0, // é»˜è®¤æ— è¾¹æ¡†
                    'shape': 'round-rectangle',
                    'width': 'label', 'height': 'label', 'padding': '8px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'curve-style': 'straight',
                }
            },

            // -----------------------------------------------------
            // 2. èŠ‚ç‚¹é…è‰² (æ ¹æ®æ‚¨è¦æ±‚çš„é¢œè‰²)
            // -----------------------------------------------------
            
            // ã€ä¸»è¦ååº”ç‰©/äº§ç‰©ã€‘ï¼šç»¿è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.main-molecule',
                style: {
                    'background-color': 'data(color)', // ç”± sheet å†³å®š
                    'font-weight': 'bold',
                    'color': '#fff',

                    'font-size': '16px',        // ä¸»ç‰©è´¨å­—å·æ›´å¤§
                       'padding': '10px',          // ä¸»ç‰©è´¨å†…è¾¹è·æ›´å¤§ï¼Œæ˜¾å¾—å—å¤´æ›´å¤§
                }
            },

            // ã€å‰¯ååº”ç‰©ã€‘ï¼šæµ…è“è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.sub-reactant',
                style: {
                    'background-color': '#74b9ff', // æµ…è“
                    'font-size': '10px',
                    'padding': '5px'
                }
            },

            // ã€å‰¯ç”Ÿæˆç‰©ã€‘ï¼šæµ…ç´«è‰²èƒŒæ™¯ï¼Œæ— è¾¹æ¡†
            {
                selector: '.sub-product',
                style: {
                    'background-color': '#a29bfe', // æµ…ç´«
                    'font-size': '10px',
                    'padding': '5px'
                }
            },
            // ã€éšè—çš„å‰¯å°åˆ†å­/å‰¯è¿çº¿ã€‘ï¼šé»˜è®¤ä¸æ˜¾ç¤º
            {
                selector: '.hidden-side',
                style: {
                    'display': 'none'
                }
            },


            // ã€éšè—çš„è·¨è†œè¿è¾“è¾¹ã€‘ï¼šé»˜è®¤ä¸æ˜¾ç¤ºï¼Œç”±é€»è¾‘æ§åˆ¶æ˜¾ç¤º
            {
                selector: '.hidden-transport',
                style: {
                    'display': 'none'
                }
            },


            // ã€é…¶/ååº”èŠ‚ç‚¹ã€‘
            {
                // ä½¿ç”¨ type é€‰æ‹©å™¨æˆ–è€… class é€‰æ‹©å™¨
                selector: 'node[type="reaction"]',
                style: {
                    'background-color': '#e5e5e5', // æµ…ç°è‰²èƒŒæ™¯
                    'background-opacity': 1,
                    'border-width': 0,
                    'color': '#000',               // é»‘è‰²å­—ä½“
                    'font-weight': 'normal',         // åŠ ç²—
                    'shape': 'round-rectangle',
                    'font-size': '14px',
                    'width': 'label', 'height': 'label', 'padding': '10px'
                }
            },

            // -----------------------------------------------------
            // 3. è¿çº¿é…è‰²ä¸ç®­å¤´ (é€»è¾‘æ ¸å¿ƒ)
            // -----------------------------------------------------

            // ã€æŒ‡å‘ååº”èŠ‚ç‚¹çš„è¾¹ (In)ã€‘ï¼šæµ…ç»¿è‰²ï¼Œæ— ç®­å¤´
            // åŒ¹é… data.type === 'in'
            {
                selector: 'edge[type="in"]',
                style: {
                    'line-color': '#C0C0C0',       // æµ…ç»¿è‰²
                    'target-arrow-shape': 'none',  // æ— ç®­å¤´
                    'width': 4           // çº¿æ›´ç²—ï¼Œç®­å¤´ä¹Ÿä¼šæ›´â€œæœ‰å­˜åœ¨æ„Ÿâ€
                }
            },

            // ã€ç¦»å¼€ååº”èŠ‚ç‚¹çš„è¾¹ (Out)ã€‘ï¼šç»¿è‰²ï¼Œæœ‰ç®­å¤´
            // åŒ¹é… data.type === 'out'
            {
                selector: 'edge[type="out"]',
                style: {
                    'line-color': '#CDCDCD',       // ç»¿è‰²
                    'target-arrow-shape': 'triangle', // ä¸‰è§’å½¢ç®­å¤´
                    'target-arrow-color': '#CDCDCD',
                    'arrow-scale': 1.6,   // è°ƒå¤§ç®­å¤´ï¼ˆé»˜è®¤å¤§æ¦‚æ˜¯ 1ï¼‰
                    'width': 4            // çº¿æ›´ç²—ï¼Œç®­å¤´ä¹Ÿä¼šæ›´â€œæœ‰å­˜åœ¨æ„Ÿâ€
                }
            },

            

            // ã€ç»†èƒå™¨è½¬è¿è¾¹ (Transport)ã€‘ï¼šç°è‰²è™šçº¿ï¼Œæ— ç®­å¤´ï¼ˆåŒååˆ†å­ä¸åŒç»†èƒå™¨ä¹‹é—´ï¼‰
            {
                selector: '.edge-transport',
                style: {
                    'line-color': '#CDCDCD',
                    'line-style': 'dashed',
                    'width': 2.0,
                    'target-arrow-shape': 'none',
                    'opacity': 1.0
                }
            },
// -----------------------------------------------------
            // 4. äº¤äº’é«˜äº®æ ·å¼ (ä¿æŒåŸæœ‰çš„åŠŸèƒ½)
            // -----------------------------------------------------
            {
                selector: ':selected',
                style: {
                    'background-color': '#e17055',
                    'line-color': '#e17055',
                    'target-arrow-color': '#e17055'
                }
            },
            {
                selector: '.dimmed',
                style: { 'opacity': 0.1, 'z-index': 0 }
            },
            {
                selector: '.highlighted',
                style: {
                    'opacity': 1,
                    // 'border-width': 3,
                    // 'border-color': '#d63031', // æœç´¢é«˜äº®çº¢æ¡†
                    'z-index': 999
                }
            },
            {
                selector: '.path-node',
                style: {
                    'border-width': 3,
                    'border-color': '#e67e22',
                    'z-index': 1000
                }
            },
            {
                selector: '.path-edge',
                style: {
                    'line-color': '#e67e22',
                    'width': 4,
                    'opacity': 0.9,
                    'z-index': 1000,
                    'line-style': 'dashed',      // ä½¿ç”¨è™šçº¿
                    'line-dash-pattern': [6, 3], // è™šçº¿æ®µé•¿åº¦å’Œé—´éš”
                    'line-dash-offset': 0        // åˆå§‹åç§»é‡
                }
            },
            // ===========================================
            // [æ–°å¢] è°ƒæ§å› å­é€šè¿‡ classæ§åˆ¶æ˜¾ç¤ºéšè—
            // ===========================================
            {
                selector: '.hidden-reg',
                style: { 'display': 'none' }
            },

            {
                selector: 'node[nodeType="activator"]',
                style: {
                    'background-color': '#2e7d32',  /* æ›´æ·±çš„ç»¿è‰² */
                    'border-color': '#1b5e20',
                    'border-width': 2,
                    'color': '#ffffff',             /* ç™½è‰²æ–‡å­— */
                    'text-outline-color': '#2e7d32', /* æ–‡å­—æè¾¹å¢å¼ºå¯è¯»æ€§ */
                    'text-outline-width': 1,
                    'shape': 'round-rectangle',
                    'font-size': 12,                /* å­—ä½“ç¨å¤§ */
                    'font-weight': 'bold',
                    'width': 'label', 'height': 'label', 'padding': '8px',
                    'opacity': 1,                   /* å¼ºåˆ¶ä¸é€æ˜ */
                    'z-index': 1002                 /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
                }
            },
            // Inhibitor (æŠ‘åˆ¶å‰‚): æ·±çº¢è‰²èƒŒæ™¯ + ç™½è‰²æ–‡å­— + å¼ºä¸é€æ˜åº¦
            {
                selector: 'node[nodeType="inhibitor"]',
                style: {
                    'background-color': '#c62828',  /* æ›´æ·±çš„çº¢è‰² */
                    'border-color': '#b71c1c',
                    'border-width': 2,
                    'color': '#ffffff',             /* ç™½è‰²æ–‡å­— */
                    'text-outline-color': '#c62828',
                    'text-outline-width': 1,
                    'shape': 'round-rectangle',
                    'font-size': 12,
                    'font-weight': 'bold',
                    'width': 'label', 'height': 'label', 'padding': '8px',
                    'opacity': 1,
                    'z-index': 1002
                }
            },
            
            // æ¿€æ´»è¿çº¿: ç»¿è‰²å®çº¿ + ç²—ç»†è°ƒæ•´
            {
                selector: 'edge[interaction="activate"]',
                style: {
                    'line-color': '#4CAF50',
                    'target-arrow-color': '#4CAF50',
                    'target-arrow-shape': 'triangle',
                    'width': 3,
                    'opacity': 0.9,
                    'curve-style': 'bezier'
                }
            },
            // æŠ‘åˆ¶è¿çº¿: çº¢è‰²å®çº¿ + ç²—ç»†è°ƒæ•´
            {
                selector: 'edge[interaction="inhibit"]',
                style: {
                    'line-color': '#EF5350',
                    'target-arrow-color': '#EF5350',
                    'target-arrow-shape': 'tee',
                    'width': 3,
                    'opacity': 0.9,
                    'curve-style': 'bezier'
                }
            }
        ],

            // åˆå§‹æ”¾å®½é™åˆ¶ï¼Œé˜²æ­¢å¸ƒå±€è®¡ç®—æ—¶è¢«å¡ä½
            minZoom: 1e-50,
            maxZoom: 1e50,
            zoomingEnabled: true,
            panningEnabled: true,
            layout: { name: 'preset' }, // åˆå§‹ä¸è®¡ç®—å¸ƒå±€
            elements: [] 
        });

        // ==========================================
        // å…³é”®ä¿®å¤ï¼šåˆ†ç¦» èŠ‚ç‚¹(Node) å’Œ è¿çº¿(Edge)
        // ==========================================
        const allNodes = [];
        const edgesByPathway = {};
        const pathwayNames = [];

        allElements.forEach(ele => {
            // åˆ¤æ–­æ˜¯å¦ä¸ºèŠ‚ç‚¹ï¼ˆgroupä¸å†™é»˜è®¤æ˜¯nodesï¼Œæˆ–è€…åˆ¤æ–­ data.source æ˜¯å¦å­˜åœ¨ï¼‰
            // Cytoscape JSON ä¸­ï¼Œè¿çº¿é€šå¸¸æœ‰ data.source å’Œ data.target
            if (ele.group === 'nodes' || (!ele.data.source && !ele.data.target)) {
                allNodes.push(ele);
            } else {
                // è¿™æ˜¯ä¸€ä¸ªè¿çº¿ (Edge)
                const p = ele.data.pathway || 'Other';
                if (!edgesByPathway[p]) {
                    edgesByPathway[p] = [];
                    pathwayNames.push(p); // è®°å½•é€šè·¯å
                }
                edgesByPathway[p].push(ele);
            }
        });

        // 2. ç¬¬ä¸€æ­¥ï¼šå®‰å…¨æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹ (ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºèŠ‚ç‚¹ä¸ä¾èµ–åˆ«äºº)
        // ä¸ºäº†é˜²æ­¢ä¸€å¼€å§‹ä¹Ÿæ˜¯ä¹±çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåŠ è¿›å»ä½†ä¸é‡ç»˜ï¼Œæˆ–è€…é»˜é»˜åŠ è¿›å»
        window.cyGraph.add(allNodes);
        console.log(`å·²é¢„åŠ è½½ ${allNodes.length} ä¸ªèŠ‚ç‚¹ï¼Œé˜²æ­¢ä¾èµ–æŠ¥é”™ã€‚`);

        // 3. ç¬¬äºŒæ­¥ï¼šé€æ­¥åŠ è½½è¿çº¿ (åŠ¨ç”»è¿‡ç¨‹)
        let currentIndex = 0;

        function renderNextBatch() {
            try {
                // ç»“æŸæ¡ä»¶
                if (currentIndex >= pathwayNames.length) {
                    finishLoading();
                    return;
                }

                const pName = pathwayNames[currentIndex];
                const edgesBatch = edgesByPathway[pName];

                // æ›´æ–° UI
                const percent = Math.round(((currentIndex + 1) / pathwayNames.length) * 100);
                if(progressBar) progressBar.style.width = `${percent}%`;
                if(progressText) progressText.innerText = `Loading: ${pName} (${currentIndex + 1}/${pathwayNames.length})`;

                // æ·»åŠ è¿™æ‰¹è¿çº¿
                if (edgesBatch && edgesBatch.length > 0) {
                    window.cyGraph.batch(() => {
                        window.cyGraph.add(edgesBatch);
                    });
                }

                currentIndex++;
                // ç»§ç»­ä¸‹ä¸€å¸§
                requestAnimationFrame(renderNextBatch);

            } catch (err) {
                console.error("åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè·³è¿‡è¯¥æ‰¹æ¬¡ç»§ç»­:", err);
                // å¦‚æœå‡ºé”™ï¼Œå¼ºåˆ¶ç»§ç»­ä¸‹ä¸€é¡¹ï¼Œé˜²æ­¢å¡æ­»
                currentIndex++;
                requestAnimationFrame(renderNextBatch);
            }
        }

    // 4. æ”¶å°¾å·¥ä½œ
function finishLoading() {
    const progressText = document.getElementById('progress-text');
    const loadingMask = document.getElementById('loading-mask');

    if(progressText) progressText.innerText = "Finalizing Layout...";
    
    // === å®‰å…¨ç½‘ 1ï¼šå¼ºåˆ¶å…œåº•è®¡æ—¶å™¨ ===
    // å¦‚æœ 8 ç§’åå¸ƒå±€è¿˜æ²¡æå®šï¼ˆæˆ–å¡æ­»äº†ï¼‰ï¼Œå¼ºåˆ¶ç§»é™¤é®ç½©ï¼Œé˜²æ­¢ç”¨æˆ·ä¸€ç›´çœ‹ç™½å±
    const safetyTimer = setTimeout(() => {
        if (loadingMask && loadingMask.style.display !== 'none') {
            console.warn("Layout took too long or failed silently. Forcing mask removal.");
            loadingMask.style.display = 'none';
        }
    }, 8000);

    setTimeout(() => {
        const cy = window.cyGraph;

        // å°è¯•è‡ªåŠ¨æ¢å¤ä¸Šä¸€æ¬¡å¸ƒå±€
        let restored = false;
        let savedPositions = null;

try {
  // å…ˆä»æœ¬åœ°ç¼“å­˜æ¢å¤
  const raw = localStorage.getItem(STORAGE_KEY_AUTO);
  if (raw) {
    savedPositions = JSON.parse(raw);
  }
  if (savedPositions) {
    restored = restoreLayoutAuto(); // è¿™ä¸ªå‡½æ•°ä¼šæŠŠä½ç½®åº”ç”¨åˆ°å›¾ä¸Š
  }
} catch (e) {
  console.warn("Auto-restore layout failed:", e);
}

        // å®šä¹‰å¸ƒå±€å‚æ•°
        const layoutConfig = {
            name: restored ? 'preset' : 'dagre',
            rankDir: 'TB',
            padding: 50,
            fit: true,
            animate: false
        };

        // æ’é™¤å‰¯åˆ†å­ï¼Œåªå¯¹éª¨å¹²è¿›è¡Œå¸ƒå±€
        // æ³¨æ„ï¼šå¦‚æœä¸å°å¿ƒæ²¡é€‰åˆ°ä»»ä½•å…ƒç´ ï¼ˆæ¯”å¦‚ç©ºå›¾ï¼‰ï¼Œlayoutstop å¯èƒ½ä¸ä¼šè§¦å‘
        // æ‰€ä»¥æˆ‘ä»¬è¦åšä¸ªåˆ¤æ–­
        const backboneEles = cy.elements().not('.side-molecule, .edge-side, .hidden-reg');
        
        // å¦‚æœå›¾æ˜¯ç©ºçš„ï¼Œç›´æ¥æ‰‹åŠ¨ç§»é™¤é®ç½©
        if (backboneEles.length === 0 && cy.elements().length === 0) {
            loadingMask.style.display = 'none';
            clearTimeout(safetyTimer);
            return;
        }
        // === æ–°å¢ï¼šæŠŠâ€œå•è¿›å•å‡ºâ€çš„ååº”èŠ‚ç‚¹æ”¾åˆ°ä¸­ç‚¹ ===
// === æ–°å¢ï¼šä»…åœ¨ã€Œæœªä¿å­˜è¿‡ä½ç½®ã€æ—¶ï¼Œä¸ºååº”èŠ‚ç‚¹åº”ç”¨ä¸­ç‚¹ ===
// å¦‚æœæ²¡æœ‰ savedPositionsï¼Œåˆ™å¯¹æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ååº”èŠ‚ç‚¹åº”ç”¨ä¸­ç‚¹
try {
  if (!savedPositions || Object.keys(savedPositions).length === 0) {
    applyReactionMidpoints(cy, null);
  } else {
    // å³ä½¿æœ‰ä¿å­˜ä½ç½®ï¼Œä¹Ÿå¯ä»¥ç»™ã€Œæœªä¿å­˜è¿‡çš„ååº”èŠ‚ç‚¹ã€åº”ç”¨ä¸­ç‚¹
    // ï¼ˆä¾‹å¦‚æ–°åŠ å…¥çš„æ•°æ®æ²¡æœ‰å†å²ä½ç½®ï¼‰
    applyReactionMidpoints(cy, savedPositions);
  }
} catch (e) {
  console.warn("applyReactionMidpoints failed:", e);
}

        const layout = backboneEles.length > 0 ? backboneEles.layout(layoutConfig) : cy.layout({ name: 'grid' });

        layout.on('layoutstop', () => {
            // æ¸…é™¤å¼ºåˆ¶å…œåº•è®¡æ—¶å™¨ï¼ˆå› ä¸ºæˆ‘ä»¬ç°åœ¨æ­£å¸¸ç»“æŸäº†ï¼‰
            clearTimeout(safetyTimer);

            // === å®‰å…¨ç½‘ 2ï¼šå°†é€»è¾‘åŒ…è£¹åœ¨ try-catch ä¸­ ===
            try {
                // 1. ç»‘å®šäº¤äº’
                if (typeof bindSideInteractionsOnce === 'function') bindSideInteractionsOnce();
                
                // 3. å¼ºåˆ¶æ’åˆ—å‰¯åˆ†å­
                if (typeof alignSideNodes === 'function') {
                    alignSideNodes(); 
                }
                // 2. åˆ·æ–°å¯è§æ€§
                if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
                if (typeof refreshTransportVisibility === 'function') refreshTransportVisibility();


                // 4. ç­›é€‰å™¨é€»è¾‘
                if (typeof filterGraph === 'function') filterGraph();
                
                // 5. é”å®šä¸é€‚é…
                cy.autoungrabify(true);
                const editToggle = document.getElementById('edit-mode-toggle');
                if(editToggle) editToggle.checked = false;
                
                cy.fit(cy.elements(), 50);

                // [æ–°å¢] åˆå§‹åŒ–ç»†èƒå™¨å›¾ç‰‡è¦†ç›–å±‚ï¼ˆåªåšä¸€æ¬¡ï¼‰
                try { initOrganelleOverlayOnce(cy); } catch(e){ console.warn('init organelles failed', e); }


                // 6. è‡ªåŠ¨ä¿å­˜
                if (typeof autoSaveLayoutDebounced === 'function') autoSaveLayoutDebounced();

                // 7. è®¾ç½®ç¼©æ”¾é™åˆ¶
                try {
                    const fitZoom = cy.zoom();
                    cy.minZoom(fitZoom * 0.5);
                    cy.maxZoom(fitZoom * 500);
                } catch(zErr) { console.warn("Zoom setup error", zErr); }

            } catch (err) {
                // å¦‚æœä¸Šé¢ä»»ä½•ä¸€æ­¥æŠ¥é”™ï¼Œè¿™é‡Œä¼šæ•è·ï¼Œå¹¶æ‰“å°çº¢è‰²é”™è¯¯ï¼Œä½†ä¸ä¼šé˜»æ­¢é®ç½©æ¶ˆé™¤
                console.error("Critical error during layout post-processing:", err);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾å¼æç¤ºç”¨æˆ·
                // alert("å¸ƒå±€å¤„ç†å‡ºç°é”™è¯¯ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ï¼Œè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                // === æ— è®ºæˆåŠŸè¿˜æ˜¯æŠ¥é”™ï¼Œè¿™é‡Œéƒ½ä¼šæ‰§è¡Œ ===
                if(loadingMask) {
                    loadingMask.style.opacity = '0';
                    setTimeout(() => {
                        loadingMask.style.display = 'none';
                    }, 500);
                }
            }
        });

        // å¼€å§‹è¿è¡Œå¸ƒå±€
        try {
            layout.run();
        } catch (runErr) {
            console.error("Layout run failed:", runErr);
            // å¦‚æœè¿ layout.run éƒ½å´©äº†ï¼Œæ‰‹åŠ¨éšè—é€»è¾‘
            loadingMask.style.display = 'none';
        }
        
        if(typeof initSearchListener === 'function') initSearchListener();

    }, 100);
}



        // å¯åŠ¨å¾ªç¯
        renderNextBatch();
    }

// è·¯å¾„åŠ¨ç”»å¾ªç¯æ§åˆ¶å™¨
window._pathAnimationTimer = null;

function startPathFlowAnimation() {
    const cy = window.cyGraph;
    if (!cy) return;

    let offset = 0;
    
    // å¦‚æœä¹‹å‰æœ‰åŠ¨ç”»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å®ƒ
    if (window._pathAnimationTimer) {
        cancelAnimationFrame(window._pathAnimationTimer);
    }

    const animate = () => {
        offset -= 1.0; // è¿™é‡Œçš„æ•°å€¼æ§åˆ¶æµåŠ¨é€Ÿåº¦ï¼Œè´Ÿæ•°ä»£è¡¨é¡ºç€è¿çº¿æ–¹å‘æµåŠ¨
        
        // åªç»™å¤„äºé«˜äº®çŠ¶æ€çš„è·¯å¾„è¾¹åº”ç”¨åŠ¨ç”»
        cy.edges('.path-edge').style('line-dash-offset', offset);
        
        window._pathAnimationTimer = requestAnimationFrame(animate);
    };

    animate();
}

function stopPathFlowAnimation() {
    if (window._pathAnimationTimer) {
        cancelAnimationFrame(window._pathAnimationTimer);
        window._pathAnimationTimer = null;
    }
}


    // ============================================================
    // 3. æ ¸å¿ƒç®—æ³•ï¼šç²¾ç¡®å‡ ä½•å®šä½ + æ··åˆçº¿å‹ (recalculateCurves)
    // ============================================================
    const recalculateCurves = () => {
    };

    // ============================================================
    // 4. å³ä¾§ç­›é€‰é€»è¾‘ (Filter)
    // ============================================================
function generateCheckboxes(pathwaysBySheet) {
    const container = document.getElementById('filter-container');
    if (!container) return;
    container.innerHTML = '';

    // A. å…¨å±€å…¨é€‰
    const globalDiv = document.createElement('label');
    globalDiv.className = 'checkbox-item';
    globalDiv.innerHTML = `<input type="checkbox" id="check-all-global" checked> <b style="margin-left:5px; flex:1;">(Select All Pathways)</b>`;
    container.appendChild(globalDiv);
    const globalCB = globalDiv.querySelector('input');

    // B. æ¸…é™¤æŒ‰é’®
    const clearBtn = document.createElement('button');
    clearBtn.className = 'side-action-btn'; 
    clearBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><span>Clear Highlights</span>`;
    clearBtn.onclick = () => {
        if (window.selectedReactionIds) window.selectedReactionIds.clear();
        refreshSideVisibility();
    };
    container.appendChild(clearBtn);

    const updateGlobalState = () => {
        const allPw = Array.from(container.querySelectorAll('.pw-check'));
        globalCB.checked = allPw.every(c => c.checked);
    };

    // D. éå†åˆ†ç±»
    TARGET_SHEETS.forEach(sheet => {
        const list = pathwaysBySheet.get ? pathwaysBySheet.get(sheet) : (pathwaysBySheet[sheet] || []);
        if (list.length === 0) return;

        const group = document.createElement('div');
        group.className = 'sheet-group collapsed';

        const header = document.createElement('div');
        header.className = 'sheet-header';
        header.innerHTML = `
            <span class="sheet-swatch-modern" style="background-color: ${SHEET_COLORS[sheet] || '#95a5a6'}"></span>
            <span style="flex: 1; cursor: pointer;">${sheet}</span>
            <label class="checkbox-item" style="padding:0; width:auto; background:none; border:none;"><input type="checkbox" class="check-all-sheet" checked></label>
            <span class="sheet-arrow">â–¼</span>
        `;
        
        const sheetCB = header.querySelector('.check-all-sheet');
        const body = document.createElement('div');
        body.className = 'sheet-body';

        list.forEach(pw => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            
            // æ„å»ºå†…éƒ¨ HTMLï¼šå¤é€‰æ¡† + æ–‡å­— + åˆ‡æ¢æŒ‰é’®
            label.innerHTML = `
                <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
                    <input type="checkbox" class="pw-check" value="${pw}" data-sheet="${sheet}" checked>
                    <span class="pw-text">${pw}</span>
                </div>
                <button type="button" class="side-toggle-btn" title="Show/Hide Small Molecules">Details</button>
            `;
            
            const cb = label.querySelector('.pw-check');
            const btn = label.querySelector('.side-toggle-btn');

            // å¤é€‰æ¡†é€»è¾‘
            cb.onchange = () => {
                const siblings = Array.from(body.querySelectorAll('.pw-check'));
                sheetCB.checked = siblings.every(s => s.checked);
                updateGlobalState();
                filterGraph();
            };

            // æ ¸å¿ƒï¼šå°åˆ†å­æ˜¾ç¤º/éšè—åˆ‡æ¢é€»è¾‘
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation(); // é˜²æ­¢è§¦å‘ label çš„ç‚¹å‡»
                
                if (!window.pinnedSidePathways) window.pinnedSidePathways = new Set();
                
                const isPinned = window.pinnedSidePathways.has(pw);
                if (isPinned) {
                    window.pinnedSidePathways.delete(pw);
                    btn.classList.remove('active');
                } else {
                    window.pinnedSidePathways.add(pw);
                    btn.classList.add('active');
                }
                
                // åˆ·æ–°å›¾è¡¨å¯è§æ€§
                if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
            };

            body.appendChild(label);
        });

        // åˆ†ç±»å…¨é€‰é€»è¾‘
        sheetCB.onchange = (e) => {
            const checked = e.target.checked;
            body.querySelectorAll('.pw-check').forEach(c => c.checked = checked);
            updateGlobalState();
            filterGraph();
        };

        // æŠ˜å é€»è¾‘ï¼šç‚¹å‡»æ ‡é¢˜æ–‡å­—æˆ–ç®­å¤´æ‰æŠ˜å ï¼Œç‚¹å‡»å‹¾é€‰æ¡†ä¸æŠ˜å 
        header.onclick = (e) => {
            if (e.target !== sheetCB) group.classList.toggle('collapsed');
        };

        group.appendChild(header);
        group.appendChild(body);
        container.appendChild(group);
    });

    // å…¨å±€å…¨é€‰é€»è¾‘
    globalCB.onchange = (e) => {
        const checked = e.target.checked;
        container.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = checked);
        filterGraph();
    };
}
    // æ ¹æ®å½“å‰é€‰ä¸­çš„ Pathwayï¼ŒåŠ¨æ€åˆ·æ–°ä¸»å¹²åˆ†å­ï¼ˆMain Reactant / Main Productï¼‰çš„é¢œè‰²
    function updateMainMoleculeColors(selectedPathways) {
        const cy = window.cyGraph || window.cy;
        const metaMap = window.mainMoleculeMeta;
        if (!cy || !metaMap) return;

        cy.nodes('.main-molecule').forEach(n => {
            const meta = metaMap.get(n.data('baseName') || n.id());
            if (!meta) return;

            // è‹¥é€‰ä¸­äº† Pathwayï¼šä¼˜å…ˆç”¨è¯¥åˆ†å­åœ¨â€œè¢«é€‰ä¸­ Pathwayâ€å¯¹åº”çš„ sheet é¢œè‰²
            if (selectedPathways && selectedPathways.length > 0) {
                const candidate = new Set();
                selectedPathways.forEach(pw => {
                    const sset = meta.pathwaySheets.get(pw);
                    if (sset) sset.forEach(s => candidate.add(s));
                });
                if (candidate.size > 0) {
                    n.data('color', pickSheetColor(candidate));
                    return;
                }
            }

            // å¦åˆ™ï¼šæŒ‰åˆ†å­å…¨å±€å‡ºç°çš„ sheets å–é»˜è®¤é¢œè‰²ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
            n.data('color', pickSheetColor(meta.sheets));
        });
    }

    function filterGraph() {
    const currentCy = window.cyGraph || window.cy;
    if (!currentCy) return;

    const checkboxes = document.querySelectorAll('.pw-check');
    const allChecked = Array.from(checkboxes).filter(cb => cb.checked);
    const selectedPathways = allChecked.map(cb => cb.value);

    // è®°å½•å…¨å±€é€‰ä¸­çš„é€šè·¯é›†åˆ
    window.__selectedPathwaysSet = new Set(selectedPathways);

    currentCy.batch(() => {
        const allElements = currentCy.elements();
        
        // é€»è¾‘ 1ï¼šå…¨é€‰çŠ¶æ€ -> æ¢å¤æ‰€æœ‰å…ƒç´ çš„åˆå§‹çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå˜æš—æ•ˆæœ
        if (allChecked.length === checkboxes.length && checkboxes.length > 0) {
            allElements.removeClass('dimmed highlighted');
            updateMainMoleculeColors(selectedPathways);
        } 
        // é€»è¾‘ 2ï¼šå…¨ä¸é€‰çŠ¶æ€ -> æ‰€æœ‰å…ƒç´ å˜æš—
        else if (allChecked.length === 0) {
            allElements.removeClass('highlighted').addClass('dimmed');
            updateMainMoleculeColors([]);
        } 
        // é€»è¾‘ 3ï¼šéƒ¨åˆ†é€‰æ‹©çŠ¶æ€ -> åªæœ‰å±äºé€‰ä¸­é€šè·¯çš„å…ƒç´ é«˜äº®ï¼Œå…¶ä½™å˜æš—
        else {
            allElements.removeClass('highlighted').addClass('dimmed');

            // ç­›é€‰å‡ºå±äºé€‰ä¸­é€šè·¯çš„è¾¹
            const activeEdges = currentCy.edges().filter(edge => {
                const pData = edge.data('pathway');
                if (!pData) return false;
                const edgePathways = String(pData).split(',').map(s => s.trim());
                return edgePathways.some(ep => selectedPathways.includes(ep));
            });

            // é«˜äº®é€‰ä¸­çš„è¾¹åŠå…¶è¿æ¥çš„èŠ‚ç‚¹
            activeEdges.removeClass('dimmed').addClass('highlighted');
            activeEdges.connectedNodes().removeClass('dimmed').addClass('highlighted');
            
            updateMainMoleculeColors(selectedPathways);
        }
    });

    // åŒæ­¥åˆ·æ–°å‰¯å°åˆ†å­å’Œè·¨è†œè¾¹çš„å¯è§æ€§
    if (typeof refreshSideVisibility === 'function') refreshSideVisibility();
    if (typeof refreshTransportVisibility === 'function') refreshTransportVisibility();
}


    // è¾…åŠ©å·¥å…·
    function showStatus(msg) { document.getElementById('status').innerText = msg; }
    function updateStatus(text) { document.getElementById('status').innerText = text; }

    // ============================================================
    // 4b. å‰¯å°åˆ†å­æ˜¾ç¤ºé€»è¾‘ï¼šé»˜è®¤éšè—ï¼ŒæŒ‰éœ€å›´ç»•é…¶èŠ‚ç‚¹å±•å¼€
    // ============================================================
    function refreshSideVisibility() {
        const cy = window.cyGraph;
        if (!cy) return;

        const selectedPathways = window.__selectedPathwaysSet || new Set();
        const pinned = window.pinnedSidePathways || new Set();
        const selectedRxns = window.selectedReactionIds || new Set();

        cy.batch(() => {
            // å…ˆå…¨éƒ¨éšè—
            cy.nodes('.side-molecule').addClass('hidden-side');
            cy.edges('.edge-side').addClass('hidden-side');

            // å†æŒ‰â€œå›ºå®šæ‰“å¼€çš„ pathwayâ€æ˜¾ç¤º
            cy.nodes('[type="reaction"]').forEach(rxn => {
                const pw = rxn.data('pathway');
                if (!pw) return;
                // åªåœ¨è¯¥ pathway ä»ç„¶è¢«å‹¾é€‰æ—¶å±•å¼€ï¼ˆé¿å…ä¸è¿‡æ»¤å†²çªï¼‰
                if (pinned.has(pw) && (selectedPathways.size === 0 || selectedPathways.has(pw))) {
                    showSideForReaction(rxn.id());
                }
            });

            // å†æŒ‰â€œç‚¹é€‰çš„ååº”â€æ˜¾ç¤ºï¼ˆå…è®¸å¤šä¸ªå…±å­˜ï¼‰
            selectedRxns.forEach(rxnId => {
                showSideForReaction(rxnId);
            });
        });

        // æ˜¾ç¤ºåå†ç»Ÿä¸€å¯¹é½ï¼Œé¿å…æ•£è½/é‡å 
        alignSideNodes();
    }

function refreshTransportVisibility() {
    const cy = window.cyGraph;
    if (!cy) return;

    const selectedPathways = window.__selectedPathwaysSet || new Set();
    const globalCheckbox = document.getElementById('check-all-global');
    const isGlobalAllChecked = !!(globalCheckbox && globalCheckbox.checked);

    cy.batch(() => {
        const allTransEdges = cy.edges('.edge-transport');

        // å…ˆå…¨éƒ¨æ˜¾ç¤ºï¼Œå†æŒ‰è§„åˆ™å»â€œæ‰“éšè—æ ‡è®°â€
        allTransEdges.removeClass('hidden-transport');

        // æƒ…å†µ 1ï¼šå…¨é€‰çŠ¶æ€ - æ‰€æœ‰è·¨è†œè¾¹éƒ½æ˜¾ç¤ºä¸ºæµ…ç°è™šçº¿
        if (isGlobalAllChecked) {
            // å…¨é€‰æ—¶ filterGraph å·²ç»æ¸…é™¤äº† dimmedï¼Œè¿™é‡Œåªéœ€ç¡®ä¿ display æ­£å¸¸
            return;
        }

        // æƒ…å†µ 2ï¼šæ²¡æœ‰ä»»ä½• Pathway è¢«é€‰ä¸­ - å…¨éƒ¨éšè—
        if (!selectedPathways || selectedPathways.size === 0) {
            allTransEdges.addClass('hidden-transport');
            return;
        }

        // å°å·¥å…·ï¼šåˆ¤æ–­ä¸€ä¸ªåˆ†å­èŠ‚ç‚¹æ˜¯å¦â€œå‚ä¸äº†é€‰ä¸­ Pathwayâ€
        const inSelectedPathway = (node) => {
            let flag = false;
            node.neighborhood('node[type="reaction"]').forEach(rxn => {
                if (flag) return;
                const pw = rxn.data('pathway');
                if (pw && selectedPathways.has(pw)) {
                    flag = true;
                }
            });
            return flag;
        };

        // æƒ…å†µ 3ï¼šéƒ¨åˆ† Pathway è¢«é€‰ä¸­ - åªæœ‰ä¸¤ç«¯éƒ½â€œå±äºé€‰ä¸­ Pathwayâ€çš„æ‰æ˜¾ç¤º
        allTransEdges.forEach(edge => {
            const src = edge.source();
            const tgt = edge.target();

            const srcOk = inSelectedPathway(src);
            const tgtOk = inSelectedPathway(tgt);

            if (!(srcOk && tgtOk)) {
                edge.addClass('hidden-transport');
            }
        });

        // è®©å¯è§çš„è·¨è†œè¿è¾“è¾¹ä¸å— filterGraph çš„ dimmed å½±å“ï¼ˆå¦åˆ™çœ‹èµ·æ¥åƒæ²¡ç”»å‡ºæ¥ï¼‰
        allTransEdges.filter(':visible').removeClass('dimmed');
    });
}


function showSideForReaction(rxnId) {
        const cy = window.cyGraph;
        if (!cy) return;

        // side nodes çš„ id éƒ½ä»¥ `${rxnId}_side_` å¼€å¤´
        cy.nodes('.side-molecule').forEach(n => {
            if (n.id().startsWith(`${rxnId}_side_`)) {
                n.removeClass('hidden-side');
            }
        });

        // side edgesï¼šè¿æ¥ååº”èŠ‚ç‚¹ä¸ side node
        cy.edges('.edge-side').forEach(e => {
            const s = e.data('source');
            const t = e.data('target');
            if ((typeof s === 'string' && s.startsWith(`${rxnId}_side_`)) ||
                (typeof t === 'string' && t.startsWith(`${rxnId}_side_`))) {
                e.removeClass('hidden-side');
            }
        });
    }

    // ============================================================
    // 4c. è‡ªåŠ¨ä¿å­˜/æ¢å¤å¸ƒå±€ï¼ˆé¿å…æ¯æ¬¡éƒ½é‡è°ƒä½ç½®ï¼‰
    // ============================================================
    const STORAGE_KEY_AUTO = STORAGE_KEY + '_autosave';

    function saveLayoutAuto() {
        if (!window.isEditMode) return; 
        if (!window.cyGraph) return;

        const positions = {};
        window.cyGraph.nodes().forEach(node => {
            // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘ ===
            // åŒæ ·ï¼Œè‡ªåŠ¨ä¿å­˜ä¹Ÿä¸åŒ…å«å‰¯èŠ‚ç‚¹
            if (node.hasClass('side-molecule')) return;

            positions[node.id()] = node.position();
        });
        
        localStorage.setItem(STORAGE_KEY + '_autosave', JSON.stringify(positions));
        saveLayoutToServer(positions);
    }



        function restoreLayoutAuto() {
        // å°è¯•ä» localStorage è·å–
        const raw = localStorage.getItem(STORAGE_KEY_AUTO);
        // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•ç”¨é¢„åŠ è½½çš„æœåŠ¡å™¨æ•°æ® (window.__preloadLayout)
        // æˆ–è€…æ˜¯ä¹‹å‰ saveLayoutToServer ä¿å­˜çš„å†…å­˜å˜é‡
        // è¿™é‡Œæ²¿ç”¨ä½ åŸæœ¬çš„é€»è¾‘ï¼Œä¸»è¦ä¿®æ”¹å¾ªç¯å†…éƒ¨
        
        if (!raw || !window.cyGraph) return false;

        let positions = null;
        try {
            positions = JSON.parse(raw);
        } catch {
            return false;
        }
        if (!positions || typeof positions !== 'object') return false;

        const cy = window.cyGraph;
        const restoredIds = new Set();
        let restoreCount = 0;

        cy.batch(() => {
            // éå† JSON ä¸­çš„æ‰€æœ‰ ID
            for (const [id, pos] of Object.entries(positions)) {
                const node = cy.getElementById(id);
                // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘ ===
                // è¿™æ ·å‰¯èŠ‚ç‚¹å°±ä¸ä¼šè¢« JSON é‡Œçš„ (0,0) æˆ–æ—§åæ ‡å½±å“
                if (node.length === 0) continue;
                if (node.hasClass('side-molecule')) continue; 

                if (typeof pos.x === 'number' && typeof pos.y === 'number') {
                    node.position({ x: pos.x, y: pos.y });
                    restoredIds.add(id);
                    restoreCount++;
                }
            }
        });

        // å¯¹â€œæ–°å‡ºç°çš„ä¸»å¹²èŠ‚ç‚¹â€ï¼Œç®€å•å®‰ç½®åœ¨é‚»å±…æ—è¾¹ (åŸæœ¬çš„é€»è¾‘)
        cy.nodes().forEach(node => {
            if (restoredIds.has(node.id())) return; 
            if (node.data('isSide') === true || node.hasClass('side-molecule')) return; // å‰¯èŠ‚ç‚¹ä¸ç®¡

            let sumX = 0, sumY = 0, cnt = 0;
            node.neighborhood('node').forEach(nb => {
                if (!restoredIds.has(nb.id())) return;
                const bp = nb.position();
                sumX += bp.x; sumY += bp.y; cnt++;
            });
            if (cnt > 0) {
                node.position({ x: sumX / cnt + 40, y: sumY / cnt });
            }
        });

        console.log(`å·²æ¢å¤ ${restoreCount} ä¸ªä¸»èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¿½ç•¥äº†å‰¯èŠ‚ç‚¹ã€‚`);
        return restoreCount > 0;
    }


    let _saveTimer = null;
    function autoSaveLayoutDebounced() {
        if (_saveTimer) clearTimeout(_saveTimer);
        _saveTimer = setTimeout(() => {
            try { saveLayoutAuto(); } catch(e) {}
        }, 250);
    }

    window.addEventListener('beforeunload', () => {
        try { saveLayoutAuto(); } catch(e) {}
    });

    // ============================================================
    // 5. ã€ä¿®æ­£ç‰ˆã€‘å‰¯èŠ‚ç‚¹å¼ºåˆ¶å¯¹é½ç®—æ³•
    // ============================================================
    function alignSideNodes(specificRxnId = null) {
        const cy = window.cyGraph;
        if (!cy) return;

        cy.batch(() => {
            // === å‚æ•°é…ç½® ===
            const OFFSET_X = 135;    // æ°´å¹³è·ç¦»ï¼šç¦»ååº”èŠ‚ç‚¹å¤šè¿œ
            const STEP_Y  = 26;      // å‚ç›´é—´è·ï¼šå‰¯äº§ç‰©ä¹‹é—´çš„è·ç¦»
            const MAX_PER_COL = 8;   // æ¯åˆ—æœ€å¤šæ”¾å‡ ä¸ª
            const COL_GAP = 65;      // å¤šåˆ—æ—¶çš„åˆ—é—´è·

            let targets;
            if (specificRxnId) {
                targets = cy.getElementById(specificRxnId);
            } else {
                targets = cy.nodes('[type="reaction"]');
            }

            targets.forEach(rxnNode => {
                const center = rxnNode.position();
                const rxnId = rxnNode.id();

                const inNodes = [];
                const outNodes = [];

                // æŸ¥æ‰¾å±äºè¯¥ååº”çš„æ‰€æœ‰å‰¯åˆ†å­
                cy.nodes('.side-molecule').forEach(n => {
                    if (n.data('parentRxn') !== rxnId) return; 
                    
                    // === ã€BUG ä¿®å¤å…³é”®ç‚¹ã€‘ ===
                    // ä½¿ç”¨ direction å­—æ®µæ¥åˆ¤æ–­æ˜¯ååº”ç‰©(in)è¿˜æ˜¯äº§ç‰©(out)
                    // åŸæ¥çš„ä»£ç ä½¿ç”¨çš„æ˜¯ roleï¼Œä½† role å­˜çš„æ˜¯ 'sub-reactant'
                    const dir = n.data('direction');

                    if (dir === 'in') inNodes.push(n);
                    else if (dir === 'out') outNodes.push(n);
                });

                // æ’ç‰ˆé€»è¾‘ï¼ˆæ …æ ¼åŒ–/åˆ—è¡¨åŒ–ï¼‰
                const placeGrid = (nodes, side) => {
                    const total = nodes.length;
                    if (total === 0) return;

                    const cols = Math.ceil(total / MAX_PER_COL);
                    for (let c = 0; c < cols; c++) {
                        const start = c * MAX_PER_COL;
                        const chunk = nodes.slice(start, start + MAX_PER_COL);
                        
                        // å‚ç›´å±…ä¸­è®¡ç®—
                        const rows = chunk.length;
                        const yStart = center.y - ((rows - 1) * STEP_Y) / 2;

                        // å·¦ä¾§å‘å·¦å»¶ä¼¸ï¼Œå³ä¾§å‘å³å»¶ä¼¸
                        const x = (side === 'left')
                            ? (center.x - OFFSET_X - c * COL_GAP)
                            : (center.x + OFFSET_X + c * COL_GAP);

                        chunk.forEach((node, r) => {
                            // å¼ºåˆ¶æ›´æ–°ä½ç½®
                            node.position({
                                x: x,
                                y: yStart + r * STEP_Y
                            });
                        });
                    }
                };

                // å·¦è¾¹æ”¾ååº”ç‰© (in)ï¼Œå³è¾¹æ”¾äº§ç‰© (out)
                placeGrid(inNodes, 'left');
                placeGrid(outNodes, 'right');
            });
        });
    }



    // ============================================================
    // Regulation æ£€ç´¢åŠŸèƒ½æ¨¡å—
    // ============================================================

    let currentRegNodeId = null; // å½“å‰é€‰ä¸­çš„æœ‰ Regulation çš„èŠ‚ç‚¹ID

    // ============================================
// [ä¿®æ”¹] åˆ‡æ¢ Regulation é¢æ¿ (å«é¡ºæ»‘åŠ¨ç”»ä¸æº¢å‡ºå¤„ç†)
// ============================================
function toggleRegulationAndRender() {
    const toggleBtn = document.getElementById('regulation-toggle');
    const isChecked = toggleBtn.checked;
    const panel = document.getElementById('regulation-panel');
    const hint = document.getElementById('scroll-hint-text');
    const cy = window.cyGraph;

    // æ§åˆ¶æç¤ºæ–‡å­—æ˜¾éš
    if (hint) hint.style.display = isChecked ? 'block' : 'none';

    if (isChecked) {
        renderRegulationList();
        panel.classList.add('is-open');
        // å…³é”®ç‚¹ï¼šä¸å†ç”¨ requestAnimationFrame å¾ªç¯è°ƒç”¨ resize
        // åªåœ¨åŠ¨ç”»å¼€å§‹ã€ä¸­é—´ã€ç»“æŸè°ƒä¸‰æ¬¡ï¼Œå‡è½» CPU è´Ÿæ‹…
        setTimeout(() => cy.resize(), 10);
        setTimeout(() => cy.resize(), 150);
        setTimeout(() => {
            cy.resize();
            panel.classList.add('allow-overflow');
        }, 400);
    } else {
        panel.classList.remove('allow-overflow', 'is-open');
        closeRegulationOverlay();
        setTimeout(() => cy.resize(), 400); // ç»“æŸåè°ƒä¸€æ¬¡å³å¯
    }

    // // === ç”»å¸ƒé¡ºæ»‘é€‚é… ===
    // // åœ¨é¢æ¿é«˜åº¦å˜åŒ–çš„ 0.45ç§’å†…ï¼ŒæŒç»­é€šçŸ¥å›¾è¡¨é‡ç»˜å¤§å°
    if (cy) {
        const startTime = Date.now();
        const duration = 450; 
            const animateResize = () => {
        cy.resize();
        if (Date.now() - startTime < duration) {
            requestAnimationFrame(animateResize);
        }
    };
    requestAnimationFrame(animateResize);
}
}



function renderRegulationList() {
    const container = document.getElementById('regulation-content-wrapper');
    if (!container || !window.cyGraph) return;
    
    container.innerHTML = '';
    const regNodes = window.cyGraph.nodes().filter(n => n.data('hasRegulation') === true);

    const groupByPathway = {};
    regNodes.forEach(node => {
        const rawPathway = node.data('pathway') || 'Other';
        const pathways = String(rawPathway).split(',').map(s => s.trim());

        pathways.forEach(pw => {
            // å¯¹é€šè·¯åè¿›è¡Œæ›¿æ¢
            const formattedPw = typeof formatText === 'function' ? formatText(pw) : pw;
            if (!groupByPathway[formattedPw]) groupByPathway[formattedPw] = [];
            groupByPathway[formattedPw].push(node);
        });
    });

    Object.keys(groupByPathway).sort().forEach(pwName => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'reg-group';

        // è¿™é‡Œçš„æ–‡æœ¬å†…å®¹åŒæ ·åº”ç”¨å­—ç¬¦æ›¿æ¢
        groupDiv.innerHTML = `
            <div class="reg-group-title">
                <span>${pwName}</span>
                <span class="reg-group-count">${groupByPathway[pwName].length}</span>
            </div>
            <div class="reg-dropdown"></div>
        `;

        const dropdown = groupDiv.querySelector('.reg-dropdown');
        groupByPathway[pwName].forEach(node => {
            const rawLabel = node.data('label') || node.data('infoEnzyme') || node.id();
            const label = typeof formatText === 'function' ? formatText(rawLabel) : rawLabel;
            
            const btn = document.createElement('div');
            btn.className = 'reg-item-btn';
            btn.innerHTML = `<span>${label}</span>`;
            
            btn.onclick = (e) => {
                e.stopPropagation();
                window.currentRegNodeId = node.id();
                // æ ¸å¿ƒï¼šç‚¹å‡»ååˆ·æ–°ä¾§è¾¹æ å†…å®¹
                updateOverlayPosition(); 
                showAndLayoutRegulators(node); 
                window.focusNodeFinal(node); 
            };
            dropdown.appendChild(btn);
        });
        container.appendChild(groupDiv);
    });
}

    // ============================================================
    // 3. ç‚¹å‡»åˆ—è¡¨é¡¹äº¤äº’ (é€‚é…æ–°æ ·å¼)
    // ============================================================
    function handleRegulationClick(node, btnElement) {
    // æ¸…é™¤å…¶ä»–æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.reg-item-btn').forEach(b => b.classList.remove('active'));
    
    // å¦‚æœé‡å¤ç‚¹å‡»åˆ™å…³é—­
    if (currentRegNodeId === node.id()) {
        closeRegulationOverlay();
        return;
    }

    currentRegNodeId = node.id();
    if(btnElement) btnElement.classList.add('active');

    // æ˜¾ç¤ºå¹¶æ’ç‰ˆå›¾ä¸Šçš„è°ƒèŠ‚å› å­ï¼ˆActivator/Inhibitorï¼‰
    showAndLayoutRegulators(node);

    // ã€å…³é”®ã€‘ï¼šæ›´æ–°ä¾§è¾¹æ å†…å®¹ï¼ˆå†…éƒ¨ä¼šè§¦å‘ updateRightSidebarï¼‰
    updateOverlayPosition(); 

    // æ‰§è¡Œè§†è§’èšç„¦
    window.focusNodeFinal(node);
}




        // ============================================================
    // 4. æ›´æ–°æ‚¬æµ®æ¡†å†…å®¹ (æœ€ç»ˆç‰ˆï¼šå«æ–‡ä»¶åæ¨¡ç³ŠåŒ¹é… + JPG/PNGè‡ªåŠ¨å›é€€)
function updateOverlayPosition() {
    if (!window.currentRegNodeId) return;
    const node = window.cyGraph.getElementById(window.currentRegNodeId);
    if (!node.length) return;

    const data = node.data();
    const displayName = typeof formatText === 'function' ? formatText(data.label || data.infoEnzyme || data.id) : (data.label || data.id);
    
    // --- ä¿®æ”¹ç‚¹ 1: å¤„ç† Regulation æ–‡æœ¬ï¼Œå¦‚æœä¸º "0" æˆ–ç©ºåˆ™è®¾ä¸º null ---
    let regText = (data.regulationText && data.regulationText !== '0') ? data.regulationText : null;
    if (regText) regText = typeof formatText === 'function' ? formatText(regText) : regText;

    // --- ä¿®æ”¹ç‚¹ 2: æå– Activator å’Œ Inhibitor ä¿¡æ¯ ---
    // ä»å›¾ä¸­æŸ¥æ‰¾è¿æ¥åˆ°è¯¥ reaction èŠ‚ç‚¹çš„è°ƒèŠ‚å› å­èŠ‚ç‚¹
    const activators = node.incomers('node[nodeType="activator"]').map(n => n.data('label'));
    const inhibitors = node.incomers('node[nodeType="inhibitor"]').map(n => n.data('label'));

    // 1. è·å–æ£€ç´¢åŸºç¡€åç”¨äºå›¾ç‰‡åŒ¹é…
    let searchName = (data.rawEnzyme || data.baseName || (data.label === '0' ? '' : data.label)).trim();
    let realFileName = typeof findMatchingImageFile === 'function' ? findMatchingImageFile(searchName) : null;

    // å¦‚æœå›¾ç‰‡æ¢æµ‹å¤±è´¥ï¼Œå®šä¹‰ä¸€ä¸ªæ¸²æŸ“å‡½æ•°
    const finalizeRender = (imgHtml = '') => {
        // æ„é€ è°ƒèŠ‚å› å­çš„é†’ç›® HTML
        let regFactorHtml = '';
        
        if (activators.length > 0) {
            regFactorHtml += `
                <div class="detail-group">
                    <div class="detail-label" style="color: #2e7d32;">â• Activators</div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                        ${activators.map(a => `<span style="background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">${formatText(a)}</span>`).join('')}
                    </div>
                </div>`;
        }

        if (inhibitors.length > 0) {
            regFactorHtml += `
                <div class="detail-group">
                    <div class="detail-label" style="color: #c62828;">â– Inhibitors</div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                        ${inhibitors.map(i => `<span style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">${formatText(i)}</span>`).join('')}
                    </div>
                </div>`;
        }

        renderRegulationSidebar(displayName, regText, imgHtml, regFactorHtml);
    };

    if (!searchName || !realFileName) {
        finalizeRender('');
        return;
    }

    // å›¾ç‰‡æ¢æµ‹é€»è¾‘ (ä¿æŒä¸å˜...)
    const baseName = realFileName.replace(/\.(png|jpg|jpeg)$/i, "");
    const foundImages = [];
    const probeImages = (index) => {
        const currentName = index === 0 ? baseName : `${baseName}_${index}`;
        const pngSrc = `images/${currentName}.png`;
        const jpgSrc = `images/${currentName}.jpg`;
        const img = new Image();
        img.src = pngSrc;
        img.onload = () => { foundImages.push(pngSrc); probeImages(index + 1); };
        img.onerror = () => {
            const imgJpg = new Image();
            imgJpg.src = jpgSrc;
            imgJpg.onload = () => { foundImages.push(jpgSrc); probeImages(index + 1); };
            imgJpg.onerror = () => {
                let imgHtml = '';
                if (foundImages.length > 0) {
                    const imgs = foundImages.map(src => `<img src="${src}" style="max-width:100%; max-height:220px; border-radius:4px; margin-bottom:12px; cursor:zoom-in; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:block;" onclick="openImageModal(this.src)">`).join('');
                    imgHtml = `<div class="reg-detail-img-container" style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:15px; display:flex; flex-direction:column; align-items:center;">${imgs}</div>`;
                }
                finalizeRender(imgHtml);
            };
        };
    };
    probeImages(0);
}

// è¾…åŠ©æ¸²æŸ“å‡½æ•°
function renderRegulationSidebar(title, text, imgHtml, regFactorHtml = '') {
    // åŸºç¡€æ ‡é¢˜
    let sideHtml = `
        <div class="detail-group">
            <div class="detail-header-title">âš™ï¸ ${title}</div>
        </div>
        ${imgHtml}
        ${regFactorHtml} 
    `;

    // --- ä¿®æ”¹ç‚¹ï¼šåªæœ‰å½“ text ä¸ä¸ºç©ºä¸”ä¸ä¸º null æ—¶ï¼Œæ‰æ¸²æŸ“è¯¥åŒºå— ---
    if (text && text !== 'null') {
        sideHtml += `
            <div class="detail-group">
                <div class="detail-label">REGULATION MECHANISM</div>
                <div class="reg-detail-text" style="background:#fffbeb; padding:12px; border-left:4px solid #f59e0b; border-radius:4px; color:#334155; line-height:1.6;">
                    ${text.replace(/\n/g, '<br/>')}
                </div>
            </div>
        `;
    }

    window.rightSidebarState.nodeHtml = sideHtml;
    window.rightSidebarState.isExpanded = true;
    if (typeof updateRightSidebar === 'function') {
        updateRightSidebar();
    }
}

    
function closeRegulationOverlay() {
    // 1. æ¸…é™¤å†…éƒ¨çŠ¶æ€
    window.currentRegNodeId = null;
    window.rightSidebarState.nodeHtml = null;
    
    // 2. æ¸…é™¤ UI çŠ¶æ€
    document.querySelectorAll('.reg-item-btn').forEach(b => b.classList.remove('active'));
    
    // 3. æ ¸å¿ƒï¼šå¼ºåˆ¶éšè—å›¾é¢ä¸Šçš„æ‰€æœ‰è°ƒèŠ‚å› å­å’Œè¿çº¿
    const cy = window.cyGraph || window.cy;
    if (cy) {
        cy.batch(() => {
            // éšè—æ‰€æœ‰è°ƒèŠ‚å› å­èŠ‚ç‚¹ï¼ˆnodeType ä¸º activator æˆ– inhibitor çš„èŠ‚ç‚¹ï¼‰
            // ä»¥åŠæ‰€æœ‰è°ƒèŠ‚è¿çº¿ï¼ˆinteraction ä¸º activate æˆ– inhibit çš„è¾¹ï¼‰
            cy.elements('.reg-node, .reg-edge').addClass('hidden-reg').style('display', 'none');
            
            // ç¡®ä¿è¿™äº›å…ƒç´ åœ¨é€»è¾‘ä¸Šä¹Ÿä¸å†å¤„äºé«˜äº®çŠ¶æ€
            cy.elements('.reg-node, .reg-edge').removeClass('highlighted');
        });
    }

    // 4. æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
    if (typeof updateRightSidebar === 'function') {
        updateRightSidebar();
    }
}

        // ============================================================
    // å›¾ç‰‡æ”¾å¤§åŠŸèƒ½å‡½æ•°
    // ============================================================
    function openImageModal(src) {
        // 1. æ£€æŸ¥é¡µé¢ä¸Šæ˜¯å¦å·²æœ‰æ¨¡æ€æ¡† DOMï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        let modal = document.getElementById('img-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'img-modal';
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = function() { modal.style.display = 'none'; };
            
            // å†…éƒ¨å›¾ç‰‡å®¹å™¨
            const img = document.createElement('img');
            img.id = 'img-modal-content';
            // é˜»æ­¢ç‚¹å‡»å›¾ç‰‡æœ¬èº«è§¦å‘å…³é—­ï¼ˆå¯é€‰ï¼Œçœ‹ä½“éªŒåå¥½ï¼Œè¿™é‡Œä¿æŒé»˜è®¤ç‚¹å‡»ä»»æ„å¤„å…³é—­æ›´æ–¹ä¾¿ï¼‰
            // img.onclick = function(e) { e.stopPropagation(); }; 
            
            modal.appendChild(img);
            document.body.appendChild(modal);
        }

        // 2. è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤º
        const imgEl = document.getElementById('img-modal-content');
        imgEl.src = src;
        modal.style.display = 'flex'; // ä½¿ç”¨ flex å±…ä¸­
    }

    // ============================================
    // ä¾§è¾¹æ æŠ˜å /å±•å¼€é€»è¾‘ (é¡ºæ»‘åŠ¨ç”»ç‰ˆ)
    // ============================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const expandBtn = document.getElementById('sidebar-expand-btn');
    const cy = window.cyGraph;

    if (!sidebar) return;

    // 1. åˆ‡æ¢çŠ¶æ€
    const isNowCollapsing = !sidebar.classList.contains('collapsed');
    sidebar.classList.toggle('collapsed');

    // 2. æŒ‰é’®æ˜¾éšé€»è¾‘
    if (isNowCollapsing) {
        setTimeout(() => { if(expandBtn) expandBtn.style.display = 'flex'; }, 400);
    } else {
        if(expandBtn) expandBtn.style.display = 'none';
    }

    // 3. ã€æ ¸å¿ƒä¼˜åŒ–ï¼šè§£å†³é—ªçƒã€‘
    if (cy) {
        // å…³é”®ç‚¹ Aï¼šåœ¨åŠ¨ç”»å¼€å§‹å‰ï¼Œåœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„æ¸²æŸ“
        // è¿™å¯ä»¥é˜²æ­¢ Cytoscape åœ¨å®¹å™¨å°ºå¯¸å‰§çƒˆå˜åŠ¨æ—¶å°è¯•å¯»æ‰¾èŠ‚ç‚¹åæ ‡
        
        // å…³é”®ç‚¹ Bï¼šåªåœ¨åŠ¨ç”»è¿›è¡Œåˆ°ä¸€åŠï¼ˆè§†è§‰å˜åŠ¨æœ€å‰§çƒˆï¼‰å’Œç»“æŸæ—¶è§¦å‘ä¸¤æ¬¡é‡ç»˜å³å¯
        // è¿™æ ·å¯ä»¥ä¿è¯è§†è§‰ä¸Šçš„å¹³æ»‘ï¼Œåˆä¸ä¼šå› ä¸ºé«˜é¢‘é‡ç»˜å¯¼è‡´ Canvas ç¼“å†²åŒºé—ªçƒ
        setTimeout(() => {
            cy.resize();
        }, 200); // åŠ¨ç”»ä¸­é—´ç‚¹

        setTimeout(() => {
            cy.resize();
            // å¦‚æœä½ å¸Œæœ›æ”¶èµ·åå›¾è¡¨è‡ªåŠ¨å¡«æ»¡å±å¹•ï¼Œå–æ¶ˆä¸‹ä¸€è¡Œçš„æ³¨é‡Š
            // cy.animate({ fit: { eles: cy.elements(), padding: 50 }, duration: 300 });
        }, 450); // åŠ¨ç”»ç»“æŸç‚¹
    }
}

    // ============================================================
    // 5. ç»‘å®šäº‹ä»¶ (æ–°ç‰ˆï¼šç§»é™¤ Pan/Zoom ç›‘å¬ï¼Œä¿ç•™ç‚¹å‡»ç©ºç™½å…³é—­)
    // ============================================================
    function bindRegulationOverlayEvents() {
        const cy = window.cyGraph;
        if (!cy) return;
        
        // ç§»é™¤åŸæœ¬çš„ cy.on('pan zoom position'...) ç›‘å¬ï¼Œå› ä¸ºç°åœ¨æ˜¯å›ºå®šå®šä½
        
        // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰ä¸­å¹¶å…³é—­
        cy.on('tap', (e) => {
             if (e.target === cy) {
        closeRegulationOverlay();
    } else if (e.target.isNode && (e.target.data('nodeType') === 'activator' || e.target.data('nodeType') === 'inhibitor')) {
        // ç‚¹å‡»è°ƒèŠ‚å› å­èŠ‚ç‚¹æœ¬èº«æ—¶ï¼Œä¸åšä»»ä½•æ“ä½œï¼Œé˜²æ­¢å…¶æ¶ˆå¤±
        return;
    }
        });
    }
    // === æ–°å¢è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå¹¶å›´ç»•ä¸­å¿ƒæ’åˆ—è°ƒèŠ‚å› å­ ===
    function showAndLayoutRegulators(centerNode) {
        const cy = window.cyGraph;
        if (!cy || !centerNode) return;

        // 1. å…ˆéšè—å›¾ä¸Šå…¶ä»–æ‰€æœ‰çš„è°ƒæ§å› å­ï¼Œä¿æŒè§†é‡å¹²å‡€
        cy.elements('.reg-node').addClass('hidden-reg').style('display', 'none');
        cy.elements('.reg-edge').addClass('hidden-reg').style('display', 'none');

        // 2. æ‰¾åˆ°æŒ‡å‘è¯¥èŠ‚ç‚¹çš„è°ƒèŠ‚è¾¹å’ŒæºèŠ‚ç‚¹
        const connectedEdges = centerNode.incomers('edge[interaction="activate"], edge[interaction="inhibit"]');
        const connectedNodes = connectedEdges.sources();

        if (connectedNodes.length > 0) {
            // 3. ç§»é™¤éšè—ç±»ï¼Œæ˜¾ç¤ºå‡ºæ¥
            connectedNodes.removeClass('hidden-reg').style('display', 'element');
            connectedEdges.removeClass('hidden-reg').style('display', 'element');

            // 4. æ•°å­¦è®¡ç®—ï¼šå›´ç»• reaction èŠ‚ç‚¹å‘ˆåœ†å½¢æ’åˆ—
            const center = centerNode.position();
            const r = 80; // åŠå¾„
            
            // ä¸ºäº†ä¸å’Œä¸»å¹²è¿çº¿ï¼ˆé€šå¸¸åœ¨å·¦å³ï¼‰å’Œå‰¯ååº”ï¼ˆé€šå¸¸åœ¨ä¸Šä¸‹ï¼‰é‡å ï¼Œ
            // æˆ‘ä»¬å¯ä»¥å°è¯•æŠŠå®ƒä»¬æ”¾åœ¨ 45åº¦è§’çš„ä½ç½®ï¼Œæˆ–è€…å¹³å‡åˆ†å¸ƒ
            connectedNodes.forEach((child, i) => {
                // (-Math.PI / 2) æ˜¯ä»æ­£ä¸Šæ–¹å¼€å§‹æ’
                const angle = i * (2 * Math.PI / connectedNodes.length) - Math.PI / 2 + 0.5; // +0.5 ç¨å¾®åä¸€ç‚¹é”™å¼€å‚ç›´æ–¹å‘
                
                // ä»…è®¾ç½®ä½ç½®ï¼Œä¸ä¿å­˜åˆ°å¸ƒå±€æ–‡ä»¶
                child.position({
                    x: center.x + r * Math.cos(angle),
                    y: center.y + r * Math.sin(angle)
                });
            });
        }
    }
    // ============================================
    // [æ–°å¢] ä½¿å¾— Regulation Bar æ”¯æŒé¼ æ ‡æ»šè½®å·¦å³æ»‘åŠ¨
    // ============================================
// ä¿®æ”¹æ»šè½®ç›‘å¬éƒ¨åˆ†
const regPanel = document.getElementById('regulation-panel');
const regContentWrapper = document.getElementById('regulation-content-wrapper');

if (regPanel && regContentWrapper) {
    regPanel.addEventListener('wheel', (evt) => {
        if (regPanel.classList.contains('is-open')) {
            if (evt.deltaY !== 0) {
                // åªæœ‰é¼ æ ‡çœŸçš„åœ¨è¿™ä¸€æ¨ªæ¡åŒºåŸŸå†…æ‰æ‹¦æˆªæ»šåŠ¨
                evt.preventDefault();
                regContentWrapper.scrollLeft += evt.deltaY;
            }
        }
    }, { passive: false });
}


// ============================================================
//  [æ–°å¢] ç»†èƒå™¨å›¾ç‰‡è¦†ç›–å±‚ï¼šå¯æ‹–æ‹½ / ç¼©æ”¾ / æ—‹è½¬ï¼Œå¹¶éšå›¾å¹³ç§»ç¼©æ”¾
// ============================================================
window.isOrganelleEditMode = false;
window.organelleOverlayInited = false;

const ORGANELLE_ASSETS = {
    chloroplast: { src: 'orgenells/chloroplast.png', title: 'Chloroplast' , zIndex:2},
    er_smooth:   { src: 'orgenells/ER%20smooth.png', title: 'ER smooth' , zIndex:2},
    glyoxysome:  { src: 'orgenells/glyoxysome.png', title: 'Glyoxysome' , zIndex:2},
    mitochondria:{ src: 'orgenells/mitochondria.png', title: 'Mitochondria', zIndex:1}
};

const ORGANELLE_STORAGE_KEY = 'metabolic_organelles_layout_v1';

function _getGraphAreaRect(){
    const ga = document.getElementById('graph-area');
    return ga ? ga.getBoundingClientRect() : null;
}

function _getCy(){
    return window.cyGraph || window.cy || null;
}

function _ensureOrganelleLayer(){
    const layer = document.getElementById('organelle-layer');
    if (!layer) return null;
    if (!layer.style.getPropertyValue('--org-opacity')) {
        layer.style.setProperty('--org-opacity', '0.27');
    }
    return layer;
}

function _defaultOrganelleLayout(){
    return {
        version: 4,
        coordMode: 'world',
        opacity: 0.27,
        organelles: {
            chloroplast: { x: 260, y: 80,  w: 220, h: 120, rot: 0 },
            er_smooth:   { x: 60,  y: 60,  w: 220, h: 140, rot: 0 },
            glyoxysome:  { x: 420, y: 360, w: 160, h: 160, rot: 0 },
            mitochondria:{ x: 260, y: 200, w: 340, h: 240, rot: 0 }
        }
    };
}

function _normalizeOrganellePayload(payload){
    const base = _defaultOrganelleLayout();
    const p = (payload && typeof payload === 'object') ? payload : {};
    const out = {
        version: Number(p.version || base.version),
        coordMode: (p.coordMode || 'world'),
        opacity: (typeof p.opacity === 'number' ? p.opacity : base.opacity),
        organelles: {}
    };
    const org = (p.organelles && typeof p.organelles === 'object') ? p.organelles : {};
    for (const key of Object.keys(ORGANELLE_ASSETS)){
        const d = base.organelles[key];
        const v = org[key] || {};
        out.organelles[key] = {
            x: (typeof v.x === 'number' ? v.x : d.x),
            y: (typeof v.y === 'number' ? v.y : d.y),
            w: (typeof v.w === 'number' ? v.w : d.w),
            h: (typeof v.h === 'number' ? v.h : d.h),
            rot: (typeof v.rot === 'number' ? v.rot : 0)
        };
    }
    return out;
}

async function loadOrganellesLayout(){
    try{
        // ä¿®æ”¹ç‚¹ï¼šè¯»å–é™æ€æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
        try {
            const resp = await fetch('organelles_layout.json');
            if (resp.ok) {
                // ... (ä¿æŒåç»­å¤„ç†é€»è¾‘ä¸å˜)
                const payload = await resp.json();
                const normalized = _normalizeOrganellePayload(payload);
                // ...
                return normalized;
            }
        } catch (e) { console.warn('Static organelles load failed', e); }
        if (resp.ok){
            const payload = await resp.json();
            const normalized = _normalizeOrganellePayload(payload);
            // === [æ–°å¢ä»£ç å¼€å§‹]ï¼šå¼ºåˆ¶ä½¿ç”¨æœ¬åœ°æµè§ˆå™¨çš„é€æ˜åº¦é…ç½® ===
            try {
                const localRaw = localStorage.getItem(ORGANELLE_STORAGE_KEY);
                if (localRaw) {
                    const localData = JSON.parse(localRaw);
                    // å¦‚æœæœ¬åœ°æœ‰è®°å½•é€æ˜åº¦ï¼Œå°±è¦†ç›–æ‰æœåŠ¡å™¨å‘æ¥çš„é€æ˜åº¦
                    if (typeof localData.opacity === 'number') {
                        normalized.opacity = localData.opacity; 
                    }
                }
            } catch(e) {}
            localStorage.setItem(ORGANELLE_STORAGE_KEY, JSON.stringify(normalized));
            return normalized;
        }
    }catch(e){
        console.warn('Fetch organelles layout failed, fallback to local:', e);
    }
    try{
        const raw = localStorage.getItem(ORGANELLE_STORAGE_KEY);
        if (raw) return _normalizeOrganellePayload(JSON.parse(raw));
    }catch(e){}
    return _defaultOrganelleLayout();
}

let _organelleSaveTimer = null;
function saveOrganellesLayoutDebounced(layout){
    try{ 
        // ä¾ç„¶ä¿ç•™æœ¬åœ°ç¼“å­˜ï¼Œè¿™æ ·ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œä»–è‡ªå·±çš„æ”¹åŠ¨è¿˜åœ¨
        localStorage.setItem(ORGANELLE_STORAGE_KEY, JSON.stringify(layout)); 
    } catch(e){}
    
    if (_organelleSaveTimer) clearTimeout(_organelleSaveTimer);
    _organelleSaveTimer = setTimeout(async () => {
        // åˆ æ‰æˆ–æ³¨é‡Šæ‰è¿™é‡Œçš„ fetch('/api/organelles', ...)
        console.log('[Local Only] Organelle layout saved to local storage.');
    }, 450);
}

function _applyOrganelleOpacity(opacity){
    const layer = _ensureOrganelleLayer();
    if (!layer) return;
    const v = Math.max(0.05, Math.min(0.85, opacity));
    layer.style.setProperty('--org-opacity', String(v));
}

function _updateOrganelleLayerTransform(){
    const cy = _getCy();
    const layer = _ensureOrganelleLayer();
    if (!cy || !layer) return;
    const pan = cy.pan();
    const zoom = cy.zoom();
    layer.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
}

function _renderOneOrganelle(el, st){
    el.style.left = st.x + 'px';
    el.style.top  = st.y + 'px';
    el.style.width  = st.w + 'px';
    el.style.height = st.h + 'px';
    el.style.transform = `rotate(${st.rot || 0}deg)`;
}

function _buildOrganelleDOM(layer, key){
    const wrapper = document.createElement('div');
    wrapper.className = 'organelle-item';
    // === [æ–°å¢] åº”ç”¨ Z-Index ===
    // å¦‚æœé…ç½®é‡Œæœ‰ zIndex å°±ç”¨ï¼Œå¦åˆ™é»˜è®¤ 1
    const zIdx = (ORGANELLE_ASSETS[key] && ORGANELLE_ASSETS[key].zIndex) ? ORGANELLE_ASSETS[key].zIndex : 1;
    wrapper.style.zIndex = zIdx;
    wrapper.dataset.key = key;
    wrapper.title = ORGANELLE_ASSETS[key].title || key;

    const img = document.createElement('img');
    img.src = ORGANELLE_ASSETS[key].src;
    img.alt = key;
    img.draggable = false;

    const rotateLine = document.createElement('div');
    rotateLine.className = 'org-rotate-line';

    const rotateHandle = document.createElement('div');
    rotateHandle.className = 'org-handle rotate';
    rotateHandle.title = 'Rotate';

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'org-handle resize-se';
    resizeHandle.title = 'Resize';

    wrapper.appendChild(img);
    wrapper.appendChild(rotateLine);
    wrapper.appendChild(rotateHandle);
    wrapper.appendChild(resizeHandle);

    layer.appendChild(wrapper);
    return { wrapper, rotateHandle, resizeHandle };
}

function initOrganelleOverlayOnce(cy){
    if (window.organelleOverlayInited) return;
    const layer = _ensureOrganelleLayer();
    if (!layer) return;
    window.organelleOverlayInited = true;

    cy.on('pan zoom', _updateOrganelleLayerTransform);
    window.addEventListener('resize', _updateOrganelleLayerTransform);

    loadOrganellesLayout().then(layout => {
        window._organelleLayout = layout;
        _applyOrganelleOpacity(layout.opacity || 0.27);

        const slider = document.getElementById('organelle-opacity');
        if (slider) slider.value = String(layout.opacity || 0.27);

        layer.innerHTML = '';
        const domMap = {};
        for (const key of Object.keys(ORGANELLE_ASSETS)){
            const dom = _buildOrganelleDOM(layer, key);
            domMap[key] = dom;
            _renderOneOrganelle(dom.wrapper, layout.organelles[key]);
        }
        window._organelleDomMap = domMap;

        _updateOrganelleLayerTransform();
        _bindOrganelleInteractions(domMap);
    });
}

function toggleOrganelleEditMode(){
    const checkbox = document.getElementById('organelle-edit-toggle');
    window.isOrganelleEditMode = !!(checkbox && checkbox.checked);

    const slider = document.getElementById('organelle-opacity');
    const resetBtn = document.getElementById('organelle-reset-btn');
    const hint = document.getElementById('organelle-hint');
    if (slider) slider.style.display = window.isOrganelleEditMode ? 'inline-block' : 'none';
    if (resetBtn) resetBtn.style.display = window.isOrganelleEditMode ? 'inline-flex' : 'none';
    if (hint) hint.style.display = window.isOrganelleEditMode ? 'block' : 'none';

    document.body.classList.toggle('organelle-edit-on', window.isOrganelleEditMode);

    const cy = _getCy();
    if (cy){
        try{
            cy.userPanningEnabled(!window.isOrganelleEditMode);
            cy.boxSelectionEnabled(!window.isOrganelleEditMode);
        }catch(e){}
    }
}

async function resetOrganellesLayout(){
    window._organelleLayout = _defaultOrganelleLayout();
    saveOrganellesLayoutDebounced(window._organelleLayout);
    const domMap = window._organelleDomMap || {};
    for (const key of Object.keys(ORGANELLE_ASSETS)){
        const st = window._organelleLayout.organelles[key];
        if (domMap[key]) _renderOneOrganelle(domMap[key].wrapper, st);
    }
    _applyOrganelleOpacity(window._organelleLayout.opacity || 0.27);
    const slider = document.getElementById('organelle-opacity');
    if (slider) slider.value = String(window._organelleLayout.opacity || 0.27);
}

function _bindOrganelleInteractions(domMap){
    const cy = _getCy();
    const layer = _ensureOrganelleLayer();
    if (!cy || !layer) return;

    const state = { mode: null, key: null, start: null };

    const getLocal = (evt) => {
        const rect = _getGraphAreaRect();
        if (!rect) return { x: 0, y: 0 };
        return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    };

    const stopAll = () => {
        state.mode = null; state.key = null; state.start = null;
        window.removeEventListener('pointermove', onMove, true);
        window.removeEventListener('pointerup', onUp, true);
    };

    const onUp = () => { stopAll(); };

    const onMove = (evt) => {
        if (!window.isOrganelleEditMode) return;
        if (!state.mode || !state.key) return;
        const layout = window._organelleLayout;
        if (!layout) return;

        const zoom = cy.zoom();
        const pan = cy.pan();
        const cur = getLocal(evt);
        const dxModel = (cur.x - state.start.px) / zoom;
        const dyModel = (cur.y - state.start.py) / zoom;

        const st = layout.organelles[state.key];

        if (state.mode === 'drag'){
            st.x = state.start.x + dxModel;
            st.y = state.start.y + dyModel;
        } else if (state.mode === 'resize'){
            st.w = Math.max(20, state.start.w + dxModel);
            st.h = Math.max(20, state.start.h + dyModel);
        } else if (state.mode === 'rotate'){
            const cxModel = st.x + st.w / 2;
            const cyModel = st.y + st.h / 2;
            const cx = cxModel * zoom + pan.x;
            const cyy = cyModel * zoom + pan.y;
            const ang = Math.atan2(cur.y - cyy, cur.x - cx) * 180 / Math.PI;
            st.rot = state.start.rot + (ang - state.start.ang0);
        }

        _renderOneOrganelle(domMap[state.key].wrapper, st);
        layout.opacity = Number(layout.opacity || 0.27);
        saveOrganellesLayoutDebounced(layout);
    };

    for (const key of Object.keys(domMap)){
        const { wrapper, rotateHandle, resizeHandle } = domMap[key];

        wrapper.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            if (evt.target === rotateHandle || evt.target === resizeHandle) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;
            const p = getLocal(evt);
            state.mode = 'drag';
            state.key = key;
            state.start = { px: p.x, py: p.y, x: layout.organelles[key].x, y: layout.organelles[key].y };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });

        resizeHandle.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;
            const p = getLocal(evt);
            state.mode = 'resize';
            state.key = key;
            state.start = { px: p.x, py: p.y, w: layout.organelles[key].w, h: layout.organelles[key].h };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });

        rotateHandle.addEventListener('pointerdown', (evt) => {
            if (!window.isOrganelleEditMode) return;
            evt.preventDefault(); evt.stopPropagation();
            const layout = window._organelleLayout;
            if (!layout) return;

            const p = getLocal(evt);
            const st = layout.organelles[key];
            const zoom = cy.zoom();
            const pan = cy.pan();
            const cxModel = st.x + st.w / 2;
            const cyModel = st.y + st.h / 2;
            const cx = cxModel * zoom + pan.x;
            const cyy = cyModel * zoom + pan.y;
            const ang0 = Math.atan2(p.y - cyy, p.x - cx) * 180 / Math.PI;

            state.mode = 'rotate';
            state.key = key;
            state.start = { px: p.x, py: p.y, rot: st.rot || 0, ang0 };
            window.addEventListener('pointermove', onMove, true);
            window.addEventListener('pointerup', onUp, true);
        }, { passive: false });
    }

    const slider = document.getElementById('organelle-opacity');
    if (slider){
        slider.addEventListener('input', (evt) => {
            const v = Number(evt.target.value);
            const layout = window._organelleLayout || _defaultOrganelleLayout();
            layout.opacity = v;
            window._organelleLayout = layout;
            _applyOrganelleOpacity(v);
            try {
                localStorage.setItem(ORGANELLE_STORAGE_KEY, JSON.stringify(layout));
            } catch(e) {}
        });
    }
}

/* ==========================================================================
   ã€ä¿®å¤è¡¥ä¸ã€‘å³ä¾§è¾¹æ çŠ¶æ€ç®¡ç†ä¸æ¸²æŸ“é€»è¾‘ (è¦†ç›–æ—§é€»è¾‘)
   ========================================================================== */

// 1. åˆå§‹åŒ–æˆ–é‡ç½®å…¨å±€çŠ¶æ€
if (!window.rightSidebarState) {
    window.rightSidebarState = {
        searchData: null,
        pathData: null,
        nodeHtml: null,
        isExpanded: false
    };
}

// 2. æ ¸å¿ƒçŠ¶æ€æ›´æ–°å‡½æ•° (ä¿®å¤å±•å¼€é€»è¾‘)
window.updateRightSidebar = function() {
    const state = window.rightSidebarState;
    const sidebar = document.getElementById('right-sidebar');
    const expandBtn = document.getElementById('right-sidebar-expand-btn');

    // è·å–ä¸‰ä¸ªåŒºå—çš„å®¹å™¨
    const secSearch = document.getElementById('section-search-results');
    const secPath = document.getElementById('section-path-results');
    const secNode = document.getElementById('section-node-details');
    // è·å–è¯¦æƒ…å†…å®¹å®¹å™¨
    const divNode = document.getElementById('node-detail-content');

    let hasVisibleContent = false;

    // --- A. æœç´¢ç»“æœåŒºå— ---
    // åªæœ‰å½“ searchData å­˜åœ¨ä¸”é•¿åº¦ > 0 æ—¶æ‰æ˜¾ç¤º
    if (state.searchData && state.searchData.length > 0) {
        if(secSearch) secSearch.style.display = 'block';
        hasVisibleContent = true;
    } else {
        if(secSearch) secSearch.style.display = 'none';
    }

    // --- B. è·¯å¾„ç»“æœåŒºå— ---
    if (state.pathData && state.pathData.length > 0) {
        if(secPath) secPath.style.display = 'block';
        hasVisibleContent = true;
    } else {
        if(secPath) secPath.style.display = 'none';
    }

    // --- C. èŠ‚ç‚¹è¯¦æƒ…åŒºå— ---
    if (state.nodeHtml) {
        if(secNode) secNode.style.display = 'block';
        if(divNode) {
            // åªæœ‰å½“å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶æ‰é‡æ–°è®¾ç½® innerHTMLï¼Œé˜²æ­¢æ­£åœ¨è¾“å…¥çš„è¾“å…¥æ¡†å¤±ç„¦
            if (divNode.innerHTML !== state.nodeHtml) {
                divNode.innerHTML = state.nodeHtml;
            }
            
            // ã€å…³é”®ä¿®å¤ã€‘ï¼šæ£€æŸ¥ Canvas æ˜¯å¦å­˜åœ¨ä¸”éœ€è¦ç»˜åˆ¶
            // å¢åŠ ä¸€ä¸ªå»¶æ—¶ï¼Œç¡®ä¿ä¾§è¾¹æ å±•å¼€åŠ¨ç”»ï¼ˆ0.3sï¼‰å®Œæˆåï¼ŒCanvas å¤„äºå¯è§çŠ¶æ€å†ç»˜åˆ¶
            if (state.isExpanded) {
                setTimeout(() => {
                    const canvas = document.getElementById('smiles-canvas');
                    if (canvas && window._currentSmilesForCanvas) {
                        renderSmilesToCanvas(canvas, window._currentSmilesForCanvas);
                    }
                }, 350); // ç•¥é•¿äº CSS çš„ 0.3s åŠ¨ç”»
            }
        }
        hasVisibleContent = true;
    } else {
        if(secNode) secNode.style.display = 'none';
    }

    // --- D. ä¾§è¾¹æ æ•´ä½“å±•å¼€/æ”¶èµ·æ§åˆ¶ ---
    if (!hasVisibleContent) {
        // å…¨ç©º -> å¼ºåˆ¶æ”¶èµ·
        sidebar.classList.remove('expanded');
        state.isExpanded = false;
        if(expandBtn) expandBtn.style.display = 'none';
    } else {
        // æœ‰å†…å®¹ -> æ ¹æ®çŠ¶æ€å†³å®šæ˜¯å¦å±•å¼€
        // å…³é”®ä¿®å¤ï¼šå¦‚æœæ˜¯æœç´¢æˆ–ç‚¹å‡»è§¦å‘çš„æ›´æ–°ï¼Œé€šå¸¸è‡ªåŠ¨å±•å¼€
        if (state.isExpanded) {
            sidebar.classList.add('expanded');
            if(expandBtn) expandBtn.style.display = 'none';
        } else {
            sidebar.classList.remove('expanded');
            if(expandBtn) expandBtn.style.display = 'flex';
        }
    }
    
    // é€šçŸ¥ Cytoscape ç”»å¸ƒè°ƒæ•´å¤§å° (é˜²æ­¢ç”»å¸ƒè¢«é®æŒ¡)
    const cy = window.cyGraph || window.cy;
    if(cy) {
        setTimeout(() => cy.resize(), 300);
    }
};
// å…¨å±€è®°å½•å½“å‰çš„ SMILESï¼Œç”¨äºä¾§è¾¹æ åˆ‡æ¢æ—¶é‡ç»˜
window._currentSmilesForCanvas = null;

function renderSmilesToCanvas(canvas, smiles) {
    if (!canvas || !smiles || !window.rdkitModule) return;
    try {
        const mol = window.rdkitModule.get_mol(smiles);
        if (mol) {
            // æ¸…é™¤æ—§ç”»å¸ƒ
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç»˜åˆ¶æ–°ç»“æ„
            mol.draw_to_canvas(canvas, -1, -1);
            mol.delete();
        }
    } catch (e) {
        console.warn('RDKit draw error:', e);
    }
}
// 3. è¦†ç›–æœç´¢æ‰§è¡Œå‡½æ•° performSearch
// ä½œç”¨ï¼šè®¡ç®—æœç´¢ç»“æœ -> æ›´æ–° state.searchData -> è°ƒç”¨ updateRightSidebar
window.performSearch = function(term) {
    const cy = window.cyGraph || window.cy;
    if (!cy) return;

    const statusSpan = document.getElementById('search-status');
    const val = term ? String(term).trim() : '';

    // æƒ…å†µ 1: è¾“å…¥ä¸ºç©º -> æ¸…é™¤æœç´¢çŠ¶æ€
    if (!val) {
        cy.batch(() => cy.elements().removeClass('dimmed highlighted'));
        if (typeof filterGraph === 'function') filterGraph(); // æ¢å¤ç­›é€‰
        if (statusSpan) statusSpan.innerText = "";
        
        window.rightSidebarState.searchData = null;
        window.updateRightSidebar();
        return;
    }

    // æƒ…å†µ 2: æ‰§è¡Œæœç´¢
    const matches = [];
    cy.nodes().forEach(node => {
        const label = node.data('label');
        if (label) {
            // æ³¨æ„ï¼šç¡®ä¿ calcSimilarity å‡½æ•°å·²å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œè¯·ä½¿ç”¨ç®€å•çš„ includes
            const score = (typeof calcSimilarity === 'function') 
                ? calcSimilarity(val, label) 
                : (label.toLowerCase().includes(val.toLowerCase()) ? 1 : 0);
                
            if (score > 0) matches.push({ node, score });
        }
    });

    if (matches.length === 0) {
        if (statusSpan) statusSpan.innerText = "No Result Found";
        // è™½ç„¶æ²¡ç»“æœï¼Œä¹Ÿè¦æ›´æ–°ä¾§è¾¹æ ï¼ˆæ¸…é™¤æ—§ç»“æœï¼‰
        window.rightSidebarState.searchData = null;
        window.updateRightSidebar();
        return;
    }

    // æ’åº
    matches.sort((a, b) => b.score - a.score);
    const orderedNodes = matches.map(m => m.node);
    const scores = matches.map(m => m.score);

    // é«˜äº®å›¾è¡¨
    cy.batch(() => {
        cy.elements().removeClass('highlighted').addClass('dimmed');
        const matchCollection = cy.collection(orderedNodes);
        matchCollection.removeClass('dimmed').addClass('highlighted');
        matchCollection.neighborhood().removeClass('dimmed').addClass('highlighted');
    });

    if (statusSpan) statusSpan.innerText = `${orderedNodes.length} Result(s) Found`;

    // æ¸²æŸ“ç»“æœåˆ—è¡¨
    window.renderSearchResults(orderedNodes, scores);
};

// [è¿˜åŸ] è¦†ç›–æœç´¢ç»“æœæ¸²æŸ“å‡½æ•° (æ¢å¤åŸå§‹æ ·å¼ç»“æ„)
window.renderSearchResults = function(nodes, scores) {
    const listContainer = document.getElementById('list-search-results');
    const countSpan = document.getElementById('result-count');
    
    // 1. æ›´æ–°æ•°æ®çŠ¶æ€
    window.rightSidebarState.searchData = nodes;
    // 2. å¼ºåˆ¶å±•å¼€ä¾§è¾¹æ 
    window.rightSidebarState.isExpanded = true; 

    // 3. ç”Ÿæˆ HTML
    if(listContainer) {
        listContainer.innerHTML = '';
        if(countSpan) countSpan.innerText = nodes.length;

        nodes.forEach((node, idxScore) => {
            const data = node.data();
            const score = Array.isArray(scores) ? scores[idxScore] : undefined;
            const item = document.createElement('div');
            item.className = 'result-item';

            // === è¿˜åŸï¼šé¢œè‰²å’Œå…¨ç§°æ–‡æœ¬ ===
            let typeColor = '#95a5a6';
            let typeText = 'Unknown';
            if(node.hasClass('reaction')) { 
                typeColor = '#55efc4'; // äº®ç»¿
                typeText = 'Enzyme/Reaction'; 
            } else if(node.hasClass('main-molecule')) { 
                typeColor = '#2ecc71'; // æ·±ç»¿
                typeText = 'Main Substrate'; 
            } else { 
                typeColor = '#74b9ff'; // è“è‰²
                typeText = 'Side Substrate'; 
            }

            // === è¿˜åŸï¼šè·å– pathway æ–‡æœ¬ ===
            const pathwayText = data.pathway || 'Regulator';

            // === è¿˜åŸï¼šç›¸ä¼¼åº¦æ˜¾ç¤º ===
            const scoreHtml = (typeof score === 'number')
                ? `<div class="result-score">Similarity ${(score*100).toFixed(0)}%</div>`
                : '';

            // === è¿˜åŸï¼šåŸå§‹ DOM ç»“æ„ (Name + Tag åœ¨ç¬¬ä¸€è¡Œ, Pathway åœ¨ç¬¬äºŒè¡Œ) ===
            item.innerHTML = `
                <div class="result-name">
                    ${data.label || data.id}
                    <span class="result-type-tag" style="background:${typeColor}">${typeText}</span>
                </div>
                <div class="result-pathway">ğŸ“‚ ${pathwayText}</div>
                ${scoreHtml}
            `;

           // æ‰¾åˆ° renderSearchResults å†…éƒ¨çš„ item.addEventListener('click', ...)
item.addEventListener('click', (e) => {
    // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
    e.preventDefault();
    e.stopPropagation();

    const cy = window.cyGraph || window.cy;
    let target = node;
    if(data.parentRxn) {
        const p = cy.$id(data.parentRxn);
        if(p.length) target = p;
    }

    // A. ä»…è´Ÿè´£ UI å±•å¼€
    window.rightSidebarState.isExpanded = true;
    updateRightSidebar();

    // B. æ‰§è¡Œå”¯ä¸€çš„è§†è§’ç§»åŠ¨ï¼ˆç”±é”æ§åˆ¶ï¼‰
    window.focusNodeFinal(target);

    // C. é™é»˜è§¦å‘ Tap äº‹ä»¶ï¼ˆåªæ›´æ–°è¯¦æƒ…å†…å®¹ï¼Œä¸ç§»åŠ¨é•œå¤´ï¼‰
    // æˆ‘ä»¬åœ¨ä¸‹ä¸€æ®µä»£ç ä¸­é€šè¿‡æ ‡è¯†ç¬¦åŒºåˆ†
    target.emit('tap', { fromSearch: true });
});
            listContainer.appendChild(item);
        });
    }

    // 4. è°ƒç”¨æ›´æ–°
    window.updateRightSidebar();
};

// 5. è¦†ç›–è·¯å¾„ç»“æœæ¸²æŸ“å‡½æ•° renderPathResults
window.renderPathResults = function(pathsInfo) {
    const listContainer = document.getElementById('list-path-results');
    
    // æ›´æ–°æ•°æ®çŠ¶æ€
    window.rightSidebarState.pathData = pathsInfo;
    
    // å¦‚æœæœ‰è·¯å¾„ï¼Œå¼ºåˆ¶å±•å¼€
    if (pathsInfo && pathsInfo.length > 0) {
        window.rightSidebarState.isExpanded = true;
    }

    if(listContainer) {
        listContainer.innerHTML = '';
        if (pathsInfo && pathsInfo.length > 0) {
            pathsInfo.forEach((info, idx) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                // ç”Ÿæˆè·¯å¾„é¢„è§ˆæ–‡å­—
                const labels = info.nodes.map(n => n.data('label') || n.data('id')).slice(0, 5).join(' â†’ ');
                
                item.innerHTML = `
                    <div style="font-weight:bold; font-size:13px; color:#e67e22;">Path ${idx+1} (${info.reactionSteps} steps)</div>
                    <div style="font-size:11px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px;">
                        ${labels}...
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if(typeof applyPathHighlight === 'function') applyPathHighlight(info.nodes);
                });
                
                listContainer.appendChild(item);
            });
        }
    }
    
    window.updateRightSidebar();
};

// 6. é‡æ–°ç»‘å®šè·¯å¾„æœç´¢æŒ‰é’®çš„äº‹ä»¶ (è¦†ç›–åŸæœ‰çš„ initSearchListener ç»‘å®š)
// é˜²æ­¢åŸæœ‰çš„äº‹ä»¶ç›‘å¬å™¨ä½¿ç”¨çš„æ˜¯æ—§é€»è¾‘
(function rebindPathSearch() {
    const pathBtn = document.getElementById('path-find-btn');
    const startInput = document.getElementById('path-start-input');
    const endInput = document.getElementById('path-end-input');
    
    if (pathBtn) {
        // å…‹éš†èŠ‚ç‚¹ä»¥å»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ (æœ€å½»åº•çš„æ¸…é™¤æ–¹å¼)
        const newBtn = pathBtn.cloneNode(true);
        pathBtn.parentNode.replaceChild(newBtn, pathBtn);
        
        newBtn.addEventListener('click', () => {
            const s = startInput.value.trim();
            const e = endInput.value.trim();
            if(!s || !e) {
                alert("Please enter start/end molecules");
                return;
            }
            if(typeof findPathBetweenMetabolites === 'function') {
                findPathBetweenMetabolites(s, e);
                // findPathBetweenMetabolites å†…éƒ¨åº”è¯¥è°ƒç”¨ renderPathResults
                // æˆ‘ä»¬å·²ç»åœ¨ä¸Šæ–¹è¦†ç›–äº† renderPathResultsï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å®‰å…¨çš„
            }
        });
    }
})();

// 7. ç¡®ä¿ä¾§è¾¹æ åˆå§‹çŠ¶æ€æ­£ç¡® (éšè—)
window.updateRightSidebar();
/* ============================================================
   [æœ€ç»ˆä¿®å¤ç‰ˆ] è·¯å¾„æœç´¢æ ¸å¿ƒé€»è¾‘
   è§£å†³ï¼šè§†è§’ç§»åŠ¨ä¸‰æ¬¡ã€æ ·å¼ä¸æ˜æ˜¾ã€ä¾§è¾¹æ å®½åº¦é—®é¢˜
   ============================================================ */
// åœ¨ script æ ‡ç­¾å†…çš„ä»»æ„ä½ç½®æ·»åŠ 
function showPathError(msg) {
    const errorEl = document.getElementById('error-msg');
    if (!errorEl) return;

    errorEl.innerText = msg;
    errorEl.style.display = 'block'; // æ˜¾ç¤ºå¼¹çª—
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        errorEl.style.display = 'none';
    }, 3500);
}
// 1. è¦†ç›–è·¯å¾„æœç´¢å‡½æ•°
window.findPathBetweenMetabolites = function(startName, endName) {
    const cy = window.cyGraph;
    if (!cy) return;

    // --- A. å¼ºåˆ¶é‡ç½®çŠ¶æ€ï¼Œé˜²æ­¢å¤šæ¬¡è·³è½¬ ---
    // æ¸…é™¤ä¸Šä¸€æ¬¡æœªæ‰§è¡Œçš„è·³è½¬å®šæ—¶å™¨
    if (window._pathZoomTimer) {
        clearTimeout(window._pathZoomTimer);
        window._pathZoomTimer = null;
    }
    
    // ç«‹å³åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„æ‰€æœ‰åŠ¨ç”» (å…³é”®)
    cy.stop();
    // æ¸…é™¤æ—§çš„é«˜äº®
    if(typeof clearPathHighlight === 'function') clearPathHighlight();
    else cy.elements().removeClass('path-node path-edge dimmed highlighted');


    // --- B. å‡†å¤‡ UI ---
    const status = document.getElementById('path-status');
    const pathEndInput = document.getElementById('path-end-input');

    // ---------------------------------------------------------
    // C. ç®—æ³•éƒ¨åˆ† (å¯»æ‰¾ Top 5 è·¯å¾„)
    // ---------------------------------------------------------
    
    // (MinHeap ç±»å®šä¹‰)
    class MinHeap {
        constructor() { this.a = []; }
        push(x) { this.a.push(x); this._up(this.a.length - 1); }
        pop() {
            if (!this.a.length) return null;
            const top = this.a[0];
            const last = this.a.pop();
            if (this.a.length) { this.a[0] = last; this._down(0); }
            return top;
        }
        _up(i) {
            while (i > 0) {
                const p = (i - 1) >> 1;
                if (this.a[p].d <= this.a[i].d) break;
                [this.a[p], this.a[i]] = [this.a[i], this.a[p]];
                i = p;
            }
        }
        _down(i) {
            const n = this.a.length;
            while (true) {
                let l = i * 2 + 1, r = l + 1, m = i;
                if (l < n && this.a[l].d < this.a[m].d) m = l;
                if (r < n && this.a[r].d < this.a[m].d) m = r;
                if (m === i) break;
                [this.a[m], this.a[i]] = [this.a[i], this.a[m]];
                i = m;
            }
        }
        get size() { return this.a.length; }
    }

    // (å¯»æ‰¾èŠ‚ç‚¹)
    const getCandidates = (term, topN = 6, minScore = 0.62) => {
        const lower = String(term || '').toLowerCase().trim();
        if (!lower) return [];
        const exactMatches = [];
        cy.nodes('[type="molecule"]').forEach(n => {
            if (String(n.data('label')).toLowerCase().trim() === lower) exactMatches.push(n);
        });
        if (exactMatches.length > 0) return exactMatches;
        const scored = [];
        cy.nodes('[type="molecule"]').forEach(n => {
            const label = n.data('label');
            if(!label) return;
            const s = (typeof calcSimilarity === 'function') ? calcSimilarity(lower, label) : 0;
            if(s>0) scored.push({n,s});
        });
        scored.sort((a,b)=>b.s-a.s);
        return scored.slice(0, topN).map(x=>x.n);
    };

    const startNodes = getCandidates(startName);
    const endNodes = getCandidates(endName);
    if (!startNodes.length || !endNodes.length) {
        if (status) status.innerText = 'No valid start/end nodes found.';
        window.renderPathResults([]); // æ¸…ç©º
        return;
    }
    const endSet = new Set(endNodes.map(n => n.id()));

    // (è¾…åŠ©å‡½æ•°)
    const isVisible = (ele) => {
        try { 
            if(ele.hasClass('hidden-side')||ele.hasClass('hidden-transport')||ele.hasClass('dimmed')) return ele.visible();
            return true;
        } catch(_){return true;}
    }

    const runSearch = (includeSide, penaltyMap) => {
        const dist = new Map(), prev = new Map(), heap = new MinHeap();
        startNodes.forEach(s => {
            if(!isVisible(s)) return;
            dist.set(s.id(), 0); heap.push({id:s.id(), d:0});
        });

        let bestEnd = null, bestDist = Infinity;
        while(heap.size) {
            const cur = heap.pop();
            if(!cur) break;
            if(cur.d > dist.get(cur.id)) continue;
            if(cur.d > bestDist + 2) break; // å‰ªæ
            if(endSet.has(cur.id)) {
                if(cur.d < bestDist) { bestEnd = cur.id; bestDist = cur.d; }
            }

            const cNode = cy.$id(cur.id);
            if(!cNode.length) continue;

            // é‚»å±…ï¼šè¿è¾“
            cNode.connectedEdges('edge[edgeType="transport"]').forEach(e => {
                if(!isVisible(e)) return;
                const other = e.source().id()===cNode.id()?e.target():e.source();
                if(!isVisible(other)) return;
                const cost = 0 + (penaltyMap.get(e.id())||0);
                pushNext(other.id(), cur.d+cost, 'transport', null, [e]);
            });
            // é‚»å±…ï¼šååº”
            const inSel = includeSide ? 'edge[type="in"]' : 'edge[type="in"][edgeType="main"]';
            const outSel = includeSide ? 'edge[type="out"]' : 'edge[type="out"][edgeType="main"]';
            cNode.outgoers(inSel).filter(e=>isVisible(e)).forEach(e1=>{
                const rxn = e1.target();
                if(!rxn || rxn.data('type')!=='reaction' || !isVisible(rxn)) return;
                rxn.outgoers(outSel).filter(e=>isVisible(e)).forEach(e2=>{
                    const prod = e2.target();
                    if(!prod || !isVisible(prod)) return;
                    const cost = 1 + (penaltyMap.get(e1.id())||0) + (penaltyMap.get(e2.id())||0);
                    pushNext(prod.id(), cur.d+cost, 'rxn', rxn.id(), [e1,e2]);
                });
            });

            function pushNext(nid, nd, via, rid, edges) {
                const old = dist.get(nid);
                if(old===undefined || nd < old) {
                    dist.set(nid, nd);
                    prev.set(nid, { prevMolId: cur.id, via, rxnId: rid, usedEdges: edges });
                    heap.push({id:nid, d:nd});
                }
            }
        }

        if(!bestEnd || bestDist===Infinity) return null;
        // å›æº¯
        const nodes = [], pathEdges = [];
        let curr = bestEnd, steps = 0;
        nodes.push(cy.$id(curr));
        while(!startNodes.some(s=>s.id()===curr)) {
            const p = prev.get(curr);
            if(!p) break;
            if(p.usedEdges) p.usedEdges.forEach(e=>pathEdges.push(e));
            if(p.via==='rxn' && p.rxnId) { nodes.push(cy.$id(p.rxnId)); steps++; }
            nodes.push(cy.$id(p.prevMolId));
            curr = p.prevMolId;
        }
        nodes.reverse();
        return { nodes, reactionSteps: steps, usedEdges: pathEdges, signature: nodes.map(n=>n.id()).join('->') };
    };

    // (å¾ªç¯è®¡ç®— Top 5)
    const foundPaths = [];
    const penaltyMap = new Map();
    const sigs = new Set();
    let tryStrict = true;

    for(let i=0; i<10; i++) {
        let side = false;
        if(i>=2 || !tryStrict) side = true;
        let res = runSearch(side, penaltyMap);
        if(!res && !side && i===0) { tryStrict = false; i--; continue; }
        if(!res) break;

        if(!sigs.has(res.signature)) {
            foundPaths.push(res);
            sigs.add(res.signature);
        }
        if(foundPaths.length >=5) break;

        res.usedEdges.forEach(e => penaltyMap.set(e.id(), (penaltyMap.get(e.id())||0)+2.5));
    }

    if(foundPaths.length === 0) {
        if(status) status.innerText = 'No path found.';
        window.renderPathResults([]);
        return;
    }

    foundPaths.sort((a,b) => a.reactionSteps - b.reactionSteps); // æ’åº

    // ---------------------------------------------------------
    // D. æ¸²æŸ“ç»“æœ å¹¶ æ‰§è¡Œä¸€æ¬¡æ€§è·³è½¬
    // ---------------------------------------------------------

    // 1. å…ˆæŠŠåˆ—è¡¨å±•ç¤ºå‡ºæ¥ (ä¼šè§¦å‘ä¾§è¾¹æ å˜å®½åŠ¨ç”»)
    window.renderPathResults(foundPaths);
    
    // 2. æ›´æ–°æ–‡å­—æç¤º
    if(status) status.innerText = `${foundPaths.length} path(s). Shortest: ${foundPaths[0].reactionSteps} steps.`;
    if(pathEndInput) pathEndInput.focus();

    // 3. ã€é˜²é‡å¤æœºåˆ¶ã€‘ä½¿ç”¨å”¯ä¸€è®¡æ—¶å™¨å»¶è¿Ÿæ‰§è¡Œ
    // å»¶è¿Ÿ 400ms æ˜¯ä¸ºäº†ç­‰å¾…ä¾§è¾¹æ å®Œå…¨å±•å¼€ (CSS æ˜¯ 0.3s)
    // è¿™æ ·é¿å…ç”»å¸ƒä¸€è¾¹å˜åŠ¨å¤§å°ï¼Œä¸€è¾¹ç¼©æ”¾ï¼Œå¯¼è‡´è·³åŠ¨
    window._pathZoomTimer = setTimeout(() => {
        const shortestPath = foundPaths[0];
        if (shortestPath && shortestPath.nodes) {
            
            // æ‰‹åŠ¨æ‰§è¡Œé«˜äº®é€»è¾‘ï¼Œç¡®ä¿æ¸…æ´
            clearPathHighlight();
            const eles = cy.collection(shortestPath.nodes);
            
            // é«˜äº®æ ·å¼
            eles.addClass('path-node');
            
            // è¿çº¿é«˜äº®
            const edgeCol = cy.collection(shortestPath.usedEdges || []);
            edgeCol.addClass('path-edge');
            
            // å”¯ä¸€çš„ä¸€æ¬¡é•œå¤´ç§»åŠ¨
            cy.animate({
                fit: {
                    eles: eles.union(edgeCol),
                    padding: 80
                },
                duration: 600,
                easing: 'ease-out-cubic'
            });
        }
        window._pathZoomTimer = null;
    }, 450);
};

// 2. è¦†ç›–è¯¦æƒ…é¡µäº¤äº’é€»è¾‘ (è§£å†³åå­—ä¸æ˜æ˜¾é—®é¢˜)
window.bindSideInteractionsOnce = function() {
    const cy = window.cyGraph;
    if (!cy || cy.__sideBound) return;
    cy.__sideBound = true;

    const createBlock = (label, content, options = {}) => {
        if (!content || content === '0' || content === 'undefined') return '';
        // å…³é”®ä¿®æ”¹ï¼šå¦‚æœæ˜¯æ ‡é¢˜ï¼Œä½¿ç”¨å¤§å·æ ·å¼ .detail-header-title
        if (options.isTitle) {
            return `<div class="detail-group"><div class="detail-header-title">${String(content)}</div></div>`;
        }
        const valClass = options.isFormula ? 'formula-box' : 'detail-value';
        return `<div class="detail-group"><div class="detail-label">${label}</div><div class="${valClass}">${String(content).replace(/\n/g, '<br/>')}</div></div>`;
    };

    cy.on('tap', 'node', (evt) => {
        const node = evt.target;
        const data = node.data();
        if (data.nodeType === 'activator' || data.nodeType === 'inhibitor') return;
        if (typeof closeRegulationOverlay === 'function') closeRegulationOverlay(); 

        let html = '';
        window._pendingSmilesCallback = null;

        if (data.type === 'reaction') {
            // [Title] é…¶åç§°
            html += createBlock('Enzyme Name', data.infoEnzyme || data.label, { isTitle: true });
            html += createBlock('Formula', data.infoFormula, { isFormula: true });
            // === æ”¹è¿›åçš„ Pathway æ˜¾ç¤º ===
            if (data.pathway) {
                const pwList = String(data.pathway).split(',').map(p => p.trim());
                const tagsHtml = pwList.map(pw => `<span class="pathway-pill">${formatText(pw)}</span>`).join('');
                html += `<div class="detail-group">
                            <div class="detail-label">Pathway</div>
                            <div class="pathway-tag-container">${tagsHtml}</div>
                        </div>`;
            }
            html += createBlock('Description', data.infoDesc);
            
            if (data.rawEnzyme && window.refData && window.refData.enzymes.has(data.rawEnzyme)) {
                const info = window.refData.enzymes.get(data.rawEnzyme);
                const linkHtml = info.link ? `<a href="${info.link}" target="_blank" class="detail-link">ğŸ”— Link</a>` : '';
                html += `<div class="detail-group"><div class="detail-label">EC Code</div><div class="detail-value">${info.ec || 'N/A'} ${linkHtml}</div></div>`;
            }
            // è”åŠ¨
            if (!window.selectedReactionIds) window.selectedReactionIds = new Set();
            window.selectedReactionIds.add(node.id());
            if(typeof refreshSideVisibility==='function') refreshSideVisibility();
            if(typeof alignSideNodes==='function') setTimeout(alignSideNodes, 50);

        } else if (data.type === 'molecule') {
            // [Title] ç‰©è´¨åç§°
            html += createBlock('Molecule Name', data.label, { isTitle: true });
            const meta = window.mainMoleculeMeta.get(data.baseName || data.label);
            let pwList = [];
            if (meta && meta.pathwaySheets) {
                pwList = Array.from(meta.pathwaySheets.keys());
            } else if (data.pathway) {
                pwList = String(data.pathway).split(',').map(p => p.trim());
            }

            if (pwList.length > 0) {
                const tagsHtml = pwList.map(pw => `<span class="pathway-pill">${formatText(pw)}</span>`).join('');
                html += `<div class="detail-group">
                            <div class="detail-label">Involved Pathways</div>
                            <div class="pathway-tag-container">${tagsHtml}</div>
                        </div>`;
            }
            // æ•°æ®åº“é“¾æ¥æŒ‰é’®
            const rawName = (data.baseName || data.label || '').trim();
            let link = data.link;
            let smiles = null;
            if (window.refData && window.refData.molecules.has(rawName)) {
                const d = window.refData.molecules.get(rawName);
                if(d.link && d.link!=='0') link = d.link;
                if(d.smiles && d.smiles!=='0') smiles = d.smiles;
            }
            if(link) {
                 html += `<div class="detail-group"><div class="detail-value"><a href="${link}" target="_blank" style="display:block;text-align:center;background:#0984e3;color:#fff;padding:12px;border-radius:6px;text-decoration:none;font-weight:bold;font-size:14px;">ğŸŒ View External Database</a></div></div>`;
            }
            // SMILES å¤„ç†
            if(smiles) {
                window._currentSmilesForCanvas = smiles; // ã€å…³é”®ã€‘ä¿å­˜åˆ°å…¨å±€å˜é‡
                html += `<div class="detail-group"><div class="detail-label">Structure</div><div style="background:#fff;border:1px solid #eee;padding:10px;display:flex;justify-content:center;"><canvas id="smiles-canvas" width="280" height="180"></canvas></div></div>`;
                
                // è®¾ç½®åˆå§‹ç»˜åˆ¶å›è°ƒ
                window._pendingSmilesCallback = () => {
                    const cvs = document.getElementById('smiles-canvas');
                    renderSmilesToCanvas(cvs, smiles);
                };
            } else {
                window._currentSmilesForCanvas = null; // æ¸…ç©º
            }
        }
        window.rightSidebarState.nodeHtml = html;
        window.rightSidebarState.isExpanded = true;
        updateRightSidebar();
        // å…³é”®ï¼šå¦‚æœä¸æ˜¯ç”±æœç´¢ç»“æœè‡ªåŠ¨è§¦å‘çš„ï¼ˆå³ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»èŠ‚ç‚¹ï¼‰ï¼Œåˆ™æ‰§è¡Œç§»åŠ¨
    // å¦‚æœæ˜¯é€šè¿‡ emit('tap') è§¦å‘çš„ï¼Œå·²ç»åœ¨ç¬¬äºŒæ­¥ç§»åŠ¨è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸åŠ¨äº†
    if (!extraData || !extraData.isAutoTrigger) {
        window.focusNodeStandard(node);
    }
    });

    // ç‚¹å‡»èƒŒæ™¯æ¸…ç©º
    // åœ¨ bindSideInteractionsOnce æˆ–åˆå§‹åŒ–é€»è¾‘ä¸­
cy.on('tap', (evt) => {
    if (evt.target === cy) {
        // 1. å…³é—­è°ƒèŠ‚å› å­è¦†ç›–å±‚å’Œè¯¦æƒ…é¢æ¿çŠ¶æ€
        if (typeof closeRegulationOverlay === 'function') closeRegulationOverlay();
        window.rightSidebarState.nodeHtml = null;
        updateRightSidebar();

        // 2. æ¸…é™¤é€‰ä¸­çš„ååº” IDï¼ˆå‰¯å°åˆ†å­é«˜äº®ï¼‰
        if (window.selectedReactionIds) window.selectedReactionIds.clear();

        // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†ç®€å• removeClassï¼Œè€Œæ˜¯é‡æ–°æ‰§è¡Œç­›é€‰é€»è¾‘
        // è¿™æ ·ä¼šæ¸…é™¤æœç´¢äº§ç”Ÿçš„ä¸´æ—¶é«˜äº®ï¼Œä½†ä¿ç•™å·¦ä¾§è¾¹æ å†³å®šçš„ Pathway ç­›é€‰çŠ¶æ€
        filterGraph(); 

        // 4. å¦‚æœæœ‰è·¯å¾„åˆ†æï¼Œæ‰§è¡Œæ¸…ç†
        if (typeof clearPathHighlight === 'function') clearPathHighlight();
    }
});
};
// ç»Ÿä¸€è§†è§’ä¸­å¿ƒå¯¹é½å‡½æ•°ï¼ˆè§£å†³ä¸¤æ¬¡ç§»åŠ¨å’Œç”»å¹…åç§»ï¼‰
window.focusNodeStandard = function(node) {
    const cy = window.cyGraph || window.cy;
    if (!cy || !node || node.length === 0) return;

    // 1. å¼ºè¡Œåœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è§†è§’åŠ¨ç”»
    cy.stop();

    // 2. å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾…ä¾§è¾¹æ å±•å¼€åŠ¨ç”»ï¼ˆ0.3sï¼‰å®Œæˆï¼Œè·å–ç¨³å®šçš„ç”»å¸ƒå®½åº¦
    setTimeout(() => {
        const targetPos = node.position();
        const level = 2.0; // ç»Ÿä¸€æ”¾å¤§å€ç‡ï¼Œå¯åœ¨æ­¤ä¿®æ”¹

        // é‡æ–°è®¡ç®—å½“å‰ç”»å¸ƒä¸­å¿ƒï¼ˆæ­¤æ—¶ cy.width() å·²æ‰£é™¤ä¾§è¾¹æ å®½åº¦ï¼‰
        const panX = cy.width() / 2 - targetPos.x * level;
        const panY = cy.height() / 2 - targetPos.y * level;

        cy.animate({
            pan: { x: panX, y: panY },
            zoom: level,
            duration: 500,
            easing: 'ease-out-cubic'
        });
    }, 350); 
};
// å…¨å±€çŠ¶æ€é”
window._viewLock = false;

window.focusNodeFinal = function(node) {
    const cy = window.cyGraph || window.cy;
    if (!cy || !node || node.length === 0 || window._viewLock) return;

    // 1. å¼€å¯é”å®š
    window._viewLock = true;
    
    // 2. å¼ºè¡Œåœæ­¢å½“å‰æ‰€æœ‰åŠ¨ç”»
    cy.stop();

    // 3. æ‰§è¡Œå•æ¬¡è·³è½¬é€»è¾‘
    setTimeout(() => {
        const targetPos = node.position();
        const level = 2.0; // ç»Ÿä¸€å€ç‡

        // æ­¤æ—¶ä¾§è¾¹æ å·²ç¨³å®šï¼Œè®¡ç®—å½“å‰ç”»å¸ƒä¸­å¿ƒ
        const panX = cy.width() / 2 - targetPos.x * level;
        const panY = cy.height() / 2 - targetPos.y * level;

        cy.animate({
            pan: { x: panX, y: panY },
            zoom: level,
            duration: 500,
            easing: 'ease-out-quint'
        });

        // 4. åŠ¨ç”»ç»“æŸåè§£é” (600ms åå…è®¸ä¸‹ä¸€æ¬¡æ“ä½œ)
        setTimeout(() => { window._viewLock = false; }, 600);
    }, 350); 
};
// åœ¨è„šæœ¬æœ€åå¯åŠ¨ç›‘å¬
initSearchListener();

</script> </body> </html>
